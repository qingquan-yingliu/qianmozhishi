// farm-game.js
// å¯åŠ¨æ–¹å¼: node farm-game.js
// ä¾èµ–: npm install ws

const WebSocket = require('ws');
const http = require('http');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

const VISION = 2.31; // å½“å‰æœåŠ¡å™¨ç‰ˆæœ¬
const PORT = 8081;
const DATA_DIR = path.join(__dirname, 'farm-data');
const ACCOUNTS_FILE = path.join(DATA_DIR, 'accounts.json');
const WORLDS_FILE = path.join(DATA_DIR, 'worlds.json');
const PLAYERS_DIR = path.join(DATA_DIR, 'players');
const WORLDS_DIR = path.join(DATA_DIR, 'worlds');
const FRIENDS_FILE = path.join(DATA_DIR, 'friends.json');
const GROUPS_FILE = path.join(DATA_DIR, 'groups.json');
const TRADE_FILE = path.join(DATA_DIR, 'trades.json');
const BLACKLIST_FILE = path.join(DATA_DIR, 'blacklist.json');
const GLOBAL_NOTICE_FILE = path.join(DATA_DIR, 'global_notice.json');
const FEEDBACK_FILE = path.join(DATA_DIR, 'feedback.json');
const MAIL_FILE = path.join(DATA_DIR, 'mails.json');
const FRIENDSHIP_LEVELS_FILE = path.join(DATA_DIR, 'friendship_levels.json');

// ============================================================
//  å¥½å‹äº²å¯†åº¦ç­‰çº§é…ç½®ï¼ˆå¯ç”±å¤©é“ä¿®æ”¹ï¼‰
// ============================================================
var friendshipLevels = [
    { name: 'å†œåœºåˆè¯†', min: 0, max: 100 },
    { name: 'ç”°å›­ä¹‹äº¤', min: 100, max: 500 },
    { name: 'çŸ¥å¿ƒå†œå‹', min: 500, max: 2000 },
    { name: 'è«é€†ä¹‹äº¤', min: 2000, max: 5000 },
    { name: 'ç”Ÿæ­»ç›¸ä¾', min: 5000, max: Infinity }
];

function increaseFriendship(userA, userB, amount) {
    var all = loadFriends();
    if (!all[userA]) all[userA] = { friends: [], requests: [], blocked: [], friendship: {} };
    if (!all[userB]) all[userB] = { friends: [], requests: [], blocked: [], friendship: {} };

    // å…¼å®¹æ—§æ•°æ®ï¼šç¡®ä¿ friendship å¯¹è±¡å­˜åœ¨
    if (!all[userA].friendship) all[userA].friendship = {};
    if (!all[userB].friendship) all[userB].friendship = {};

    if (!all[userA].friendship[userB]) all[userA].friendship[userB] = 0;
    if (!all[userB].friendship[userA]) all[userB].friendship[userA] = 0;

    all[userA].friendship[userB] += amount;
    all[userB].friendship[userA] += amount;

    saveFriends(all);

    var levelInfoA = getFriendshipLevel(all[userA].friendship[userB]);
    var levelInfoB = getFriendshipLevel(all[userB].friendship[userA]);

    broadcastToTiandao({
        type: 'td_friendship',
        userA: userA,
        userB: userB,
        newFriendshipA: all[userA].friendship[userB],
        newFriendshipB: all[userB].friendship[userA],
        levelA: levelInfoA.level,
        levelNameA: levelInfoA.name,
        levelB: levelInfoB.level,
        levelNameB: levelInfoB.name,
        increaseAmount: amount
    });
}

function getFriendshipLevel(friendship) {
    var friendshipLevels = [
        { name: 'å†œåœºåˆè¯†', min: 0, max: 100 },
        { name: 'ç”°å›­ä¹‹äº¤', min: 100, max: 500 },
        { name: 'çŸ¥å¿ƒå†œå‹', min: 500, max: 2000 },
        { name: 'è«é€†ä¹‹äº¤', min: 2000, max: 5000 },
        { name: 'ç”Ÿæ­»ç›¸ä¾', min: 5000, max: Infinity }
    ];

    for (var i = 0; i < friendshipLevels.length; i++) {
        if (friendship >= friendshipLevels[i].min && friendship < (friendshipLevels[i + 1] ? friendshipLevels[i + 1].min : Infinity)) {
            return { level: i + 1, name: friendshipLevels[i].name };
        }
    }
    return { level: 1, name: 'å†œåœºåˆè¯†' };
}

function ensureDir(dir) { if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); }
ensureDir(DATA_DIR); ensureDir(PLAYERS_DIR); ensureDir(WORLDS_DIR);

function readJSON(fp, fb) {
    try {
        if (fs.existsSync(fp)) {
            var content = fs.readFileSync(fp, 'utf-8').trim();
            if (!content) {
                console.warn('[ç©ºæ–‡ä»¶]', fp, 'ä½¿ç”¨é»˜è®¤å€¼');
                return fb;
            }
            return JSON.parse(content);
        }
    } catch (e) {
        console.error('[è¯»å–å¤±è´¥]', fp, e.message);
        try {
            var backupPath = fp + '.corrupt.' + Date.now();
            fs.copyFileSync(fp, backupPath);
            console.warn('[è‡ªåŠ¨æ¢å¤]', fp, 'æŸåæ–‡ä»¶å·²å¤‡ä»½åˆ°', backupPath);
            if (fb !== undefined && fb !== null) {
                fs.writeFileSync(fp, JSON.stringify(fb, null, 2), 'utf-8');
                console.warn('[è‡ªåŠ¨æ¢å¤]', fp, 'å·²ç”¨é»˜è®¤å€¼è¦†ç›–');
            }
        } catch (e2) { console.error('[æ¢å¤å¤±è´¥]', e2.message); }
    }
    return fb;
}
function writeJSON(fp, d) {
    try {
        var tmpPath = fp + '.tmp';
        fs.writeFileSync(tmpPath, JSON.stringify(d, null, 2), 'utf-8');
        fs.renameSync(tmpPath, fp);
    } catch (e) { console.error('[å†™å…¥å¤±è´¥]', fp, e.message); }
}

// ============================================================
//  å†…å­˜ç¼“å­˜å±‚ â€” å‡å°‘ç£ç›˜è¯»å†™
// ============================================================
var _memCache = {};
var _dirtyFlags = {};
var FLUSH_DELAY = 3000; // 3ç§’å»¶è¿Ÿå†™å…¥

function cachedRead(fp, fallback) {
    if (_memCache[fp] !== undefined) return _memCache[fp];
    _memCache[fp] = readJSON(fp, fallback);
    return _memCache[fp];
}

function cachedWrite(fp, data) {
    _memCache[fp] = data;
    if (!_dirtyFlags[fp]) {
        _dirtyFlags[fp] = true;
        setTimeout(function () {
            try {
                writeJSON(fp, _memCache[fp]);
            } catch (e) { console.error('[å»¶è¿Ÿå†™å…¥å¤±è´¥]', fp, e.message); }
            _dirtyFlags[fp] = false;
        }, FLUSH_DELAY);
    }
}

function cachedWriteNow(fp, data) {
    _memCache[fp] = data;
    _dirtyFlags[fp] = false;
    writeJSON(fp, data);
}

function invalidateCache(fp) {
    delete _memCache[fp];
}

// ============================================================
//  è´¦å·ç³»ç»Ÿ
// ============================================================
function loadAccounts() { return cachedRead(ACCOUNTS_FILE, {}); }
function saveAccounts(a) { cachedWrite(ACCOUNTS_FILE, a); }
function hashPw(pw) { return crypto.createHash('sha256').update(pw).digest('hex'); }

function register(username, password) {
    if (!username || username.length < 2 || username.length > 16) return { ok: false, msg: 'ç”¨æˆ·åéœ€è¦2-16ä¸ªå­—ç¬¦' };
    if (!password || password.length < 4) return { ok: false, msg: 'å¯†ç è‡³å°‘4ä¸ªå­—ç¬¦' };
    if (!/^[\w\u4e00-\u9fa5]+$/.test(username)) return { ok: false, msg: 'ç”¨æˆ·ååªèƒ½åŒ…å«ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿' };
    var accounts = loadAccounts();
    if (accounts[username]) return { ok: false, msg: 'ç”¨æˆ·åå·²å­˜åœ¨' };
    var farmId = generateFarmId();
    accounts[username] = { password: password, createdAt: Date.now(), lastLogin: Date.now(), farmId: farmId };
    saveAccounts(accounts);
    return { ok: true, msg: 'æ³¨å†ŒæˆåŠŸ', farmId: farmId };
}

function login(username, password) {
    var accounts = loadAccounts();
    var acc = accounts[username];
    if (!acc) return { ok: false, msg: 'è´¦å·ä¸å­˜åœ¨' };
    if (acc.password !== password) return { ok: false, msg: 'å¯†ç é”™è¯¯' };
    acc.lastLogin = Date.now();
    saveAccounts(accounts);
    return { ok: true, msg: 'ç™»å½•æˆåŠŸ', farmId: acc.farmId };
}

function generateFarmId() {
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var accounts = loadAccounts();
    var existingIds = {};
    for (var u in accounts) existingIds[accounts[u].farmId] = true;

    for (var attempt = 0; attempt < 1000; attempt++) {
        var id = '';
        for (var i = 0; i < 6; i++) id += chars[Math.floor(Math.random() * chars.length)];
        if (!existingIds[id]) return id;
    }
    var id = '';
    for (var i = 0; i < 7; i++) id += chars[Math.floor(Math.random() * chars.length)];
    return id;
}

// ============================================================
//  é»‘åå•ç³»ç»Ÿ
// ============================================================
function loadBlacklist() { return cachedRead(BLACKLIST_FILE, {}); }
function saveBlacklist(bl) { cachedWrite(BLACKLIST_FILE, bl); }

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æŸä¸–ç•Œçš„é»‘åå•ä¸­
function isBlacklisted(username, worldId) {
    var bl = loadBlacklist();
    if (!bl[worldId]) return false;
    var entry = bl[worldId].find(function (e) { return e.username === username; });
    return !!entry;
}

// æ·»åŠ åˆ°é»‘åå•
function addToBlacklist(username, worldId, reason) {
    var bl = loadBlacklist();
    if (!bl[worldId]) bl[worldId] = [];
    // é¿å…é‡å¤
    var existing = bl[worldId].find(function (e) { return e.username === username; });
    if (existing) return { ok: false, msg: 'è¯¥ç”¨æˆ·å·²åœ¨é»‘åå•ä¸­' };
    bl[worldId].push({ username: username, reason: reason || '', addedAt: Date.now() });
    saveBlacklist(bl);
    return { ok: true };
}

// ä»é»‘åå•ç§»é™¤
function removeFromBlacklist(username, worldId) {
    var bl = loadBlacklist();
    if (!bl[worldId]) return { ok: false, msg: 'é»‘åå•ä¸ºç©º' };
    var idx = bl[worldId].findIndex(function (e) { return e.username === username; });
    if (idx === -1) return { ok: false, msg: 'è¯¥ç”¨æˆ·ä¸åœ¨é»‘åå•ä¸­' };
    bl[worldId].splice(idx, 1);
    if (bl[worldId].length === 0) delete bl[worldId];
    saveBlacklist(bl);
    return { ok: true };
}

// è·å–æŸä¸–ç•Œçš„é»‘åå•
function getBlacklist(worldId) {
    var bl = loadBlacklist();
    return bl[worldId] || [];
}

// ============================================================
//  ä¸–ç•Œç³»ç»Ÿ
// ============================================================
function loadWorldIndex() { return cachedRead(WORLDS_FILE, {}); }
function saveWorldIndex(idx) { cachedWrite(WORLDS_FILE, idx); }
function loadWorldData(wid) { return cachedRead(path.join(WORLDS_DIR, wid + '.json'), null); }
function saveWorldData(wid, d) { cachedWrite(path.join(WORLDS_DIR, wid + '.json'), d); }

function genWorldId() { return 'w_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 4); }

function createWorld(name, password, worldData) {
    var id = genWorldId();
    var idx = loadWorldIndex();
    idx[id] = { id: id, name: name, password: password || '', createdAt: Date.now(), status: 'active', playerCount: 0 };
    saveWorldIndex(idx);
    var full = {
        id: id, name: name, createdAt: Date.now(),
        season: worldData.season || 'æ˜¥',
        weather: 'æ™´',
        plants: worldData.plants || [],
        wildAreas: worldData.wildAreas || [],
        shop: worldData.shop || getDefaultShop(),
        announcements: [],
        history: [],
        events: [],
        worldTitles: {},
        dailyTaskPool: getDefaultDailyTasks(),
        adventureRate: 0.1,
        adventures: getDefaultAdventures().adventures,
    };
    saveWorldData(id, full);
    return { ok: true, worldId: id };
}

function getDefaultAdventures() {
    return {
        rate: 0.1, // è§¦å‘æ¦‚ç‡ 10%
        adventures: [
            {
                id: 'adv_fairy',
                text: 'ğŸ§š ä½ åœ¨æ—é—´é‡åˆ°ä¸€åªå°ç²¾çµï¼Œå¥¹é€äº†ä½ ä¸€äº›é‡‘å¸ã€‚',
                weight: 15,
                rewards: [{ type: 'money', amount: 30 }]
            },
            {
                id: 'adv_seed',
                text: 'ğŸŒ± ä¸€é˜µé£å¹è¿‡ï¼Œä½ å‘ç°åœ°ä¸Šå¤šäº†å‡ é¢—ç§å­ã€‚',
                weight: 15,
                rewards: [{ type: 'seed', data: { id: 'shop_wheat_seed', name: 'éº¦ç§', icon: 'ğŸŒ¾', count: 2, growTime: 1800000, fruitId: 'wheat', fruitName: 'å°éº¦', fruitIcon: 'ğŸŒ¾', fruitValue: 8 } }]
            },
            {
                id: 'adv_fruit',
                text: 'ğŸ ä¸€æ£µæœæ ‘ä¸Šçš„æœå­æ‰åœ¨ä½ é¢å‰ã€‚',
                weight: 15,
                rewards: [{ type: 'fruit', data: { id: 'wheat', name: 'å°éº¦', icon: 'ğŸŒ¾', count: 3, value: 8 } }]
            },
            {
                id: 'adv_pet',
                text: 'ğŸ± ä½ çš„å® ç‰©ä»¬å›´ç€ä½ æ‰“è½¬ï¼Œå¿ƒæƒ…å˜å¥½äº†ã€‚',
                weight: 10,
                rewards: [{ type: 'pet_mood', amount: 15 }]
            },
            {
                id: 'adv_stamina',
                text: 'âš¡ ä½ å‘ç°ä¸€çœ¼æ¸…æ³‰ï¼Œå–äº†å‡ å£åä½“åŠ›æ¢å¤äº†ã€‚',
                weight: 15,
                rewards: [{ type: 'stamina', amount: 20 }]
            },
            {
                id: 'adv_mixed',
                text: 'ğŸ ä½ å‘ç°ä¸€ä¸ªç¥ç§˜çš„åŒ…è£¹ï¼Œé‡Œé¢æœ‰å¥½ä¸œè¥¿ï¼',
                weight: 10,
                rewards: [
                    { type: 'money', amount: 20 },
                    { type: 'stamina', amount: 10 }
                ]
            }
        ]
    };
}

function getDefaultShop() {
    return {
        items: [
            {
                id: 'shop_wheat_seed', name: 'éº¦ç§', type: 'seed', price: 6, desc: 'åŸºç¡€ä½œç‰©ï¼Œ30åˆ†é’Ÿæˆç†Ÿ', icon: 'ğŸŒ¾',
                seedData: { id: 'shop_wheat_seed', name: 'éº¦ç§', icon: 'ğŸŒ¾', growTime: 1800000, fruitId: 'wheat', fruitName: 'å°éº¦', fruitIcon: 'ğŸŒ¾', fruitValue: 8, fruitDesc: 'é‡‘é»„çš„éº¦ç©—' }
            },
            {
                id: 'shop_radish_seed', name: 'èåœç§å­', type: 'seed', price: 10, desc: '45åˆ†é’Ÿæˆç†Ÿï¼Œæ”¶ç›Šä¸é”™', icon: 'ğŸŒ±',
                seedData: { id: 'shop_radish_seed', name: 'èåœç§å­', icon: 'ğŸŒ±', growTime: 2700000, fruitId: 'radish', fruitName: 'èåœ', fruitIcon: 'ğŸ¥•', fruitValue: 12, fruitDesc: 'è„†ç”œçš„èåœ' }
            },
            {
                id: 'shop_cabbage_seed', name: 'ç™½èœç§å­', type: 'seed', price: 15, desc: '1å°æ—¶æˆç†Ÿï¼Œäº§é‡ç¨³å®š', icon: 'ğŸ¥¬',
                seedData: { id: 'shop_cabbage_seed', name: 'ç™½èœç§å­', icon: 'ğŸ¥¬', growTime: 3600000, fruitId: 'cabbage', fruitName: 'ç™½èœ', fruitIcon: 'ğŸ¥¬', fruitValue: 16, fruitDesc: 'ç¿ ç»¿çš„å¤§ç™½èœ' }
            },
            {
                id: 'shop_corn_seed', name: 'ç‰ç±³ç§å­', type: 'seed', price: 20, desc: '1.5å°æ—¶æˆç†Ÿï¼Œä»·å€¼è¾ƒé«˜', icon: 'ğŸŒ½',
                seedData: { id: 'shop_corn_seed', name: 'ç‰ç±³ç§å­', icon: 'ğŸŒ½', growTime: 5400000, fruitId: 'corn', fruitName: 'ç‰ç±³', fruitIcon: 'ğŸŒ½', fruitValue: 25, fruitDesc: 'é¥±æ»¡çš„ç‰ç±³æ£’' }
            },
            {
                id: 'shop_melon_seed', name: 'ç”œç“œç§å­', type: 'seed', price: 40, desc: '3å°æ—¶æˆç†Ÿï¼Œé«˜ä»·å€¼ä½œç‰©', icon: 'ğŸˆ',
                seedData: { id: 'shop_melon_seed', name: 'ç”œç“œç§å­', icon: 'ğŸˆ', growTime: 10800000, fruitId: 'melon', fruitName: 'ç”œç“œ', fruitIcon: 'ğŸˆ', fruitValue: 50, fruitDesc: 'é¦™ç”œå¤šæ±çš„ç”œç“œ' }
            },
            { id: 'fertilizer_basic', name: 'æ™®é€šè‚¥æ–™', type: 'fertilizer', price: 50, desc: 'å‡å°‘1å°æ—¶æˆç†Ÿæ—¶é—´', effect: { growthReduce: 3600000 } },
            { id: 'fertilizer_super', name: 'é«˜çº§è‚¥æ–™', type: 'fertilizer', price: 150, desc: 'å‡å°‘3å°æ—¶æˆç†Ÿæ—¶é—´', effect: { growthReduce: 10800000 } },
            { id: 'fertilizer_magic', name: 'ç¥å¥‡è‚¥æ–™', type: 'fertilizer', price: 500, desc: 'å‡å°‘8å°æ—¶æˆç†Ÿæ—¶é—´', effect: { growthReduce: 28800000 } },
            { id: 'plot_expand', name: 'å¼€å¦ä»¤', type: 'tool', price: 300, desc: 'å¢åŠ ä¸€å—ç§æ¤åœ°ï¼ˆæœ€å¤š12å—ï¼‰', effect: { addPlot: 1 } },
            {
                id: 'watering_can_lv1', name: 'æ™®é€šæ°´å£¶', type: 'tool', price: 100, desc: 'æµ‡æ°´æ•ˆæœæå‡10%', icon: 'ğŸ’§',
                effect: { waterBoost: true, waterBoostLevel: 1, waterBoostPercent: 0.1 }
            },
            {
                id: 'watering_can_lv2', name: 'ç²¾è‰¯æ°´å£¶', type: 'tool', price: 200, desc: 'æµ‡æ°´æ•ˆæœæå‡20%', icon: 'ğŸ’§',
                effect: { waterBoost: true, waterBoostLevel: 2, waterBoostPercent: 0.2 }
            },
            {
                id: 'watering_can_lv3', name: 'ä¼˜è´¨æ°´å£¶', type: 'tool', price: 350, desc: 'æµ‡æ°´æ•ˆæœæå‡30%', icon: 'ğŸ’§',
                effect: { waterBoost: true, waterBoostLevel: 3, waterBoostPercent: 0.3 }
            },
            {
                id: 'watering_can_lv4', name: 'ç¨€æœ‰æ°´å£¶', type: 'tool', price: 550, desc: 'æµ‡æ°´æ•ˆæœæå‡40%', icon: 'ğŸ’§',
                effect: { waterBoost: true, waterBoostLevel: 4, waterBoostPercent: 0.4 }
            },
            {
                id: 'watering_can_lv5', name: 'ä¼ è¯´æ°´å£¶', type: 'tool', price: 800, desc: 'æµ‡æ°´æ•ˆæœæå‡50%', icon: 'ğŸ’§',
                effect: { waterBoost: true, waterBoostLevel: 5, waterBoostPercent: 0.5 }
            },
            { id: 'cage_expand', name: 'åœˆç¬¼', type: 'tool', price: 300, desc: 'å¢åŠ ä¸€ä¸ªåœˆå…»æ ï¼ˆæœ€å¤š12ä¸ªï¼‰', effect: { addCage: 1 } },
            {
                id: 'chicken', name: 'é¸¡', type: 'animal', price: 150, desc: 'åŸºç¡€å®¶ç¦½ï¼Œ5å°æ—¶ç¹æ®–', icon: 'ğŸ”',
                animalData: { id: 'chicken', name: 'é¸¡', icon: 'ğŸ”', foodPerHour: 2, sellPrice: 50, breedTime: 18000000 }
            },
            {
                id: 'duck', name: 'é¸­', type: 'animal', price: 180, desc: 'æ°´ç¦½ï¼Œ5å°æ—¶ç¹æ®–', icon: 'ğŸ¦†',
                animalData: { id: 'duck', name: 'é¸­', icon: 'ğŸ¦†', foodPerHour: 2, sellPrice: 60, breedTime: 18000000 }
            },
            {
                id: 'pig', name: 'çŒª', type: 'animal', price: 300, desc: 'å¤§å‹å®¶ç•œï¼Œ8å°æ—¶ç¹æ®–', icon: 'ğŸ·',
                animalData: { id: 'pig', name: 'çŒª', icon: 'ğŸ·', foodPerHour: 5, sellPrice: 100, breedTime: 28800000 }
            },
            {
                id: 'goose', name: 'é¹…', type: 'animal', price: 210, desc: 'å¤§å‹æ°´ç¦½ï¼Œ6å°æ—¶ç¹æ®–', icon: 'ğŸ¦¢',
                animalData: { id: 'goose', name: 'é¹…', icon: 'ğŸ¦¢', foodPerHour: 3, sellPrice: 70, breedTime: 21600000 }
            },
            {
                id: 'fish', name: 'é±¼', type: 'animal', price: 120, desc: 'æ°´äº§ï¼Œ5å°æ—¶ç¹æ®–', icon: 'ğŸŸ',
                animalData: { id: 'fish', name: 'é±¼', icon: 'ğŸŸ', foodPerHour: 1, sellPrice: 40, breedTime: 18000000 }
            },
            {
                id: 'pet_cat', name: 'çŒ«', type: 'pet', price: 200, desc: 'æ¸©é¡ºçš„å®¶çŒ«ï¼Œä¼šå¸®ä½ å¯»å®', icon: 'ğŸ±',
                petData: { species: 'çŒ«', speciesIcon: 'ğŸ±', rarity: 'common', baseValue: 30, baseMood: 100 }
            },
            {
                id: 'pet_dog', name: 'ç‹—', type: 'pet', price: 250, desc: 'å¿ è¯šçš„ä¼™ä¼´ï¼Œå¯»å®èƒ½åŠ›å¼º', icon: 'ğŸ•',
                petData: { species: 'ç‹—', speciesIcon: 'ğŸ•', rarity: 'common', baseValue: 35, baseMood: 100 }
            },
            {
                id: 'pet_mouse', name: 'é¼ ', type: 'pet', price: 120, desc: 'çµå·§çš„å°å®¶ä¼™ï¼Œæ“…é•¿æ‰¾ç§å­', icon: 'ğŸ­',
                petData: { species: 'é¼ ', speciesIcon: 'ğŸ­', rarity: 'common', baseValue: 15, baseMood: 100 }
            },
            {
                id: 'pet_parrot', name: 'é¹¦é¹‰', type: 'pet', price: 350, desc: 'èªæ˜çš„é¸Ÿå„¿ï¼Œå¯»å®æ”¶ç›Šé«˜', icon: 'ğŸ¦œ',
                petData: { species: 'é¹¦é¹‰', speciesIcon: 'ğŸ¦œ', rarity: 'uncommon', baseValue: 60, baseMood: 100 }
            },
            { id: 'decoration_flower', name: 'èŠ±å›', type: 'decoration', price: 50, desc: 'ç¾ä¸½çš„èŠ±å›ï¼Œè£…é¥°å†œåœº', icon: 'ğŸŒ¸' },
            { id: 'decoration_scarecrow', name: 'ç¨»è‰äºº', type: 'decoration', price: 100, desc: 'å“å”¬å°é¸Ÿï¼Œè£…é¥°å†œåœº', icon: 'ğŸŒ¾' },
            { id: 'decoration_fence', name: 'æ …æ ', type: 'decoration', price: 30, desc: 'ç®€å•çš„æœ¨æ …æ ', icon: 'â¬œ' },
            { id: 'decoration_well', name: 'æ°´äº•', type: 'decoration', price: 200, desc: 'å¤è‰²å¤é¦™çš„æ°´äº•', icon: 'â›²' },
            { id: 'decoration_bench', name: 'é•¿æ¤…', type: 'decoration', price: 80, desc: 'ä¼‘æ¯çš„é•¿æ¤…', icon: 'ğŸª‘' },
        ]
    };
}

// ============================================================
//  å‘¨æŒ‘æˆ˜ç³»ç»Ÿ
// ============================================================
var weeklyChallenges = {
    current: null,      // å½“å‰å‘¨æŒ‘æˆ˜ { id, name, desc, startTime, endTime, tasks: [], rewards: [] }
    next: null,         // ä¸‹ä¸€å‘¨æŒ‘æˆ˜
    history: [],         // å†å²æŒ‘æˆ˜
    list: []             // æ‰€æœ‰å¯ç”¨çš„å‘¨æŒ‘æˆ˜æ¨¡æ¿
};

function getCurrentWeekMonday() {
    var d = new Date();
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() - (d.getDay() + 6) % 7); // å‘¨ä¸€
    return d.getTime();
}

// ============================================================
//  é»˜è®¤æ¯æ—¥ä»»åŠ¡æ± ï¼ˆå½“ä¸–ç•Œæ²¡æœ‰é…ç½®æ—¶ä½¿ç”¨ï¼‰
// ============================================================
function getDefaultDailyTasks() {
    return {
        pool: [
            // æ”¶è·ç±»
            {
                id: 'daily_harvest_any', type: 'harvest', targetDesc: 'æ”¶è·ä»»æ„æœå®', targetCount: 5, difficulty: 'easy', weight: 10,
                rewards: [{ type: 'money', amount: 30 }]
            },
            {
                id: 'daily_harvest_any_10', type: 'harvest', targetDesc: 'æ”¶è·ä»»æ„æœå®', targetCount: 10, difficulty: 'medium', weight: 8,
                rewards: [{ type: 'money', amount: 60 }, { type: 'seed', data: { id: 'shop_wheat_seed', name: 'éº¦ç§', icon: 'ğŸŒ¾', count: 2, growTime: 1800000, fruitId: 'wheat', fruitName: 'å°éº¦', fruitIcon: 'ğŸŒ¾', fruitValue: 8 } }]
            },

            // é‡‡é›†ç±»
            {
                id: 'daily_gather_any', type: 'gather', targetDesc: 'åœ¨é‡å¤–é‡‡é›†', targetCount: 3, difficulty: 'easy', weight: 10,
                rewards: [{ type: 'money', amount: 25 }]
            },
            {
                id: 'daily_gather_any_6', type: 'gather', targetDesc: 'åœ¨é‡å¤–é‡‡é›†', targetCount: 6, difficulty: 'medium', weight: 8,
                rewards: [{ type: 'money', amount: 50 }]
            },

            // ç§æ¤ç±»
            {
                id: 'daily_plant_any', type: 'plant', targetDesc: 'ç§æ¤ä½œç‰©', targetCount: 3, difficulty: 'easy', weight: 10,
                rewards: [{ type: 'money', amount: 20 }]
            },
            {
                id: 'daily_plant_any_6', type: 'plant', targetDesc: 'ç§æ¤ä½œç‰©', targetCount: 6, difficulty: 'medium', weight: 8,
                rewards: [{ type: 'money', amount: 40 }, { type: 'fruit', data: { id: 'wheat', name: 'å°éº¦', icon: 'ğŸŒ¾', count: 5, value: 8 } }]
            },

            // æµ‡æ°´ç±»
            {
                id: 'daily_water_self', type: 'water_self', targetDesc: 'ç»™è‡ªå·±çš„ä½œç‰©æµ‡æ°´', targetCount: 3, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 15 }]
            },
            {
                id: 'daily_water_friend', type: 'water_friend', targetDesc: 'ç»™å¥½å‹æµ‡æ°´', targetCount: 2, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 20 }]
            },

            // é”€å”®ç±»
            {
                id: 'daily_sell_any', type: 'sell', targetDesc: 'å–å‡ºä»»æ„ç‰©å“', targetCount: 5, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 35 }]
            },
            {
                id: 'daily_sell_any_10', type: 'sell', targetDesc: 'å–å‡ºä»»æ„ç‰©å“', targetCount: 10, difficulty: 'medium', weight: 6,
                rewards: [{ type: 'money', amount: 70 }]
            },

            // åŠ¨ç‰©ç±»
            {
                id: 'daily_catch_animal', type: 'catch_animal', targetDesc: 'æ•è·é‡ç”ŸåŠ¨ç‰©', targetCount: 1, difficulty: 'medium', weight: 6,
                rewards: [{ type: 'money', amount: 40 }]
            },
            {
                id: 'daily_feed_animal', type: 'feed_animal', targetDesc: 'å–‚é£ŸåŠ¨ç‰©', targetCount: 3, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 25 }]
            },

            // å® ç‰©ç±»
            {
                id: 'daily_pet_adventure', type: 'pet_adventure', targetDesc: 'æ´¾å® ç‰©å¯»å®', targetCount: 2, difficulty: 'medium', weight: 6,
                rewards: [{ type: 'money', amount: 45 }]
            },
            {
                id: 'daily_pet_collect', type: 'pet_collect', targetDesc: 'é¢†å–å¯»å®å¥–åŠ±', targetCount: 1, difficulty: 'easy', weight: 6,
                rewards: [{ type: 'money', amount: 30 }]
            },
            {
                id: 'daily_catch_pet', type: 'catch_pet', targetDesc: 'æ•è·å® ç‰©', targetCount: 1, difficulty: 'hard', weight: 4,
                rewards: [{ type: 'money', amount: 80 }]
            },

            // ç¤¾äº¤ç±»
            {
                id: 'daily_visit', type: 'visit', targetDesc: 'æ‹œè®¿å¥½å‹å†œåœº', targetCount: 1, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 20 }]
            },
            {
                id: 'daily_chat', type: 'chat', targetDesc: 'åœ¨ä¸–ç•Œé¢‘é“å‘è¨€', targetCount: 3, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 15 }]
            },

            // ä½“åŠ›ç±»
            {
                id: 'daily_rest', type: 'rest', targetDesc: 'ä¼‘æ¯æ¢å¤ä½“åŠ›', targetCount: 1, difficulty: 'easy', weight: 6,
                rewards: [{ type: 'money', amount: 20 }]
            },

            // é‡‘é’±ç±»
            {
                id: 'daily_earn_money', type: 'earn_money', targetDesc: 'èµšå–é‡‘å¸', targetCount: 100, difficulty: 'medium', weight: 8,
                rewards: [{ type: 'money', amount: 20 }]
            },
            {
                id: 'daily_earn_money_200', type: 'earn_money', targetDesc: 'èµšå–é‡‘å¸', targetCount: 200, difficulty: 'hard', weight: 5,
                rewards: [{ type: 'money', amount: 50 }, { type: 'seed', data: { id: 'shop_corn_seed', name: 'ç‰ç±³ç§å­', icon: 'ğŸŒ½', count: 2, growTime: 5400000, fruitId: 'corn', fruitName: 'ç‰ç±³', fruitIcon: 'ğŸŒ½', fruitValue: 25 } }]
            },

            // æ¶ˆè´¹ç±»
            {
                id: 'daily_spend_money', type: 'spend_money', targetDesc: 'æ¶ˆè´¹é‡‘å¸', targetCount: 50, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 15 }]
            },
            {
                id: 'daily_spend_money_150', type: 'spend_money', targetDesc: 'æ¶ˆè´¹é‡‘å¸', targetCount: 150, difficulty: 'medium', weight: 6,
                rewards: [{ type: 'money', amount: 30 }]
            },

            // å•†åº—è´­ä¹°
            {
                id: 'daily_shop_buy', type: 'shop_buy', targetDesc: 'åœ¨å•†åº—è´­ä¹°ç‰©å“', targetCount: 1, difficulty: 'easy', weight: 8,
                rewards: [{ type: 'money', amount: 20 }]
            }
        ],
        dailyCount: 5,        // æ¯æ—¥ä»»åŠ¡æ•°é‡
        perfectBonus: {       // å…¨å‹¤å¥–åŠ±ï¼ˆå…¨éƒ¨å®Œæˆï¼‰
            rewards: [{ type: 'money', amount: 100 }, { type: 'seed', data: { id: 'shop_melon_seed', name: 'ç”œç“œç§å­', icon: 'ğŸˆ', count: 1, growTime: 10800000, fruitId: 'melon', fruitName: 'ç”œç“œ', fruitIcon: 'ğŸˆ', fruitValue: 50 } }]
        }
    };
}

function getWorldList(isTiandao) {
    var idx = loadWorldIndex();
    var list = [];
    for (var id in idx) {
        var w = idx[id];
        if (isTiandao) { list.push(w); }
        else { list.push({ id: w.id, name: w.name, hasPassword: !!w.password, playerCount: w.playerCount || 0, status: w.status }); }
    }
    return list;
}

function verifyWorldPw(wid, pw) {
    var idx = loadWorldIndex();
    var w = idx[wid];
    if (!w) return { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' };
    if (w.status !== 'active') return { ok: false, msg: 'ä¸–ç•Œæœªå¼€æ”¾' };
    if (w.password && w.password !== pw) return { ok: false, msg: 'å¯†ç é”™è¯¯' };
    return { ok: true };
}

//æ›´æ–°ä¸–ç•Œåœ¨çº¿äººæ•°çš„è¾…åŠ©å‡½æ•°
function updateWorldPlayerCount(worldId) {
    var idx = loadWorldIndex();
    if (idx[worldId]) {
        idx[worldId].playerCount = getOnlineInWorld(worldId).length;
        saveWorldIndex(idx);
    }
}

// ============================================================
//  ç©å®¶æ•°æ®
// ============================================================
function loadPlayer(username, worldId) {
    var fp = path.join(PLAYERS_DIR, username + '_' + worldId + '.json');
    return cachedRead(fp, null);
}

function savePlayer(username, worldId, data) {
    var fp = path.join(PLAYERS_DIR, username + '_' + worldId + '.json');
    cachedWrite(fp, data);
}

function createPlayerData(username, worldId, farmId) {
    var accounts = loadAccounts();
    var fid = farmId || (accounts[username] ? accounts[username].farmId : generateFarmId());
    return {
        username: username,
        worldId: worldId,
        farmId: fid,
        createdAt: Date.now(),
        stamina: 100,
        staminaMax: 100,
        lastStaminaFull: Date.now(),
        restCooldown: 0,
        money: 200,
        plots: [
            { id: 0, plant: null }, { id: 1, plant: null }, { id: 2, plant: null },
            { id: 3, plant: null }, { id: 4, plant: null }, { id: 5, plant: null }
        ],
        cages: [
            { id: 0, animal: null }, { id: 1, animal: null }, { id: 2, animal: null },
            { id: 3, animal: null }, { id: 4, animal: null }, { id: 5, animal: null }
        ],
        maxCages: 6,
        animals: [],
        maxPlots: 6,
        seeds: [
            { id: 'starter_wheat_seed', name: 'éº¦ç§', icon: 'ğŸŒ¾', count: 3, growTime: 1800000, fruitId: 'wheat', fruitName: 'å°éº¦', fruitIcon: 'ğŸŒ¾', fruitValue: 8, fruitDesc: 'é‡‘é»„çš„éº¦ç©—ï¼Œæœ€åŸºç¡€çš„ä½œç‰©', source: 'starter' },
            { id: 'starter_radish_seed', name: 'èåœç§å­', icon: 'ğŸŒ±', count: 3, growTime: 2700000, fruitId: 'radish', fruitName: 'èåœ', fruitIcon: 'ğŸ¥•', fruitValue: 12, fruitDesc: 'è„†ç”œçš„èåœ', source: 'starter' }
        ],
        fruits: [],
        items: [],
        waterBoostLevel: 0,
        totalHarvest: 0,
        totalGather: 0,
        lastActive: Date.now(),
        pets: [],    // æ¯ä¸ªå® ç‰©ç»“æ„: { id: å”¯ä¸€id, species: 'çŒ«', speciesIcon: 'ğŸ±', name: 'å°èŠ±', rarity: 'common', mood: 100, value: 50, createdAt: timestamp, lastAdventure: 0 }
        dailyTasks: {
            lastRefreshDate: '',  // ä¸Šæ¬¡åˆ·æ–°çš„æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
            tasks: [],            // å½“å‰çš„ä»»åŠ¡åˆ—è¡¨
            completedCount: 0,    // å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡ï¼ˆç”¨äºå…¨å‹¤å¥–åŠ±ï¼‰
            claimedAll: false     // æ˜¯å¦å·²é¢†å–å…¨å‹¤å¥–åŠ±
        },
        decorations: [], // è£…é¥°ç‰©æ•°ç»„ { id: è£…é¥°ç‰©ID, name: åç§°, icon: å›¾æ ‡, x: ä½ç½®, y: ä½ç½® }
        ownedTitleIds: [],    // ç©å®¶æ‹¥æœ‰çš„ç§°å·IDæ•°ç»„
        activeTitleId: null,  // ç©å®¶å½“å‰æ¿€æ´»çš„ç§°å·ID
        titles: [],           // ç§°å·æ•°ç»„ [{ worldId, titleId, titleName, titleColor, obtainedAt }]
        activeTitle: null,    // å½“å‰æ¿€æ´»çš„ç§°å· { worldId, titleId }
        holidayTasks: {},
    };
}

function getOrCreatePlayer(username, worldId) {
    var data = loadPlayer(username, worldId);
    if (!data) {
        var accounts = loadAccounts();
        var farmId = accounts[username] ? accounts[username].farmId : generateFarmId();
        data = createPlayerData(username, worldId, farmId);
        savePlayer(username, worldId, data);
        //å…¼å®¹æ—§æ•°æ® - æ·»åŠ  holidayTasks å­—æ®µ
        if (!data.holidayTasks) {
            data.holidayTasks = {};
            changed = true;
        }
        return data; // æ–°å»ºçš„æ•°æ®ä¸éœ€è¦ä¿®è¡¥
    }

    var changed = false;

    if (data.titles && !data.ownedTitleIds) {
        // ç¡®ä¿ data.titles æ˜¯æ•°ç»„ï¼Œå¦åˆ™è§†ä¸ºç©ºæ•°ç»„
        var titlesArray = Array.isArray(data.titles) ? data.titles : [];
        data.ownedTitleIds = titlesArray.map(t => t.titleId);
        // å°è¯•è¿ç§» activeTitle
        if (data.activeTitle && data.activeTitle.titleId) {
            data.activeTitleId = data.activeTitle.titleId;
        } else {
            data.activeTitleId = null;
        }
        delete data.titles;
        delete data.activeTitle;
        changed = true;
    }
    if (!data.ownedTitleIds) {
        data.ownedTitleIds = [];
        data.activeTitleId = null;
        changed = true;
    }

    // å…¼å®¹æ—§æ•°æ®ï¼šåªåœ¨ç¼ºå¤±æ—¶è¡¥
    if (!data.cages) {
        data.cages = [
            { id: 0, animal: null }, { id: 1, animal: null }, { id: 2, animal: null },
            { id: 3, animal: null }, { id: 4, animal: null }, { id: 5, animal: null }
        ];
        data.maxCages = 6;
        data.animals = [];
        changed = true;
    }
    if (!data.pets) {
        data.pets = [];
        changed = true;
    }

    //å…¼å®¹æ—§æ•°æ® - æ·»åŠ  dailyTasks å­—æ®µ
    if (!data.dailyTasks) {
        data.dailyTasks = {
            lastRefreshDate: '',
            tasks: [],
            completedCount: 0,
            claimedAll: false
        };
        changed = true;
    }

    // ä½“åŠ›æ¢å¤
    var oldStamina = data.stamina;
    data = recalcStamina(data);
    if (data.stamina !== oldStamina) changed = true;

    // å® ç‰©å¿ƒæƒ…ï¼šæ¯4å°æ—¶-1ï¼Œå¢é‡è®¡ç®—
    var now = Date.now();
    if (data.pets.length > 0) {
        for (var i = 0; i < data.pets.length; i++) {
            var pet = data.pets[i];
            var lastCalc = pet._lastMoodCalc || pet.lastInteraction || pet.createdAt || now;
            var hoursSinceCalc = (now - lastCalc) / 3600000;
            if (hoursSinceCalc >= 4) {
                var moodLoss = Math.floor(hoursSinceCalc / 4);
                pet.mood = Math.max(0, (pet.mood || 100) - moodLoss);
                pet._lastMoodCalc = now;
                changed = true;
            }
        }
    }

    // cageçŠ¶æ€æ£€æŸ¥
    checkAllCages(data);

    return data;
}

// ç¡®ä¿ä¸–ç•Œæœ‰å¥‡é‡æ•°æ®
function ensureWorldAdventures(worldData) {
    if (!worldData.adventureRate) worldData.adventureRate = 0.1;
    if (!worldData.adventures) {
        worldData.adventures = getDefaultAdventures().adventures;
    }
    return worldData;
}

function recalcStamina(data) {
    var now = Date.now();

    //åˆå§‹åŒ–ç‹¬ç«‹çš„ä½“åŠ›è®¡ç®—æ—¶é—´æˆ³ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
    if (!data.lastStaminaCalc) {
        data.lastStaminaCalc = data.lastActive || data.createdAt || now;
    }

    var dayMs = 24 * 60 * 60 * 1000;
    var elapsed = now - (data.lastStaminaFull || data.createdAt || now);

    if (elapsed >= dayMs) {
        // è¶…è¿‡24å°æ—¶ï¼Œç›´æ¥å›æ»¡
        data.stamina = data.staminaMax;
        data.lastStaminaFull = now;
        data.lastStaminaCalc = now;
    } else {
        //åŸºäº lastStaminaCalc è®¡ç®—ï¼Œä¸å— lastActive å½±å“
        var hourMs = 60 * 60 * 1000;
        var hoursPassed = (now - data.lastStaminaCalc) / hourMs;
        if (hoursPassed > 0) {
            var recover = Math.floor(hoursPassed * (data.staminaMax / 24));
            if (recover > 0) {
                data.stamina = Math.min(data.stamina + recover, data.staminaMax);
                //åªåœ¨å®é™…æ¢å¤äº†ä½“åŠ›æ—¶æ‰æ›´æ–°æ—¶é—´æˆ³
                data.lastStaminaCalc = now;
            }
        }
    }

    data.lastActive = now;
    return data;
}

// ============================================================
//  å¥½å‹ç³»ç»Ÿ
// ============================================================
function loadFriends() { return cachedRead(FRIENDS_FILE, {}); }
function saveFriends(d) { cachedWrite(FRIENDS_FILE, d); }

function getFriendData(username) {
    var all = loadFriends();
    if (!all[username]) all[username] = { friends: [], requests: [], blocked: [], friendship: {} };
    // ç¡®ä¿æ¯ä¸ªå¥½å‹éƒ½æœ‰äº²å¯†åº¦æ•°æ®
    if (!all[username].friendship) all[username].friendship = {};
    return all[username];
}

function saveFriendData(username, data) {
    var all = loadFriends();
    all[username] = data;
    saveFriends(all);
}

// ============================================================
//  ç¾¤èŠç³»ç»Ÿ
// ============================================================
function loadGroups() { return cachedRead(GROUPS_FILE, {}); }
function saveGroups(d) { cachedWrite(GROUPS_FILE, d); }
function genGroupId() { return 'g_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 3); }

// ============================================================
//  äº¤æ˜“ç³»ç»Ÿ
// ============================================================
function loadTrades() { return cachedRead(TRADE_FILE, {}); }
function saveTrades(d) { cachedWrite(TRADE_FILE, d); }
function genTradeId() { return 't_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4); }

// ============================================================
//  åœ¨çº¿ç®¡ç†
// ============================================================
var onlinePlayers = {};
var tiandaoClients = [];
var TIANDAO_SECRET = 'tiandao_farm_2026';

function safeSend(ws, data) {
    try { if (ws && ws.readyState === WebSocket.OPEN) ws.send(typeof data === 'string' ? data : JSON.stringify(data)); } catch (e) { }
}

function broadcastToWorld(worldId, msg, exclude) {
    for (var u in onlinePlayers) {
        var p = onlinePlayers[u];
        if (p.worldId === worldId && u !== exclude) safeSend(p.ws, msg);
    }
}

function broadcastToTiandao(msg) {
    tiandaoClients.forEach(function (ws) { safeSend(ws, msg); });
}

function getOnlineInWorld(worldId) {
    var list = [];
    for (var u in onlinePlayers) { if (onlinePlayers[u].worldId === worldId) list.push(u); }
    return list;
}

//è¸¢å‡ºç©å®¶å¹¶æ›´æ–°äººæ•°çš„ç»Ÿä¸€å‡½æ•°
function removePlayerFromWorld(username, reason, msgType) {
    var p = onlinePlayers[username];
    if (!p) return;
    var worldId = p.worldId;
    safeSend(p.ws, { type: msgType || 'kicked', msg: reason || 'è¢«è¸¢å‡º' });
    p.ws.close();
    delete onlinePlayers[username];
    broadcastToWorld(worldId, { type: 'player_offline', username: username });
    broadcastToTiandao({ type: 'td_player_offline', username: username, worldId: worldId });
    updateWorldPlayerCount(worldId);
    console.log('[ç§»é™¤]', username, 'ä»ä¸–ç•Œ', worldId, 'åŸå› :', reason);
}

// ============================================================
//  ç§ç”°æ ¸å¿ƒï¼šæœåŠ¡å™¨ç«¯è®¡ç®—è¿›åº¦
// ============================================================
function calcPlotProgress(plot, waterBoostLevel, weather) {
    if (!plot.plant) return;
    if (!plot.plant.friendWaters) {
        plot.plant.friendWaters = [];
    }
    var now = Date.now();
    var elapsed = now - plot.plant.plantedAt;
    var growTime = plot.plant.growTime || 7200000;

    // å¤©æ°”å½±å“
    if (weather) {
        var weatherFactor = 1.0;
        switch (weather) {
            case 'æ™´':
                weatherFactor = 1.0; // æ­£å¸¸
                break;
            case 'å¤šäº‘':
                weatherFactor = 0.95; // 5%åŠ é€Ÿ
                break;
            case 'é˜´':
                weatherFactor = 1.0;
                break;
            case 'å°é›¨':
                weatherFactor = 0.9; // 10%åŠ é€Ÿ
                break;
            case 'å¤§é›¨':
                weatherFactor = 0.85; // 15%åŠ é€Ÿ
                break;
            case 'é›ª':
                weatherFactor = 1.2; // 20%å‡é€Ÿ
                break;
            case 'é›¾':
                weatherFactor = 1.1; // 10%å‡é€Ÿ
                break;
        }
        growTime = Math.floor(growTime * weatherFactor);
    }

    //è‡ªå·±æµ‡æ°´ç”¨è‡ªå·±çš„æ°´å£¶ç­‰çº§
    if (plot.plant.selfWatered) {
        var boostPercent = waterBoostLevel > 0 ? (0.05 + waterBoostLevel * 0.05) : 0.1;
        growTime = Math.floor(growTime * (1 - boostPercent));
    }

    //å¥½å‹æµ‡æ°´ï¼šæ¯ä¸ªå¥½å‹çš„æµ‡æ°´éƒ½ç‹¬ç«‹å‡å°‘æ—¶é—´
    if (plot.plant.friendWaters && plot.plant.friendWaters.length > 0) {
        var totalFriendReduce = 0;
        for (var i = 0; i < plot.plant.friendWaters.length; i++) {
            totalFriendReduce += plot.plant.friendWaters[i].reduce || 0;
        }
        growTime = Math.max(growTime - totalFriendReduce, 60000);
    }

    if (plot.plant.fertilizerReduce && plot.plant.fertilizerReduce > 0) {
        growTime = Math.max(growTime - plot.plant.fertilizerReduce, 60000);
    }

    plot.plant.effectiveGrowTime = growTime;
    plot.plant.progress = Math.max(0, Math.min(1, elapsed / growTime));
    if (plot.plant.progress >= 1) {
        plot.plant.mature = true;
    }
}
function checkAllPlots(playerData, weather) {
    if (!playerData.plots) return;
    for (var i = 0; i < playerData.plots.length; i++) {
        calcPlotProgress(playerData.plots[i], playerData.waterBoostLevel || 0, weather);
    }
}
// ============================================================
//  å…»æ®–æ ¸å¿ƒï¼šæœåŠ¡å™¨ç«¯è®¡ç®—è¿›åº¦
// ============================================================
function calcCageStatus(cage) {
    if (!cage.animal) return;
    var now = Date.now();
    var hoursPassed = (now - cage.animal.lastUpdate) / 3600000;
    if (hoursPassed < 1) return;

    var hoursToProcess = Math.floor(hoursPassed);
    cage.animal.lastUpdate = now;

    // é€å°æ—¶æ¨¡æ‹Ÿ
    for (var h = 0; h < hoursToProcess; h++) {
        // å…ˆæ‰£é£Ÿç‰©
        var foodNeeded = cage.animal.foodPerHour * cage.animal.count;
        cage.animal.food -= foodNeeded;

        // é£Ÿç‰©ä¸è¶³ï¼Œæ­»äº¡
        if (cage.animal.food < 0) {
            var deaths = Math.ceil(cage.animal.count * 0.15);
            cage.animal.count = Math.max(0, cage.animal.count - deaths);
            cage.animal.food = 0;
            if (cage.animal.count === 0) {
                cage.animal = null;
                return;
            }
            continue; // é¥¥é¥¿æ—¶ä¸ç¹æ®–
        }

        // é£Ÿç‰©å……è¶³æ‰åˆ¤æ–­ç¹æ®–
        var breedElapsed = (cage.animal.lastUpdate - cage.animal.lastBreed)
            - (hoursToProcess - h - 1) * 3600000;
        if (cage.animal.count >= 2 && breedElapsed >= cage.animal.breedTime) {
            cage.animal.count = Math.min(1024, cage.animal.count * 2);
            cage.animal.lastBreed = now - (hoursToProcess - h - 1) * 3600000;
        }
    }
}

function checkAllCages(playerData) {
    if (!playerData.cages) return;
    for (var i = 0; i < playerData.cages.length; i++) {
        calcCageStatus(playerData.cages[i]);
    }
}

// ============================================================
//  æ’è¡Œæ¦œé€šç”¨å‡½æ•°ï¼ˆæ›¿æ¢åŸæ¥åˆ†æ•£çš„æ’è¡Œæ¦œé€»è¾‘ï¼‰
// ============================================================
function getWorldRanking(worldId) {
    var cacheKey = 'money_' + worldId;
    var now = Date.now();
    if (_rankingCache[cacheKey] && now - _rankingCache[cacheKey].time < RANKING_CACHE_TTL) {
        return _rankingCache[cacheKey].data;
    }
    var ranking = [];
    try {
        var files = fs.readdirSync(PLAYERS_DIR);
        var suffix = '_' + worldId + '.json';
        for (var i = 0; i < files.length; i++) {
            if (!files[i].endsWith(suffix)) continue;
            var pd = readJSON(path.join(PLAYERS_DIR, files[i]), null);
            if (pd) {
                ranking.push({
                    username: pd.username, farmId: pd.farmId,
                    money: pd.money || 0, totalHarvest: pd.totalHarvest || 0,
                    totalGather: pd.totalGather || 0,
                    plotCount: (pd.plots || []).filter(function (pl) { return pl.plant; }).length,
                    maxPlots: (pd.plots || []).length
                });
            }
        }
    } catch (e) { console.error('[æ’è¡Œæ¦œ]', e.message); }
    ranking.sort(function (a, b) { return b.money - a.money; });
    _rankingCache[cacheKey] = { data: ranking, time: now };
    return ranking;
}

function getPetRanking(worldId) {
    var cacheKey = 'pet_' + worldId;
    var now = Date.now();
    if (_rankingCache[cacheKey] && now - _rankingCache[cacheKey].time < RANKING_CACHE_TTL) {
        return _rankingCache[cacheKey].data;
    }
    var ranking = [];
    try {
        var files = fs.readdirSync(PLAYERS_DIR);
        var suffix = '_' + worldId + '.json';
        for (var i = 0; i < files.length; i++) {
            if (!files[i].endsWith(suffix)) continue;
            var pd = readJSON(path.join(PLAYERS_DIR, files[i]), null);
            if (pd && pd.pets && pd.pets.length > 0) {
                for (var j = 0; j < pd.pets.length; j++) {
                    var pet = pd.pets[j];
                    ranking.push({
                        owner: pd.username, farmId: pd.farmId,
                        petName: pet.name || pet.species, species: pet.species,
                        speciesIcon: pet.speciesIcon || 'ğŸ¾', rarity: pet.rarity || 'common',
                        value: pet.value || 0, mood: pet.mood || 0,
                        totalAdventures: pet.totalAdventures || 0, petId: pet.id
                    });
                }
            }
        }
    } catch (e) { console.error('[å® ç‰©æ’è¡Œæ¦œ]', e.message); }
    ranking.sort(function (a, b) { return b.value - a.value; });
    ranking = ranking.slice(0, 50);
    _rankingCache[cacheKey] = { data: ranking, time: now };
    return ranking;
}

// ============================================================
//  èŠ‚æ—¥æ´»åŠ¨ç³»ç»Ÿ
// ============================================================
var holidayEvents = {}; // { worldId: [events] }

function getHolidayEvents(worldId) {
    if (!holidayEvents[worldId]) holidayEvents[worldId] = [];
    return holidayEvents[worldId];
}

// ============================================================
//  è¡Œä¸ºå¤„ç†å™¨
// ============================================================
var actions = {};

actions['chat'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var text = (payload.text || '').substring(0, 500);

    // è·å–ç©å®¶æ•°æ®
    var playerData = getOrCreatePlayer(username, p.worldId);
    var titleInfo = null;

    // å¦‚æœç©å®¶æœ‰æ¿€æ´»çš„ç§°å·ï¼Œä»ä¸–ç•Œæ•°æ®ä¸­è·å–è¯¦æƒ…
    if (playerData.activeTitleId) {
        var worldData = loadWorldData(p.worldId);
        if (worldData && worldData.worldTitles && worldData.worldTitles[playerData.activeTitleId]) {
            titleInfo = {
                titleId: playerData.activeTitleId,
                ...worldData.worldTitles[playerData.activeTitleId]
            };
        }
    }

    var msg = {
        type: 'chat',
        from: username,
        text: payload.text,
        channel: payload.channel || 'world',
        timestamp: Date.now(),
        title: titleInfo  // æ·»åŠ ç§°å·ä¿¡æ¯
    };

    if (payload.channel === 'world') {
        broadcastToWorld(p.worldId, msg, username);
    } else if (payload.channel === 'farm') {
        var farmOwner = p.visitingFarm || username;
        for (var u in onlinePlayers) {
            var op = onlinePlayers[u];
            if (op.worldId === p.worldId && (op.visitingFarm === farmOwner || u === farmOwner) && u !== username) {
                safeSend(op.ws, msg);
            }
        }
    }

    broadcastToTiandao({ type: 'td_chat', worldId: p.worldId, data: msg });
    triggerDailyTaskCheck(username, p.worldId, 'chat', null, 1);
};

actions['private_msg'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var target = payload.to;
    var tp = onlinePlayers[target];
    if (!tp) { safeSend(p.ws, { type: 'action_result', action: 'private_msg', ok: false, msg: 'å¯¹æ–¹ä¸åœ¨çº¿' }); return; }
    safeSend(tp.ws, { type: 'private_msg', from: username, text: payload.text, timestamp: Date.now() });
    safeSend(p.ws, { type: 'action_result', action: 'private_msg', ok: true, msg: 'å·²å‘é€' });
    broadcastToTiandao({ type: 'td_private_msg', worldId: p.worldId, from: username, to: target });
};

actions['group_msg'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var groups = loadGroups();
    var g = groups[payload.groupId];
    if (!g || !g.members.includes(username)) { safeSend(p.ws, { type: 'action_result', action: 'group_msg', ok: false, msg: 'ä½ ä¸åœ¨è¿™ä¸ªç¾¤é‡Œ' }); return; }
    var msg = { type: 'group_msg', groupId: g.id, groupName: g.name, from: username, text: payload.text, timestamp: Date.now() };
    g.members.forEach(function (m) { if (m !== username && onlinePlayers[m]) safeSend(onlinePlayers[m].ws, msg); });
};

actions['create_group'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var name = (payload.name || '').trim();
    if (!name || name.length > 20) { safeSend(p.ws, { type: 'action_result', action: 'create_group', ok: false, msg: 'ç¾¤å1-20å­—' }); return; }
    var groups = loadGroups();
    var id = genGroupId();
    groups[id] = { id: id, name: name, owner: username, members: [username], createdAt: Date.now() };
    saveGroups(groups);
    safeSend(p.ws, { type: 'action_result', action: 'create_group', ok: true, group: groups[id] });
};

actions['invite_group'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var groups = loadGroups();
    var g = groups[payload.groupId];
    if (!g || !g.members.includes(username)) { safeSend(p.ws, { type: 'action_result', action: 'invite_group', ok: false, msg: 'ç¾¤ä¸å­˜åœ¨æˆ–ä½ ä¸åœ¨ç¾¤é‡Œ' }); return; }
    var target = payload.target;
    if (g.members.includes(target)) { safeSend(p.ws, { type: 'action_result', action: 'invite_group', ok: false, msg: 'å¯¹æ–¹å·²åœ¨ç¾¤é‡Œ' }); return; }
    var accounts = loadAccounts();
    if (!accounts[target]) { safeSend(p.ws, { type: 'action_result', action: 'invite_group', ok: false, msg: 'ç”¨æˆ·ä¸å­˜åœ¨' }); return; }
    g.members.push(target);
    saveGroups(groups);
    safeSend(p.ws, { type: 'action_result', action: 'invite_group', ok: true, msg: target + ' å·²åŠ å…¥ç¾¤èŠ' });
    if (onlinePlayers[target]) { safeSend(onlinePlayers[target].ws, { type: 'group_invite', group: g, inviter: username }); }
};

actions['leave_group'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var groups = loadGroups();
    var g = groups[payload.groupId];
    if (!g) return;
    g.members = g.members.filter(function (m) { return m !== username; });
    if (g.members.length === 0) { delete groups[payload.groupId]; }
    else if (g.owner === username) { g.owner = g.members[0]; }
    saveGroups(groups);
    safeSend(p.ws, { type: 'action_result', action: 'leave_group', ok: true, msg: 'å·²é€€å‡ºç¾¤èŠ' });
};

actions['list_groups'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var groups = loadGroups();
    var myGroups = [];
    for (var gid in groups) { if (groups[gid].members.includes(username)) myGroups.push(groups[gid]); }
    safeSend(p.ws, { type: 'action_result', action: 'list_groups', ok: true, groups: myGroups });
};

actions['friend_request'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var target = payload.target;
    if (target === username) { safeSend(p.ws, { type: 'action_result', action: 'friend_request', ok: false, msg: 'ä¸èƒ½åŠ è‡ªå·±' }); return; }
    var accounts = loadAccounts();
    if (!accounts[target]) { safeSend(p.ws, { type: 'action_result', action: 'friend_request', ok: false, msg: 'ç”¨æˆ·ä¸å­˜åœ¨' }); return; }
    var myFd = getFriendData(username);
    if (myFd.friends.includes(target)) { safeSend(p.ws, { type: 'action_result', action: 'friend_request', ok: false, msg: 'å·²ç»æ˜¯å¥½å‹äº†' }); return; }
    var targetFd = getFriendData(target);
    if (targetFd.requests.includes(username)) { safeSend(p.ws, { type: 'action_result', action: 'friend_request', ok: false, msg: 'å·²å‘é€è¿‡è¯·æ±‚' }); return; }
    targetFd.requests.push(username);
    saveFriendData(target, targetFd);
    safeSend(p.ws, { type: 'action_result', action: 'friend_request', ok: true, msg: 'å¥½å‹è¯·æ±‚å·²å‘é€' });
    if (onlinePlayers[target]) { safeSend(onlinePlayers[target].ws, { type: 'friend_request_received', from: username }); }
};

actions['friend_accept'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var from = payload.from;
    var myFd = getFriendData(username);
    if (!myFd.requests.includes(from)) { safeSend(p.ws, { type: 'action_result', action: 'friend_accept', ok: false, msg: 'æ²¡æœ‰è¯¥è¯·æ±‚' }); return; }
    myFd.requests = myFd.requests.filter(function (r) { return r !== from; });
    if (!myFd.friends.includes(from)) myFd.friends.push(from);
    saveFriendData(username, myFd);
    var fromFd = getFriendData(from);
    if (!fromFd.friends.includes(username)) fromFd.friends.push(username);
    fromFd.requests = fromFd.requests.filter(function (r) { return r !== username; });
    saveFriendData(from, fromFd);
    safeSend(p.ws, { type: 'action_result', action: 'friend_accept', ok: true, msg: 'å·²æ·»åŠ å¥½å‹ ' + from });
    broadcastToTiandao({ type: 'td_friend', action: 'accept', from: from, to: username });
    if (onlinePlayers[from]) { safeSend(onlinePlayers[from].ws, { type: 'friend_accepted', by: username }); }
};

actions['friend_reject'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var myFd = getFriendData(username);
    myFd.requests = myFd.requests.filter(function (r) { return r !== payload.from; });
    saveFriendData(username, myFd);
    safeSend(p.ws, { type: 'action_result', action: 'friend_reject', ok: true, msg: 'å·²æ‹’ç»' });
};

actions['friend_remove'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var target = payload.target;
    var myFd = getFriendData(username);
    myFd.friends = myFd.friends.filter(function (f) { return f !== target; });
    saveFriendData(username, myFd);
    var targetFd = getFriendData(target);
    targetFd.friends = targetFd.friends.filter(function (f) { return f !== username; });
    saveFriendData(target, targetFd);
    safeSend(p.ws, { type: 'action_result', action: 'friend_remove', ok: true, msg: 'å·²åˆ é™¤å¥½å‹' });
    broadcastToTiandao({ type: 'td_friend', action: 'remove', from: username, target: target });
};

actions['friend_list'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var myFd = getFriendData(username);
    var accounts = loadAccounts();
    var friendList = myFd.friends.map(function (f) {
        var friendship = myFd.friendship[f] || 0;
        var levelInfo = getFriendshipLevel(friendship);
        return {
            username: f,
            farmId: accounts[f] ? accounts[f].farmId : '???',
            online: !!onlinePlayers[f],
            friendship: friendship,
            level: levelInfo.level,
            levelName: levelInfo.name
        };
    });
    safeSend(p.ws, { type: 'action_result', action: 'friend_list', ok: true, friends: friendList, requests: myFd.requests });
};

actions['visit_farm'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var targetFarmId = (payload.farmId || '').trim().toUpperCase();
    if (!targetFarmId) { safeSend(p.ws, { type: 'action_result', action: 'visit_farm', ok: false, msg: 'è¯·è¾“å…¥é¢†åœ°ID' }); return; }
    var accounts = loadAccounts();
    var owner = null;
    for (var u in accounts) { if (accounts[u].farmId === targetFarmId) { owner = u; break; } }
    if (!owner) { safeSend(p.ws, { type: 'action_result', action: 'visit_farm', ok: false, msg: 'é¢†åœ°ä¸å­˜åœ¨' }); return; }
    if (owner === username) { safeSend(p.ws, { type: 'action_result', action: 'visit_farm', ok: false, msg: 'è¿™æ˜¯ä½ è‡ªå·±çš„å†œåœº' }); return; }

    // æ£€æŸ¥ç›®æ ‡ç©å®¶åœ¨å½“å‰ä¸–ç•Œæ˜¯å¦æœ‰å­˜æ¡£ï¼Œé˜²æ­¢è·¨ç•Œä¸²é—¨
    var ownerData = loadPlayer(owner, p.worldId);
    if (!ownerData) {
        safeSend(p.ws, { type: 'action_result', action: 'visit_farm', ok: false, msg: 'è¯¥ç©å®¶ä¸åœ¨è¿™ä¸ªä¸–ç•Œä¸­' });
        return;
    }

    // å¦‚æœå·²ç»åœ¨è¿™ä¸ªå†œåœºäº†ï¼ˆåˆ·æ–°ï¼‰ï¼Œä¸è¦é‡å¤å‘é€è¿›å…¥/ç¦»å¼€æ¶ˆæ¯
    var isRefresh = (p.visitingFarm === owner);

    // å…ˆå¤„ç†ç¦»å¼€æ—§å†œåœºï¼ˆä»…å½“åˆ‡æ¢åˆ°ä¸åŒå†œåœºæ—¶ï¼‰
    if (p.visitingFarm && !isRefresh) {
        var oldVisit = p.visitingFarm;
        for (var ou in onlinePlayers) {
            var op = onlinePlayers[ou];
            if (op.worldId === p.worldId && (op.visitingFarm === oldVisit || ou === oldVisit) && ou !== username) {
                safeSend(op.ws, { type: 'visitor_leave', username: username });
            }
        }
    }

    checkAllPlots(ownerData);
    p.visitingFarm = owner;
    var visitors = [];
    for (var ou in onlinePlayers) {
        if (onlinePlayers[ou].worldId === p.worldId && (onlinePlayers[ou].visitingFarm === owner || ou === owner) && ou !== username) {
            visitors.push(ou);
        }
    }
    safeSend(p.ws, {
        type: 'action_result', action: 'visit_farm', ok: true,
        owner: owner, farmId: targetFarmId,
        plots: ownerData.plots.map(function (pl) {
            if (!pl.plant) return { id: pl.id, plant: null };
            return {
                id: pl.id, plant: {
                    name: pl.plant.name, icon: pl.plant.icon, fruitIcon: pl.plant.fruitIcon || 'ğŸ',
                    progress: pl.plant.progress, mature: pl.plant.mature,
                    selfWatered: pl.plant.selfWatered || pl.plant.watered || false,
                    friendWaters: pl.plant.friendWaters || []
                }
            };
        }),
        cages: ownerData.cages.map(function (cage) {
            if (!cage.animal) return { id: cage.id, animal: null };
            return {
                id: cage.id, animal: {
                    name: cage.animal.name, icon: cage.animal.icon,
                    count: cage.animal.count, food: cage.animal.food,
                    foodPerHour: cage.animal.foodPerHour, sellPrice: cage.animal.sellPrice
                }
            };
        }),
        visitors: visitors
    });
    // åªåœ¨é¦–æ¬¡è¿›å…¥æ—¶å¹¿æ’­ï¼Œåˆ·æ–°æ—¶ä¸å¹¿æ’­
    if (!isRefresh) {
        for (var vu in onlinePlayers) {
            var vp = onlinePlayers[vu];
            if (vp.worldId === p.worldId && (vp.visitingFarm === owner || vu === owner) && vu !== username) {
                safeSend(vp.ws, { type: 'visitor_enter', username: username });
            }
        }
        broadcastToTiandao({ type: 'td_visit', worldId: p.worldId, username: username, target: owner, farmId: targetFarmId });
        //æ¯æ—¥ä»»åŠ¡æ£€æŸ¥
        triggerDailyTaskCheck(username, p.worldId, 'visit', null, 1);
    }
};

actions['go_home'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var oldVisit = p.visitingFarm;
    p.visitingFarm = null;
    safeSend(p.ws, { type: 'action_result', action: 'go_home', ok: true });
    if (oldVisit) {
        for (var u in onlinePlayers) {
            var op = onlinePlayers[u];
            if (op.worldId === p.worldId && (op.visitingFarm === oldVisit || u === oldVisit) && u !== username) {
                safeSend(op.ws, { type: 'visitor_leave', username: username });
            }
        }
    }
};

actions['gather'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var worldData = loadWorldData(p.worldId);
    if (!worldData || !worldData.wildAreas || worldData.wildAreas.length === 0) {
        safeSend(p.ws, { type: 'action_result', action: 'gather', ok: false, msg: 'è¿™ä¸ªä¸–ç•Œæ²¡æœ‰é‡å¤–åŒºåŸŸ' });
        return;
    }
    var staminaCost = 25;
    if (playerData.stamina < staminaCost) {
        safeSend(p.ws, { type: 'action_result', action: 'gather', ok: false, msg: 'ä½“åŠ›ä¸è¶³ï¼ˆéœ€è¦' + staminaCost + 'ï¼Œå½“å‰' + playerData.stamina + 'ï¼‰ï¼Œä¼‘æ¯æˆ–ç­‰å¾…æ¢å¤' });
        return;
    }
    playerData.stamina -= staminaCost;
    var areaIdx = payload.areaIndex || 0;
    if (areaIdx < 0 || areaIdx >= worldData.wildAreas.length) areaIdx = 0;
    var area = worldData.wildAreas[areaIdx];
    var roll = Math.random();
    var found = null;
    var msg = '';

    if (area.seeds && area.seeds.length > 0) {
        for (var i = 0; i < area.seeds.length; i++) {
            var s = area.seeds[i];
            if (roll < (s.dropRate || 0.15)) { found = s; break; }
            roll -= (s.dropRate || 0.15);
        }
    }

    //æ£€æŸ¥èŠ‚æ—¥æ´»åŠ¨æ•ˆæœ
    var now = Date.now();
    var activeEvents = [];
    if (worldData && worldData.events) {
        for (var ei = 0; ei < worldData.events.length; ei++) {
            var ev = worldData.events[ei];
            if (ev.startTime && now < ev.startTime) continue;
            if (ev.endTime && now > ev.endTime) continue;
            activeEvents.push(ev);
        }
    }

    if (found) {
        var existing = playerData.seeds.find(function (sd) { return sd.id === found.id; });
        if (existing) { existing.count += 1; }
        else {
            playerData.seeds.push({
                id: found.id, name: found.name, icon: found.icon || 'ğŸŒ±',
                count: 1, growTime: found.growTime || 7200000,
                fruitId: found.fruitId, fruitName: found.fruitName,
                fruitIcon: found.fruitIcon || 'ğŸ', fruitValue: found.fruitValue || 10,
                fruitDesc: found.fruitDesc || '',
                source: 'gather'
            });
        }

        //èŠ‚æ—¥åŒå€é‡‡é›†
        for (var evIdx = 0; evIdx < activeEvents.length; evIdx++) {
            var ev = activeEvents[evIdx];
            if (ev.doubleGather) {
                // å†ç»™ä¸€ä¸ª
                var existing2 = playerData.seeds.find(function (sd) { return sd.id === found.id; });
                if (existing2) { existing2.count += 1; }
                else {
                    playerData.seeds.push({
                        id: found.id, name: found.name, icon: found.icon || 'ğŸŒ±',
                        count: 1, growTime: found.growTime || 7200000,
                        fruitId: found.fruitId, fruitName: found.fruitName,
                        fruitIcon: found.fruitIcon || 'ğŸ', fruitValue: found.fruitValue || 10,
                        fruitDesc: found.fruitDesc || '',
                        source: 'gather'
                    });
                }
                msg = 'ï¼ˆèŠ‚æ—¥åŒå€ï¼ï¼‰';
                break;
            }
        }

        //èŠ‚æ—¥ç‰¹æ®Šæ‰è½
        var specialDrops = [];
        for (var evIdx = 0; evIdx < activeEvents.length; evIdx++) {
            var ev = activeEvents[evIdx];
            if (ev.specialDrops && ev.specialDrops.length > 0) {
                for (var sdi = 0; sdi < ev.specialDrops.length; sdi++) {
                    var drop = ev.specialDrops[sdi];
                    if (Math.random() < (drop.chance / 100)) {
                        specialDrops.push(drop);
                    }
                }
            }
        }

        var specialMsg = '';
        for (var sdi = 0; sdi < specialDrops.length; sdi++) {
            var drop = specialDrops[sdi];
            if (drop.type === 'money') {
                var amount = drop.amount || 10;
                playerData.money += amount;
                specialMsg += ' +ğŸ’°' + amount;
            } else if (drop.type === 'seed' && drop.data) {
                var existingSeed = playerData.seeds.find(function (s) { return s.id === drop.data.id; });
                if (existingSeed) {
                    existingSeed.count += (drop.data.count || 1);
                } else {
                    playerData.seeds.push(JSON.parse(JSON.stringify(drop.data)));
                }
                specialMsg += ' +' + (drop.data.icon || 'ğŸŒ±') + drop.data.name;
            } else if (drop.type === 'fruit' && drop.data) {
                var existingFruit = playerData.fruits.find(function (f) { return f.id === drop.data.id; });
                if (existingFruit) {
                    existingFruit.count += (drop.data.count || 1);
                } else {
                    playerData.fruits.push(JSON.parse(JSON.stringify(drop.data)));
                }
                specialMsg += ' +' + (drop.data.icon || 'ğŸ') + drop.data.name;
            }
        }

        playerData.totalGather++;
        savePlayer(username, p.worldId, playerData);
        triggerDailyTaskCheck(username, p.worldId, 'gather', null, 1);
        triggerDailyTaskCheck(username, p.worldId, 'earn_money', null, found.fruitValue || 5);
        updateWeeklyChallengeProgress(username, p.worldId, 'gather', 1);

        //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹
        var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'gather', null, 1);

        safeSend(p.ws, {
            type: 'action_result', action: 'gather', ok: true,
            msg: 'åœ¨' + area.name + 'æ‰¾åˆ°äº† ' + found.name + 'ï¼' + msg + specialMsg,
            stamina: playerData.stamina, seeds: playerData.seeds, money: playerData.money
        });
    } else {
        var consolation = Math.random() < 0.4;
        if (consolation && area.junkItems && area.junkItems.length > 0) {
            var junk = area.junkItems[Math.floor(Math.random() * area.junkItems.length)];
            var ej = playerData.fruits.find(function (f) { return f.id === junk.id; });
            if (ej) { ej.count += 1; }
            else { playerData.fruits.push({ id: junk.id, name: junk.name, icon: junk.icon || 'ğŸ‚', count: 1, value: junk.value || 2 }); }
            savePlayer(username, p.worldId, playerData);

            //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹ï¼ˆå³ä½¿æ²¡æ‰¾åˆ°ä¹Ÿç®—ä¸€æ¬¡é‡‡é›†å°è¯•ï¼‰
            var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'gather', null, 1);

            safeSend(p.ws, {
                type: 'action_result', action: 'gather', ok: true,
                msg: 'åœ¨' + area.name + 'ç¿»æ‰¾äº†åŠå¤©ï¼Œåªæ‰¾åˆ°äº† ' + junk.name,
                stamina: playerData.stamina, fruits: playerData.fruits
            });
        } else {
            savePlayer(username, p.worldId, playerData);
            triggerDailyTaskCheck(username, p.worldId, 'gather', null, 1);

            //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹ï¼ˆå³ä½¿æ²¡æ‰¾åˆ°ä¹Ÿç®—ä¸€æ¬¡é‡‡é›†å°è¯•ï¼‰
            var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'gather', null, 1);

            safeSend(p.ws, {
                type: 'action_result', action: 'gather', ok: true,
                msg: 'åœ¨' + area.name + 'ä»”ç»†æœå¯»äº†ä¸€ç•ªï¼Œä»€ä¹ˆä¹Ÿæ²¡æ‰¾åˆ°...',
                stamina: playerData.stamina
            });
        }
    }

    //å‘é€èŠ‚æ—¥ä»»åŠ¡å®Œæˆé€šçŸ¥
    if (holidayCompleted && holidayCompleted.length > 0) {
        for (var hc = 0; hc < holidayCompleted.length; hc++) {
            var htask = holidayCompleted[hc];
            safeSend(p.ws, {
                type: 'holiday_task_complete',
                eventName: htask.eventName,
                taskDesc: htask.taskDesc,
                titleName: htask.titleName,
                titleColor: htask.titleColor
            });
        }
    }

    // å¥‡é‡ç³»ç»Ÿ - é‡‡é›†è§¦å‘
    if (Math.random() < (worldData.adventureRate || 0.1)) {
        var adventure = triggerAdventure(username, p.worldId, playerData, 'gather');
        if (adventure) {
            safeSend(p.ws, {
                type: 'adventure_result',
                adventure: adventure
            });
        }
    }
    broadcastToTiandao({ type: 'td_gather', worldId: p.worldId, username: username, found: found ? found.name : null });
};

actions['rest'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var now = Date.now();
    if (playerData.restCooldown && now < playerData.restCooldown) {
        var remain = Math.ceil((playerData.restCooldown - now) / 1000);
        var min = Math.floor(remain / 60);
        var sec = remain % 60;
        safeSend(p.ws, { type: 'action_result', action: 'rest', ok: false, msg: 'è¿˜éœ€è¦ ' + min + 'åˆ†' + sec + 'ç§’ æ‰èƒ½å†æ¬¡ä¼‘æ¯', restCooldown: playerData.restCooldown });
        return;
    }
    var recover = 35;
    playerData.stamina = Math.min(playerData.stamina + recover, playerData.staminaMax);
    playerData.restCooldown = now + 10 * 60 * 1000;
    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'rest', null, 1);
    safeSend(p.ws, {
        type: 'action_result', action: 'rest', ok: true,
        msg: 'ä½ ååœ¨æ ‘è«ä¸‹ä¼‘æ¯äº†ä¸€ä¼šå„¿ï¼Œæ¢å¤äº†' + recover + 'ç‚¹ä½“åŠ›',
        stamina: playerData.stamina, restCooldown: playerData.restCooldown
    });
    broadcastToTiandao({ type: 'td_rest', worldId: p.worldId, username: username });
};

actions['plant'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    if (p.visitingFarm) { safeSend(p.ws, { type: 'action_result', action: 'plant', ok: false, msg: 'ä¸èƒ½åœ¨åˆ«äººçš„å†œåœºç§æ¤' }); return; }
    var playerData = getOrCreatePlayer(username, p.worldId);
    var plotId = payload.plotId;
    var seedId = payload.seedId;
    if (plotId === undefined || plotId < 0 || plotId >= playerData.plots.length) {
        safeSend(p.ws, { type: 'action_result', action: 'plant', ok: false, msg: 'æ— æ•ˆçš„åœ°å—' }); return;
    }
    var plot = playerData.plots[plotId];
    if (plot.plant) { safeSend(p.ws, { type: 'action_result', action: 'plant', ok: false, msg: 'è¿™å—åœ°å·²ç»ç§äº†ä¸œè¥¿' }); return; }
    var seedIdx = playerData.seeds.findIndex(function (s) { return s.id === seedId; });
    if (seedIdx === -1) { safeSend(p.ws, { type: 'action_result', action: 'plant', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§ç§å­' }); return; }
    var seed = playerData.seeds[seedIdx];
    plot.plant = {
        seedId: seed.id, name: seed.name, icon: seed.icon,
        plantedAt: Date.now(), growTime: seed.growTime,
        fruitId: seed.fruitId, fruitName: seed.fruitName,
        fruitIcon: seed.fruitIcon, fruitValue: seed.fruitValue,
        progress: 0, mature: false,
        selfWatered: false,
        friendWaters: [],
        fertilizerReduce: 0,
        effectiveGrowTime: seed.growTime
    };
    seed.count -= 1;
    if (seed.count <= 0) playerData.seeds.splice(seedIdx, 1);
    checkAllPlots(playerData);
    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'plant', seedId, 1);
    //å‘¨æŒ‘æˆ˜è¿›åº¦
    updateWeeklyChallengeProgress(username, p.worldId, 'plant', 1);

    //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹
    var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'plant', seedId, 1);

    //å‘é€èŠ‚æ—¥ä»»åŠ¡å®Œæˆé€šçŸ¥
    if (holidayCompleted && holidayCompleted.length > 0) {
        for (var hc = 0; hc < holidayCompleted.length; hc++) {
            var htask = holidayCompleted[hc];
            safeSend(p.ws, {
                type: 'holiday_task_complete',
                eventName: htask.eventName,
                taskDesc: htask.taskDesc,
                titleName: htask.titleName,
                titleColor: htask.titleColor
            });
        }
    }

    safeSend(p.ws, {
        type: 'action_result', action: 'plant', ok: true,
        msg: 'åœ¨ç¬¬' + (plotId + 1) + 'å—åœ°ç§ä¸‹äº† ' + seed.name,
        plots: playerData.plots, seeds: playerData.seeds
    });
    broadcastToTiandao({ type: 'td_plant', worldId: p.worldId, username: username, seedName: seed.name, plotId: plotId });
};

actions['water'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var isVisiting = !!p.visitingFarm;
    var targetUsername = isVisiting ? p.visitingFarm : username;
    var playerData = getOrCreatePlayer(targetUsername, p.worldId);
    var plotId = payload.plotId;

    if (plotId === undefined || plotId < 0 || plotId >= playerData.plots.length) {
        safeSend(p.ws, { type: 'action_result', action: 'water', ok: false, msg: 'æ— æ•ˆçš„åœ°å—' }); return;
    }
    var plot = playerData.plots[plotId];
    if (!plot.plant) { safeSend(p.ws, { type: 'action_result', action: 'water', ok: false, msg: 'è¿™å—åœ°æ²¡æœ‰ä½œç‰©' }); return; }
    if (plot.plant.mature) { safeSend(p.ws, { type: 'action_result', action: 'water', ok: false, msg: 'ä½œç‰©å·²æˆç†Ÿï¼Œå¯ä»¥æ”¶è·äº†' }); return; }

    //å…¼å®¹æ—§æ•°æ®
    if (!plot.plant.friendWaters) plot.plant.friendWaters = [];
    if (plot.plant.watered !== undefined && plot.plant.selfWatered === undefined) {
        plot.plant.selfWatered = plot.plant.watered;
    }

    if (!isVisiting) {
        //è‡ªå·±ç»™è‡ªå·±æµ‡æ°´
        if (plot.plant.selfWatered) {
            safeSend(p.ws, { type: 'action_result', action: 'water', ok: false, msg: 'ä½ å·²ç»æµ‡è¿‡æ°´äº†' }); return;
        }
        plot.plant.selfWatered = true;

        var boostLevel = playerData.waterBoostLevel || 0;
        var boostText = 'ï¼ˆå‡å°‘' + (boostLevel > 0 ? (5 + boostLevel * 5) : 10) + '%ç”Ÿé•¿æ—¶é—´ï¼‰';

        checkAllPlots(playerData);
        savePlayer(targetUsername, p.worldId, playerData);
        triggerDailyTaskCheck(username, p.worldId, 'water_self', null, 1);

        //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹ï¼ˆæµ‡æ°´ä»»åŠ¡ï¼‰
        var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'water_self', null, 1);
        if (holidayCompleted && holidayCompleted.length > 0) {
            for (var hc = 0; hc < holidayCompleted.length; hc++) {
                var htask = holidayCompleted[hc];
                safeSend(p.ws, {
                    type: 'holiday_task_complete',
                    eventName: htask.eventName,
                    taskDesc: htask.taskDesc,
                    titleName: htask.titleName,
                    titleColor: htask.titleColor
                });
            }
        }

        safeSend(p.ws, {
            type: 'action_result', action: 'water', ok: true,
            msg: 'ç»™ç¬¬' + (plotId + 1) + 'å—åœ°çš„ ' + plot.plant.name + ' æµ‡äº†æ°´ ' + boostText,
            plots: playerData.plots
        });
        broadcastToTiandao({ type: 'td_water', worldId: p.worldId, username: username, target: targetUsername, plotId: plotId, isSelf: true });
    } else {
        //å¥½å‹ç»™ä½ æµ‡æ°´ï¼šæ£€æŸ¥è¿™ä¸ªå¥½å‹æ˜¯å¦å·²ç»æµ‡è¿‡
        var alreadyWatered = plot.plant.friendWaters.some(function (fw) { return fw.username === username; });
        if (alreadyWatered) {
            safeSend(p.ws, { type: 'action_result', action: 'water', ok: false, msg: 'ä½ å·²ç»ç»™è¿™å—åœ°æµ‡è¿‡æ°´äº†' }); return;
        }

        //è·å–æµ‡æ°´è€…çš„æ°´å£¶ç­‰çº§
        var watererData = getOrCreatePlayer(username, p.worldId);
        var watererBoostLevel = watererData.waterBoostLevel || 0;

        //æ ¹æ®æµ‡æ°´è€…çš„æ°´å£¶ç­‰çº§è®¡ç®—å‡å°‘çš„æ—¶é—´
        var baseGrowTime = plot.plant.growTime || 7200000;
        var reducePercent = 0.03 + (watererBoostLevel * 0.02); // lv0=3%, lv1=5%, lv2=7%...lv5=13%
        var actualReduce = Math.floor(baseGrowTime * reducePercent);

        plot.plant.friendWaters.push({
            username: username,
            reduce: actualReduce,
            waterBoostLevel: watererBoostLevel,
            timestamp: Date.now()
        });

        checkAllPlots(playerData);
        savePlayer(targetUsername, p.worldId, playerData);
        //å¢åŠ å¥½å‹äº²å¯†åº¦
        triggerDailyTaskCheck(username, p.worldId, 'water_friend', null, 1);
        increaseFriendship(username, targetUsername, 1);

        //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹ï¼ˆå¥½å‹æµ‡æ°´ä»»åŠ¡ï¼‰
        var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'water_friend', null, 1);
        if (holidayCompleted && holidayCompleted.length > 0) {
            for (var hc = 0; hc < holidayCompleted.length; hc++) {
                var htask = holidayCompleted[hc];
                safeSend(p.ws, {
                    type: 'holiday_task_complete',
                    eventName: htask.eventName,
                    taskDesc: htask.taskDesc,
                    titleName: htask.titleName,
                    titleColor: htask.titleColor
                });
            }
        }

        var reduceMin = Math.round(actualReduce / 60000);
        safeSend(p.ws, {
            type: 'action_result', action: 'water', ok: true,
            msg: 'ç»™' + targetUsername + 'çš„ç¬¬' + (plotId + 1) + 'å—åœ°çš„ ' + plot.plant.name + ' æµ‡äº†æ°´ï¼ˆå‡å°‘' + reduceMin + 'åˆ†é’Ÿï¼‰',
            plots: playerData.plots
        });
        broadcastToTiandao({ type: 'td_water', worldId: p.worldId, username: username, target: targetUsername, plotId: plotId, isSelf: false, reduceMin: reduceMin });

        // é€šçŸ¥å†œåœºä¸»
        if (onlinePlayers[targetUsername]) {
            safeSend(onlinePlayers[targetUsername].ws, {
                type: 'visitor_water', from: username, plotId: plotId, plantName: plot.plant.name
            });
        }
        // é€šçŸ¥å…¶ä»–è®¿å®¢
        for (var vu in onlinePlayers) {
            var vp = onlinePlayers[vu];
            if (vp.worldId === p.worldId && vp.visitingFarm === targetUsername && vu !== username) {
                safeSend(vp.ws, {
                    type: 'farm_plot_update', owner: targetUsername, plotId: plotId,
                    watered: true, plantName: plot.plant.name
                });
            }
        }
    }
};

actions['fertilize'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    if (p.visitingFarm) { safeSend(p.ws, { type: 'action_result', action: 'fertilize', ok: false, msg: 'ä¸èƒ½ç»™åˆ«äººçš„ä½œç‰©æ–½è‚¥' }); return; }
    var playerData = getOrCreatePlayer(username, p.worldId);
    var plotId = payload.plotId;
    var itemId = payload.itemId;
    if (plotId === undefined || plotId < 0 || plotId >= playerData.plots.length) {
        safeSend(p.ws, { type: 'action_result', action: 'fertilize', ok: false, msg: 'æ— æ•ˆçš„åœ°å—' }); return;
    }
    var plot = playerData.plots[plotId];
    if (!plot.plant) { safeSend(p.ws, { type: 'action_result', action: 'fertilize', ok: false, msg: 'è¿™å—åœ°æ²¡æœ‰ä½œç‰©' }); return; }
    if (plot.plant.mature) { safeSend(p.ws, { type: 'action_result', action: 'fertilize', ok: false, msg: 'ä½œç‰©å·²æˆç†Ÿ' }); return; }
    var itemIdx = playerData.items.findIndex(function (it) { return it.id === itemId && it.type === 'fertilizer'; });
    if (itemIdx === -1) { safeSend(p.ws, { type: 'action_result', action: 'fertilize', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§è‚¥æ–™' }); return; }
    var item = playerData.items[itemIdx];
    plot.plant.fertilizerReduce = (plot.plant.fertilizerReduce || 0) + (item.effect.growthReduce || 0);
    item.count -= 1;
    if (item.count <= 0) playerData.items.splice(itemIdx, 1);
    checkAllPlots(playerData);
    savePlayer(username, p.worldId, playerData);
    safeSend(p.ws, {
        type: 'action_result', action: 'fertilize', ok: true,
        msg: 'ç»™ç¬¬' + (plotId + 1) + 'å—åœ°æ–½äº† ' + item.name,
        plots: playerData.plots, items: playerData.items
    });
    broadcastToTiandao({ type: 'td_fertilize', worldId: p.worldId, username: username, plotId: plotId, itemName: item.name });

};

actions['harvest'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    if (p.visitingFarm) { safeSend(p.ws, { type: 'action_result', action: 'harvest', ok: false, msg: 'ä¸èƒ½æ”¶è·åˆ«äººçš„ä½œç‰©' }); return; }
    var playerData = getOrCreatePlayer(username, p.worldId);
    var worldData = loadWorldData(p.worldId);
    checkAllPlots(playerData);
    var plotId = payload.plotId;
    if (plotId === undefined || plotId < 0 || plotId >= playerData.plots.length) {
        safeSend(p.ws, { type: 'action_result', action: 'harvest', ok: false, msg: 'æ— æ•ˆçš„åœ°å—' }); return;
    }
    var plot = playerData.plots[plotId];
    if (!plot.plant) { safeSend(p.ws, { type: 'action_result', action: 'harvest', ok: false, msg: 'è¿™å—åœ°æ²¡æœ‰ä½œç‰©' }); return; }
    if (!plot.plant.mature) {
        var pct = Math.floor((plot.plant.progress || 0) * 100);
        safeSend(p.ws, { type: 'action_result', action: 'harvest', ok: false, msg: 'è¿˜æ²¡æˆç†Ÿå‘¢ï¼ˆ' + pct + '%ï¼‰' }); return;
    }

    //ä¿å­˜æ¤ç‰©ä¿¡æ¯ï¼Œå› ä¸ºåé¢è¦å°† plot.plant è®¾ä¸º null
    var plantInfo = {
        fruitId: plot.plant.fruitId,
        fruitName: plot.plant.fruitName,
        seedId: plot.plant.seedId
    };

    var fruitCount = 1 + Math.floor(Math.random() * 3);
    var msg = '';

    //æ£€æŸ¥èŠ‚æ—¥æ´»åŠ¨æ•ˆæœ
    var now = Date.now();
    var activeEvents = [];
    if (worldData && worldData.events) {
        for (var ei = 0; ei < worldData.events.length; ei++) {
            var ev = worldData.events[ei];
            if (ev.startTime && now < ev.startTime) continue;
            if (ev.endTime && now > ev.endTime) continue;
            activeEvents.push(ev);
        }
    }

    //èŠ‚æ—¥åŒå€æ”¶è·
    for (var evIdx = 0; evIdx < activeEvents.length; evIdx++) {
        var ev = activeEvents[evIdx];
        if (ev.doubleHarvest) {
            fruitCount *= 2;
            msg = 'ï¼ˆèŠ‚æ—¥åŒå€ï¼ï¼‰';
            break;
        }
    }

    var ef = playerData.fruits.find(function (f) { return f.id === plot.plant.fruitId; });
    if (ef) { ef.count += fruitCount; }
    else {
        playerData.fruits.push({
            id: plot.plant.fruitId, name: plot.plant.fruitName,
            icon: plot.plant.fruitIcon, count: fruitCount, value: plot.plant.fruitValue
        });
    }

    //èŠ‚æ—¥ç‰¹æ®Šæ‰è½
    var specialDrops = [];
    for (var evIdx = 0; evIdx < activeEvents.length; evIdx++) {
        var ev = activeEvents[evIdx];
        if (ev.specialDrops && ev.specialDrops.length > 0) {
            for (var sdi = 0; sdi < ev.specialDrops.length; sdi++) {
                var drop = ev.specialDrops[sdi];
                if (Math.random() < (drop.chance / 100)) {
                    specialDrops.push(drop);
                }
            }
        }
    }

    var specialMsg = '';
    for (var sdi = 0; sdi < specialDrops.length; sdi++) {
        var drop = specialDrops[sdi];
        if (drop.type === 'money') {
            var amount = drop.amount || 10;
            playerData.money += amount;
            specialMsg += ' +ğŸ’°' + amount;
        } else if (drop.type === 'seed' && drop.data) {
            var existingSeed = playerData.seeds.find(function (s) { return s.id === drop.data.id; });
            if (existingSeed) {
                existingSeed.count += (drop.data.count || 1);
            } else {
                playerData.seeds.push(JSON.parse(JSON.stringify(drop.data)));
            }
            specialMsg += ' +' + (drop.data.icon || 'ğŸŒ±') + drop.data.name;
        } else if (drop.type === 'fruit' && drop.data) {
            var existingFruit = playerData.fruits.find(function (f) { return f.id === drop.data.id; });
            if (existingFruit) {
                existingFruit.count += (drop.data.count || 1);
            } else {
                playerData.fruits.push(JSON.parse(JSON.stringify(drop.data)));
            }
            specialMsg += ' +' + (drop.data.icon || 'ğŸ') + drop.data.name;
        }
    }

    var gotSeed = Math.random() < 0.3;
    if (gotSeed) {
        var es = playerData.seeds.find(function (s) { return s.id === plot.plant.seedId; });
        if (es) {
            es.count += 1;
            if (!es.source) es.source = 'harvest';
        }
        else {
            var worldData = loadWorldData(p.worldId);
            var seedInfo = null;
            if (worldData && worldData.wildAreas) {
                worldData.wildAreas.forEach(function (area) {
                    if (area.seeds) {
                        var found = area.seeds.find(function (s) { return s.id === plot.plant.seedId; });
                        if (found) seedInfo = found;
                    }
                });
            }
            if (!seedInfo && worldData && worldData.shop && worldData.shop.items) {
                var shopSeed = worldData.shop.items.find(function (si) { return si.seedData && si.seedData.id === plot.plant.seedId; });
                if (shopSeed) seedInfo = shopSeed.seedData;
            }
            if (seedInfo) {
                playerData.seeds.push({
                    id: seedInfo.id, name: seedInfo.name, icon: seedInfo.icon || 'ğŸŒ±',
                    count: 1, growTime: seedInfo.growTime || 7200000,
                    fruitId: seedInfo.fruitId, fruitName: seedInfo.fruitName,
                    fruitIcon: seedInfo.fruitIcon || 'ğŸ', fruitValue: seedInfo.fruitValue || 10,
                    fruitDesc: seedInfo.fruitDesc || '',
                    source: 'harvest'
                });
            } else {
                playerData.seeds.push({
                    id: plot.plant.seedId, name: plot.plant.name, icon: plot.plant.icon || 'ğŸŒ±',
                    count: 1, growTime: plot.plant.growTime || 7200000,
                    fruitId: plot.plant.fruitId, fruitName: plot.plant.fruitName,
                    fruitIcon: plot.plant.fruitIcon || 'ğŸ', fruitValue: plot.plant.fruitValue || 10,
                    source: 'harvest'
                });
            }
        }
    }

    var fruitName = plot.plant.fruitName;

    //åœ¨æ¸…é™¤æ¤ç‰©ä¹‹å‰æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹ï¼ˆä½¿ç”¨ä¿å­˜çš„ plantInfoï¼‰
    var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'harvest', plantInfo.fruitId, fruitCount);

    // æ¸…é™¤åœ°å—
    plot.plant = null;

    playerData.totalHarvest += fruitCount;
    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'harvest', plantInfo.fruitId, fruitCount);
    triggerDailyTaskCheck(username, p.worldId, 'harvest_specific', plantInfo.fruitId, fruitCount);
    triggerDailyTaskCheck(username, p.worldId, 'earn_money', null, fruitCount * (plot.plant ? plot.plant.fruitValue : 0));
    updateWeeklyChallengeProgress(username, p.worldId, 'harvest', fruitCount);

    //å‘é€èŠ‚æ—¥ä»»åŠ¡å®Œæˆé€šçŸ¥
    if (holidayCompleted && holidayCompleted.length > 0) {
        for (var hc = 0; hc < holidayCompleted.length; hc++) {
            var htask = holidayCompleted[hc];
            safeSend(p.ws, {
                type: 'holiday_task_complete',
                eventName: htask.eventName,
                taskDesc: htask.taskDesc,
                titleName: htask.titleName,
                titleColor: htask.titleColor
            });
        }
    }

    safeSend(p.ws, {
        type: 'action_result', action: 'harvest', ok: true,
        msg: 'æ”¶è·äº† ' + fruitName + ' x' + fruitCount + 'ï¼' + msg + (gotSeed ? 'ï¼ˆè¿˜è·å¾—äº†ä¸€é¢—ç§å­ï¼‰' : '') + specialMsg,
        plots: playerData.plots, fruits: playerData.fruits, seeds: playerData.seeds, money: playerData.money
    });
    broadcastToTiandao({ type: 'td_harvest', worldId: p.worldId, username: username, fruitName: fruitName, fruitCount: fruitCount, gotSeed: gotSeed });
};

actions['cage_detail'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    var farmId = payload.farmId;
    var cageId = payload.cageId;

    if (!farmId || cageId === undefined) {
        safeSend(p.ws, { type: 'action_result', action: 'cage_detail', ok: false, msg: 'å‚æ•°é”™è¯¯' });
        return;
    }

    // æŸ¥æ‰¾å†œåœºä¸»
    var accounts = loadAccounts();
    var owner = null;
    for (var u in accounts) {
        if (accounts[u].farmId === farmId) {
            owner = u;
            break;
        }
    }

    if (!owner) {
        safeSend(p.ws, { type: 'action_result', action: 'cage_detail', ok: false, msg: 'å†œåœºä¸å­˜åœ¨' });
        return;
    }

    // è·å–å¯¹æ–¹æ•°æ®
    var targetData = getOrCreatePlayer(owner, p.worldId);
    if (!targetData || !targetData.cages || cageId >= targetData.cages.length) {
        safeSend(p.ws, { type: 'action_result', action: 'cage_detail', ok: false, msg: 'åœˆå…»åŒºæ•°æ®é”™è¯¯' });
        return;
    }

    var cage = targetData.cages[cageId];

    // æ„å»ºé¢æ¿HTML
    var h = '';

    if (!cage.animal) {
        h += '<div style="text-align:center;margin-bottom:10px;font-size:13px;color:#aaa;">ç¬¬' + (cageId + 1) + 'ä¸ªåœˆ Â· ç©ºåœˆ</div>';
        h += '<div style="text-align:center;color:#666;padding:20px;">è¿™ä¸ªåœˆæ˜¯ç©ºçš„</div>';
    } else {
        var a = cage.animal;
        var isStarving = a.food < 0;
        var foodStatus = a.food >= 0 ? Math.floor(a.food) : 0;

        h += '<div style="text-align:center;margin-bottom:12px;">';
        h += '<div style="font-size:36px;margin-bottom:6px;">' + (a.icon || 'ğŸ¾') + '</div>';
        h += '<div style="font-size:16px;color:#fcd34d;">' + esc(a.name) + '</div>';
        h += '<div style="font-size:12px;color:#888;margin-top:4px;">' + owner + ' çš„åœˆå…»åŒº</div>';
        h += '<div style="font-size:14px;color:#67e8f9;margin-top:6px;">æ•°é‡: ' + a.count + ' åª</div>';

        if (isStarving) {
            h += '<div style="font-size:13px;color:#ef4444;margin-top:6px;">âš ï¸ é£Ÿç‰©ä¸è¶³ï¼</div>';
        } else {
            h += '<div style="font-size:13px;color:#a5d6a7;margin-top:6px;">ğŸ– é£Ÿç‰©: ' + foodStatus + '</div>';
        }

        h += '<div style="font-size:11px;color:#888;margin-top:4px;">æ¶ˆè€—: ' + a.foodPerHour + '/å°æ—¶</div>';
        h += '</div>';

        // å–‚é£Ÿé€‰é¡¹ - ä¸²é—¨æ—¶åªèƒ½å–‚é£Ÿï¼Œä¸èƒ½å‡ºå”®
        h += '<div style="font-size:12px;color:#888;margin-bottom:4px;">ç»™å¥½å‹çš„åŠ¨ç‰©å–‚é£Ÿï¼š</div>';

        var myData = getOrCreatePlayer(username, p.worldId);
        var hasFood = false;

        if (myData.seeds && myData.seeds.length > 0) {
            hasFood = true;
            h += '<select id="feedSeedSelect" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px;font-size:12px;color:#e0e0e0;margin-bottom:4px;">';
            for (var si = 0; si < myData.seeds.length; si++) {
                var s = myData.seeds[si];
                h += '<option value="' + s.id + '">ğŸŒ± ' + esc(s.name) + ' (x' + s.count + ')</option>';
            }
            h += '</select>';
            h += '<div style="display:flex;gap:4px;margin-bottom:8px;">';
            h += '<input type="number" id="feedSeedCount" value="1" min="1" style="width:60px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px;font-size:12px;color:#e0e0e0;text-align:center;">';
            h += '<button style="flex:1;padding:8px;background:rgba(76,175,80,0.2);color:#a5d6a7;border:1px solid rgba(76,175,80,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doFeedFriendAnimal(\'' + farmId + '\',' + cageId + ',\'seed\')">ç”¨ç§å­å–‚é£Ÿ</button>';
            h += '</div>';
        }

        if (myData.fruits && myData.fruits.length > 0) {
            hasFood = true;
            h += '<select id="feedFruitSelect" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px;font-size:12px;color:#e0e0e0;margin-bottom:4px;">';
            for (var fi = 0; fi < myData.fruits.length; fi++) {
                var f = myData.fruits[fi];
                h += '<option value="' + f.id + '">ğŸ ' + esc(f.name) + ' (x' + f.count + ')</option>';
            }
            h += '</select>';
            h += '<div style="display:flex;gap:4px;margin-bottom:8px;">';
            h += '<input type="number" id="feedFruitCount" value="1" min="1" style="width:60px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px;font-size:12px;color:#e0e0e0;text-align:center;">';
            h += '<button style="flex:1;padding:8px;background:rgba(251,191,36,0.2);color:#fcd34d;border:1px solid rgba(251,191,36,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doFeedFriendAnimal(\'' + farmId + '\',' + cageId + ',\'fruit\')">ç”¨æœå®å–‚é£Ÿ</button>';
            h += '</div>';
        }

        if (!hasFood) {
            h += '<div style="font-size:11px;color:#666;text-align:center;padding:10px;">ä½ æ²¡æœ‰é£Ÿç‰©å¯ä»¥å–‚é£Ÿ</div>';
        }
    }

    safeSend(p.ws, {
        type: 'action_result',
        action: 'cage_detail',
        ok: true,
        html: h,
        farmId: farmId,
        cageId: cageId
    });
};

actions['catch_animal'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var worldData = loadWorldData(p.worldId);

    if (!worldData || !worldData.wildAreas || worldData.wildAreas.length === 0) {
        safeSend(p.ws, { type: 'action_result', action: 'catch_animal', ok: false, msg: 'è¿™ä¸ªä¸–ç•Œæ²¡æœ‰é‡å¤–åŒºåŸŸ' });
        return;
    }

    var staminaCost = 30;
    if (playerData.stamina < staminaCost) {
        safeSend(p.ws, { type: 'action_result', action: 'catch_animal', ok: false, msg: 'ä½“åŠ›ä¸è¶³ï¼ˆéœ€è¦' + staminaCost + 'ï¼‰' });
        return;
    }

    playerData.stamina -= staminaCost;
    var areaIdx = payload.areaIndex || 0;
    if (areaIdx < 0 || areaIdx >= worldData.wildAreas.length) areaIdx = 0;
    var area = worldData.wildAreas[areaIdx];

    var roll = Math.random();
    var found = null;

    if (area.animals && area.animals.length > 0) {
        for (var i = 0; i < area.animals.length; i++) {
            var a = area.animals[i];
            if (roll < (a.catchRate || 0.15)) {
                found = a;
                break;
            }
            roll -= (a.catchRate || 0.15);
        }
    }

    if (found) {
        var existing = playerData.animals.find(function (an) { return an.id === found.id; });
        if (existing) {
            existing.count += 1;
        } else {
            playerData.animals.push({
                id: found.id,
                name: found.name,
                icon: found.icon || 'ğŸ¾',
                count: 1,
                foodPerHour: found.foodPerHour || 2,
                sellPrice: found.sellPrice || 50,
                breedTime: found.breedTime || 7200000
            });
        }
        savePlayer(username, p.worldId, playerData);
        triggerDailyTaskCheck(username, p.worldId, 'catch_animal', found.id, 1);
        //å‘¨æŒ‘æˆ˜è¿›åº¦
        updateWeeklyChallengeProgress(username, p.worldId, 'catch_animal', 1);

        //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹
        var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'catch_animal', found.id, 1);

        //å‘é€èŠ‚æ—¥ä»»åŠ¡å®Œæˆé€šçŸ¥
        if (holidayCompleted && holidayCompleted.length > 0) {
            for (var hc = 0; hc < holidayCompleted.length; hc++) {
                var htask = holidayCompleted[hc];
                safeSend(p.ws, {
                    type: 'holiday_task_complete',
                    eventName: htask.eventName,
                    taskDesc: htask.taskDesc,
                    titleName: htask.titleName,
                    titleColor: htask.titleColor
                });
            }
        }

        safeSend(p.ws, {
            type: 'action_result',
            action: 'catch_animal',
            ok: true,
            msg: 'åœ¨' + area.name + 'æŠ“åˆ°äº† ' + found.name + 'ï¼',
            stamina: playerData.stamina,
            animals: playerData.animals
        });
        broadcastToTiandao({ type: 'td_catch_animal', worldId: p.worldId, username: username, animalName: found.name });
    } else {
        savePlayer(username, p.worldId, playerData);

        //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹ï¼ˆå³ä½¿æ²¡æŠ“åˆ°ä¹Ÿç®—ä¸€æ¬¡å°è¯•ï¼‰
        var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'catch_animal', null, 1);

        //å‘é€èŠ‚æ—¥ä»»åŠ¡å®Œæˆé€šçŸ¥
        if (holidayCompleted && holidayCompleted.length > 0) {
            for (var hc = 0; hc < holidayCompleted.length; hc++) {
                var htask = holidayCompleted[hc];
                safeSend(p.ws, {
                    type: 'holiday_task_complete',
                    eventName: htask.eventName,
                    taskDesc: htask.taskDesc,
                    titleName: htask.titleName,
                    titleColor: htask.titleColor
                });
            }
        }

        safeSend(p.ws, {
            type: 'action_result',
            action: 'catch_animal',
            ok: true,
            msg: 'åœ¨' + area.name + 'æœå¯»äº†ä¸€ç•ªï¼Œæ²¡æœ‰å‘ç°åŠ¨ç‰©...',
            stamina: playerData.stamina
        });
    }
    // å¥‡é‡ç³»ç»Ÿ - æ•çŒè§¦å‘
    if (Math.random() < (worldData.adventureRate || 0.1)) {
        var adventure = triggerAdventure(username, p.worldId, playerData, 'catch_animal');
        if (adventure) {
            safeSend(p.ws, {
                type: 'adventure_result',
                adventure: adventure
            });
        }
    }
};

actions['place_animal'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var cageId = payload.cageId;
    var animalId = payload.animalId;
    var count = parseInt(payload.count) || 1;

    if (cageId === undefined || cageId < 0 || cageId >= playerData.cages.length) {
        safeSend(p.ws, { type: 'action_result', action: 'place_animal', ok: false, msg: 'æ— æ•ˆçš„åœˆ' });
        return;
    }

    var cage = playerData.cages[cageId];

    // æŸ¥æ‰¾åº“å­˜ä¸­çš„åŠ¨ç‰©
    var animalIdx = playerData.animals.findIndex(function (a) { return a.id === animalId; });
    if (animalIdx === -1) {
        safeSend(p.ws, { type: 'action_result', action: 'place_animal', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§åŠ¨ç‰©' });
        return;
    }
    var animal = playerData.animals[animalIdx];
    if (animal.count < count) {
        safeSend(p.ws, { type: 'action_result', action: 'place_animal', ok: false, msg: 'åŠ¨ç‰©æ•°é‡ä¸è¶³' });
        return;
    }

    if (cage.animal) {
        //åœˆé‡Œå·²æœ‰åŠ¨ç‰©ï¼šåªå…è®¸è¿½åŠ åŒç§
        if (cage.animal.id !== animalId) {
            safeSend(p.ws, { type: 'action_result', action: 'place_animal', ok: false, msg: 'è¿™ä¸ªåœˆå·²ç»æœ‰å…¶ä»–ç§ç±»çš„åŠ¨ç‰©äº†' });
            return;
        }
        cage.animal.count += count;
        animal.count -= count;
        if (animal.count <= 0) playerData.animals.splice(animalIdx, 1);

        checkAllCages(playerData);
        savePlayer(username, p.worldId, playerData);
        safeSend(p.ws, {
            type: 'action_result', action: 'place_animal', ok: true,
            msg: 'å¾€ç¬¬' + (cageId + 1) + 'ä¸ªåœˆè¿½åŠ äº† ' + count + ' åª ' + animal.name + 'ï¼ˆç°æœ‰' + cage.animal.count + 'åªï¼‰',
            cages: playerData.cages, animals: playerData.animals
        });
        broadcastToTiandao({ type: 'td_place_animal', worldId: p.worldId, username: username, animalName: animal.name, count: count, cageId: cageId });
        return;
    }

    //ç©ºåœˆï¼šæ”¾å…¥æ–°åŠ¨ç‰©
    cage.animal = {
        id: animal.id,
        name: animal.name,
        icon: animal.icon,
        count: count,
        food: 0,
        foodPerHour: animal.foodPerHour,
        sellPrice: animal.sellPrice,
        breedTime: animal.breedTime,
        lastUpdate: Date.now(),
        lastBreed: Date.now()
    };

    animal.count -= count;
    if (animal.count <= 0) {
        playerData.animals.splice(animalIdx, 1);
    }

    checkAllCages(playerData);
    savePlayer(username, p.worldId, playerData);

    safeSend(p.ws, {
        type: 'action_result', action: 'place_animal', ok: true,
        msg: 'åœ¨ç¬¬' + (cageId + 1) + 'ä¸ªåœˆæ”¾å…¥äº† ' + count + ' åª ' + animal.name,
        cages: playerData.cages, animals: playerData.animals
    });
    broadcastToTiandao({ type: 'td_place_animal', worldId: p.worldId, username: username, animalName: animal.name, count: count, cageId: cageId });
};

actions['feed_animal'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    var isVisiting = !!p.visitingFarm;
    var targetUsername = isVisiting ? p.visitingFarm : username;
    var playerData = getOrCreatePlayer(targetUsername, p.worldId);
    var watererData = getOrCreatePlayer(username, p.worldId); // å–‚é£Ÿè€…çš„æ•°æ®ï¼ˆç”¨äºæ‰£å‡é£Ÿç‰©ï¼‰

    var cageId = payload.cageId;
    var feedType = payload.feedType; // 'seed' or 'fruit'
    var itemId = payload.itemId;
    var count = parseInt(payload.count) || 1;

    if (cageId === undefined || cageId < 0 || cageId >= playerData.cages.length) {
        safeSend(p.ws, { type: 'action_result', action: 'feed_animal', ok: false, msg: 'æ— æ•ˆçš„åœˆ' });
        return;
    }

    var cage = playerData.cages[cageId];
    if (!cage.animal) {
        safeSend(p.ws, { type: 'action_result', action: 'feed_animal', ok: false, msg: 'è¿™ä¸ªåœˆæ²¡æœ‰åŠ¨ç‰©' });
        return;
    }

    var foodValue = feedType === 'fruit' ? 5 : 1;
    var arr = feedType === 'fruit' ? watererData.fruits : watererData.seeds;
    var itemIdx = arr.findIndex(function (it) { return it.id === itemId; });

    if (itemIdx === -1) {
        safeSend(p.ws, { type: 'action_result', action: 'feed_animal', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ä¸ªç‰©å“' });
        return;
    }

    var item = arr[itemIdx];
    if (item.count < count) {
        safeSend(p.ws, { type: 'action_result', action: 'feed_animal', ok: false, msg: 'æ•°é‡ä¸è¶³' });
        return;
    }

    // æ‰£å‡å–‚é£Ÿè€…çš„ç‰©å“
    item.count -= count;
    if (item.count <= 0) {
        arr.splice(itemIdx, 1);
    }
    savePlayer(username, p.worldId, watererData);

    // ç»™ç›®æ ‡ç©å®¶çš„åŠ¨ç‰©å¢åŠ é£Ÿç‰©
    cage.animal.food += foodValue * count;

    // å¦‚æœæ˜¯ä¸²é—¨å–‚é£Ÿï¼Œå¢åŠ å¥½å‹äº²å¯†åº¦
    if (isVisiting) {
        increaseFriendship(username, targetUsername, 1);
        // é€šçŸ¥ç›®æ ‡ç©å®¶æœ‰äººå–‚äº†ä»–çš„åŠ¨ç‰©
        if (onlinePlayers[targetUsername]) {
            safeSend(onlinePlayers[targetUsername].ws, {
                type: 'visitor_feed',
                from: username,
                cageId: cageId,
                animalName: cage.animal.name,
                foodAdded: foodValue * count
            });
        }
    }

    broadcastToTiandao({
        type: 'td_feed_friend',
        worldId: p.worldId,
        username: username,
        target: targetUsername,
        animalName: cage.animal.name,
        itemName: item.name,
        count: count,
        foodValue: foodValue
    });

    checkAllCages(playerData);
    savePlayer(targetUsername, p.worldId, playerData);

    triggerDailyTaskCheck(username, p.worldId, 'feed_animal', null, count);

    var actionMsg = isVisiting ?
        'ç»™' + targetUsername + 'çš„ç¬¬' + (cageId + 1) + 'ä¸ªåœˆçš„ ' + cage.animal.name + ' å–‚äº† ' + count + ' ä¸ª ' + item.name + 'ï¼Œå¢åŠ äº† ' + (foodValue * count) + ' é£Ÿç‰©' :
        'å–‚é£Ÿäº† ' + count + ' ä¸ª ' + item.name + 'ï¼Œå¢åŠ äº† ' + (foodValue * count) + ' é£Ÿç‰©';

    safeSend(p.ws, {
        type: 'action_result',
        action: 'feed_animal',
        ok: true,
        msg: actionMsg,
        cages: playerData.cages,
        seeds: watererData.seeds,
        fruits: watererData.fruits
    });

    broadcastToTiandao({
        type: 'td_feed_animal',
        worldId: p.worldId,
        username: username,
        target: isVisiting ? targetUsername : null,
        feedType: feedType,
        itemName: item.name,
        count: count
    });
};

actions['sell_animal'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var cageId = payload.cageId;
    var count = parseInt(payload.count) || 1;
    var sellAll = payload.sellAll || false;

    if (cageId === undefined || cageId < 0 || cageId >= playerData.cages.length) {
        safeSend(p.ws, { type: 'action_result', action: 'sell_animal', ok: false, msg: 'æ— æ•ˆçš„åœˆ' });
        return;
    }

    var cage = playerData.cages[cageId];
    if (!cage.animal) {
        safeSend(p.ws, { type: 'action_result', action: 'sell_animal', ok: false, msg: 'è¿™ä¸ªåœˆæ²¡æœ‰åŠ¨ç‰©' });
        return;
    }

    if (sellAll) {
        count = cage.animal.count;
    }

    if (cage.animal.count < count) {
        safeSend(p.ws, { type: 'action_result', action: 'sell_animal', ok: false, msg: 'åŠ¨ç‰©æ•°é‡ä¸è¶³' });
        return;
    }

    var income = cage.animal.sellPrice * count;
    playerData.money += income;
    cage.animal.count -= count;

    if (cage.animal.count <= 0) {
        cage.animal = null;
    }

    checkAllCages(playerData);
    savePlayer(username, p.worldId, playerData);

    safeSend(p.ws, {
        type: 'action_result',
        action: 'sell_animal',
        ok: true,
        msg: 'å–å‡ºäº† ' + count + ' åªåŠ¨ç‰©ï¼Œè·å¾— ' + income + ' é‡‘å¸',
        cages: playerData.cages,
        money: playerData.money
    });
    broadcastToTiandao({ type: 'td_sell_animal', worldId: p.worldId, username: username, count: count, income: income });
};

actions['my_cages'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    checkAllCages(playerData);
    savePlayer(username, p.worldId, playerData);
    safeSend(p.ws, {
        type: 'action_result',
        action: 'my_cages',
        ok: true,
        cages: playerData.cages,
        animals: playerData.animals
    });
};

actions['my_farm'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    checkAllPlots(playerData);
    savePlayer(username, p.worldId, playerData);
    safeSend(p.ws, {
        type: 'action_result', action: 'my_farm', ok: true,
        plots: playerData.plots, seeds: playerData.seeds, fruits: playerData.fruits,
        items: playerData.items, money: playerData.money, stamina: playerData.stamina,
        staminaMax: playerData.staminaMax, restCooldown: playerData.restCooldown,
        farmId: playerData.farmId, waterBoostLevel: playerData.waterBoostLevel || 0,  //æ·»åŠ è¿™è¡Œ
        totalHarvest: playerData.totalHarvest, totalGather: playerData.totalGather,
        cages: playerData.cages,
        animals: playerData.animals,
        pets: playerData.pets
    });
};

actions['inventory'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    safeSend(p.ws, {
        type: 'action_result', action: 'inventory', ok: true,
        seeds: playerData.seeds, fruits: playerData.fruits, items: playerData.items,
        money: playerData.money
    });
};

actions['shop_buy'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var worldData = loadWorldData(p.worldId);
    if (!worldData || !worldData.shop) { safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: false, msg: 'å•†åº—ä¸å¯ç”¨' }); return; }
    var shopItem = worldData.shop.items.find(function (it) { return it.id === payload.itemId; });
    if (!shopItem) { safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: false, msg: 'å•†å“ä¸å­˜åœ¨' }); return; }
    var count = payload.count || 1;
    var totalPrice = shopItem.price * count;
    if (playerData.money < totalPrice) {
        safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: false, msg: 'é‡‘å¸ä¸è¶³ï¼ˆéœ€è¦' + totalPrice + 'ï¼Œå½“å‰' + playerData.money + 'ï¼‰' }); return;
    }
    playerData.money -= totalPrice;
    if (shopItem.type === 'seed' && shopItem.seedData) {
        var sd = shopItem.seedData;
        var existingSeed = playerData.seeds.find(function (s) { return s.id === sd.id; });
        if (existingSeed) {
            existingSeed.count += count;
            if (!existingSeed.source) existingSeed.source = 'bought';
        }
        else {
            playerData.seeds.push({
                id: sd.id, name: sd.name, icon: sd.icon || 'ğŸŒ±',
                count: count, growTime: sd.growTime || 7200000,
                fruitId: sd.fruitId, fruitName: sd.fruitName,
                fruitIcon: sd.fruitIcon || 'ğŸ', fruitValue: sd.fruitValue || 10,
                fruitDesc: sd.fruitDesc || '',
                source: 'bought'
            });
        }
        savePlayer(username, p.worldId, playerData);
        triggerDailyTaskCheck(username, p.worldId, 'shop_buy', payload.itemId, count);
        triggerDailyTaskCheck(username, p.worldId, 'spend_money', null, totalPrice);
        //å‘¨æŒ‘æˆ˜è¿›åº¦
        updateWeeklyChallengeProgress(username, p.worldId, 'shop_buy', count);
        safeSend(p.ws, {
            type: 'action_result', action: 'shop_buy', ok: true,
            msg: 'è´­ä¹°äº† ' + sd.name + ' x' + count,
            money: playerData.money, seeds: playerData.seeds
        });
        broadcastToTiandao({ type: 'td_shop_buy', worldId: p.worldId, username: username, itemName: sd.name, count: count, totalPrice: totalPrice });
        return;
    }
    if (shopItem.id === 'plot_expand') {
        if (playerData.plots.length >= 12) {
            playerData.money += totalPrice;
            safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: false, msg: 'å·²è¾¾åˆ°æœ€å¤§åœ°å—æ•°ï¼ˆ12ï¼‰' }); return;
        }
        for (var i = 0; i < count; i++) {
            if (playerData.plots.length < 12) playerData.plots.push({ id: playerData.plots.length, plant: null });
        }
        savePlayer(username, p.worldId, playerData);
        safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: true, msg: 'å¼€å¦æˆåŠŸï¼ç°åœ¨æœ‰' + playerData.plots.length + 'å—åœ°', money: playerData.money, plots: playerData.plots });
        broadcastToTiandao({ type: 'td_shop_buy', worldId: p.worldId, username: username, itemName: 'å¼€å¦ä»¤', count: count, totalPrice: totalPrice });
        return;
    }

    if (shopItem.id.startsWith('watering_can_lv')) {
        var newLevel = parseInt(shopItem.id.replace('watering_can_lv', '')) || 0;
        var currentLevel = playerData.waterBoostLevel || 0;

        if (newLevel <= currentLevel) {
            playerData.money += totalPrice;
            safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: false, msg: 'ä½ å·²ç»æœ‰æ›´å¥½çš„æ°´å£¶äº†' });
            return;
        }

        var oldWaterToolId = 'watering_can_lv' + currentLevel;
        var oldToolIdx = playerData.items.findIndex(function (it) { return it.id === oldWaterToolId; });
        if (oldToolIdx !== -1) {
            playerData.items.splice(oldToolIdx, 1);
        }

        playerData.waterBoostLevel = newLevel;
        savePlayer(username, p.worldId, playerData);
        var boostPercent = newLevel * 10;
        safeSend(p.ws, {
            type: 'action_result',
            action: 'shop_buy',
            ok: true,
            msg: 'å‡çº§åˆ° ' + shopItem.name + 'ï¼æµ‡æ°´æ•ˆæœæå‡' + boostPercent + '%',
            money: playerData.money,
            waterBoostLevel: playerData.waterBoostLevel,
            items: playerData.items
        });
        broadcastToTiandao({ type: 'td_shop_buy', worldId: p.worldId, username: username, itemName: shopItem.name, count: 1, totalPrice: totalPrice });
        return;
    }

    if (shopItem.id === 'cage_expand') {
        if (playerData.cages.length >= 12) {
            playerData.money += totalPrice;
            safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: false, msg: 'å·²è¾¾åˆ°æœ€å¤§åœˆæ•°ï¼ˆ12ï¼‰' });
            return;
        }
        for (var i = 0; i < count; i++) {
            if (playerData.cages.length < 12) playerData.cages.push({ id: playerData.cages.length, animal: null });
        }
        savePlayer(username, p.worldId, playerData);
        safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: true, msg: 'è´­ä¹°æˆåŠŸï¼ç°åœ¨æœ‰' + playerData.cages.length + 'ä¸ªåœˆ', money: playerData.money, cages: playerData.cages });
        broadcastToTiandao({ type: 'td_shop_buy', worldId: p.worldId, username: username, itemName: 'åœˆæ‰©å±•', count: count, totalPrice: totalPrice });
        return;
    }

    if (shopItem.type === 'animal' && shopItem.animalData) {
        var ad = shopItem.animalData;
        var existingAnimal = playerData.animals.find(function (a) { return a.id === ad.id; });
        if (existingAnimal) {
            existingAnimal.count += count;
        } else {
            playerData.animals.push({
                id: ad.id,
                name: ad.name,
                icon: ad.icon || 'ğŸ¾',
                count: count,
                foodPerHour: ad.foodPerHour || 2,
                sellPrice: ad.sellPrice || 50,
                breedTime: ad.breedTime || 36000000
            });
        }
        savePlayer(username, p.worldId, playerData);
        safeSend(p.ws, {
            type: 'action_result',
            action: 'shop_buy',
            ok: true,
            msg: 'è´­ä¹°äº† ' + ad.name + ' x' + count,
            money: playerData.money,
            animals: playerData.animals
        });
        broadcastToTiandao({ type: 'td_shop_buy', worldId: p.worldId, username: username, itemName: ad.name, count: count, totalPrice: totalPrice });
        return;
    }

    if (shopItem.type === 'pet' && shopItem.petData) {
        if (playerData.pets.length >= 6) {
            playerData.money += totalPrice;
            safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: false, msg: 'ä½ å·²ç»æœ‰6åªå® ç‰©äº†ï¼Œå…ˆæ”¾ç”Ÿä¸€äº›å†è´­ä¹°' });
            return;
        }
        var pd = shopItem.petData;
        var newPet = {
            id: generatePetId(),
            species: pd.species,
            speciesIcon: pd.speciesIcon || 'ğŸ¾',
            name: pd.species,
            rarity: pd.rarity || 'common',
            mood: pd.baseMood || 100,
            value: pd.baseValue || 30,
            createdAt: Date.now(),
            lastInteraction: Date.now(),
            lastAdventure: 0,
            adventureEndTime: 0,
            totalAdventures: 0
        };
        playerData.pets.push(newPet);
        savePlayer(username, p.worldId, playerData);
        safeSend(p.ws, {
            type: 'action_result', action: 'shop_buy', ok: true,
            msg: 'è´­ä¹°äº†å® ç‰© ' + newPet.speciesIcon + ' ' + newPet.species + 'ï¼',
            money: playerData.money,
            pets: playerData.pets
        });
        broadcastToTiandao({ type: 'td_shop_buy', worldId: p.worldId, username: username, itemName: 'å® ç‰©Â·' + newPet.species, count: 1, totalPrice: totalPrice });
        return;
    }

    var ei = playerData.items.find(function (it) { return it.id === shopItem.id; });
    if (ei) { ei.count += count; }
    else { playerData.items.push({ id: shopItem.id, name: shopItem.name, type: shopItem.type, count: count, desc: shopItem.desc, effect: shopItem.effect }); }
    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'shop_buy', payload.itemId, count);
    triggerDailyTaskCheck(username, p.worldId, 'spend_money', null, totalPrice);
    safeSend(p.ws, { type: 'action_result', action: 'shop_buy', ok: true, msg: 'è´­ä¹°äº† ' + shopItem.name + ' x' + count, money: playerData.money, items: playerData.items });
    broadcastToTiandao({ type: 'td_shop_buy', worldId: p.worldId, username: username, itemName: shopItem.name, count: count, totalPrice: totalPrice });
};

actions['shop_list'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var worldData = loadWorldData(p.worldId);
    var playerData = getOrCreatePlayer(username, p.worldId);
    safeSend(p.ws, {
        type: 'action_result', action: 'shop_list', ok: true,
        shop: worldData ? worldData.shop : { items: [] },
        money: playerData.money
    });
};

actions['sell_fruit'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var worldData = loadWorldData(p.worldId);
    var fruitId = payload.fruitId;
    var count = payload.count || 1;
    var fi = playerData.fruits.findIndex(function (f) { return f.id === fruitId; });
    if (fi === -1) { safeSend(p.ws, { type: 'action_result', action: 'sell_fruit', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§æœå®' }); return; }
    var fruit = playerData.fruits[fi];
    if (fruit.count < count) { safeSend(p.ws, { type: 'action_result', action: 'sell_fruit', ok: false, msg: 'æ•°é‡ä¸è¶³' }); return; }

    var income = fruit.value * count;
    var msg = '';

    //æ£€æŸ¥èŠ‚æ—¥æ´»åŠ¨æ•ˆæœ
    var now = Date.now();
    var activeEvents = [];
    if (worldData && worldData.events) {
        for (var ei = 0; ei < worldData.events.length; ei++) {
            var ev = worldData.events[ei];
            if (ev.startTime && now < ev.startTime) continue;
            if (ev.endTime && now > ev.endTime) continue;
            activeEvents.push(ev);
        }
    }

    //èŠ‚æ—¥åŒå€é‡‘å¸
    for (var evIdx = 0; evIdx < activeEvents.length; evIdx++) {
        var ev = activeEvents[evIdx];
        if (ev.doubleMoney) {
            income *= 2;
            msg = 'ï¼ˆèŠ‚æ—¥åŒå€ï¼ï¼‰';
            break;
        }
    }

    playerData.money += income;
    fruit.count -= count;
    if (fruit.count <= 0) playerData.fruits.splice(fi, 1);
    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'sell', fruitId, count);
    triggerDailyTaskCheck(username, p.worldId, 'earn_money', null, income);
    updateWeeklyChallengeProgress(username, p.worldId, 'sell', count);

    safeSend(p.ws, {
        type: 'action_result', action: 'sell_fruit', ok: true,
        msg: 'å–å‡º ' + fruit.name + ' x' + count + 'ï¼Œè·å¾— ' + income + ' é‡‘å¸' + msg,
        money: playerData.money, fruits: playerData.fruits
    });
    broadcastToTiandao({ type: 'td_sell', worldId: p.worldId, username: username, itemName: fruit.name, count: count, income: income, sellType: 'fruit' });
};

actions['sell_seed'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var seedId = payload.seedId;
    var count = payload.count || 1;
    var si = playerData.seeds.findIndex(function (s) { return s.id === seedId; });
    if (si === -1) { safeSend(p.ws, { type: 'action_result', action: 'sell_seed', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§ç§å­' }); return; }
    var seed = playerData.seeds[si];
    if (seed.count < count) { safeSend(p.ws, { type: 'action_result', action: 'sell_seed', ok: false, msg: 'æ•°é‡ä¸è¶³' }); return; }

    var sellPrice = 0;
    if (seed.source === 'bought') {
        var worldData = loadWorldData(p.worldId);
        var shopItem = null;
        if (worldData && worldData.shop && worldData.shop.items) {
            shopItem = worldData.shop.items.find(function (it) { return it.seedData && it.seedData.id === seedId; });
        }
        if (shopItem) {
            sellPrice = Math.floor(shopItem.price / 2);
        } else {
            sellPrice = 5;
        }
    } else if (seed.source === 'harvest') {
        sellPrice = Math.floor((seed.fruitValue || 10) / 3);
    } else {
        safeSend(p.ws, { type: 'action_result', action: 'sell_seed', ok: false, msg: 'è¿™ç§ç§å­æ— æ³•å–å‡º' });
        return;
    }

    var income = sellPrice * count;
    playerData.money += income;
    seed.count -= count;
    if (seed.count <= 0) playerData.seeds.splice(si, 1);
    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'sell', seedId, count);
    triggerDailyTaskCheck(username, p.worldId, 'earn_money', null, income);
    safeSend(p.ws, {
        type: 'action_result', action: 'sell_seed', ok: true,
        msg: 'å–å‡º ' + seed.name + ' x' + count + 'ï¼Œè·å¾— ' + income + ' é‡‘å¸',
        money: playerData.money, seeds: playerData.seeds
    });
    broadcastToTiandao({ type: 'td_sell', worldId: p.worldId, username: username, itemName: seed.name, count: count, income: income, sellType: 'seed' });
};

actions['sell_stock_animal'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var animalId = payload.animalId;
    var count = parseInt(payload.count) || 1;
    var ai = playerData.animals.findIndex(function (a) { return a.id === animalId; });
    if (ai === -1) { safeSend(p.ws, { type: 'action_result', action: 'sell_stock_animal', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§åŠ¨ç‰©' }); return; }
    var animal = playerData.animals[ai];
    if (animal.count < count) { safeSend(p.ws, { type: 'action_result', action: 'sell_stock_animal', ok: false, msg: 'æ•°é‡ä¸è¶³' }); return; }
    var income = animal.sellPrice * count;
    playerData.money += income;
    animal.count -= count;
    if (animal.count <= 0) playerData.animals.splice(ai, 1);
    savePlayer(username, p.worldId, playerData);
    safeSend(p.ws, {
        type: 'action_result', action: 'sell_stock_animal', ok: true,
        msg: 'å–å‡º ' + animal.name + ' x' + count + 'ï¼Œè·å¾— ' + income + ' é‡‘å¸',
        money: playerData.money, animals: playerData.animals
    });
    broadcastToTiandao({ type: 'td_sell', worldId: p.worldId, username: username, itemName: animal.name, count: count, income: income, sellType: 'stock_animal' });
};

var _rankingCache = {};
var RANKING_CACHE_TTL = 30000;

actions['world_ranking'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var ranking = getWorldRanking(p.worldId);
    var myRank = null;
    for (var i = 0; i < ranking.length; i++) {
        if (ranking[i].username === username) { myRank = i; break; }
    }
    safeSend(p.ws, { type: 'action_result', action: 'world_ranking', ok: true, ranking: ranking, myRank: myRank });
};

actions['pet_ranking'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var ranking = getPetRanking(p.worldId);
    var myRank = null;
    for (var i = 0; i < ranking.length; i++) {
        if (ranking[i].owner === username) { myRank = i; break; }
    }
    safeSend(p.ws, { type: 'action_result', action: 'pet_ranking', ok: true, ranking: ranking, myRank: myRank });
};

actions['wild_areas'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var worldData = loadWorldData(p.worldId);
    var playerData = getOrCreatePlayer(username, p.worldId);
    safeSend(p.ws, {
        type: 'action_result', action: 'wild_areas', ok: true,
        areas: (worldData && worldData.wildAreas) ? worldData.wildAreas.map(function (a) {
            return {
                name: a.name, desc: a.desc, icon: a.icon,
                seedNames: (a.seeds || []).map(function (s) { return s.name; }),
                animalNames: (a.animals || []).map(function (an) { return (an.icon || 'ğŸ¾') + an.name; }),
                petNames: (a.pets || []).map(function (pt) { return (pt.speciesIcon || 'ğŸ¾') + pt.species; })
            };
        }) : [],
        stamina: playerData.stamina, staminaMax: playerData.staminaMax
    });
};

actions['event_list'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    var worldData = loadWorldData(p.worldId);
    var events = (worldData && worldData.events) ? worldData.events : [];

    // åˆå¹¶èŠ‚æ—¥æ´»åŠ¨
    var holidayEvts = getHolidayEvents(p.worldId) || [];
    var combined = events.concat(holidayEvts);

    // è·å–ç©å®¶ä»»åŠ¡è¿›åº¦
    var playerData = getOrCreatePlayer(username, p.worldId);
    var holidayTasks = playerData.holidayTasks || {};

    safeSend(p.ws, {
        type: 'action_result',
        action: 'event_list',
        ok: true,
        events: combined,
        playerProgress: playerData.holidayTasks || {}   //è¿”å›ç©å®¶çš„èŠ‚æ—¥ä»»åŠ¡è¿›åº¦
    });
};

// ============================================================
// ç§°å·ç³»ç»Ÿ
// ============================================================
actions['set_active_title'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    var playerData = getOrCreatePlayer(username, p.worldId);
    var titleId = payload.titleId;

    if (titleId === null || titleId === '') {
        playerData.activeTitleId = null;
    } else {
        // æ£€æŸ¥ç©å®¶æ˜¯å¦æ‹¥æœ‰è¯¥ç§°å·
        if (playerData.ownedTitleIds && playerData.ownedTitleIds.includes(titleId)) {
            playerData.activeTitleId = titleId;
        } else {
            safeSend(p.ws, { type: 'action_result', action: 'set_active_title', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ä¸ªç§°å·' });
            return;
        }
    }

    savePlayer(username, p.worldId, playerData);

    // åœ¨å‘é€ç»™å®¢æˆ·ç«¯å‰ï¼Œéœ€è¦ç»„åˆä¸–ç•Œç§°å·æ•°æ®
    var worldData = loadWorldData(p.worldId);
    var activeTitleInfo = null;
    if (playerData.activeTitleId && worldData.worldTitles && worldData.worldTitles[playerData.activeTitleId]) {
        activeTitleInfo = {
            titleId: playerData.activeTitleId,
            ...worldData.worldTitles[playerData.activeTitleId]
        };
    }
    // æ›´æ–°åœ¨çº¿ç©å®¶çš„æ•°æ®å‰¯æœ¬ä¸­çš„ activeTitle
    if (playerData.player) playerData.player.activeTitle = activeTitleInfo;


    safeSend(p.ws, { type: 'action_result', action: 'set_active_title', ok: true, msg: 'ç§°å·å·²åˆ‡æ¢' });

    // é‡æ–°å‘é€ä¸€æ¬¡player_updateï¼Œè®©å®¢æˆ·ç«¯æ›´æ–°ç§°å·æ˜¾ç¤º
    var updatedPlayer = getOrCreatePlayer(username, p.worldId);
    if (onlinePlayers[username]) {
        handlePlayerUpdate(username, updatedPlayer);
    }
};

function handlePlayerUpdate(username, playerData) {
    var p = onlinePlayers[username];
    if (!p) return;

    var worldData = loadWorldData(p.worldId);
    var fullPlayerData = JSON.parse(JSON.stringify(playerData)); // ä½¿ç”¨ playerData

    // ç»„åˆ activeTitle
    fullPlayerData.activeTitle = null;
    if (fullPlayerData.activeTitleId && worldData.worldTitles && worldData.worldTitles[fullPlayerData.activeTitleId]) { // ä½¿ç”¨ worldData
        fullPlayerData.activeTitle = {
            titleId: fullPlayerData.activeTitleId,
            ...worldData.worldTitles[fullPlayerData.activeTitleId]
        };
    }

    // ç»„åˆ titles æ•°ç»„
    fullPlayerData.titles = [];
    if (fullPlayerData.ownedTitleIds && worldData.worldTitles) {
        fullPlayerData.ownedTitleIds.forEach(id => {
            if (worldData.worldTitles[id]) {
                fullPlayerData.titles.push({
                    titleId: id,
                    ...worldData.worldTitles[id]
                });
            }
        });
    }

    safeSend(p.ws, { type: 'player_update', player: fullPlayerData });
}

// ============================================================
//  é‚®ä»¶ç³»ç»Ÿ actions
// ============================================================
actions['mail_list'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var mails = getPlayerMails(username, p.worldId);
    safeSend(p.ws, {
        type: 'action_result', action: 'mail_list', ok: true,
        mails: mails
    });
};

actions['mail_claim'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var mailId = payload.mailId;
    var all = loadMails();
    var userMails = all[username] || [];
    var mail = userMails.find(function (m) { return m.id === mailId; });
    if (!mail) {
        safeSend(p.ws, { type: 'action_result', action: 'mail_claim', ok: false, msg: 'é‚®ä»¶ä¸å­˜åœ¨' });
        return;
    }
    if (mail.claimed) {
        safeSend(p.ws, { type: 'action_result', action: 'mail_claim', ok: false, msg: 'å·²ç»é¢†å–è¿‡äº†' });
        return;
    }
    if (!mail.attachments || mail.attachments.length === 0) {
        safeSend(p.ws, { type: 'action_result', action: 'mail_claim', ok: false, msg: 'è¿™å°é‚®ä»¶æ²¡æœ‰é™„ä»¶' });
        return;
    }

    var playerData = getOrCreatePlayer(username, p.worldId);
    var claimedItems = [];

    for (var i = 0; i < mail.attachments.length; i++) {
        var att = mail.attachments[i];
        if (att.type === 'money') {
            playerData.money += att.amount || 0;
            claimedItems.push('ğŸ’°' + att.amount + 'é‡‘å¸');
        } else if (att.type === 'seed') {
            var existingSeed = playerData.seeds.find(function (s) { return s.id === att.data.id; });
            if (existingSeed) {
                existingSeed.count += att.data.count || 1;
            } else {
                var seedCopy = JSON.parse(JSON.stringify(att.data));
                if (!seedCopy.source) seedCopy.source = 'mail';
                playerData.seeds.push(seedCopy);
            }
            claimedItems.push((att.data.icon || 'ğŸŒ±') + att.data.name + ' x' + (att.data.count || 1));
        } else if (att.type === 'fruit') {
            var existingFruit = playerData.fruits.find(function (f) { return f.id === att.data.id; });
            if (existingFruit) {
                existingFruit.count += att.data.count || 1;
            } else {
                playerData.fruits.push(JSON.parse(JSON.stringify(att.data)));
            }
            claimedItems.push((att.data.icon || 'ğŸ') + att.data.name + ' x' + (att.data.count || 1));
        } else if (att.type === 'pet') {
            if (playerData.pets.length >= 6) {
                safeSend(p.ws, { type: 'action_result', action: 'mail_claim', ok: false, msg: 'å® ç‰©å·²æ»¡ï¼ˆ6åªï¼‰ï¼Œè¯·å…ˆæ”¾ç”Ÿä¸€äº›å†é¢†å–' });
                return;
            }
            var petCopy = JSON.parse(JSON.stringify(att.data));
            petCopy.id = generatePetId();
            petCopy.createdAt = Date.now();
            petCopy.lastInteraction = Date.now();
            if (!petCopy.mood) petCopy.mood = 100;
            if (!petCopy.adventureEndTime) petCopy.adventureEndTime = 0;
            if (!petCopy.totalAdventures) petCopy.totalAdventures = 0;
            playerData.pets.push(petCopy);
            claimedItems.push((petCopy.speciesIcon || 'ğŸ¾') + petCopy.species + 'Â·' + petCopy.name);
        }
    }

    mail.claimed = true;
    saveMails(all);
    savePlayer(username, p.worldId, playerData);

    safeSend(p.ws, {
        type: 'action_result', action: 'mail_claim', ok: true,
        msg: 'é¢†å–æˆåŠŸï¼š' + claimedItems.join('ã€'),
        money: playerData.money,
        seeds: playerData.seeds,
        fruits: playerData.fruits,
        pets: playerData.pets
    });
};

actions['mail_delete'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var mailId = payload.mailId;
    var all = loadMails();
    var userMails = all[username] || [];
    var mailIdx = userMails.findIndex(function (m) { return m.id === mailId; });
    if (mailIdx === -1) {
        safeSend(p.ws, { type: 'action_result', action: 'mail_delete', ok: false, msg: 'é‚®ä»¶ä¸å­˜åœ¨' });
        return;
    }
    userMails.splice(mailIdx, 1);
    all[username] = userMails;
    saveMails(all);
    safeSend(p.ws, { type: 'action_result', action: 'mail_delete', ok: true, msg: 'é‚®ä»¶å·²åˆ é™¤' });
};

actions['mail_delete_all'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var all = loadMails();
    var userMails = all[username] || [];
    //æ£€æŸ¥æ˜¯å¦æœ‰æœªé¢†å–çš„é™„ä»¶
    var unclaimedCount = userMails.filter(function (m) {
        return !m.claimed && m.attachments && m.attachments.length > 0;
    }).length;
    var count = userMails.length;
    all[username] = [];
    saveMails(all);
    safeSend(p.ws, {
        type: 'action_result', action: 'mail_delete_all', ok: true,
        msg: 'å·²åˆ é™¤å…¨éƒ¨ ' + count + ' å°é‚®ä»¶' + (unclaimedCount > 0 ? 'ï¼ˆå…¶ä¸­ ' + unclaimedCount + ' å°æœ‰æœªé¢†å–é™„ä»¶ï¼‰' : '')
    });
};

actions['mail_read'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var mailId = payload.mailId;
    var all = loadMails();
    var userMails = all[username] || [];
    var mail = userMails.find(function (m) { return m.id === mailId; });
    if (!mail) {
        safeSend(p.ws, { type: 'action_result', action: 'mail_read', ok: false, msg: 'é‚®ä»¶ä¸å­˜åœ¨' });
        return;
    }
    mail.read = true;
    saveMails(all);
    safeSend(p.ws, { type: 'action_result', action: 'mail_read', ok: true, msg: 'å·²æ ‡è®°ä¸ºå·²è¯»' });
};

actions['mail_read_all'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var all = loadMails();
    var userMails = all[username] || [];
    var count = 0;
    userMails.forEach(function (m) {
        if (!m.read) { m.read = true; count++; }
    });
    saveMails(all);
    safeSend(p.ws, { type: 'action_result', action: 'mail_read_all', ok: true, msg: 'å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»ï¼ˆ' + count + 'å°ï¼‰' });
};

// ============================================================
//  å® ç‰©ç³»ç»Ÿ
// ============================================================

function generatePetId() {
    return 'pet_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 4);
}

actions['my_pets'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    safeSend(p.ws, {
        type: 'action_result', action: 'my_pets', ok: true,
        pets: playerData.pets || []
    });
};

actions['catch_pet'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var worldData = loadWorldData(p.worldId);

    if (!worldData || !worldData.wildAreas || worldData.wildAreas.length === 0) {
        safeSend(p.ws, { type: 'action_result', action: 'catch_pet', ok: false, msg: 'è¿™ä¸ªä¸–ç•Œæ²¡æœ‰é‡å¤–åŒºåŸŸ' });
        return;
    }

    var staminaCost = 20;
    if (playerData.stamina < staminaCost) {
        safeSend(p.ws, { type: 'action_result', action: 'catch_pet', ok: false, msg: 'ä½“åŠ›ä¸è¶³ï¼ˆéœ€è¦' + staminaCost + 'ï¼‰' });
        return;
    }

    playerData.stamina -= staminaCost;

    var areaIdx = payload.areaIndex || 0;
    if (areaIdx < 0 || areaIdx >= worldData.wildAreas.length) areaIdx = 0;
    var area = worldData.wildAreas[areaIdx];

    // æ”¶é›†è¯¥åŒºåŸŸå¯æ•è·çš„å® ç‰©
    var availablePets = (area.pets || []);
    // ä¹ŸåŠ å…¥å…¨å±€é»˜è®¤å® ç‰©ï¼ˆå¦‚æœåŒºåŸŸæ²¡æœ‰è‡ªå®šä¹‰å® ç‰©ï¼‰
    if (availablePets.length === 0 && worldData.globalPets && worldData.globalPets.length > 0) {
        availablePets = worldData.globalPets;
    }
    // å¦‚æœä¸–ç•Œå®Œå…¨æ²¡æœ‰å® ç‰©æ•°æ®ï¼Œç”¨é»˜è®¤çš„
    if (availablePets.length === 0) {
        availablePets = [
            { species: 'çŒ«', speciesIcon: 'ğŸ±', catchRate: 0.12, rarity: 'common', baseValue: 30 },
            { species: 'ç‹—', speciesIcon: 'ğŸ•', catchRate: 0.10, rarity: 'common', baseValue: 35 },
            { species: 'é¼ ', speciesIcon: 'ğŸ­', catchRate: 0.15, rarity: 'common', baseValue: 15 },
            { species: 'é¹¦é¹‰', speciesIcon: 'ğŸ¦œ', catchRate: 0.08, rarity: 'uncommon', baseValue: 60 }
        ];
    }

    var roll = Math.random();
    var caught = null;
    for (var i = 0; i < availablePets.length; i++) {
        var pet = availablePets[i];
        if (roll < (pet.catchRate || 0.12)) {
            caught = pet;
            break;
        }
        roll -= (pet.catchRate || 0.12);
    }

    if (caught) {
        //æ£€æŸ¥å® ç‰©æ•°é‡ä¸Šé™
        if (playerData.pets.length >= 6) {
            savePlayer(username, p.worldId, playerData);
            safeSend(p.ws, {
                type: 'action_result', action: 'catch_pet', ok: false,
                msg: 'ä½ å·²ç»æœ‰6åªå® ç‰©äº†ï¼Œå…ˆæ”¾ç”Ÿä¸€äº›å†æ¥æ•æ‰å§',
                stamina: playerData.stamina
            });
            return;
        }
        var newPet = {
            id: generatePetId(),
            species: caught.species,
            speciesIcon: caught.speciesIcon || 'ğŸ¾',
            name: caught.species,  // é»˜è®¤åç§°=ç±»åˆ«
            rarity: caught.rarity || 'common',
            mood: 100,
            value: caught.baseValue || Math.floor(Math.random() * 91) + 10,
            createdAt: Date.now(),
            lastInteraction: Date.now(),
            lastAdventure: 0,
            adventureEndTime: 0,
            totalAdventures: 0
        };
        playerData.pets.push(newPet);
        savePlayer(username, p.worldId, playerData);
        triggerDailyTaskCheck(username, p.worldId, 'catch_pet', caught.species, 1);
        //å‘¨æŒ‘æˆ˜è¿›åº¦
        updateWeeklyChallengeProgress(username, p.worldId, 'catch_pet', 1);

        //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹
        var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'catch_pet', caught.species, 1);

        //å‘é€èŠ‚æ—¥ä»»åŠ¡å®Œæˆé€šçŸ¥
        if (holidayCompleted && holidayCompleted.length > 0) {
            for (var hc = 0; hc < holidayCompleted.length; hc++) {
                var htask = holidayCompleted[hc];
                safeSend(p.ws, {
                    type: 'holiday_task_complete',
                    eventName: htask.eventName,
                    taskDesc: htask.taskDesc,
                    titleName: htask.titleName,
                    titleColor: htask.titleColor
                });
            }
        }

        safeSend(p.ws, {
            type: 'action_result', action: 'catch_pet', ok: true,
            msg: 'åœ¨' + area.name + 'æ•è·äº†ä¸€åª ' + caught.speciesIcon + ' ' + caught.species + 'ï¼',
            stamina: playerData.stamina,
            pets: playerData.pets,
            newPet: newPet
        });
        broadcastToTiandao({ type: 'td_catch_pet', worldId: p.worldId, username: username, petSpecies: caught.species, petRarity: caught.rarity, areaName: area.name });
    } else {
        savePlayer(username, p.worldId, playerData);

        //æ·»åŠ èŠ‚æ—¥ä»»åŠ¡æ£€æµ‹ï¼ˆå³ä½¿æ²¡æŠ“åˆ°ä¹Ÿç®—ä¸€æ¬¡å°è¯•ï¼‰
        var holidayCompleted = checkHolidayTaskProgress(username, p.worldId, 'catch_pet', null, 1);

        //å‘é€èŠ‚æ—¥ä»»åŠ¡å®Œæˆé€šçŸ¥
        if (holidayCompleted && holidayCompleted.length > 0) {
            for (var hc = 0; hc < holidayCompleted.length; hc++) {
                var htask = holidayCompleted[hc];
                safeSend(p.ws, {
                    type: 'holiday_task_complete',
                    eventName: htask.eventName,
                    taskDesc: htask.taskDesc,
                    titleName: htask.titleName,
                    titleColor: htask.titleColor
                });
            }
        }

        safeSend(p.ws, {
            type: 'action_result', action: 'catch_pet', ok: true,
            msg: 'åœ¨' + area.name + 'æœå¯»äº†ä¸€ç•ªï¼Œæ²¡æœ‰å‘ç°å¯ä»¥æ•è·çš„å® ç‰©...',
            stamina: playerData.stamina
        });
    }
    // å¥‡é‡ç³»ç»Ÿ - æ‰å® è§¦å‘
    if (Math.random() < (worldData.adventureRate || 0.1)) {
        var adventure = triggerAdventure(username, p.worldId, playerData, 'catch_pet');
        if (adventure) {
            safeSend(p.ws, {
                type: 'adventure_result',
                adventure: adventure
            });
        }
    }
};

actions['rename_pet'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var petId = payload.petId;
    var newName = (payload.name || '').trim();
    if (!newName || newName.length > 12) {
        safeSend(p.ws, { type: 'action_result', action: 'rename_pet', ok: false, msg: 'åç§°éœ€è¦1-12ä¸ªå­—ç¬¦' });
        return;
    }
    var pet = playerData.pets.find(function (pt) { return pt.id === petId; });
    if (!pet) {
        safeSend(p.ws, { type: 'action_result', action: 'rename_pet', ok: false, msg: 'å® ç‰©ä¸å­˜åœ¨' });
        return;
    }
    pet.name = newName;
    savePlayer(username, p.worldId, playerData);
    safeSend(p.ws, {
        type: 'action_result', action: 'rename_pet', ok: true,
        msg: pet.speciesIcon + ' ' + pet.species + ' æ”¹åä¸ºã€Œ' + newName + 'ã€',
        pets: playerData.pets
    });
};

actions['pet_adventure'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var petId = payload.petId;
    var pet = playerData.pets.find(function (pt) { return pt.id === petId; });
    if (!pet) {
        safeSend(p.ws, { type: 'action_result', action: 'pet_adventure', ok: false, msg: 'å® ç‰©ä¸å­˜åœ¨' });
        return;
    }
    var now = Date.now();
    if (pet.adventureEndTime && now < pet.adventureEndTime) {
        var remainMs = pet.adventureEndTime - now;
        var remainMin = Math.ceil(remainMs / 60000);
        safeSend(p.ws, { type: 'action_result', action: 'pet_adventure', ok: false, msg: pet.speciesIcon + ' ' + pet.name + ' è¿˜åœ¨å¤–é¢å¯»å®ï¼Œ' + remainMin + 'åˆ†é’Ÿåå›æ¥' });
        return;
    }
    if (pet.mood < 10) {
        safeSend(p.ws, { type: 'action_result', action: 'pet_adventure', ok: false, msg: pet.name + ' å¿ƒæƒ…å¤ªå·®äº†ï¼Œå…ˆå®‰æŠšä¸€ä¸‹å§' });
        return;
    }
    // æ´¾å‡ºå¯»å® 15åˆ†é’Ÿ
    pet.adventureEndTime = now + 15 * 60 * 1000;
    pet._notifiedAdventure = false;
    pet.mood = Math.max(0, pet.mood - 5);  // å¯»å®æ¶ˆè€—ä¸€ç‚¹å¿ƒæƒ…
    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'pet_adventure', null, 1);
    safeSend(p.ws, {
        type: 'action_result', action: 'pet_adventure', ok: true,
        msg: pet.speciesIcon + ' ' + pet.name + ' å‡ºé—¨å¯»å®äº†ï¼15åˆ†é’Ÿåå›æ¥',
        pets: playerData.pets,
        petId: petId
    });
    broadcastToTiandao({ type: 'td_pet_adventure', worldId: p.worldId, username: username, petName: pet.name, petSpecies: pet.species });
};

actions['pet_collect'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var worldData = loadWorldData(p.worldId);
    var petId = payload.petId;
    var pet = playerData.pets.find(function (pt) { return pt.id === petId; });
    if (!pet) {
        safeSend(p.ws, { type: 'action_result', action: 'pet_collect', ok: false, msg: 'å® ç‰©ä¸å­˜åœ¨' });
        return;
    }
    var now = Date.now();
    if (!pet.adventureEndTime || now < pet.adventureEndTime) {
        if (pet.adventureEndTime) {
            var remainMs = pet.adventureEndTime - now;
            var remainMin = Math.ceil(remainMs / 60000);
            safeSend(p.ws, { type: 'action_result', action: 'pet_collect', ok: false, msg: pet.name + ' è¿˜æ²¡å›æ¥ï¼Œè¿˜éœ€' + remainMin + 'åˆ†é’Ÿ' });
        } else {
            safeSend(p.ws, { type: 'action_result', action: 'pet_collect', ok: false, msg: pet.name + ' æ²¡æœ‰åœ¨å¯»å®' });
        }
        return;
    }

    // æ”¶é›†å¯»å®ç»“æœ
    pet.adventureEndTime = 0;
    pet._notifiedAdventure = false;
    pet.totalAdventures = (pet.totalAdventures || 0) + 1;
    pet.lastInteraction = now;

    var rewards = [];
    var roll = Math.random();

    // æ”¶é›†ä¸–ç•Œä¸­æ‰€æœ‰å¯ç”¨çš„ç§å­å’Œæœå®
    var allSeeds = [];
    var allFruits = [];
    if (worldData && worldData.wildAreas) {
        worldData.wildAreas.forEach(function (area) {
            if (area.seeds) {
                area.seeds.forEach(function (s) { allSeeds.push(s); });
            }
        });
    }
    // ä»ç©å®¶å·²æœ‰æœå®ç±»å‹ä¸­æ”¶é›†
    if (playerData.fruits) {
        playerData.fruits.forEach(function (f) { allFruits.push(f); });
    }
    // ä¹Ÿä»å•†åº—ç§å­ä¸­æ”¶é›†æœå®ä¿¡æ¯
    if (worldData && worldData.shop && worldData.shop.items) {
        worldData.shop.items.forEach(function (it) {
            if (it.seedData) {
                allFruits.push({
                    id: it.seedData.fruitId,
                    name: it.seedData.fruitName,
                    icon: it.seedData.fruitIcon || 'ğŸ',
                    value: it.seedData.fruitValue || 10
                });
            }
        });
    }

    // 40% æ¦‚ç‡è·å¾—ç§å­
    if (Math.random() < 0.4 && allSeeds.length > 0) {
        var seedCount = 1 + Math.floor(Math.random() * 3);  // 1~3ä¸ª
        var pickedSeed = allSeeds[Math.floor(Math.random() * allSeeds.length)];
        var existingSeed = playerData.seeds.find(function (s) { return s.id === pickedSeed.id; });
        if (existingSeed) {
            existingSeed.count += seedCount;
        } else {
            playerData.seeds.push({
                id: pickedSeed.id, name: pickedSeed.name, icon: pickedSeed.icon || 'ğŸŒ±',
                count: seedCount, growTime: pickedSeed.growTime || 7200000,
                fruitId: pickedSeed.fruitId, fruitName: pickedSeed.fruitName,
                fruitIcon: pickedSeed.fruitIcon || 'ğŸ', fruitValue: pickedSeed.fruitValue || 10,
                fruitDesc: pickedSeed.fruitDesc || '',
                source: 'pet_adventure'
            });
        }
        rewards.push((pickedSeed.icon || 'ğŸŒ±') + pickedSeed.name + ' x' + seedCount);
    }

    // 50% æ¦‚ç‡è·å¾—é‡‘å¸
    if (Math.random() < 0.5) {
        var moneyGain = 2 + Math.floor(Math.random() * 19);  // 2~20
        playerData.money += moneyGain;
        // æå‡å® ç‰©ä»·å€¼ï¼ˆè·å¾—é‡‘å¸çš„ä¸€åŠï¼‰
        var valueGain = Math.floor(moneyGain / 2);
        pet.value = (pet.value || 0) + valueGain;
        rewards.push('ğŸ’°' + moneyGain + 'é‡‘å¸ï¼ˆå® ç‰©ä»·å€¼+' + valueGain + 'ï¼‰');
    }

    // 35% æ¦‚ç‡è·å¾—æœå®
    if (Math.random() < 0.35) {
        var fruitSources = allFruits.length > 0 ? allFruits : [{ id: 'wild_berry', name: 'é‡æœ', icon: 'ğŸ«', value: 3 }];
        // å»é‡
        var uniqueFruits = [];
        var fruitIds = {};
        fruitSources.forEach(function (f) {
            if (!fruitIds[f.id]) { fruitIds[f.id] = true; uniqueFruits.push(f); }
        });
        var fruitCount = 1 + Math.floor(Math.random() * 3);  // 1~3ä¸ª
        var pickedFruit = uniqueFruits[Math.floor(Math.random() * uniqueFruits.length)];
        var existingFruit = playerData.fruits.find(function (f) { return f.id === pickedFruit.id; });
        if (existingFruit) {
            existingFruit.count += fruitCount;
        } else {
            playerData.fruits.push({
                id: pickedFruit.id, name: pickedFruit.name,
                icon: pickedFruit.icon || 'ğŸ', count: fruitCount,
                value: pickedFruit.value || 5
            });
        }
        rewards.push((pickedFruit.icon || 'ğŸ') + pickedFruit.name + ' x' + fruitCount);
    }

    // å¿ƒæƒ…æ¢å¤ä¸€ç‚¹ï¼ˆå¯»å®å›æ¥å¼€å¿ƒï¼‰
    pet.mood = Math.min(100, pet.mood + 3);

    savePlayer(username, p.worldId, playerData);
    triggerDailyTaskCheck(username, p.worldId, 'pet_collect', null, 1);
    triggerDailyTaskCheck(username, p.worldId, 'earn_money', null, moneyGain || 0);
    var rewardMsg = rewards.length > 0 ? rewards.join('ã€') : 'ä»€ä¹ˆä¹Ÿæ²¡æ‰¾åˆ°';
    safeSend(p.ws, {
        type: 'action_result', action: 'pet_collect', ok: true,
        msg: pet.speciesIcon + ' ' + pet.name + ' å¯»å®å½’æ¥ï¼å¸¦å›äº†ï¼š' + rewardMsg,
        pets: playerData.pets,
        seeds: playerData.seeds,
        fruits: playerData.fruits,
        money: playerData.money,
        petId: petId
    });
    broadcastToTiandao({ type: 'td_pet_collect', worldId: p.worldId, username: username, petName: pet.name, rewards: rewardMsg });
};

actions['pet_interact'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var petId = payload.petId;
    var pet = playerData.pets.find(function (pt) { return pt.id === petId; });
    if (!pet) {
        safeSend(p.ws, { type: 'action_result', action: 'pet_interact', ok: false, msg: 'å® ç‰©ä¸å­˜åœ¨' });
        return;
    }
    var now = Date.now();
    // äº’åŠ¨å†·å´ï¼šåˆ†é’Ÿ
    if (pet.lastInteraction && now - pet.lastInteraction < 2 * 60 * 1000) {
        var cdRemain = Math.ceil((2 * 60 * 1000 - (now - pet.lastInteraction)) / 60000);
        safeSend(p.ws, { type: 'action_result', action: 'pet_interact', ok: false, msg: 'åˆšäº’åŠ¨è¿‡ï¼Œ' + cdRemain + 'åˆ†é’Ÿåå†æ¥' });
        return;
    }
    pet.mood = Math.min(100, (pet.mood || 0) + 15);
    pet.lastInteraction = now;
    savePlayer(username, p.worldId, playerData);

    var reactions = ['å¼€å¿ƒåœ°è¹­äº†è¹­ä½ ', 'é¡¶äº†é¡¶ä½ ', 'ä¸€åŠ¨ä¸åŠ¨çœ‹ç€ä½ '];
    var reaction = reactions[Math.floor(Math.random() * reactions.length)];
    safeSend(p.ws, {
        type: 'action_result', action: 'pet_interact', ok: true,
        msg: pet.speciesIcon + ' ' + pet.name + ' ' + reaction + 'ï¼ˆå¿ƒæƒ…+15ï¼Œå½“å‰' + pet.mood + 'ï¼‰',
        pets: playerData.pets,
        petId: petId
    });
};

actions['release_pet'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var petId = payload.petId;
    var petIdx = playerData.pets.findIndex(function (pt) { return pt.id === petId; });
    if (petIdx === -1) {
        safeSend(p.ws, { type: 'action_result', action: 'release_pet', ok: false, msg: 'å® ç‰©ä¸å­˜åœ¨' });
        return;
    }
    var pet = playerData.pets[petIdx];
    // æ”¾ç”Ÿè·å¾—ä¸€åŠä»·å€¼çš„é‡‘å¸
    var refund = Math.floor((pet.value || 0) / 2);
    playerData.money += refund;
    playerData.pets.splice(petIdx, 1);
    savePlayer(username, p.worldId, playerData);
    safeSend(p.ws, {
        type: 'action_result', action: 'release_pet', ok: true,
        msg: pet.speciesIcon + ' ' + pet.name + ' è¢«æ”¾å½’è‡ªç„¶äº†' + (refund > 0 ? 'ï¼Œè·å¾—ğŸ’°' + refund : ''),
        pets: playerData.pets,
        money: playerData.money
    });
    broadcastToTiandao({ type: 'td_release_pet', worldId: p.worldId, username: username, petName: pet.name, petSpecies: pet.species, refund: refund });
};

// ============================================================
//  äº¤æ˜“ç³»ç»Ÿ
// ============================================================
actions['trade_create'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var playerData = getOrCreatePlayer(username, p.worldId);
    var to = payload.to;
    if (!to || to === username) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'æ— æ•ˆçš„äº¤æ˜“å¯¹è±¡' }); return; }
    var accounts = loadAccounts();
    if (!accounts[to]) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'ç”¨æˆ·ä¸å­˜åœ¨' }); return; }
    var offerType = payload.offerType;
    var offerId = payload.offerId;
    var offerCount = parseInt(payload.offerCount) || 1;
    var offerItem = null;
    var offerName = '';
    if (offerType === 'seed') {
        offerItem = playerData.seeds.find(function (s) { return s.id === offerId; });
        if (!offerItem) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§ç§å­' }); return; }
        if (offerItem.count < offerCount) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'ç§å­æ•°é‡ä¸è¶³' }); return; }
        offerName = offerItem.name;
    } else if (offerType === 'fruit') {
        offerItem = playerData.fruits.find(function (f) { return f.id === offerId; });
        if (!offerItem) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ç§æœå®' }); return; }
        if (offerItem.count < offerCount) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'æœå®æ•°é‡ä¸è¶³' }); return; }
        offerName = offerItem.name;
    } else if (offerType === 'money') {
        if (playerData.money < offerCount) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'é‡‘å¸ä¸è¶³ï¼ˆå½“å‰' + playerData.money + 'ï¼‰' }); return; }
        offerId = 'money';
        offerName = 'é‡‘å¸';
    } else if (offerType === 'pet') {
        var petItem = playerData.pets.find(function (pt) { return pt.id === offerId; });
        if (!petItem) { safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ä¸ªå® ç‰©' }); return; }
        offerName = petItem.species + 'Â·' + petItem.name;
    } else {
        safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: false, msg: 'æ— æ•ˆçš„ç‰©å“ç±»å‹' }); return;
    }

    //é¢„æ‰£ç‰©å“ï¼Œé˜²æ­¢é‡å¤äº¤æ˜“åˆ·ç‰©å“
    if (offerType === 'seed') {
        offerItem.count -= offerCount;
        if (offerItem.count <= 0) {
            var seedIdx = playerData.seeds.indexOf(offerItem);
            if (seedIdx !== -1) playerData.seeds.splice(seedIdx, 1);
        }
    } else if (offerType === 'fruit') {
        offerItem.count -= offerCount;
        if (offerItem.count <= 0) {
            var fruitIdx = playerData.fruits.indexOf(offerItem);
            if (fruitIdx !== -1) playerData.fruits.splice(fruitIdx, 1);
        }
    } else if (offerType === 'money') {
        playerData.money -= offerCount;
    } else if (offerType === 'pet') {
        var petIdx = playerData.pets.findIndex(function (pt) { return pt.id === offerId; });
        if (petIdx !== -1) playerData.pets.splice(petIdx, 1);
    }
    savePlayer(username, p.worldId, playerData);

    var trades = loadTrades();
    var tid = genTradeId();
    trades[tid] = {
        id: tid, from: username, to: to, worldId: p.worldId,
        offerType: offerType, offerId: offerId, offerName: offerName, offerCount: offerCount,
        wantType: payload.wantType || 'fruit', wantId: payload.wantId || '', wantName: payload.wantName || 'ä»»æ„', wantCount: parseInt(payload.wantCount) || 1,
        status: 'pending', createdAt: Date.now(),
        _petSnapshot: offerType === 'pet' ? JSON.parse(JSON.stringify(playerData.pets.find(function (pt) { return pt.id === offerId; }) || {})) : null
    };
    saveTrades(trades);
    safeSend(p.ws, { type: 'action_result', action: 'trade_create', ok: true, msg: 'äº¤æ˜“è¯·æ±‚å·²å‘é€ç»™ ' + to + 'ï¼ˆç‰©å“å·²æš‚æ‰£ï¼‰', trade: trades[tid], money: playerData.money, seeds: playerData.seeds, fruits: playerData.fruits });
    if (onlinePlayers[to]) {
        safeSend(onlinePlayers[to].ws, { type: 'trade_incoming', trade: trades[tid] });
    }
};

actions['trade_list'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var trades = loadTrades();
    var myTrades = [];
    for (var tid in trades) {
        var t = trades[tid];
        if ((t.from === username || t.to === username) && t.status === 'pending') myTrades.push(t);
    }
    safeSend(p.ws, { type: 'action_result', action: 'trade_list', ok: true, trades: myTrades });
};

actions['trade_accept'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var trades = loadTrades();
    var t = trades[payload.tradeId];
    if (!t || t.to !== username || t.status !== 'pending') {
        safeSend(p.ws, { type: 'action_result', action: 'trade_accept', ok: false, msg: 'äº¤æ˜“ä¸å­˜åœ¨æˆ–å·²å¤„ç†' }); return;
    }
    var fromData = getOrCreatePlayer(t.from, t.worldId);
    var toData = getOrCreatePlayer(t.to, t.worldId);

    // å‘èµ·è€…çš„ç‰©å“å·²ç»åœ¨åˆ›å»ºæ—¶é¢„æ‰£äº†ï¼Œä¸éœ€è¦å†æ£€æŸ¥
    // åªéœ€è¦æ£€æŸ¥æ¥å—è€…æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç‰©å“

    var toOk = false;
    if (t.wantType === 'money') {
        toOk = toData.money >= t.wantCount;
    } else if (t.wantType === 'seed') {
        var ts = toData.seeds.find(function (s) { return s.id === t.wantId || s.name === t.wantId; });
        toOk = ts && ts.count >= t.wantCount;
        if (ts) t.wantId = ts.id;
    } else if (t.wantType === 'fruit') {
        var tf = toData.fruits.find(function (f) { return f.id === t.wantId || f.name === t.wantId; });
        toOk = tf && tf.count >= t.wantCount;
        if (tf) t.wantId = tf.id;
    } else if (t.wantType === 'pet') {
        var tp2 = toData.pets.find(function (pt) { return pt.id === t.wantId || pt.name === t.wantId; });
        toOk = !!tp2;
        if (tp2) t.wantId = tp2.id;
    } else if (t.wantType === 'any') {
        toOk = true;
    }
    if (!toOk) {
        safeSend(p.ws, { type: 'action_result', action: 'trade_accept', ok: false, msg: 'ä½ æ²¡æœ‰è¶³å¤Ÿçš„ ' + t.wantName + ' æ¥å®Œæˆäº¤æ˜“' }); return;
    }

    // å® ç‰©å®¹é‡æ£€æŸ¥
    if (t.offerType === 'pet' && toData.pets.length >= 6) {
        safeSend(p.ws, { type: 'action_result', action: 'trade_accept', ok: false, msg: 'ä½ çš„å® ç‰©å·²æ»¡ï¼ˆ6åªï¼‰ï¼Œæ— æ³•æ¥æ”¶å® ç‰©' });
        return;
    }
    if (t.wantType === 'pet' && fromData.pets.length >= 6) {
        safeSend(p.ws, { type: 'action_result', action: 'trade_accept', ok: false, msg: 'å¯¹æ–¹å® ç‰©å·²æ»¡ï¼ˆ6åªï¼‰ï¼Œæ— æ³•å®Œæˆäº¤æ˜“' });
        return;
    }

    // ä¿å­˜ç‰©å“ä¿¡æ¯ç”¨äºè½¬ç§»
    var offerItemInfo = null;
    var wantItemInfo = null;

    // å‘èµ·è€…çš„ç‰©å“å·²é¢„æ‰£ï¼Œä»äº¤æ˜“è®°å½•ä¸­æ¢å¤ä¿¡æ¯å³å¯
    // å¯¹äºç§å­å’Œæœå®ï¼Œéœ€è¦ä»ä¸–ç•Œæ•°æ®æˆ–äº¤æ˜“è®°å½•ä¸­è·å–å®Œæ•´ä¿¡æ¯
    if (t.offerType === 'seed') {
        // å°è¯•ä»å‘èµ·è€…å‰©ä½™ç§å­ä¸­æ‰¾åŒç±»å‹çš„å®Œæ•´ä¿¡æ¯
        var existOffer = fromData.seeds.find(function (s) { return s.id === t.offerId; });
        if (existOffer) {
            offerItemInfo = JSON.parse(JSON.stringify(existOffer));
        } else {
            // ä»ä¸–ç•Œæ•°æ®ä¸­æŸ¥æ‰¾
            var worldData = loadWorldData(t.worldId);
            if (worldData && worldData.wildAreas) {
                worldData.wildAreas.forEach(function (area) {
                    if (area.seeds) {
                        var found = area.seeds.find(function (s) { return s.id === t.offerId; });
                        if (found) offerItemInfo = JSON.parse(JSON.stringify(found));
                    }
                });
            }
            if (!offerItemInfo && worldData && worldData.shop && worldData.shop.items) {
                var shopSeed = worldData.shop.items.find(function (si) { return si.seedData && si.seedData.id === t.offerId; });
                if (shopSeed) offerItemInfo = JSON.parse(JSON.stringify(shopSeed.seedData));
            }
        }
    } else if (t.offerType === 'fruit') {
        var existOfferF = fromData.fruits.find(function (f) { return f.id === t.offerId; });
        if (existOfferF) offerItemInfo = JSON.parse(JSON.stringify(existOfferF));
    } else if (t.offerType === 'pet') {
        // å® ç‰©å·²ä»å‘èµ·è€…ç§»é™¤ï¼Œä¿¡æ¯éœ€è¦ä»äº¤æ˜“è®°å½•æ¢å¤
        // è¿™é‡Œæˆ‘ä»¬åœ¨åˆ›å»ºäº¤æ˜“æ—¶åº”è¯¥ä¿å­˜å® ç‰©å¿«ç…§ï¼Œä½†å½“å‰æ²¡æœ‰
        // æ‰€ä»¥ç”¨ offerId å’Œ offerName é‡å»ºåŸºæœ¬ä¿¡æ¯
        offerItemInfo = { id: t.offerId, species: t.offerName.split('Â·')[0] || '?', name: t.offerName.split('Â·')[1] || '?', speciesIcon: 'ğŸ¾', rarity: 'common', mood: 100, value: 0 };
    }

    if (t.wantType === 'seed') {
        var wts = toData.seeds.find(function (s) { return s.id === t.wantId; });
        if (wts) wantItemInfo = JSON.parse(JSON.stringify(wts));
    } else if (t.wantType === 'fruit') {
        var wtf = toData.fruits.find(function (f) { return f.id === t.wantId; });
        if (wtf) wantItemInfo = JSON.parse(JSON.stringify(wtf));
    } else if (t.wantType === 'pet') {
        var wtp = toData.pets.find(function (pt) { return pt.id === t.wantId; });
        if (wtp) wantItemInfo = JSON.parse(JSON.stringify(wtp));
    }

    //å‘èµ·è€…ç‰©å“å·²é¢„æ‰£ï¼Œç›´æ¥ç»™æ¥å—è€…
    transferItemWithInfo(toData, t.offerType, t.offerId, t.offerCount, offerItemInfo);

    // æ‰£é™¤æ¥å—è€…çš„ç‰©å“ï¼Œç»™å‘èµ·è€…
    if (t.wantType !== 'any') {
        transferItem(toData, t.wantType, t.wantId, t.wantCount, false);
        transferItemWithInfo(fromData, t.wantType, t.wantId, t.wantCount, wantItemInfo);
    }

    t.status = 'completed';
    saveTrades(trades);
    savePlayer(t.from, t.worldId, fromData);
    savePlayer(t.to, t.worldId, toData);

    safeSend(p.ws, { type: 'action_result', action: 'trade_accept', ok: true, msg: 'äº¤æ˜“å®Œæˆï¼', seeds: toData.seeds, fruits: toData.fruits, money: toData.money });
    if (onlinePlayers[t.from]) {
        safeSend(onlinePlayers[t.from].ws, { type: 'trade_completed', trade: t, seeds: fromData.seeds, fruits: fromData.fruits, money: fromData.money });
    }
    broadcastToTiandao({ type: 'td_trade', worldId: t.worldId, from: t.from, to: t.to, offer: t.offerName, want: t.wantName });
};

actions['trade_reject'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var trades = loadTrades();
    var t = trades[payload.tradeId];
    if (!t || t.to !== username || t.status !== 'pending') {
        safeSend(p.ws, { type: 'action_result', action: 'trade_reject', ok: false, msg: 'äº¤æ˜“ä¸å­˜åœ¨æˆ–å·²å¤„ç†' }); return;
    }
    t.status = 'rejected';
    saveTrades(trades);

    //é€€è¿˜å‘èµ·è€…çš„ç‰©å“
    refundTradeOffer(t);

    safeSend(p.ws, { type: 'action_result', action: 'trade_reject', ok: true, msg: 'å·²æ‹’ç»äº¤æ˜“' });
    if (onlinePlayers[t.from]) {
        var fromData = getOrCreatePlayer(t.from, t.worldId);
        safeSend(onlinePlayers[t.from].ws, { type: 'trade_rejected', trade: t, money: fromData.money, seeds: fromData.seeds, fruits: fromData.fruits });
    }
};

actions['trade_cancel'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    var trades = loadTrades();
    var t = trades[payload.tradeId];
    if (!t || t.from !== username || t.status !== 'pending') {
        safeSend(p.ws, { type: 'action_result', action: 'trade_cancel', ok: false, msg: 'äº¤æ˜“ä¸å­˜åœ¨æˆ–å·²å¤„ç†' }); return;
    }
    t.status = 'cancelled';
    saveTrades(trades);

    //é€€è¿˜å‘èµ·è€…çš„ç‰©å“
    refundTradeOffer(t);

    var playerData = getOrCreatePlayer(username, p.worldId);
    safeSend(p.ws, { type: 'action_result', action: 'trade_cancel', ok: true, msg: 'å·²å–æ¶ˆäº¤æ˜“ï¼Œç‰©å“å·²é€€è¿˜', money: playerData.money, seeds: playerData.seeds, fruits: playerData.fruits });
    if (onlinePlayers[t.to]) {
        safeSend(onlinePlayers[t.to].ws, { type: 'trade_cancelled', trade: t });
    }
};

// ============================================================
//  è£…é¥°ç³»ç»Ÿ
// ============================================================
actions['place_decoration'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;
    if (p.visitingFarm) {
        safeSend(p.ws, { type: 'action_result', action: 'place_decoration', ok: false, msg: 'ä¸èƒ½åœ¨åˆ«äººå†œåœºæ”¾ç½®è£…é¥°' });
        return;
    }

    var playerData = getOrCreatePlayer(username, p.worldId);
    var itemId = payload.itemId;
    var position = payload.position || { x: 0, y: 0 };

    // æ£€æŸ¥æ˜¯å¦æœ‰è¿™ä¸ªè£…é¥°ç‰©é“å…·
    var itemIdx = playerData.items.findIndex(function (it) {
        return it.id === itemId && it.type === 'decoration';
    });

    if (itemIdx === -1) {
        safeSend(p.ws, { type: 'action_result', action: 'place_decoration', ok: false, msg: 'ä½ æ²¡æœ‰è¿™ä¸ªè£…é¥°ç‰©' });
        return;
    }

    var item = playerData.items[itemIdx];

    // æ£€æŸ¥æ”¾ç½®æ•°é‡
    var placedCount = playerData.decorations.filter(function (d) { return d.id === itemId; }).length;
    if (placedCount >= item.count) {
        safeSend(p.ws, { type: 'action_result', action: 'place_decoration', ok: false, msg: 'ä½ å·²ç»æ”¾å®Œæ‰€æœ‰è¿™ä¸ªè£…é¥°ç‰©äº†' });
        return;
    }

    // æ·»åŠ è£…é¥°ç‰©
    playerData.decorations.push({
        id: itemId,
        name: item.name,
        icon: item.icon || 'ğŸ¨',
        x: position.x,
        y: position.y,
        placedAt: Date.now()
    });

    savePlayer(username, p.worldId, playerData);

    safeSend(p.ws, {
        type: 'action_result',
        action: 'place_decoration',
        ok: true,
        msg: 'æ”¾ç½®äº† ' + item.name,
        decorations: playerData.decorations
    });
};

// æ”¶èµ·è£…é¥°ç‰©
actions['remove_decoration'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    var playerData = getOrCreatePlayer(username, p.worldId);
    var decorationId = payload.decorationId;

    var idx = playerData.decorations.findIndex(function (d) { return d.id === decorationId; });
    if (idx === -1) {
        safeSend(p.ws, { type: 'action_result', action: 'remove_decoration', ok: false, msg: 'è£…é¥°ç‰©ä¸å­˜åœ¨' });
        return;
    }

    playerData.decorations.splice(idx, 1);
    savePlayer(username, p.worldId, playerData);

    safeSend(p.ws, {
        type: 'action_result',
        action: 'remove_decoration',
        ok: true,
        msg: 'æ”¶èµ·äº†è£…é¥°ç‰©',
        decorations: playerData.decorations
    });
};

// ============================================================
//  å¥‡é‡ç³»ç»Ÿ
// ============================================================
// åœ¨æœåŠ¡å™¨ç«¯.js ä¸­ï¼Œæ‰¾åˆ° triggerAdventure å‡½æ•°
function triggerAdventure(username, worldId, playerData, actionType) {
    var worldData = loadWorldData(worldId);
    if (!worldData || !worldData.adventures || worldData.adventures.length === 0) return null;

    // æŒ‰æƒé‡éšæœºé€‰æ‹©å¥‡é‡
    var adventures = worldData.adventures;
    var totalWeight = 0;
    for (var i = 0; i < adventures.length; i++) {
        totalWeight += (adventures[i].weight || 10);
    }

    var roll = Math.random() * totalWeight;
    var cumulative = 0;
    var selected = null;

    for (var i = 0; i < adventures.length; i++) {
        cumulative += (adventures[i].weight || 10);
        if (roll < cumulative) {
            selected = adventures[i];
            break;
        }
    }

    if (!selected) return null;

    // åº”ç”¨å¥‡é‡æ•ˆæœ
    var rewards = [];
    var adventureResult = {
        text: selected.text || 'ä½ é‡åˆ°äº†å¥‡å¦™çš„äº‹æƒ…...',
        rewards: []
    };

    if (selected.rewards) {
        for (var j = 0; j < selected.rewards.length; j++) {
            var rew = selected.rewards[j];

            if (rew.type === 'money') {
                var amount = rew.amount || 0;
                playerData.money += amount;
                rewards.push('ğŸ’°' + amount + 'é‡‘å¸');
            }
            else if (rew.type === 'seed') {
                if (rew.data) {
                    var seedData = rew.data;
                    var existingSeed = playerData.seeds.find(function (s) { return s.id === seedData.id; });
                    if (existingSeed) {
                        existingSeed.count += (seedData.count || 1);
                    } else {
                        var seedCopy = JSON.parse(JSON.stringify(seedData));
                        seedCopy.count = seedData.count || 1;
                        seedCopy.source = 'adventure';
                        playerData.seeds.push(seedCopy);
                    }
                    rewards.push((seedData.icon || 'ğŸŒ±') + seedData.name + ' x' + (seedData.count || 1));
                }
            }
            else if (rew.type === 'fruit') {
                if (rew.data) {
                    var fruitData = rew.data;
                    var existingFruit = playerData.fruits.find(function (f) { return f.id === fruitData.id; });
                    if (existingFruit) {
                        existingFruit.count += (fruitData.count || 1);
                    } else {
                        playerData.fruits.push(JSON.parse(JSON.stringify(fruitData)));
                    }
                    rewards.push((fruitData.icon || 'ğŸ') + fruitData.name + ' x' + (fruitData.count || 1));
                }
            }
            else if (rew.type === 'pet_mood') {
                //ä¿®æ”¹ç‚¹ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å® ç‰©
                var moodChange = rew.amount || 10;
                if (playerData.pets && playerData.pets.length > 0) {
                    for (var k = 0; k < playerData.pets.length; k++) {
                        playerData.pets[k].mood = Math.min(100, (playerData.pets[k].mood || 0) + moodChange);
                    }
                    rewards.push('æ‰€æœ‰å® ç‰©å¿ƒæƒ… +' + moodChange);
                } else {
                    // å¦‚æœæ²¡æœ‰å® ç‰©ï¼Œæ”¹æˆä½“åŠ›å¥–åŠ±
                    playerData.stamina = Math.min(playerData.staminaMax, (playerData.stamina || 0) + moodChange);
                    rewards.push('âš¡ä½“åŠ› +' + moodChange + 'ï¼ˆä½ æ²¡æœ‰å® ç‰©ï¼Œè½¬åŒ–ä¸ºä½“åŠ›ï¼‰');
                }
            }
            else if (rew.type === 'stamina') {
                var staminaAmount = rew.amount || 10;
                playerData.stamina = Math.min(playerData.staminaMax, (playerData.stamina || 0) + staminaAmount);
                rewards.push('âš¡ä½“åŠ› +' + staminaAmount);
            }
        }
    }

    adventureResult.rewards = rewards;
    savePlayer(username, worldId, playerData);

    broadcastToTiandao({
        type: 'td_adventure',
        worldId: worldId,
        username: username,
        adventureText: selected.text,
        rewards: rewards,
        actionType: actionType
    });

    return adventureResult;
}

// ============================================================
//  äº¤æ˜“ç‰©å“è½¬ç§»å·¥å…·å‡½æ•°
// ============================================================

function transferItem(playerData, type, id, count, isAdd) {
    if (type === 'money') {
        if (isAdd) playerData.money += count;
        else playerData.money -= count;
        return;
    }
    if (type === 'pet') {
        if (!isAdd) {
            var petIdx = playerData.pets.findIndex(function (pt) { return pt.id === id; });
            if (petIdx !== -1) playerData.pets.splice(petIdx, 1);
        }
        return;
    }
    var arr = type === 'seed' ? playerData.seeds : playerData.fruits;
    if (isAdd) {
        var existing = arr.find(function (it) { return it.id === id; });
        if (existing) { existing.count += count; }
        else { arr.push({ id: id, name: '?', icon: '?', count: count, value: 0 }); }
    } else {
        var idx = arr.findIndex(function (it) { return it.id === id; });
        if (idx !== -1) {
            arr[idx].count -= count;
            if (arr[idx].count <= 0) arr.splice(idx, 1);
        }
    }
}

function transferItemWithInfo(playerData, type, id, count, itemInfo) {
    if (type === 'money') {
        playerData.money += count;
        return;
    }
    if (type === 'pet') {
        if (itemInfo) {
            var petCopy = JSON.parse(JSON.stringify(itemInfo));
            petCopy.id = generatePetId();  // ç»™æ–°ä¸»äººç”Ÿæˆæ–°ID
            playerData.pets.push(petCopy);
        }
        return;
    }
    var arr = type === 'seed' ? playerData.seeds : playerData.fruits;
    var existing = arr.find(function (it) { return it.id === id; });
    if (existing) {
        existing.count += count;
    } else if (itemInfo) {
        var newItem = JSON.parse(JSON.stringify(itemInfo));
        newItem.count = count;
        arr.push(newItem);
    } else {
        arr.push({ id: id, name: 'æœªçŸ¥ç‰©å“', icon: 'â“', count: count, value: 0 });
    }
}

//é€€è¿˜äº¤æ˜“å‘èµ·è€…çš„é¢„æ‰£ç‰©å“
function refundTradeOffer(trade) {
    var fromData = getOrCreatePlayer(trade.from, trade.worldId);
    if (trade.offerType === 'money') {
        fromData.money += trade.offerCount;
    } else if (trade.offerType === 'seed') {
        var existingSeed = fromData.seeds.find(function (s) { return s.id === trade.offerId; });
        if (existingSeed) {
            existingSeed.count += trade.offerCount;
        } else {
            // ç§å­ä¿¡æ¯ä¸å®Œæ•´æ—¶ï¼Œä»ä¸–ç•Œæ•°æ®æ¢å¤
            var worldData = loadWorldData(trade.worldId);
            var seedInfo = null;
            if (worldData && worldData.wildAreas) {
                worldData.wildAreas.forEach(function (area) {
                    if (area.seeds) {
                        var found = area.seeds.find(function (s) { return s.id === trade.offerId; });
                        if (found) seedInfo = found;
                    }
                });
            }
            if (!seedInfo && worldData && worldData.shop && worldData.shop.items) {
                var shopSeed = worldData.shop.items.find(function (si) { return si.seedData && si.seedData.id === trade.offerId; });
                if (shopSeed) seedInfo = shopSeed.seedData;
            }
            if (seedInfo) {
                fromData.seeds.push({
                    id: seedInfo.id, name: seedInfo.name, icon: seedInfo.icon || 'ğŸŒ±',
                    count: trade.offerCount, growTime: seedInfo.growTime || 7200000,
                    fruitId: seedInfo.fruitId, fruitName: seedInfo.fruitName,
                    fruitIcon: seedInfo.fruitIcon || 'ğŸ', fruitValue: seedInfo.fruitValue || 10,
                    fruitDesc: seedInfo.fruitDesc || '', source: 'trade_refund'
                });
            } else {
                fromData.seeds.push({ id: trade.offerId, name: trade.offerName || '?', icon: 'ğŸŒ±', count: trade.offerCount, growTime: 7200000, fruitId: trade.offerId + '_fruit', fruitName: '?', fruitIcon: 'ğŸ', fruitValue: 10, source: 'trade_refund' });
            }
        }
    } else if (trade.offerType === 'fruit') {
        var existingFruit = fromData.fruits.find(function (f) { return f.id === trade.offerId; });
        if (existingFruit) {
            existingFruit.count += trade.offerCount;
        } else {
            fromData.fruits.push({ id: trade.offerId, name: trade.offerName || '?', icon: 'ğŸ', count: trade.offerCount, value: 0 });
        }
    } else if (trade.offerType === 'pet') {
        if (trade._petSnapshot && trade._petSnapshot.species) {
            var petCopy = JSON.parse(JSON.stringify(trade._petSnapshot));
            petCopy.id = generatePetId();
            fromData.pets.push(petCopy);
        } else {
            // é™çº§å¤„ç†
            fromData.pets.push({
                id: generatePetId(),
                species: (trade.offerName || '').split('Â·')[0] || '?',
                speciesIcon: 'ğŸ¾', name: (trade.offerName || '').split('Â·')[1] || '?',
                rarity: 'common', mood: 100, value: 0,
                createdAt: Date.now(), lastInteraction: Date.now(),
                adventureEndTime: 0, totalAdventures: 0
            });
        }
    }
    savePlayer(trade.from, trade.worldId, fromData);
}

function cleanOldTrades() {
    var trades = loadTrades();
    var keys = Object.keys(trades);
    if (keys.length === 0) return; // æ²¡æœ‰äº¤æ˜“ï¼Œç›´æ¥è·³è¿‡

    var now = Date.now();
    var toDelete = [];
    for (var i = 0; i < keys.length; i++) {
        var tid = keys[i];
        var t = trades[tid];
        if (t.status === 'pending' && now - t.createdAt > 86400000) {
            toDelete.push(tid);
        } else if (t.status !== 'pending' && now - t.createdAt > 259200000) {
            toDelete.push(tid);
        }
    }
    if (toDelete.length > 0) {
        for (var j = 0; j < toDelete.length; j++) {
            delete trades[toDelete[j]];
        }
        saveTrades(trades);
        console.log('[äº¤æ˜“æ¸…ç†] æ¸…ç†äº†', toDelete.length, 'æ¡è¿‡æœŸäº¤æ˜“');
    }
}

function cleanupAccountData(username) {
    try {
        var files = fs.readdirSync(PLAYERS_DIR);
        files.forEach(function (f) {
            if (f.startsWith(username + '_') && f.endsWith('.json')) {
                var fp = path.join(PLAYERS_DIR, f);
                fs.unlinkSync(fp);
                invalidateCache(fp);
            }
        });
    } catch (e) { console.error('[æ¸…ç†ç©å®¶æ–‡ä»¶]', e.message); }

    var allFriends = loadFriends();
    delete allFriends[username];
    for (var u in allFriends) {
        var fd = allFriends[u];
        fd.friends = fd.friends.filter(function (f) { return f !== username; });
        fd.requests = fd.requests.filter(function (r) { return r !== username; });
        if (fd.blocked) fd.blocked = fd.blocked.filter(function (b) { return b !== username; });
    }
    saveFriends(allFriends);

    var groups = loadGroups();
    for (var gid in groups) {
        var g = groups[gid];
        g.members = g.members.filter(function (m) { return m !== username; });
        if (g.members.length === 0) { delete groups[gid]; }
        else if (g.owner === username) { g.owner = g.members[0]; }
    }
    saveGroups(groups);

    var mails = loadMails();
    delete mails[username];
    saveMails(mails);

    var trades = loadTrades();
    for (var tid in trades) {
        if (trades[tid].from === username || trades[tid].to === username) { delete trades[tid]; }
    }
    saveTrades(trades);

    var bl = loadBlacklist();
    for (var wid in bl) {
        bl[wid] = bl[wid].filter(function (e) { return e.username !== username; });
        if (bl[wid].length === 0) delete bl[wid];
    }
    saveBlacklist(bl);

    console.log('[æ¸…ç†å®Œæˆ]', username, 'çš„æ‰€æœ‰å…³è”æ•°æ®å·²åˆ é™¤');
}

// ============================================================
//  èŠ‚æ—¥æ´»åŠ¨ä»»åŠ¡ç³»ç»Ÿ
// ============================================================

// æ£€æŸ¥èŠ‚æ—¥ä»»åŠ¡è¿›åº¦
function checkHolidayTaskProgress(username, worldId, taskType, targetItemId, progressIncrement) {
    var worldData = loadWorldData(worldId);
    if (!worldData || !worldData.events || worldData.events.length === 0) return null;

    var now = Date.now();
    var playerData = getOrCreatePlayer(username, worldId);
    var anyCompleted = false;
    var completedTasks = [];

    // åˆå§‹åŒ–ç©å®¶çš„èŠ‚æ—¥ä»»åŠ¡è¿›åº¦
    if (!playerData.holidayTasks) {
        playerData.holidayTasks = {};
    }

    // éå†æ‰€æœ‰è¿›è¡Œä¸­çš„æ´»åŠ¨
    for (var e = 0; e < worldData.events.length; e++) {
        var event = worldData.events[e];

        // æ£€æŸ¥æ´»åŠ¨æ˜¯å¦è¿›è¡Œä¸­
        if (event.startTime && now < event.startTime) continue;
        if (event.endTime && now > event.endTime) continue;

        // æ£€æŸ¥æ´»åŠ¨æ˜¯å¦æœ‰ä»»åŠ¡
        if (!event.tasks || !Array.isArray(event.tasks)) continue;

        // ä¸ºè¿™ä¸ªæ´»åŠ¨åˆå§‹åŒ–è¿›åº¦
        var eventKey = event.id;
        if (!playerData.holidayTasks[eventKey]) {
            playerData.holidayTasks[eventKey] = {
                tasks: [],
                completed: false,
                claimedTitles: []  // å·²é¢†å–çš„ç§°å·ID
            };
        }

        var eventProgress = playerData.holidayTasks[eventKey];

        // éå†æ´»åŠ¨çš„æ‰€æœ‰ä»»åŠ¡
        for (var i = 0; i < event.tasks.length; i++) {
            var task = event.tasks[i];

            // å¦‚æœä»»åŠ¡ç±»å‹ä¸åŒ¹é…ï¼Œè·³è¿‡
            if (task.type !== taskType) continue;

            // å¦‚æœä»»åŠ¡æœ‰ç‰¹å®šç›®æ ‡IDä¸”ä¸åŒ¹é…ï¼Œè·³è¿‡
            if (task.targetItemId && task.targetItemId !== targetItemId) continue;

            // åˆå§‹åŒ–è¿™ä¸ªä»»åŠ¡çš„è¿›åº¦
            if (!eventProgress.tasks[i]) {
                eventProgress.tasks[i] = 0;
            }

            // å¢åŠ è¿›åº¦
            eventProgress.tasks[i] += progressIncrement || 1;

            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
            if (eventProgress.tasks[i] >= task.targetCount) {
                // ç¡®ä¿ä¸è¶…è¿‡ç›®æ ‡æ•°é‡
                eventProgress.tasks[i] = task.targetCount;

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†
                var allCompleted = true;
                for (var j = 0; j < event.tasks.length; j++) {
                    if ((eventProgress.tasks[j] || 0) < event.tasks[j].targetCount) {
                        allCompleted = false;
                        break;
                    }
                }

                if (allCompleted && !eventProgress.completed) {
                    eventProgress.completed = true;

                    // å‘æ”¾ç§°å·å¥–åŠ±
                    if (task.rewardTitle) {
                        var titleId = task.rewardTitle.titleId;
                        var titleName = task.rewardTitle.name;
                        var titleColor = task.rewardTitle.color || '#fcd34d';

                        // æ£€æŸ¥æ˜¯å¦å·²ç»é¢†è¿‡è¿™ä¸ªç§°å·
                        if (!eventProgress.claimedTitles.includes(titleId)) {
                            // ç»™ç©å®¶æ·»åŠ ç§°å·
                            if (!playerData.titles) playerData.titles = [];

                            var existingTitle = playerData.titles.find(function (t) {
                                return t.titleId === titleId && t.worldId === worldId;
                            });

                            if (!existingTitle) {
                                playerData.titles.push({
                                    titleId: titleId,
                                    titleName: titleName,
                                    titleColor: titleColor,
                                    worldId: worldId,
                                    obtainedAt: Date.now(),
                                    eventId: event.id
                                });
                                eventProgress.claimedTitles.push(titleId);

                                anyCompleted = true;
                                completedTasks.push({
                                    eventName: event.name,
                                    taskDesc: task.desc || 'å®ŒæˆèŠ‚æ—¥ä»»åŠ¡',
                                    titleName: titleName,
                                    titleColor: titleColor
                                });
                            }
                        }
                    }
                }
            }
        }
    }

    if (anyCompleted) {
        savePlayer(username, worldId, playerData);
    }

    return completedTasks;
}


// ============================================================
//  å¤©é“æ“ä½œ
// ============================================================
var tdHandlers = {};

tdHandlers['create_world'] = function (ws, payload) {
    var result = createWorld(payload.name, payload.password, payload.worldData || { plants: [], wildAreas: [] });
    safeSend(ws, { type: 'td_result', action: 'create_world', data: result });
};

tdHandlers['list_worlds'] = function (ws, payload) {
    safeSend(ws, { type: 'td_result', action: 'list_worlds', data: getWorldList(true) });
};

tdHandlers['get_world'] = function (ws, payload) {
    safeSend(ws, { type: 'td_result', action: 'get_world', data: loadWorldData(payload.worldId) });
};

tdHandlers['update_world'] = function (ws, payload) {
    saveWorldData(payload.worldId, payload.worldData);
    broadcastToWorld(payload.worldId, { type: 'world_update', announcement: payload.announcement || null });
    safeSend(ws, { type: 'td_result', action: 'update_world', data: { ok: true } });
};

tdHandlers['delete_world'] = function (ws, payload) {
    var idx = loadWorldIndex();
    if (idx[payload.worldId]) {
        delete idx[payload.worldId];
        saveWorldIndex(idx);
        var fp = path.join(WORLDS_DIR, payload.worldId + '.json');
        if (fs.existsSync(fp)) fs.unlinkSync(fp);
        invalidateCache(fp);
        for (var u in onlinePlayers) {
            if (onlinePlayers[u].worldId === payload.worldId) {
                removePlayerFromWorld(u, 'ä¸–ç•Œå·²å…³é—­', 'kicked');
            }
        }
        try {
            var files = fs.readdirSync(PLAYERS_DIR);
            files.forEach(function (f) {
                if (f.endsWith('_' + payload.worldId + '.json')) {
                    var pfp = path.join(PLAYERS_DIR, f);
                    fs.unlinkSync(pfp);
                    invalidateCache(pfp);
                }
            });
        } catch (e) { console.error('[æ¸…ç†ä¸–ç•Œç©å®¶æ–‡ä»¶]', e.message); }
        var bl = loadBlacklist();
        delete bl[payload.worldId];
        saveBlacklist(bl);
    }
    safeSend(ws, { type: 'td_result', action: 'delete_world', data: { ok: true } });
};

tdHandlers['update_world_info'] = function (ws, payload) {
    var worldId = payload.worldId;
    if (!worldId) { safeSend(ws, { type: 'td_result', action: 'update_world_info', data: { ok: false, msg: 'ç¼ºå°‘worldId' } }); return; }

    var idx = loadWorldIndex();
    if (!idx[worldId]) { safeSend(ws, { type: 'td_result', action: 'update_world_info', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }

    var wd = loadWorldData(worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'update_world_info', data: { ok: false, msg: 'ä¸–ç•Œæ•°æ®å¼‚å¸¸' } }); return; }

    // ä¿®æ”¹åç§°
    if (payload.name !== undefined && payload.name.trim()) {
        var newName = payload.name.trim();
        idx[worldId].name = newName;
        wd.name = newName;
    }

    // ä¿®æ”¹å¯†ç ï¼ˆç©ºå­—ç¬¦ä¸²è¡¨ç¤ºåˆ é™¤å¯†ç ï¼‰
    if (payload.password !== undefined) {
        idx[worldId].password = payload.password;
    }
    // ä¿®æ”¹å¥‡é‡è§¦å‘æ¦‚ç‡
    if (payload.adventureRate !== undefined) {
        wd.adventureRate = payload.adventureRate;
    }

    saveWorldIndex(idx);
    saveWorldData(worldId, wd);

    safeSend(ws, { type: 'td_result', action: 'update_world_info', data: { ok: true, msg: 'ä¸–ç•Œä¿¡æ¯å·²æ›´æ–°' } });
};

tdHandlers['online_players'] = function (ws, payload) {
    var result = {};
    for (var u in onlinePlayers) {
        var p = onlinePlayers[u];
        if (!payload.worldId || p.worldId === payload.worldId) {
            result[u] = { worldId: p.worldId, visitingFarm: p.visitingFarm || null, lastHeartbeat: p.lastHeartbeat };
        }
    }
    safeSend(ws, { type: 'td_result', action: 'online_players', data: result });
};

tdHandlers['list_accounts'] = function (ws, payload) {
    var accounts = loadAccounts();
    var list = [];
    for (var u in accounts) {
        list.push({ username: u, farmId: accounts[u].farmId, password: accounts[u].password, createdAt: accounts[u].createdAt, lastLogin: accounts[u].lastLogin });
    }
    safeSend(ws, { type: 'td_result', action: 'list_accounts', data: list });
};

tdHandlers['delete_account'] = function (ws, payload) {
    var accounts = loadAccounts();
    if (accounts[payload.username]) {
        if (onlinePlayers[payload.username]) {
            removePlayerFromWorld(payload.username, 'è´¦å·å·²è¢«åˆ é™¤', 'kicked');
        }
        delete accounts[payload.username];
        saveAccounts(accounts);
        //æ¸…ç†æ‰€æœ‰å…³è”æ•°æ®
        cleanupAccountData(payload.username);
    }
    safeSend(ws, { type: 'td_result', action: 'delete_account', data: { ok: true } });
};

tdHandlers['update_account'] = function (ws, payload) {
    var accounts = loadAccounts();
    var oldUsername = payload.username;
    if (!accounts[oldUsername]) {
        safeSend(ws, { type: 'td_result', action: 'update_account', data: { ok: false, msg: 'è´¦å·ä¸å­˜åœ¨' } });
        return;
    }
    // ä¿®æ”¹å¯†ç 
    if (payload.newPassword) {
        accounts[oldUsername].password = payload.newPassword;
    }
    // ä¿®æ”¹æ˜µç§°
    if (payload.newUsername && payload.newUsername !== oldUsername) {
        var newName = payload.newUsername;
        if (accounts[newName]) {
            safeSend(ws, { type: 'td_result', action: 'update_account', data: { ok: false, msg: 'æ–°æ˜µç§°å·²è¢«å ç”¨' } });
            return;
        }
        if (newName.length < 2 || newName.length > 16 || !/^[\w\u4e00-\u9fa5]+$/.test(newName)) {
            safeSend(ws, { type: 'td_result', action: 'update_account', data: { ok: false, msg: 'æ˜µç§°æ ¼å¼ä¸åˆæ³•ï¼ˆ2-16å­—ï¼Œä¸­æ–‡å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰' } });
            return;
        }
        // å¤åˆ¶è´¦å·æ•°æ®åˆ°æ–°åç§°
        accounts[newName] = accounts[oldUsername];
        delete accounts[oldUsername];
        // é‡å‘½åç©å®¶å­˜æ¡£æ–‡ä»¶
        try {
            var files = fs.readdirSync(PLAYERS_DIR);
            files.forEach(function (f) {
                if (f.startsWith(oldUsername + '_') && f.endsWith('.json')) {
                    var worldId = f.slice(oldUsername.length + 1, -5);
                    var oldPath = path.join(PLAYERS_DIR, f);
                    var newPath = path.join(PLAYERS_DIR, newName + '_' + worldId + '.json');
                    var pdata = readJSON(oldPath, null);
                    if (pdata) {
                        pdata.username = newName;
                        writeJSON(newPath, pdata);
                        fs.unlinkSync(oldPath);
                    }
                }
            });
        } catch (e) { console.error('[é‡å‘½åç©å®¶æ–‡ä»¶]', e.message); }
        // æ›´æ–°å¥½å‹ç³»ç»Ÿä¸­çš„å¼•ç”¨
        var allFriends = loadFriends();
        if (allFriends[oldUsername]) {
            allFriends[newName] = allFriends[oldUsername];
            delete allFriends[oldUsername];
        }
        for (var u in allFriends) {
            var fd = allFriends[u];
            fd.friends = fd.friends.map(function (f) { return f === oldUsername ? newName : f; });
            fd.requests = fd.requests.map(function (r) { return r === oldUsername ? newName : r; });
            if (fd.blocked) fd.blocked = fd.blocked.map(function (b) { return b === oldUsername ? newName : b; });
        }
        saveFriends(allFriends);
        // è¸¢å‡ºåœ¨çº¿ç©å®¶ï¼ˆéœ€è¦é‡æ–°ç™»å½•ï¼‰
        if (onlinePlayers[oldUsername]) {
            removePlayerFromWorld(oldUsername, 'æ˜µç§°å·²ä¿®æ”¹ä¸º ' + newName + 'ï¼Œè¯·é‡æ–°ç™»å½•', 'kicked');
        }
    }
    saveAccounts(accounts);
    safeSend(ws, { type: 'td_result', action: 'update_account', data: { ok: true } });
};

tdHandlers['get_world_titles'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'get_world_titles', data: {} }); return; }
    safeSend(ws, { type: 'td_result', action: 'get_world_titles', data: wd.worldTitles || {} });
};

tdHandlers['worldtitle_update'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) return;
    if (!wd.worldTitles) wd.worldTitles = {};

    var titleId = payload.titleId;
    if (!titleId) { safeSend(ws, { type: 'td_result', action: 'worldtitle_update', data: { ok: false, msg: 'ç¼ºå°‘ç§°å·ID' } }); return; }

    wd.worldTitles[titleId] = {
        name: payload.name,
        color: payload.color
    };

    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'worldtitle_update', data: { ok: true } });
};

tdHandlers['worldtitle_delete'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd || !wd.worldTitles) return;

    var titleId = payload.titleId;
    if (wd.worldTitles[titleId]) {
        delete wd.worldTitles[titleId];
        saveWorldData(payload.worldId, wd);
        safeSend(ws, { type: 'td_result', action: 'worldtitle_delete', data: { ok: true } });
    } else {
        safeSend(ws, { type: 'td_result', action: 'worldtitle_delete', data: { ok: false, msg: 'ç§°å·ä¸å­˜åœ¨' } });
    }
};

// ============================================================
//  èŠ‚æ—¥æ´»åŠ¨ç®¡ç†
// ============================================================
tdHandlers['holiday_list'] = function (ws, payload) {
    var worldId = payload.worldId;
    safeSend(ws, { type: 'td_result', action: 'holiday_list', data: getHolidayEvents(worldId) });
};

tdHandlers['holiday_create'] = function (ws, payload) {
    var worldId = payload.worldId;
    var event = payload.event;

    if (!worldId || !event || !event.name) {
        safeSend(ws, { type: 'td_result', action: 'holiday_create', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } });
        return;
    }

    var events = getHolidayEvents(worldId);
    event.id = 'holiday_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
    event.createdAt = Date.now();
    events.push(event);

    // é€šçŸ¥åœ¨çº¿ç©å®¶æ´»åŠ¨æ›´æ–°
    broadcastToWorld(worldId, { type: 'holiday_update' });

    safeSend(ws, { type: 'td_result', action: 'holiday_create', data: { ok: true, event: event } });
};

tdHandlers['holiday_update'] = function (ws, payload) {
    var worldId = payload.worldId;
    var eventId = payload.eventId;
    var eventData = payload.event;

    var events = getHolidayEvents(worldId);
    var idx = events.findIndex(function (e) { return e.id === eventId; });
    if (idx === -1) {
        safeSend(ws, { type: 'td_result', action: 'holiday_update', data: { ok: false, msg: 'æ´»åŠ¨ä¸å­˜åœ¨' } });
        return;
    }

    events[idx] = eventData;
    broadcastToWorld(worldId, { type: 'holiday_update' });
    safeSend(ws, { type: 'td_result', action: 'holiday_update', data: { ok: true } });
};

tdHandlers['holiday_delete'] = function (ws, payload) {
    var worldId = payload.worldId;
    var eventId = payload.eventId;

    var events = getHolidayEvents(worldId);
    var idx = events.findIndex(function (e) { return e.id === eventId; });
    if (idx === -1) {
        safeSend(ws, { type: 'td_result', action: 'holiday_delete', data: { ok: false, msg: 'æ´»åŠ¨ä¸å­˜åœ¨' } });
        return;
    }

    events.splice(idx, 1);
    broadcastToWorld(worldId, { type: 'holiday_update' });
    safeSend(ws, { type: 'td_result', action: 'holiday_delete', data: { ok: true } });
};

//ä¿®å¤ï¼šè¸¢äººåæ›´æ–°ä¸–ç•Œäººæ•°
tdHandlers['kick_player'] = function (ws, payload) {
    if (onlinePlayers[payload.username]) {
        removePlayerFromWorld(payload.username, payload.reason || 'è¢«å¤©é“è¸¢å‡º', 'kicked');
    }
    safeSend(ws, { type: 'td_result', action: 'kick_player', data: { ok: true } });
};

tdHandlers['announce'] = function (ws, payload) {
    broadcastToWorld(payload.worldId, { type: 'announcement', text: payload.text, level: payload.level || 'info', timestamp: Date.now() });
    var wd = loadWorldData(payload.worldId);
    if (wd) {
        wd.announcements = wd.announcements || [];
        wd.announcements.push({ text: payload.text, level: payload.level || 'info', timestamp: Date.now() });
        if (wd.announcements.length > 100) wd.announcements = wd.announcements.slice(-50);
        saveWorldData(payload.worldId, wd);
    }
    safeSend(ws, { type: 'td_result', action: 'announce', data: { ok: true } });
};

tdHandlers['delete_announcement'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd || !wd.announcements) { safeSend(ws, { type: 'td_result', action: 'delete_announcement', data: { ok: false, msg: 'æ— å…¬å‘Šæ•°æ®' } }); return; }
    var idx = payload.index;
    if (idx === undefined || idx < 0 || idx >= wd.announcements.length) { safeSend(ws, { type: 'td_result', action: 'delete_announcement', data: { ok: false, msg: 'ç´¢å¼•æ— æ•ˆ' } }); return; }
    var removed = wd.announcements.splice(idx, 1);
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'delete_announcement', data: { ok: true, removed: removed[0] } });
};

tdHandlers['clear_announcements'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'clear_announcements', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var count = (wd.announcements || []).length;
    wd.announcements = [];
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'clear_announcements', data: { ok: true, count: count } });
};

tdHandlers['world_snapshot'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'world_snapshot', data: null }); return; }
    var online = getOnlineInWorld(payload.worldId);
    var allPlayers = [];
    try {
        var files = fs.readdirSync(PLAYERS_DIR);
        files.forEach(function (f) {
            if (f.endsWith('_' + payload.worldId + '.json')) {
                var pd = readJSON(path.join(PLAYERS_DIR, f), null);
                if (pd) allPlayers.push(pd);
            }
        });
    } catch (e) { }
    //é™„å¸¦é»‘åå•æ•°æ®
    var bl = getBlacklist(payload.worldId);
    safeSend(ws, { type: 'td_result', action: 'world_snapshot', data: { world: wd, onlinePlayers: online, allPlayers: allPlayers, blacklist: bl } });
};

tdHandlers['modify_player'] = function (ws, payload) {
    var data = getOrCreatePlayer(payload.username, payload.worldId);
    deepMerge(data, payload.changes);
    savePlayer(payload.username, payload.worldId, data);
    if (onlinePlayers[payload.username]) {
        safeSend(onlinePlayers[payload.username].ws, { type: 'player_update', player: data });
    }
    safeSend(ws, { type: 'td_result', action: 'modify_player', data: { ok: true, player: data } });
};

tdHandlers['add_plant'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'add_plant', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var plant = payload.plant;
    if (!plant || !plant.id || !plant.name) { safeSend(ws, { type: 'td_result', action: 'add_plant', data: { ok: false, msg: 'æ¤ç‰©æ•°æ®ä¸å®Œæ•´' } }); return; }
    var areaIdx = plant.areaIndex || 0;
    if (areaIdx >= 0 && areaIdx < wd.wildAreas.length) {
        wd.wildAreas[areaIdx].seeds = wd.wildAreas[areaIdx].seeds || [];
        wd.wildAreas[areaIdx].seeds.push({
            id: plant.id, name: plant.name, icon: plant.icon || 'ğŸŒ±',
            growTime: plant.growTime || 7200000, dropRate: plant.dropRate || 0.1,
            fruitId: plant.fruitId || plant.id + '_fruit',
            fruitName: plant.fruitName || plant.name + 'æœ',
            fruitIcon: plant.fruitIcon || 'ğŸ',
            fruitValue: plant.fruitValue || 10,
            fruitDesc: plant.fruitDesc || ''
        });
    }
    wd.plants = wd.plants || [];
    wd.plants.push(plant);
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'add_plant', data: { ok: true, plant: plant } });
};

tdHandlers['add_animal'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'add_animal', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var animal = payload.animal;
    if (!animal || !animal.id || !animal.name) { safeSend(ws, { type: 'td_result', action: 'add_animal', data: { ok: false, msg: 'åŠ¨ç‰©æ•°æ®ä¸å®Œæ•´' } }); return; }

    var areaIdx = animal.areaIndex || 0;
    if (areaIdx >= 0 && areaIdx < wd.wildAreas.length) {
        wd.wildAreas[areaIdx].animals = wd.wildAreas[areaIdx].animals || [];
        wd.wildAreas[areaIdx].animals.push({
            id: animal.id,
            name: animal.name,
            icon: animal.icon || 'ğŸ¾',
            catchRate: animal.catchRate || 0.1,
            foodPerHour: animal.foodPerHour || 2,
            sellPrice: animal.sellPrice || 50,
            breedTime: animal.breedTime || 36000000
        });
    }

    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'add_animal', data: { ok: true, animal: animal } });
};

tdHandlers['update_animal'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'update_animal', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }

    var areaIdx = payload.areaIndex;
    var animalIdx = payload.animalIndex;

    if (areaIdx === undefined || areaIdx < 0 || !wd.wildAreas || areaIdx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'update_animal', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } });
        return;
    }

    var area = wd.wildAreas[areaIdx];
    if (animalIdx === undefined || animalIdx < 0 || !area.animals || animalIdx >= area.animals.length) {
        safeSend(ws, { type: 'td_result', action: 'update_animal', data: { ok: false, msg: 'åŠ¨ç‰©ç´¢å¼•æ— æ•ˆ' } });
        return;
    }

    area.animals[animalIdx] = payload.animal;
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'update_animal', data: { ok: true } });
};

tdHandlers['delete_animal'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'delete_animal', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }

    var areaIdx = payload.areaIndex;
    var animalIdx = payload.animalIndex;

    if (areaIdx === undefined || areaIdx < 0 || !wd.wildAreas || areaIdx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_animal', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } });
        return;
    }

    var area = wd.wildAreas[areaIdx];
    if (animalIdx === undefined || animalIdx < 0 || !area.animals || animalIdx >= area.animals.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_animal', data: { ok: false, msg: 'åŠ¨ç‰©ç´¢å¼•æ— æ•ˆ' } });
        return;
    }

    var removed = area.animals.splice(animalIdx, 1);
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'delete_animal', data: { ok: true, removed: removed[0] } });
};

tdHandlers['add_wild_area'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'add_wild_area', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var area = payload.area;
    if (!area || !area.name) { safeSend(ws, { type: 'td_result', action: 'add_wild_area', data: { ok: false, msg: 'åŒºåŸŸæ•°æ®ä¸å®Œæ•´' } }); return; }
    area.seeds = area.seeds || [];
    area.junkItems = area.junkItems || [];
    wd.wildAreas.push(area);
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'add_wild_area', data: { ok: true, area: area } });
};

tdHandlers['update_shop'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) return;
    wd.shop = payload.shop;
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'update_shop', data: { ok: true } });
};

tdHandlers['update_season'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) return;
    if (payload.season) wd.season = payload.season;
    if (payload.weather) wd.weather = payload.weather;
    saveWorldData(payload.worldId, wd);
    broadcastToWorld(payload.worldId, { type: 'season_update', season: wd.season, weather: wd.weather });
    safeSend(ws, { type: 'td_result', action: 'update_season', data: { ok: true } });
};

//é»‘åå•å¤©é“æ“ä½œ
tdHandlers['blacklist_add'] = function (ws, payload) {
    var username = payload.username;
    var worldId = payload.worldId;
    var reason = payload.reason || '';
    if (!username || !worldId) { safeSend(ws, { type: 'td_result', action: 'blacklist_add', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } }); return; }
    var result = addToBlacklist(username, worldId, reason);
    if (result.ok) {
        // å¦‚æœåœ¨çº¿åˆ™è¸¢å‡º
        if (onlinePlayers[username] && onlinePlayers[username].worldId === worldId) {
            removePlayerFromWorld(username, 'ä½ å·²è¢«åŠ å…¥é»‘åå•' + (reason ? 'ï¼š' + reason : ''), 'blacklisted');
        }
    }
    safeSend(ws, { type: 'td_result', action: 'blacklist_add', data: result });
};

tdHandlers['blacklist_remove'] = function (ws, payload) {
    var username = payload.username;
    var worldId = payload.worldId;
    if (!username || !worldId) { safeSend(ws, { type: 'td_result', action: 'blacklist_remove', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } }); return; }
    var result = removeFromBlacklist(username, worldId);
    safeSend(ws, { type: 'td_result', action: 'blacklist_remove', data: result });
};

tdHandlers['blacklist_list'] = function (ws, payload) {
    var worldId = payload.worldId;
    if (!worldId) { safeSend(ws, { type: 'td_result', action: 'blacklist_list', data: [] }); return; }
    safeSend(ws, { type: 'td_result', action: 'blacklist_list', data: getBlacklist(worldId) });
};

tdHandlers['update_wild_area'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'update_wild_area', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var idx = payload.areaIndex;
    if (idx === undefined || idx < 0 || !wd.wildAreas || idx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'update_wild_area', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } }); return;
    }
    wd.wildAreas[idx] = payload.area;
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'update_wild_area', data: { ok: true } });
};

tdHandlers['delete_wild_area'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'delete_wild_area', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var idx = payload.areaIndex;
    if (idx === undefined || idx < 0 || !wd.wildAreas || idx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_wild_area', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var removed = wd.wildAreas.splice(idx, 1);
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'delete_wild_area', data: { ok: true, removed: removed[0] } });
};

tdHandlers['update_seed'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'update_seed', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var areaIdx = payload.areaIndex;
    var seedIdx = payload.seedIndex;
    if (areaIdx === undefined || areaIdx < 0 || !wd.wildAreas || areaIdx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'update_seed', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var area = wd.wildAreas[areaIdx];
    if (seedIdx === undefined || seedIdx < 0 || !area.seeds || seedIdx >= area.seeds.length) {
        safeSend(ws, { type: 'td_result', action: 'update_seed', data: { ok: false, msg: 'ç§å­ç´¢å¼•æ— æ•ˆ' } }); return;
    }
    area.seeds[seedIdx] = payload.seed;
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'update_seed', data: { ok: true } });
};

tdHandlers['delete_seed'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'delete_seed', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var areaIdx = payload.areaIndex;
    var seedIdx = payload.seedIndex;
    if (areaIdx === undefined || areaIdx < 0 || !wd.wildAreas || areaIdx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_seed', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var area = wd.wildAreas[areaIdx];
    if (seedIdx === undefined || seedIdx < 0 || !area.seeds || seedIdx >= area.seeds.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_seed', data: { ok: false, msg: 'ç§å­ç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var removed = area.seeds.splice(seedIdx, 1);
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'delete_seed', data: { ok: true, removed: removed[0] } });
};

tdHandlers['get_global_notice'] = function (ws, payload) {
    var notice = readJSON(GLOBAL_NOTICE_FILE, { text: '', updatedAt: 0 });
    safeSend(ws, { type: 'td_result', action: 'get_global_notice', data: notice });
};

tdHandlers['set_global_notice'] = function (ws, payload) {
    var notice = { text: payload.text || '', updatedAt: Date.now() };
    writeJSON(GLOBAL_NOTICE_FILE, notice);
    safeSend(ws, { type: 'td_result', action: 'set_global_notice', data: { ok: true } });
};

tdHandlers['get_world_ranking'] = function (ws, payload) {
    var worldId = payload.worldId;
    if (!worldId) { safeSend(ws, { type: 'td_result', action: 'get_world_ranking', data: [] }); return; }
    safeSend(ws, { type: 'td_result', action: 'get_world_ranking', data: getWorldRanking(worldId) });
};

tdHandlers['get_pet_ranking'] = function (ws, payload) {
    var worldId = payload.worldId;
    if (!worldId) { safeSend(ws, { type: 'td_result', action: 'get_pet_ranking', data: [] }); return; }
    safeSend(ws, { type: 'td_result', action: 'get_pet_ranking', data: getPetRanking(worldId) });
};

tdHandlers['set_player_title'] = function (ws, payload) {
    var username = payload.username;
    var worldId = payload.worldId;
    var titleIds = payload.titleIds; // æ”¹ä¸ºæ¥æ”¶ä¸€ä¸ªIDæ•°ç»„

    if (!username || !worldId || !Array.isArray(titleIds)) {
        safeSend(ws, { type: 'td_result', action: 'set_player_title', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } });
        return;
    }

    var playerData = getOrCreatePlayer(username, worldId);
    playerData.ownedTitleIds = titleIds;

    // å¦‚æœå½“å‰æ¿€æ´»çš„ç§°å·ä¸åœ¨æ–°çš„æ‹¥æœ‰åˆ—è¡¨é‡Œï¼Œåˆ™æ¸…ç©º
    if (playerData.activeTitleId && !titleIds.includes(playerData.activeTitleId)) {
        playerData.activeTitleId = null;
    }

    savePlayer(username, worldId, playerData);
    safeSend(ws, { type: 'td_result', action: 'set_player_title', data: { ok: true, msg: 'ç©å®¶ç§°å·å·²æ›´æ–°' } });

    // å¦‚æœç©å®¶åœ¨çº¿ï¼Œé€šçŸ¥ä»–æ›´æ–°
    if (onlinePlayers[username] && onlinePlayers[username].worldId === worldId) {
        handlePlayerUpdate(username, playerData);
    }
};

tdHandlers['get_player_titles'] = function (ws, payload) {
    var worldId = payload.worldId;
    if (!worldId) {
        safeSend(ws, { type: 'td_result', action: 'get_player_titles', data: [] });
        return;
    }

    var titles = [];
    try {
        var files = fs.readdirSync(PLAYERS_DIR);
        files.forEach(function (f) {
            if (f.endsWith('_' + worldId + '.json')) {
                var pd = readJSON(path.join(PLAYERS_DIR, f), null);
                if (pd && pd.titles && pd.titles[worldId]) {
                    titles.push({
                        username: pd.username,
                        farmId: pd.farmId,
                        title: pd.titles[worldId]
                    });
                }
            }
        });
    } catch (e) { console.error('[è·å–ç§°å·]', e.message); }

    safeSend(ws, { type: 'td_result', action: 'get_player_titles', data: titles });
};

tdHandlers['add_world_pet'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'add_world_pet', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var pet = payload.pet;
    if (!pet || !pet.species) { safeSend(ws, { type: 'td_result', action: 'add_world_pet', data: { ok: false, msg: 'å® ç‰©æ•°æ®ä¸å®Œæ•´' } }); return; }

    var areaIdx = pet.areaIndex || 0;
    if (areaIdx >= 0 && areaIdx < wd.wildAreas.length) {
        wd.wildAreas[areaIdx].pets = wd.wildAreas[areaIdx].pets || [];
        wd.wildAreas[areaIdx].pets.push({
            species: pet.species,
            speciesIcon: pet.speciesIcon || 'ğŸ¾',
            catchRate: pet.catchRate || 0.12,
            rarity: pet.rarity || 'common',
            baseValue: pet.baseValue || 30
        });
    }
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'add_world_pet', data: { ok: true, pet: pet } });
};

tdHandlers['update_world_pet'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'update_world_pet', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var areaIdx = payload.areaIndex;
    var petIdx = payload.petIndex;
    if (areaIdx === undefined || !wd.wildAreas || areaIdx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'update_world_pet', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var area = wd.wildAreas[areaIdx];
    if (!area.pets || petIdx === undefined || petIdx >= area.pets.length) {
        safeSend(ws, { type: 'td_result', action: 'update_world_pet', data: { ok: false, msg: 'å® ç‰©ç´¢å¼•æ— æ•ˆ' } }); return;
    }
    area.pets[petIdx] = payload.pet;
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'update_world_pet', data: { ok: true } });
};

tdHandlers['delete_world_pet'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'delete_world_pet', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var areaIdx = payload.areaIndex;
    var petIdx = payload.petIndex;
    if (areaIdx === undefined || !wd.wildAreas || areaIdx >= wd.wildAreas.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_world_pet', data: { ok: false, msg: 'åŒºåŸŸç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var area = wd.wildAreas[areaIdx];
    if (!area.pets || petIdx === undefined || petIdx >= area.pets.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_world_pet', data: { ok: false, msg: 'å® ç‰©ç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var removed = area.pets.splice(petIdx, 1);
    saveWorldData(payload.worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'delete_world_pet', data: { ok: true, removed: removed[0] } });
};

tdHandlers['get_friendship_levels'] = function (ws, payload) {
    // ä»æ–‡ä»¶è¯»å–ï¼ˆè‹¥æ— åˆ™è¿”å›é»˜è®¤å€¼ï¼‰
    var levels = readJSON(FRIENDSHIP_LEVELS_FILE, friendshipLevels);
    safeSend(ws, { type: 'td_result', action: 'get_friendship_levels', data: levels });
};

tdHandlers['set_friendship_levels'] = function (ws, payload) {
    if (payload.levels && Array.isArray(payload.levels)) {
        friendshipLevels = payload.levels;
        // å†™å…¥æ–‡ä»¶
        writeJSON(FRIENDSHIP_LEVELS_FILE, friendshipLevels);
        safeSend(ws, { type: 'td_result', action: 'set_friendship_levels', data: { ok: true } });
    }
};

tdHandlers['set_friendship_levels'] = function (ws, payload) {
    if (payload.levels && Array.isArray(payload.levels)) {
        friendshipLevels = payload.levels;
        safeSend(ws, { type: 'td_result', action: 'set_friendship_levels', data: { ok: true } });
    }
};

// ============================================================
//  å‘¨æŒ‘æˆ˜ç®¡ç†-å¤©é“ç«¯
// ============================================================
tdHandlers['get_weekly_challenges'] = function (ws, payload) {
    safeSend(ws, { type: 'td_result', action: 'get_weekly_challenges', data: weeklyChallenges.list || [] });
};

tdHandlers['save_weekly_challenge'] = function (ws, payload) {
    var index = payload.index;
    var challenge = payload.challenge;

    if (!weeklyChallenges.list) weeklyChallenges.list = [];

    if (index >= 0) {
        weeklyChallenges.list[index] = challenge;
    } else {
        weeklyChallenges.list.push(challenge);
    }

    safeSend(ws, { type: 'td_result', action: 'save_weekly_challenge', data: { ok: true } });
};

tdHandlers['set_current_weekly_challenge'] = function (ws, payload) {
    var index = payload.index;
    if (index >= 0 && weeklyChallenges.list && weeklyChallenges.list[index]) {
        weeklyChallenges.current = weeklyChallenges.list[index];
        safeSend(ws, { type: 'td_result', action: 'set_current_weekly_challenge', data: { ok: true } });
    } else {
        safeSend(ws, { type: 'td_result', action: 'set_current_weekly_challenge', data: { ok: false, msg: 'æŒ‘æˆ˜ä¸å­˜åœ¨' } });
    }
};

tdHandlers['clear_current_weekly_challenge'] = function (ws, payload) {
    weeklyChallenges.current = null;
    safeSend(ws, { type: 'td_result', action: 'clear_current_weekly_challenge', data: { ok: true } });
};

tdHandlers['delete_weekly_challenge'] = function (ws, payload) {
    var index = payload.index;
    if (weeklyChallenges.list && index >= 0 && index < weeklyChallenges.list.length) {
        weeklyChallenges.list.splice(index, 1);
    }
    safeSend(ws, { type: 'td_result', action: 'delete_weekly_challenge', data: { ok: true } });
};

tdHandlers['get_weekly_ranking'] = function (ws, payload) {
    var worldId = payload.worldId;
    var ranking = loadWeeklyRanking(worldId) || [];
    safeSend(ws, { type: 'td_result', action: 'get_weekly_ranking', data: ranking });
};

// ============================================================
//  æ´»åŠ¨ç®¡ç†ï¼ˆå¤©é“ç«¯ï¼‰
// ============================================================
tdHandlers['event_list'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'event_list', data: [] }); return; }
    safeSend(ws, { type: 'td_result', action: 'event_list', data: wd.events || [] });
};

tdHandlers['event_create'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'event_create', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var ev = payload.event;
    if (!ev || !ev.name) { safeSend(ws, { type: 'td_result', action: 'event_create', data: { ok: false, msg: 'æ´»åŠ¨åç§°ä¸èƒ½ä¸ºç©º' } }); return; }
    if (!wd.events) wd.events = [];
    ev.id = 'ev_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 3);
    ev.createdAt = Date.now();
    wd.events.push(ev);
    saveWorldData(payload.worldId, wd);
    // é€šçŸ¥åœ¨çº¿ç©å®¶
    broadcastToWorld(payload.worldId, { type: 'event_update' });
    safeSend(ws, { type: 'td_result', action: 'event_create', data: { ok: true, event: ev } });
};

tdHandlers['event_update'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd || !wd.events) { safeSend(ws, { type: 'td_result', action: 'event_update', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var idx = payload.eventIndex;
    if (idx === undefined || idx < 0 || idx >= wd.events.length) {
        safeSend(ws, { type: 'td_result', action: 'event_update', data: { ok: false, msg: 'æ´»åŠ¨ç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var ev = payload.event;
    ev.id = wd.events[idx].id;
    ev.createdAt = wd.events[idx].createdAt;
    wd.events[idx] = ev;
    saveWorldData(payload.worldId, wd);
    broadcastToWorld(payload.worldId, { type: 'event_update' });
    safeSend(ws, { type: 'td_result', action: 'event_update', data: { ok: true } });
};

tdHandlers['event_delete'] = function (ws, payload) {
    var wd = loadWorldData(payload.worldId);
    if (!wd || !wd.events) { safeSend(ws, { type: 'td_result', action: 'event_delete', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } }); return; }
    var idx = payload.eventIndex;
    if (idx === undefined || idx < 0 || idx >= wd.events.length) {
        safeSend(ws, { type: 'td_result', action: 'event_delete', data: { ok: false, msg: 'æ´»åŠ¨ç´¢å¼•æ— æ•ˆ' } }); return;
    }
    var removed = wd.events.splice(idx, 1);
    saveWorldData(payload.worldId, wd);
    broadcastToWorld(payload.worldId, { type: 'event_update' });
    safeSend(ws, { type: 'td_result', action: 'event_delete', data: { ok: true, removed: removed[0] } });
};

tdHandlers['modify_player_pet'] = function (ws, payload) {
    var username = payload.username;
    var worldId = payload.worldId;
    var petId = payload.petId;
    var changes = payload.changes;
    if (!username || !worldId || !petId) {
        safeSend(ws, { type: 'td_result', action: 'modify_player_pet', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } }); return;
    }
    var playerData = getOrCreatePlayer(username, worldId);
    var pet = playerData.pets.find(function (pt) { return pt.id === petId; });
    if (!pet) {
        safeSend(ws, { type: 'td_result', action: 'modify_player_pet', data: { ok: false, msg: 'å® ç‰©ä¸å­˜åœ¨' } }); return;
    }
    for (var key in changes) {
        if (changes.hasOwnProperty(key)) {
            pet[key] = changes[key];
        }
    }
    savePlayer(username, worldId, playerData);
    if (onlinePlayers[username] && onlinePlayers[username].worldId === worldId) {
        safeSend(onlinePlayers[username].ws, { type: 'player_update', player: playerData });
    }
    safeSend(ws, { type: 'td_result', action: 'modify_player_pet', data: { ok: true, pet: pet } });
};

tdHandlers['send_mail'] = function (ws, payload) {
    var toUsername = payload.username;
    var worldId = payload.worldId;
    var broadcast = payload.broadcast || false;

    //ç¾¤å‘æ¨¡å¼ï¼šç»™æŸä¸–ç•Œå…¨ä½“ç©å®¶å‘é€
    if (broadcast && worldId) {
        var accounts = loadAccounts();
        var sentCount = 0;
        try {
            var files = fs.readdirSync(PLAYERS_DIR);
            var sentUsers = {};
            files.forEach(function (f) {
                if (f.endsWith('_' + worldId + '.json')) {
                    var pd = readJSON(path.join(PLAYERS_DIR, f), null);
                    if (pd && pd.username && !sentUsers[pd.username]) {
                        sentUsers[pd.username] = true;
                        var mail = {
                            id: genMailId(),
                            from: 'å¤©é“',
                            worldId: worldId,
                            subject: payload.subject || 'ç³»ç»Ÿé‚®ä»¶',
                            text: payload.text || '',
                            attachments: payload.attachments ? JSON.parse(JSON.stringify(payload.attachments)) : [],
                            claimed: false,
                            deleted: false,
                            createdAt: Date.now()
                        };
                        addMail(pd.username, mail);
                        sentCount++;
                        // å¦‚æœç©å®¶åœ¨çº¿ï¼Œæ¨é€é€šçŸ¥
                        if (onlinePlayers[pd.username]) {
                            safeSend(onlinePlayers[pd.username].ws, { type: 'new_mail', mail: mail });
                        }
                    }
                }
            });
        } catch (e) { console.error('[ç¾¤å‘é‚®ä»¶]', e.message); }
        safeSend(ws, { type: 'td_result', action: 'send_mail', data: { ok: true, msg: 'å·²ç¾¤å‘ç»™ ' + sentCount + ' åç©å®¶' } });
        return;
    }

    //å•äººå‘é€
    if (!toUsername) {
        safeSend(ws, { type: 'td_result', action: 'send_mail', data: { ok: false, msg: 'è¯·æŒ‡å®šæ”¶ä»¶äºº' } });
        return;
    }
    var accounts = loadAccounts();
    if (!accounts[toUsername]) {
        safeSend(ws, { type: 'td_result', action: 'send_mail', data: { ok: false, msg: 'ç”¨æˆ·ä¸å­˜åœ¨' } });
        return;
    }

    var mail = {
        id: genMailId(),
        from: 'å¤©é“',
        worldId: worldId || '',
        subject: payload.subject || 'ç³»ç»Ÿé‚®ä»¶',
        text: payload.text || '',
        attachments: payload.attachments || [],
        claimed: false,
        deleted: false,
        createdAt: Date.now()
    };

    addMail(toUsername, mail);

    // å¦‚æœç©å®¶åœ¨çº¿ï¼Œæ¨é€é€šçŸ¥
    if (onlinePlayers[toUsername]) {
        safeSend(onlinePlayers[toUsername].ws, {
            type: 'new_mail', mail: mail
        });
    }

    safeSend(ws, { type: 'td_result', action: 'send_mail', data: { ok: true, msg: 'é‚®ä»¶å·²å‘é€ç»™ ' + toUsername } });
};

tdHandlers['get_player_mails'] = function (ws, payload) {
    var username = payload.username;
    if (!username) {
        safeSend(ws, { type: 'td_result', action: 'get_player_mails', data: [] });
        return;
    }
    var all = loadMails();
    safeSend(ws, { type: 'td_result', action: 'get_player_mails', data: all[username] || [] });
};

tdHandlers['delete_player_mail'] = function (ws, payload) {
    var username = payload.username;
    var mailId = payload.mailId;
    if (!username || !mailId) {
        safeSend(ws, { type: 'td_result', action: 'delete_player_mail', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } });
        return;
    }
    var all = loadMails();
    var userMails = all[username] || [];
    var idx = userMails.findIndex(function (m) { return m.id === mailId; });
    if (idx === -1) {
        safeSend(ws, { type: 'td_result', action: 'delete_player_mail', data: { ok: false, msg: 'é‚®ä»¶ä¸å­˜åœ¨' } });
        return;
    }
    userMails.splice(idx, 1);
    all[username] = userMails;
    saveMails(all);
    safeSend(ws, { type: 'td_result', action: 'delete_player_mail', data: { ok: true } });
};

tdHandlers['clear_player_mails'] = function (ws, payload) {
    var username = payload.username;
    if (!username) {
        safeSend(ws, { type: 'td_result', action: 'clear_player_mails', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } });
        return;
    }
    var all = loadMails();
    var count = (all[username] || []).length;
    all[username] = [];
    saveMails(all);
    safeSend(ws, { type: 'td_result', action: 'clear_player_mails', data: { ok: true, count: count } });
};

// ============================================================
//  å¤©é“ç«¯ï¼šæ¯æ—¥ä»»åŠ¡æ± ç®¡ç†
// ============================================================
tdHandlers['get_daily_task_pool'] = function (ws, payload) {
    var worldId = payload.worldId;
    if (!worldId) { safeSend(ws, { type: 'td_result', action: 'get_daily_task_pool', data: null }); return; }
    var wd = loadWorldData(worldId);
    if (!wd) { safeSend(ws, { type: 'td_result', action: 'get_daily_task_pool', data: null }); return; }
    safeSend(ws, { type: 'td_result', action: 'get_daily_task_pool', data: wd.dailyTaskPool || getDefaultDailyTasks() });
};

tdHandlers['update_daily_task_pool'] = function (ws, payload) {
    var worldId = payload.worldId;
    var poolData = payload.poolData;
    if (!worldId || !poolData) {
        safeSend(ws, { type: 'td_result', action: 'update_daily_task_pool', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } });
        return;
    }
    var wd = loadWorldData(worldId);
    if (!wd) {
        safeSend(ws, { type: 'td_result', action: 'update_daily_task_pool', data: { ok: false, msg: 'ä¸–ç•Œä¸å­˜åœ¨' } });
        return;
    }
    wd.dailyTaskPool = poolData;
    saveWorldData(worldId, wd);
    safeSend(ws, { type: 'td_result', action: 'update_daily_task_pool', data: { ok: true } });
};

tdHandlers['reset_player_daily_tasks'] = function (ws, payload) {
    var username = payload.username;
    var worldId = payload.worldId;
    if (!username || !worldId) {
        safeSend(ws, { type: 'td_result', action: 'reset_player_daily_tasks', data: { ok: false, msg: 'å‚æ•°ä¸å®Œæ•´' } });
        return;
    }
    var playerData = getOrCreatePlayer(username, worldId);
    playerData.dailyTasks = {
        lastRefreshDate: '',
        tasks: [],
        completedCount: 0,
        claimedAll: false
    };
    savePlayer(username, worldId, playerData);
    safeSend(ws, { type: 'td_result', action: 'reset_player_daily_tasks', data: { ok: true } });
};

// ============================================================
//  æ„è§åé¦ˆç³»ç»Ÿ
// ============================================================
function loadFeedback() { return cachedRead(FEEDBACK_FILE, []); }
function saveFeedback(d) { cachedWrite(FEEDBACK_FILE, d); }

tdHandlers['list_feedback'] = function (ws, payload) {
    var list = loadFeedback();
    safeSend(ws, { type: 'td_result', action: 'list_feedback', data: list });
};

tdHandlers['delete_feedback'] = function (ws, payload) {
    var list = loadFeedback();
    var idx = payload.index;
    if (idx === undefined || idx < 0 || idx >= list.length) {
        safeSend(ws, { type: 'td_result', action: 'delete_feedback', data: { ok: false, msg: 'ç´¢å¼•æ— æ•ˆ' } });
        return;
    }
    var removed = list.splice(idx, 1);
    saveFeedback(list);
    safeSend(ws, { type: 'td_result', action: 'delete_feedback', data: { ok: true, removed: removed[0] } });
};

tdHandlers['clear_feedback'] = function (ws, payload) {
    var list = loadFeedback();
    var count = list.length;
    saveFeedback([]);
    safeSend(ws, { type: 'td_result', action: 'clear_feedback', data: { ok: true, count: count } });
};

function deepMerge(target, source) {
    if (!source) return target;
    for (var key in source) {
        if (source.hasOwnProperty(key)) {
            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key]) && target[key] && typeof target[key] === 'object' && !Array.isArray(target[key])) {
                deepMerge(target[key], source[key]);
            } else {
                target[key] = source[key];
            }
        }
    }
    return target;
}

// ============================================================
//  é‚®ä»¶ç³»ç»Ÿ
// ============================================================
function loadMails() { return cachedRead(MAIL_FILE, {}); }
function saveMails(d) { cachedWrite(MAIL_FILE, d); }
function genMailId() { return 'm_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 4); }

function getPlayerMails(username, worldId) {
    var all = loadMails();
    return (all[username] || []).filter(function (m) {
        if (m.deleted) return false;
        // å¦‚æœé‚®ä»¶æŒ‡å®šäº†ä¸–ç•Œï¼Œåªåœ¨å¯¹åº”ä¸–ç•Œæ˜¾ç¤ºï¼›æ²¡æŒ‡å®šä¸–ç•Œçš„ï¼ˆå…¨å±€é‚®ä»¶ï¼‰æ‰€æœ‰ä¸–ç•Œéƒ½èƒ½çœ‹åˆ°
        if (worldId && m.worldId && m.worldId !== worldId) return false;
        return true;
    });
}

function addMail(toUsername, mail) {
    var all = loadMails();
    if (!all[toUsername]) all[toUsername] = [];
    all[toUsername].push(mail);
    // é™åˆ¶æ¯äººæœ€å¤šä¿ç•™20å°
    if (all[toUsername].length > 20) {
        all[toUsername] = all[toUsername].slice(-20);
    }
    saveMails(all);
}

// ============================================================
//  å‘¨æŒ‘æˆ˜è¿›åº¦æ›´æ–°
// ============================================================
// å‘¨æŒ‘æˆ˜æ’è¡Œæ¦œå­˜å‚¨
function loadWeeklyRanking(worldId) {
    var rankingFile = path.join(WORLDS_DIR, worldId + '_weekly_ranking.json');
    return readJSON(rankingFile, []);
}

function saveWeeklyRanking(worldId, ranking) {
    var rankingFile = path.join(WORLDS_DIR, worldId + '_weekly_ranking.json');
    writeJSON(rankingFile, ranking);
}

function updateWeeklyChallengeProgress(username, worldId, taskType, increment) {
    if (!weeklyChallenges.current) return;

    var playerData = getOrCreatePlayer(username, worldId);
    var challengeProgress = playerData.weeklyChallenge || { completed: false, completedAt: 0, tasks: {} };

    if (challengeProgress.completed) return;

    var tasks = weeklyChallenges.current.tasks || [];
    var anyChange = false;

    for (var i = 0; i < tasks.length; i++) {
        var task = tasks[i];
        if (task.type === taskType) {
            var current = challengeProgress.tasks[i] || 0;
            current += increment || 1;
            challengeProgress.tasks[i] = current;
            anyChange = true;
        }
    }

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆ
    var allCompleted = true;
    for (var i = 0; i < tasks.length; i++) {
        if ((challengeProgress.tasks[i] || 0) < tasks[i].targetCount) {
            allCompleted = false;
            break;
        }
    }

    if (allCompleted && !challengeProgress.completed) {
        challengeProgress.completed = true;
        challengeProgress.completedAt = Date.now();

        // æ·»åŠ åˆ°å‘¨æŒ‘æˆ˜æ’è¡Œæ¦œ
        var ranking = loadWeeklyRanking(worldId);
        ranking.push({ username: username, completedAt: Date.now() });
        ranking.sort(function (a, b) { return a.completedAt - b.completedAt; });
        ranking = ranking.slice(0, 50); // åªä¿ç•™å‰50å
        saveWeeklyRanking(worldId, ranking);

        // è·å–æ’åï¼ˆéœ€è¦åœ¨ ranking å®šä¹‰ä¹‹åï¼‰
        var rankPosition = ranking.findIndex(function (r) { return r.username === username; }) + 1;

        // æ·»åŠ å¤©é“æ—¥å¿—
        broadcastToTiandao({
            type: 'td_weekly_complete',
            worldId: worldId,
            username: username,
            challengeName: weeklyChallenges.current.name || 'æœ¬å‘¨æŒ‘æˆ˜',
            completedAt: challengeProgress.completedAt,
            rank: rankPosition,
            totalCompleters: ranking.length
        });
    }

    if (anyChange || allCompleted) {
        playerData.weeklyChallenge = challengeProgress;
        savePlayer(username, worldId, playerData);
    }
}

// ============================================================
//  æ¯æ—¥ä»»åŠ¡ç³»ç»Ÿ
// ============================================================

// è·å–ä¸–ç•Œä»»åŠ¡æ± 
function getWorldTaskPool(worldId) {
    var wd = loadWorldData(worldId);
    if (wd && wd.dailyTaskPool && wd.dailyTaskPool.pool && wd.dailyTaskPool.pool.length > 0) {
        return wd.dailyTaskPool;
    }
    return getDefaultDailyTasks();
}

// è·å–å½“å‰æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DDï¼ˆåŸºäºæœåŠ¡å™¨æ—¶é—´ï¼‰
function getTodayDateStr() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

// åˆ·æ–°ç©å®¶æ¯æ—¥ä»»åŠ¡
function refreshPlayerDailyTasks(playerData, worldId) {
    var today = getTodayDateStr();
    if (playerData.dailyTasks.lastRefreshDate === today) {
        // ä»Šå¤©å·²ç»åˆ·æ–°è¿‡ï¼Œåªéœ€è¦é‡æ–°è®¡ç®—å·²å®ŒæˆçŠ¶æ€ï¼ˆé˜²æ­¢ä»»åŠ¡æ ‡è®°ä¸ºå·²å®Œæˆä½†è¿›åº¦æ²¡å˜çš„æƒ…å†µï¼‰
        var anyChange = false;
        for (var i = 0; i < playerData.dailyTasks.tasks.length; i++) {
            var task = playerData.dailyTasks.tasks[i];
            if (!task.claimed && task.progress >= task.targetCount && !task.completed) {
                task.completed = true;
                anyChange = true;
            }
        }
        if (anyChange) {
            // é‡æ–°è®¡ç®—å·²å®Œæˆæ•°é‡
            playerData.dailyTasks.completedCount = playerData.dailyTasks.tasks.filter(function (t) { return t.completed; }).length;
        }
        return false; // æœªåˆ·æ–°
    }

    // éœ€è¦åˆ·æ–°
    var poolData = getWorldTaskPool(worldId);
    var pool = poolData.pool || [];
    var dailyCount = poolData.dailyCount || 5;

    // æŒ‰éš¾åº¦åˆ†ç±»
    var easyTasks = pool.filter(function (t) { return t.difficulty === 'easy'; });
    var mediumTasks = pool.filter(function (t) { return t.difficulty === 'medium'; });
    var hardTasks = pool.filter(function (t) { return t.difficulty === 'hard'; });

    // æŒ‰æƒé‡éšæœºæŠ½å–çš„å‡½æ•°
    function pickRandomByWeight(taskArray, count) {
        if (taskArray.length === 0) return [];
        var result = [];
        var available = taskArray.slice(); // å¤åˆ¶ä¸€ä»½

        for (var j = 0; j < count && available.length > 0; j++) {
            // è®¡ç®—æ€»æƒé‡
            var totalWeight = 0;
            for (var k = 0; k < available.length; k++) {
                totalWeight += (available[k].weight || 10);
            }
            var rand = Math.random() * totalWeight;
            var cumulative = 0;
            for (var k = 0; k < available.length; k++) {
                cumulative += (available[k].weight || 10);
                if (rand < cumulative) {
                    result.push(available[k]);
                    available.splice(k, 1); // ç§»é™¤å·²é€‰ä¸­çš„ï¼Œé¿å…é‡å¤
                    break;
                }
            }
        }
        return result;
    }

    // éšæœºæŠ½å–ä»»åŠ¡
    var newTasks = [];

    // æŠ½å– 2 ä¸ª easy
    var pickedEasy = pickRandomByWeight(easyTasks, 2);
    newTasks = newTasks.concat(pickedEasy);

    // æŠ½å– 2 ä¸ª medium
    var pickedMedium = pickRandomByWeight(mediumTasks, 2);
    newTasks = newTasks.concat(pickedMedium);

    // æŠ½å– 1 ä¸ª hard
    var pickedHard = pickRandomByWeight(hardTasks, 1);
    newTasks = newTasks.concat(pickedHard);

    // å¦‚æœæŸç±»ä»»åŠ¡ä¸å¤Ÿï¼Œä»å…¶ä»–ç±»è¡¥è¶³
    while (newTasks.length < dailyCount) {
        var allTasks = pool.slice();
        var extra = pickRandomByWeight(allTasks, 1);
        if (extra.length > 0) newTasks.push(extra[0]);
        else break;
    }

    // è½¬æ¢ä¸ºç©å®¶ä»»åŠ¡æ ¼å¼ï¼ˆå¤åˆ¶æ¨¡æ¿ï¼Œæ·»åŠ è¿›åº¦å­—æ®µï¼‰
    playerData.dailyTasks.tasks = newTasks.map(function (t) {
        return {
            id: t.id,
            type: t.type,
            targetDesc: t.targetDesc,
            targetCount: t.targetCount,
            targetItemId: t.targetItemId || null, // å¦‚æœæœ‰æŒ‡å®šç‰©å“
            progress: 0,
            completed: false,
            claimed: false,
            rewards: t.rewards ? JSON.parse(JSON.stringify(t.rewards)) : [{ type: 'money', amount: 20 }],
            difficulty: t.difficulty || 'easy'
        };
    });

    playerData.dailyTasks.lastRefreshDate = today;
    playerData.dailyTasks.completedCount = 0;
    playerData.dailyTasks.claimedAll = false;

    return true; // å·²åˆ·æ–°
}

// æ£€æŸ¥ä»»åŠ¡è¿›åº¦
function checkDailyTaskProgress(playerData, taskType, targetItemId, progressIncrement, worldId) {
    if (!playerData.dailyTasks || !playerData.dailyTasks.tasks) return null;

    // ç¡®ä¿ä»»åŠ¡æ˜¯æœ€æ–°çš„
    refreshPlayerDailyTasks(playerData, worldId);

    var anyCompleted = false;
    var completedTasks = [];

    for (var i = 0; i < playerData.dailyTasks.tasks.length; i++) {
        var task = playerData.dailyTasks.tasks[i];
        if (task.claimed || task.completed) continue; // å·²å®Œæˆæˆ–å·²é¢†å–çš„ä¸å†ç´¯åŠ 

        // ç±»å‹åŒ¹é…æ£€æŸ¥
        if (task.type !== taskType) continue;

        // å¦‚æœä»»åŠ¡æŒ‡å®šäº†ç‰¹å®šç‰©å“IDï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…
        if (task.targetItemId && task.targetItemId !== targetItemId) continue;

        // ç´¯åŠ è¿›åº¦
        task.progress = (task.progress || 0) + (progressIncrement || 1);

        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
        if (task.progress >= task.targetCount) {
            task.completed = true;
            anyCompleted = true;
            completedTasks.push(task);
        }
    }

    if (anyCompleted) {
        // æ›´æ–°å·²å®Œæˆæ•°é‡
        playerData.dailyTasks.completedCount = playerData.dailyTasks.tasks.filter(function (t) { return t.completed; }).length;
    }

    return completedTasks; // è¿”å›åˆšåˆšå®Œæˆçš„ä»»åŠ¡åˆ—è¡¨
}

// æ£€æŸ¥æ‰€æœ‰å¯èƒ½è§¦å‘ä»»åŠ¡çš„è¡ŒåŠ¨ï¼ˆç»Ÿä¸€å®šç‚¹è°ƒç”¨ï¼‰
// åœ¨ç›¸å…³ action çš„æœ«å°¾è°ƒç”¨æ­¤å‡½æ•°
function triggerDailyTaskCheck(username, worldId, taskType, targetItemId, increment) {
    var p = onlinePlayers[username];
    if (!p) return;

    var playerData = getOrCreatePlayer(username, worldId);
    var completedTasks = checkDailyTaskProgress(playerData, taskType, targetItemId, increment, worldId);

    if (completedTasks && completedTasks.length > 0) {
        // æœ‰ä»»åŠ¡åˆšåˆšå®Œæˆï¼Œä¿å­˜æ•°æ®
        savePlayer(username, worldId, playerData);

        // é€šçŸ¥å®¢æˆ·ç«¯
        for (var i = 0; i < completedTasks.length; i++) {
            var task = completedTasks[i];
            if (onlinePlayers[username]) {
                safeSend(onlinePlayers[username].ws, {
                    type: 'daily_task_complete',
                    task: {
                        index: playerData.dailyTasks.tasks.indexOf(task),
                        desc: task.targetDesc,
                        progress: task.progress,
                        target: task.targetCount
                    }
                });
            }
        }
    } else {
        // æ²¡æœ‰ä»»åŠ¡å®Œæˆï¼Œä½†ä¹Ÿå¯èƒ½è¿›åº¦å˜åŒ–äº†ï¼Œéœ€è¦ä¿å­˜
        savePlayer(username, worldId, playerData);
    }
}

// é¢†å–ä»»åŠ¡å¥–åŠ±
actions['claim_daily_task'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    var playerData = getOrCreatePlayer(username, p.worldId);
    refreshPlayerDailyTasks(playerData, p.worldId);

    var taskIndex = payload.taskIndex;
    if (taskIndex === undefined || taskIndex < 0 || taskIndex >= playerData.dailyTasks.tasks.length) {
        safeSend(p.ws, { type: 'action_result', action: 'claim_daily_task', ok: false, msg: 'ä»»åŠ¡ä¸å­˜åœ¨' });
        return;
    }

    var task = playerData.dailyTasks.tasks[taskIndex];
    if (!task.completed) {
        safeSend(p.ws, { type: 'action_result', action: 'claim_daily_task', ok: false, msg: 'ä»»åŠ¡å°šæœªå®Œæˆ' });
        return;
    }

    if (task.claimed) {
        safeSend(p.ws, { type: 'action_result', action: 'claim_daily_task', ok: false, msg: 'å·²ç»é¢†å–è¿‡äº†' });
        return;
    }

    // å‘æ”¾å¥–åŠ±
    var rewards = task.rewards || [];
    var rewardItems = [];

    for (var i = 0; i < rewards.length; i++) {
        var rew = rewards[i];
        if (rew.type === 'money') {
            playerData.money += rew.amount || 0;
            rewardItems.push('ğŸ’°' + (rew.amount || 0) + 'é‡‘å¸');
        } else if (rew.type === 'seed') {
            var seedData = rew.data;
            if (seedData) {
                var existingSeed = playerData.seeds.find(function (s) { return s.id === seedData.id; });
                if (existingSeed) {
                    existingSeed.count += (seedData.count || 1);
                } else {
                    var seedCopy = JSON.parse(JSON.stringify(seedData));
                    if (!seedCopy.source) seedCopy.source = 'daily_task';
                    playerData.seeds.push(seedCopy);
                }
                rewardItems.push((seedData.icon || 'ğŸŒ±') + seedData.name + ' x' + (seedData.count || 1));
            }
        } else if (rew.type === 'fruit') {
            var fruitData = rew.data;
            if (fruitData) {
                var existingFruit = playerData.fruits.find(function (f) { return f.id === fruitData.id; });
                if (existingFruit) {
                    existingFruit.count += (fruitData.count || 1);
                } else {
                    playerData.fruits.push(JSON.parse(JSON.stringify(fruitData)));
                }
                rewardItems.push((fruitData.icon || 'ğŸ') + fruitData.name + ' x' + (fruitData.count || 1));
            }
        }
    }

    task.claimed = true;

    // æ›´æ–°å·²å®Œæˆæ•°é‡
    playerData.dailyTasks.completedCount = playerData.dailyTasks.tasks.filter(function (t) { return t.completed; }).length;

    // æ£€æŸ¥å…¨å‹¤å¥–åŠ±
    var allCompleted = playerData.dailyTasks.tasks.every(function (t) { return t.completed; });
    var allClaimed = playerData.dailyTasks.tasks.every(function (t) { return t.claimed; });

    if (allCompleted && allClaimed && !playerData.dailyTasks.claimedAll) {
        // å‘æ”¾å…¨å‹¤å¥–åŠ±
        var poolData = getWorldTaskPool(p.worldId);
        var perfectBonus = poolData.perfectBonus || { rewards: [{ type: 'money', amount: 100 }] };

        for (var j = 0; j < perfectBonus.rewards.length; j++) {
            var pb = perfectBonus.rewards[j];
            if (pb.type === 'money') {
                playerData.money += pb.amount || 100;
                rewardItems.push('ğŸ† å…¨å‹¤å¥–åŠ± ğŸ’°' + (pb.amount || 100));
            } else if (pb.type === 'seed') {
                var seedData = pb.data;
                if (seedData) {
                    var existingSeed = playerData.seeds.find(function (s) { return s.id === seedData.id; });
                    if (existingSeed) {
                        existingSeed.count += (seedData.count || 1);
                    } else {
                        var seedCopy = JSON.parse(JSON.stringify(seedData));
                        if (!seedCopy.source) seedCopy.source = 'daily_task_perfect';
                        playerData.seeds.push(seedCopy);
                    }
                    rewardItems.push('ğŸ† ' + (seedData.icon || 'ğŸŒ±') + seedData.name + ' x' + (seedData.count || 1));
                }
            }
        }
        playerData.dailyTasks.claimedAll = true;
    }

    savePlayer(username, p.worldId, playerData);

    var rewardMsg = rewardItems.join('ã€');
    safeSend(p.ws, {
        type: 'action_result',
        action: 'claim_daily_task',
        ok: true,
        msg: 'é¢†å–æˆåŠŸï¼š' + rewardMsg,
        money: playerData.money,
        seeds: playerData.seeds,
        fruits: playerData.fruits,
        dailyTasks: playerData.dailyTasks
    });
};

// æŸ¥çœ‹æ¯æ—¥ä»»åŠ¡
actions['daily_tasks'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    var playerData = getOrCreatePlayer(username, p.worldId);
    refreshPlayerDailyTasks(playerData, p.worldId);
    savePlayer(username, p.worldId, playerData);

    // è·å–ä¸–ç•Œä»»åŠ¡æ± ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºå…¨å‹¤å¥–åŠ±ï¼‰
    var poolData = getWorldTaskPool(p.worldId);

    safeSend(p.ws, {
        type: 'action_result',
        action: 'daily_tasks',
        ok: true,
        dailyTasks: playerData.dailyTasks,
        perfectBonus: poolData.perfectBonus || { rewards: [{ type: 'money', amount: 100 }] }
    });
};

//=============================================================
//  å‘¨æŒ‘æˆ˜ç³»ç»Ÿ
// ============================================================

actions['weekly_challenge_info'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    if (!weeklyChallenges.current) {
        safeSend(p.ws, { type: 'action_result', action: 'weekly_challenge_info', ok: false, msg: 'æš‚æ— å‘¨æŒ‘æˆ˜' });
        return;
    }

    var playerData = getOrCreatePlayer(username, p.worldId);
    var challengeProgress = playerData.weeklyChallenge || { completed: false, completedAt: 0 };

    safeSend(p.ws, {
        type: 'action_result',
        action: 'weekly_challenge_info',
        ok: true,
        challenge: weeklyChallenges.current,
        progress: challengeProgress
    });
};

actions['claim_weekly_reward'] = function (username, payload) {
    var p = onlinePlayers[username];
    if (!p) return;

    if (!weeklyChallenges.current) {
        safeSend(p.ws, { type: 'action_result', action: 'claim_weekly_reward', ok: false, msg: 'æš‚æ— å‘¨æŒ‘æˆ˜' });
        return;
    }

    var playerData = getOrCreatePlayer(username, p.worldId);
    var challengeProgress = playerData.weeklyChallenge || { completed: false, completedAt: 0 };

    if (!challengeProgress.completed) {
        safeSend(p.ws, { type: 'action_result', action: 'claim_weekly_reward', ok: false, msg: 'è¿˜æœªå®ŒæˆæŒ‘æˆ˜' });
        return;
    }

    if (challengeProgress.claimed) {
        safeSend(p.ws, { type: 'action_result', action: 'claim_weekly_reward', ok: false, msg: 'å·²ç»é¢†å–è¿‡å¥–åŠ±äº†' });
        return;
    }

    // å‘æ”¾å¥–åŠ±
    var rewards = weeklyChallenges.current.rewards || [];
    var rewardItems = [];

    for (var i = 0; i < rewards.length; i++) {
        var rew = rewards[i];
        if (rew.type === 'money') {
            playerData.money += rew.amount || 0;
            rewardItems.push('ğŸ’°' + rew.amount);
        } else if (rew.type === 'seed' && rew.data) {
            var seedData = rew.data;
            var existingSeed = playerData.seeds.find(function (s) { return s.id === seedData.id; });
            if (existingSeed) {
                existingSeed.count += seedData.count || 1;
            } else {
                var seedCopy = JSON.parse(JSON.stringify(seedData));
                seedCopy.source = 'weekly_challenge';
                playerData.seeds.push(seedCopy);
            }
            rewardItems.push((seedData.icon || 'ğŸŒ±') + seedData.name + ' x' + (seedData.count || 1));
        } else if (rew.type === 'fruit' && rew.data) {
            var fruitData = rew.data;
            var existingFruit = playerData.fruits.find(function (f) { return f.id === fruitData.id; });
            if (existingFruit) {
                existingFruit.count += fruitData.count || 1;
            } else {
                playerData.fruits.push(JSON.parse(JSON.stringify(fruitData)));
            }
            rewardItems.push((fruitData.icon || 'ğŸ') + fruitData.name + ' x' + (fruitData.count || 1));
        } else if (rew.type === 'pet' && rew.data) {
            if (playerData.pets.length >= 6) {
                safeSend(p.ws, { type: 'action_result', action: 'claim_weekly_reward', ok: false, msg: 'å® ç‰©å·²æ»¡ï¼Œæ— æ³•é¢†å–å® ç‰©å¥–åŠ±' });
                return;
            }
            var petCopy = JSON.parse(JSON.stringify(rew.data));
            petCopy.id = generatePetId();
            petCopy.createdAt = Date.now();
            petCopy.lastInteraction = Date.now();
            playerData.pets.push(petCopy);
            rewardItems.push((petCopy.speciesIcon || 'ğŸ¾') + petCopy.species + 'Â·' + petCopy.name);
        }
    }

    challengeProgress.claimed = true;
    playerData.weeklyChallenge = challengeProgress;
    savePlayer(username, p.worldId, playerData);

    safeSend(p.ws, {
        type: 'action_result',
        action: 'claim_weekly_reward',
        ok: true,
        msg: 'é¢†å–æˆåŠŸï¼š' + rewardItems.join('ã€'),
        money: playerData.money,
        seeds: playerData.seeds,
        fruits: playerData.fruits,
        pets: playerData.pets
    });
};

// ============================================================
//  å®šæ—¶å…¨å±€æ¸…ç†ï¼ˆæ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
// ============================================================
function globalCleanup() {
    console.log('[å…¨å±€æ¸…ç†] å¼€å§‹...');
    var accounts = loadAccounts();
    var accountSet = {};
    for (var u in accounts) accountSet[u] = true;

    // æ¸…ç†å­¤å„¿é‚®ç®±
    var mails = loadMails();
    var mailKeys = Object.keys(mails);
    var mailCleaned = 0;
    for (var i = 0; i < mailKeys.length; i++) {
        if (!accountSet[mailKeys[i]]) { delete mails[mailKeys[i]]; mailCleaned++; }
    }
    if (mailCleaned > 0) { saveMails(mails); console.log('[å…¨å±€æ¸…ç†] æ¸…ç†äº†', mailCleaned, 'ä¸ªå­¤å„¿é‚®ç®±'); }

    // æ¸…ç†å­¤å„¿å¥½å‹æ•°æ®
    var friends = loadFriends();
    var friendKeys = Object.keys(friends);
    var friendCleaned = 0;
    for (var fi = 0; fi < friendKeys.length; fi++) {
        if (!accountSet[friendKeys[fi]]) { delete friends[friendKeys[fi]]; friendCleaned++; }
    }
    if (friendCleaned > 0) { saveFriends(friends); console.log('[å…¨å±€æ¸…ç†] æ¸…ç†äº†', friendCleaned, 'ä¸ªå­¤å„¿å¥½å‹æ•°æ®'); }

    // æ¸…ç†å­¤å„¿ç©å®¶å­˜æ¡£
    var worldIdx = loadWorldIndex();
    var worldSet = {};
    for (var wid in worldIdx) worldSet[wid] = true;

    try {
        var files = fs.readdirSync(PLAYERS_DIR);
        var fileCleaned = 0;
        for (var j = 0; j < files.length; j++) {
            var f = files[j];
            if (!f.endsWith('.json')) continue;
            // ä»æ–‡ä»¶åè§£æ username å’Œ worldIdï¼Œé¿å…è¯»å–æ–‡ä»¶å†…å®¹
            var lastUnderscore = f.lastIndexOf('_');
            if (lastUnderscore === -1) continue;
            // æ–‡ä»¶åæ ¼å¼: username_worldId.json
            // worldId æ ¼å¼: w_xxx_xxxxï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°æ­£ç¡®çš„åˆ†å‰²ç‚¹
            var baseName = f.slice(0, -5); // å»æ‰ .json
            var playerUsername = null;
            var playerWorldId = null;
            // worldId ä»¥ w_ å¼€å¤´ï¼Œä»åå¾€å‰æ‰¾
            var wIdx = baseName.lastIndexOf('_w_');
            if (wIdx !== -1) {
                playerUsername = baseName.slice(0, wIdx);
                playerWorldId = baseName.slice(wIdx + 1);
            }
            if (!playerUsername || !playerWorldId) {
                // æ— æ³•è§£æï¼Œè¯»å–æ–‡ä»¶åˆ¤æ–­
                var fp = path.join(PLAYERS_DIR, f);
                var pd = cachedRead(fp, null);
                if (!pd || !accountSet[pd.username] || !worldSet[pd.worldId]) {
                    fs.unlinkSync(fp);
                    invalidateCache(fp);
                    fileCleaned++;
                }
                continue;
            }
            if (!accountSet[playerUsername] || !worldSet[playerWorldId]) {
                var fp2 = path.join(PLAYERS_DIR, f);
                try { fs.unlinkSync(fp2); } catch (e) { }
                invalidateCache(fp2);
                fileCleaned++;
            }
        }
        if (fileCleaned > 0) console.log('[å…¨å±€æ¸…ç†] æ¸…ç†äº†', fileCleaned, 'ä¸ªå­¤å„¿ç©å®¶å­˜æ¡£');
    } catch (e) { console.error('[å…¨å±€æ¸…ç†] ç©å®¶æ–‡ä»¶æ¸…ç†å¤±è´¥:', e.message); }

    console.log('[å…¨å±€æ¸…ç†] å®Œæˆ');
}

// æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡å…¨å±€æ¸…ç†
setInterval(globalCleanup, 6 * 3600000);
// å¯åŠ¨5åˆ†é’Ÿåæ‰§è¡Œä¸€æ¬¡
setTimeout(globalCleanup, 5 * 60000);

// ============================================================
//  WebSocket æœåŠ¡å™¨
// ============================================================
var _rateLimits = {};

function checkRate(ws, limit) {
    var key = ws._remoteAddress || 'unknown';
    var now = Date.now();
    if (!_rateLimits[key]) _rateLimits[key] = [];
    _rateLimits[key] = _rateLimits[key].filter(function (t) { return now - t < 1000; });
    if (_rateLimits[key].length >= limit) return false;
    _rateLimits[key].push(now);
    return true;
}

var server = http.createServer(function (req, res) {
    if (req.url === '/health') {
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ status: 'ok', online: Object.keys(onlinePlayers).length, tiandao: tiandaoClients.length, uptime: process.uptime() }));
        return;
    }
    res.writeHead(404); res.end('Not Found');
});

var wss = new WebSocket.Server({ server: server });

wss.on('connection', function (ws) {
    var authedUser = null;
    var isTiandao = false;

    ws.on('message', function (raw) {
        if (!checkRate(ws, 20)) return;
        var msg;
        try { msg = JSON.parse(raw); } catch (e) { return; }

        if (msg.type === 'td_auth') {
            if (msg.secret === TIANDAO_SECRET) {
                isTiandao = true;
                tiandaoClients.push(ws);
                safeSend(ws, { type: 'td_auth_result', ok: true });
                console.log('[å¤©é“] å·²è¿æ¥');
            } else {
                safeSend(ws, { type: 'td_auth_result', ok: false, msg: 'å¯†é’¥é”™è¯¯' });
            }
            return;
        }

        if (msg.type === 'td_action' && isTiandao) {
            var handler = tdHandlers[msg.action];
            if (handler) {
                try { handler(ws, msg.payload || {}); }
                catch (e) { console.error('[å¤©é“å¼‚å¸¸]', msg.action, e.message); safeSend(ws, { type: 'td_result', action: msg.action, data: { ok: false, msg: e.message } }); }
            } else {
                safeSend(ws, { type: 'td_result', action: msg.action, data: { ok: false, msg: 'æœªçŸ¥æ“ä½œ' } });
            }
            return;
        }

        if (msg.type === 'register') {
            var rr = register(msg.username, msg.password);
            safeSend(ws, { type: 'register_result', ok: rr.ok, msg: rr.msg, farmId: rr.farmId });
            if (rr.ok) broadcastToTiandao({ type: 'td_new_account', username: msg.username });
            return;
        }

        if (msg.type === 'login') {
            var lr = login(msg.username, msg.password);
            if (lr.ok) {
                if (onlinePlayers[msg.username]) {
                    safeSend(onlinePlayers[msg.username].ws, { type: 'kicked', msg: 'è´¦å·åœ¨åˆ«å¤„ç™»å½•' });
                    onlinePlayers[msg.username].ws.close();
                    delete onlinePlayers[msg.username];
                }
                authedUser = msg.username;
            }
            safeSend(ws, { type: 'login_result', ok: lr.ok, msg: lr.msg, username: lr.ok ? msg.username : null, farmId: lr.farmId });
            if (lr.ok) broadcastToTiandao({ type: 'td_player_login', username: msg.username });
            return;
        }

        if (!authedUser) { safeSend(ws, { type: 'error', msg: 'è¯·å…ˆç™»å½•' }); return; }

        if (msg.type === 'list_worlds') {
            var notice = readJSON(GLOBAL_NOTICE_FILE, { text: '', updatedAt: 0 });
            safeSend(ws, { type: 'world_list', data: getWorldList(false), globalNotice: notice.text || '' });
            return;
        }

        if (msg.type === 'submit_feedback') {
            var fbText = (msg.text || '').trim();
            if (!fbText || fbText.length < 2) { safeSend(ws, { type: 'feedback_result', ok: false, msg: 'åé¦ˆå†…å®¹è‡³å°‘2ä¸ªå­—' }); return; }
            if (fbText.length > 500) { safeSend(ws, { type: 'feedback_result', ok: false, msg: 'åé¦ˆå†…å®¹ä¸èƒ½è¶…è¿‡500å­—' }); return; }
            var list = loadFeedback();
            list.push({ username: authedUser, text: fbText, timestamp: Date.now() });
            if (list.length > 500) list = list.slice(-500);
            saveFeedback(list);
            safeSend(ws, { type: 'feedback_result', ok: true, msg: 'æ„Ÿè°¢ä½ çš„åé¦ˆï¼' });
            broadcastToTiandao({ type: 'td_new_feedback', username: authedUser, text: fbText });
            return;
        }

        //è¿›å…¥ä¸–ç•Œæ—¶æ£€æŸ¥é»‘åå•
        if (msg.type === 'enter_world') {
            // å…ˆæ£€æŸ¥é»‘åå•
            if (isBlacklisted(authedUser, msg.worldId)) {
                safeSend(ws, { type: 'enter_world_result', ok: false, msg: 'ä½ å·²è¢«è¯¥ä¸–ç•Œæ‹‰å…¥é»‘åå•ï¼Œæ— æ³•è¿›å…¥' });
                return;
            }
            var vr = verifyWorldPw(msg.worldId, msg.password);
            if (!vr.ok) { safeSend(ws, { type: 'enter_world_result', ok: false, msg: vr.msg }); return; }
            var wd = loadWorldData(msg.worldId);
            if (!wd) { safeSend(ws, { type: 'enter_world_result', ok: false, msg: 'ä¸–ç•Œæ•°æ®å¼‚å¸¸' }); return; }
            var pd = getOrCreatePlayer(authedUser, msg.worldId);
            checkAllPlots(pd);
            pd.lastActive = Date.now();
            savePlayer(authedUser, msg.worldId, pd);
            onlinePlayers[authedUser] = { ws: ws, worldId: msg.worldId, visitingFarm: null, lastHeartbeat: Date.now() };
            updateWorldPlayerCount(msg.worldId);
            var fullPlayerData = JSON.parse(JSON.stringify(pd));

            // ç»„åˆ activeTitle
            fullPlayerData.activeTitle = null;
            if (fullPlayerData.activeTitleId && wd.worldTitles && wd.worldTitles[fullPlayerData.activeTitleId]) {
                fullPlayerData.activeTitle = {
                    titleId: fullPlayerData.activeTitleId,
                    ...wd.worldTitles[fullPlayerData.activeTitleId]
                };
            }

            // ç»„åˆ titles æ•°ç»„ï¼ˆç”¨äºè®¾ç½®é¢æ¿å±•ç¤ºï¼‰
            fullPlayerData.titles = [];
            if (fullPlayerData.ownedTitleIds && wd.worldTitles) {
                fullPlayerData.ownedTitleIds.forEach(id => {
                    if (wd.worldTitles[id]) {
                        fullPlayerData.titles.push({
                            titleId: id,
                            ...wd.worldTitles[id]
                        });
                    }
                });
            }
            safeSend(ws, {
                type: 'enter_world_result', ok: true,
                world: {
                    id: wd.id, name: wd.name, season: wd.season, weather: wd.weather, shop: wd.shop,
                    wildAreas: (wd.wildAreas || []).map(function (a) { return { name: a.name, desc: a.desc, icon: a.icon, seedNames: (a.seeds || []).map(function (s) { return s.name; }) }; }),
                    announcements: (wd.announcements || []).slice(-5)
                },
                player: fullPlayerData,
                onlinePlayers: getOnlineInWorld(msg.worldId)
            });
            var myFriends = getFriendData(authedUser).friends;
            for (var u in onlinePlayers) {
                if (myFriends.includes(u) && onlinePlayers[u].worldId === msg.worldId) {
                    safeSend(onlinePlayers[u].ws, { type: 'friend_online', username: authedUser });
                }
            }
            broadcastToWorld(msg.worldId, { type: 'player_online', username: authedUser }, authedUser);
            //é€šçŸ¥ç©å®¶æœ‰æœªè¯»é‚®ä»¶ï¼ˆåªç»Ÿè®¡æœªè¯»çš„ï¼‰
            var playerMails = getPlayerMails(authedUser, msg.worldId);
            var unreadMails = playerMails.filter(function (m) { return !m.read; });
            var unclaimedCount = unreadMails.filter(function (m) { return !m.claimed && m.attachments && m.attachments.length > 0; }).length;
            var unreadCount = unreadMails.length;
            if (unreadCount > 0) {
                safeSend(ws, { type: 'mail_notify', count: unreadCount, unclaimedCount: unclaimedCount });
            }

            // é€šçŸ¥ç©å®¶æœ‰å® ç‰©å¯»å®å®Œæˆ
            var now = Date.now();
            var readyPets = (pd.pets || []).filter(function (pet) {
                return pet.adventureEndTime && now >= pet.adventureEndTime;
            });
            if (readyPets.length > 0) {
                var petNames = readyPets.map(function (pet) {
                    return (pet.speciesIcon || 'ğŸ¾') + pet.name;
                }).join('ã€');
                safeSend(ws, { type: 'pet_adventure_ready', count: readyPets.length, petNames: petNames });
            }
            broadcastToTiandao({ type: 'td_player_enter', username: authedUser, worldId: msg.worldId });
            return;
        }

        if (msg.type === 'action') {
            var ah = actions[msg.action];
            if (ah) {
                try { ah(authedUser, msg.payload || {}); }
                catch (e) { console.error('[è¡Œä¸ºå¼‚å¸¸]', msg.action, e.message); safeSend(ws, { type: 'action_result', action: msg.action, ok: false, msg: 'æ“ä½œå¤±è´¥: ' + e.message }); }
            } else {
                safeSend(ws, { type: 'action_result', action: msg.action, ok: false, msg: 'æœªçŸ¥è¡Œä¸º' });
            }
            return;
        }

        if (msg.type === 'leave_world') {
            if (authedUser && onlinePlayers[authedUser]) {
                var info = onlinePlayers[authedUser];
                var worldId = info.worldId;

                // é€šçŸ¥åŒä¸–ç•Œå¥½å‹ä¸‹çº¿
                var myFriends = getFriendData(authedUser).friends;
                for (var fu in onlinePlayers) {
                    if (myFriends.includes(fu) && onlinePlayers[fu].worldId === worldId) {
                        safeSend(onlinePlayers[fu].ws, { type: 'friend_offline', username: authedUser });
                    }
                }

                // å¦‚æœåœ¨ä¸²é—¨ï¼Œé€šçŸ¥å†œåœºä¸»
                if (info.visitingFarm) {
                    for (var vu in onlinePlayers) {
                        var vp = onlinePlayers[vu];
                        if (vp.worldId === worldId && (vp.visitingFarm === info.visitingFarm || vu === info.visitingFarm) && vu !== authedUser) {
                            safeSend(vp.ws, { type: 'visitor_leave', username: authedUser });
                        }
                    }
                }

                delete onlinePlayers[authedUser];
                broadcastToWorld(worldId, { type: 'player_offline', username: authedUser }, authedUser);
                updateWorldPlayerCount(worldId);
                broadcastToTiandao({ type: 'td_player_offline', username: authedUser, worldId: worldId });
                console.log('[ç¦»å¼€ä¸–ç•Œ]', authedUser, 'ä»', worldId);
            }
            safeSend(ws, { type: 'leave_world_result', ok: true });
            return;
        }

        if (msg.type === 'heartbeat') {
            if (onlinePlayers[authedUser]) onlinePlayers[authedUser].lastHeartbeat = Date.now();
            safeSend(ws, { type: 'heartbeat_ack', timestamp: Date.now() });
            return;
        }
    });

    ws.on('close', function () {
        if (isTiandao) {
            var i = tiandaoClients.indexOf(ws);
            if (i !== -1) tiandaoClients.splice(i, 1);
            console.log('[å¤©é“] æ–­å¼€');
            return;
        }
        if (authedUser && onlinePlayers[authedUser]) {
            var info = onlinePlayers[authedUser];

            // é€šçŸ¥åŒä¸–ç•Œçš„å¥½å‹ä¸‹çº¿
            var myFriends = getFriendData(authedUser).friends;
            for (var fu in onlinePlayers) {
                if (myFriends.includes(fu) && onlinePlayers[fu].worldId === info.worldId) {
                    safeSend(onlinePlayers[fu].ws, { type: 'friend_offline', username: authedUser });
                }
            }

            delete onlinePlayers[authedUser];
            broadcastToWorld(info.worldId, { type: 'player_offline', username: authedUser }, authedUser);
            // æ–­å¼€æ—¶ä¹Ÿæ›´æ–°ä¸–ç•Œäººæ•°
            updateWorldPlayerCount(info.worldId);
            broadcastToTiandao({ type: 'td_player_offline', username: authedUser, worldId: info.worldId });
            console.log('[ç¦»çº¿]', authedUser);
        }
    });

    ws.on('error', function (err) { console.error('[WSé”™è¯¯]', err.message); });
});

// å®šæ—¶ä»»åŠ¡ï¼šå¿ƒè·³è¶…æ—¶æ£€æµ‹
setInterval(function () {
    var now = Date.now();
    for (var u in onlinePlayers) {
        var p = onlinePlayers[u];
        if (now - p.lastHeartbeat > 90000) {
            console.log('[è¶…æ—¶]', u);
            removePlayerFromWorld(u, 'è¿æ¥è¶…æ—¶', 'kicked');
        }
    }
}, 30000);

setInterval(cleanOldTrades, 3600000);

// å®šæ—¶æ£€æŸ¥åœ¨çº¿ç©å®¶çš„å® ç‰©å¯»å®å®Œæˆ
setInterval(function () {
    var now = Date.now();
    for (var u in onlinePlayers) {
        var p = onlinePlayers[u];
        // ç”¨ cachedRead è€Œä¸æ˜¯ loadPlayerï¼Œé¿å…é‡å¤è¯»
        var fp = path.join(PLAYERS_DIR, u + '_' + p.worldId + '.json');
        var playerData = _memCache[fp]; // ç›´æ¥ä»å†…å­˜å–ï¼Œä¸è§¦å‘ç£ç›˜è¯»
        if (!playerData || !playerData.pets || playerData.pets.length === 0) continue;

        var readyPets = [];
        for (var i = 0; i < playerData.pets.length; i++) {
            var pet = playerData.pets[i];
            if (pet.adventureEndTime && now >= pet.adventureEndTime && !pet._notifiedAdventure) {
                readyPets.push(pet);
            }
        }

        if (readyPets.length > 0) {
            for (var j = 0; j < readyPets.length; j++) {
                readyPets[j]._notifiedAdventure = true;
            }
            // æ ‡è®°è„æ•°æ®ï¼Œå»¶è¿Ÿå†™å…¥
            cachedWrite(fp, playerData);

            var petNames = readyPets.map(function (pet) {
                return (pet.speciesIcon || 'ğŸ¾') + pet.name;
            }).join('ã€');
            safeSend(p.ws, { type: 'pet_adventure_ready', count: readyPets.length, petNames: petNames });
        }
    }
}, 30000);

setInterval(function () {
    var c = Object.keys(onlinePlayers).length;
    if (c > 0) console.log('[çŠ¶æ€] åœ¨çº¿:', c, 'å¤©é“:', tiandaoClients.length);
}, 60000);

// è¿›ç¨‹é€€å‡ºå‰å¼ºåˆ¶å†™å…¥æ‰€æœ‰è„æ•°æ®
function flushAllCache() {
    console.log('[ç¼“å­˜] æ­£åœ¨åˆ·ç›˜...');
    for (var fp in _dirtyFlags) {
        if (_dirtyFlags[fp] && _memCache[fp] !== undefined) {
            try { writeJSON(fp, _memCache[fp]); } catch (e) { console.error('[åˆ·ç›˜å¤±è´¥]', fp, e.message); }
            _dirtyFlags[fp] = false;
        }
    }
    console.log('[ç¼“å­˜] åˆ·ç›˜å®Œæˆ');
}

process.on('SIGINT', function () { flushAllCache(); process.exit(0); });
process.on('SIGTERM', function () { flushAllCache(); process.exit(0); });
process.on('exit', flushAllCache);

server.listen(PORT, function () {
    // å¯åŠ¨æ—¶é‡ç½®æ‰€æœ‰ä¸–ç•Œåœ¨çº¿äººæ•°
    var idx = loadWorldIndex();
    for (var id in idx) {
        idx[id].playerCount = 0;
    }
    saveWorldIndex(idx);

    var worldCount = Object.keys(idx).length;
    var accountCount = Object.keys(loadAccounts()).length;
    var now = new Date().toLocaleString('zh-CN', { hour12: false });

    console.log('==================================================');
    console.log('ğŸŒ¾ é˜¡é™Œä¹‹è¯—');
    console.log('v' + VISION + ' Â· ç”°å›­ç‰§æ­Œ');
    console.log('ç«¯å£' + PORT + ' Â· ä¸–ç•Œ ' + worldCount + ' Â· è´¦å· ' + accountCount);
    console.log('å¯åŠ¨æ—¶é—´' + now);
    console.log('âœ“ å¯åŠ¨æˆåŠŸ Â· äººæ•°å·²é‡ç½®');
    console.log('==================================================');
});
