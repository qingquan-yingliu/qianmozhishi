<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Èò°Èôå‰πãËØó</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            width: 100%;
        }

        body {
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a2e1a;
            color: #e0e0e0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .page {
            display: none;
            width: 100%;
            height: 100vh;
            flex-direction: column;
        }

        .page.active {
            display: flex;
        }

        .login-page {
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a2e1a 0%, #2d4a2d 50%, #1a3a1a 100%);
        }

        .login-box {
            width: 90%;
            max-width: 360px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 32px 24px;
            backdrop-filter: blur(10px);
        }

        .login-box h1 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 6px;
        }

        .login-box .subtitle {
            text-align: center;
            font-size: 13px;
            color: #888;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 4px;
            padding-left: 4px;
        }

        .form-group input {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 11px 14px;
            font-size: 14px;
            color: #e0e0e0;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            border-color: #6abf69;
        }

        .form-group input::placeholder {
            color: #666;
        }

        .remember-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
            padding-left: 4px;
        }

        .remember-row input[type=checkbox] {
            width: 16px;
            height: 16px;
            accent-color: #4caf50;
            cursor: pointer;
        }

        .remember-row label {
            font-size: 12px;
            color: #aaa;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-green {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: #fff;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ccc;
            margin-top: 8px;
        }

        .btn-ghost:hover {
            border-color: #6abf69;
            color: #6abf69;
        }

        .login-msg {
            text-align: center;
            font-size: 12px;
            margin-top: 12px;
            min-height: 18px;
        }

        .login-msg.err {
            color: #ef4444;
        }

        .login-msg.ok {
            color: #4ade80;
        }

        .login-status {
            text-align: center;
            font-size: 11px;
            color: #555;
            margin-top: 16px;
        }

        .worlds-page {
            background: #1a2e1a;
        }

        .worlds-header {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
        }

        .worlds-header h2 {
            font-size: 18px;
            color: #6abf69;
        }

        .worlds-header .user-info {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        #globalNoticeBar {
            display: none;
            padding: 8px 16px;
            background: rgba(76, 175, 80, 0.08);
            border-bottom: 1px solid rgba(76, 175, 80, 0.15);
            font-size: 12px;
            color: #a5d6a7;
            line-height: 1.6;
            flex-shrink: 0;
            max-height: 120px;
            overflow-y: auto;
        }

        #globalNoticeBar.show {
            display: block;
        }

        .worlds-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
        }

        .world-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .world-card:hover {
            border-color: #6abf69;
            background: rgba(106, 191, 105, 0.08);
        }

        .world-card h3 {
            font-size: 15px;
            color: #a5d6a7;
            margin-bottom: 4px;
        }

        .world-card .world-info {
            font-size: 12px;
            color: #888;
            display: flex;
            gap: 12px;
        }

        .world-card .world-info span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .world-pw-input {
            margin-top: 10px;
            display: none;
        }

        .world-pw-input input {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 9px 12px;
            font-size: 13px;
            color: #e0e0e0;
            outline: none;
        }

        .world-pw-input button {
            margin-top: 6px;
            width: 100%;
            padding: 9px;
            background: #4caf50;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .no-worlds {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 14px;
        }

        .worlds-footer {
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
            text-align: center;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #888;
            padding: 8px 24px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .game-page {
            background: #12201a;
            display: flex;
            flex-direction: column;
        }

        .game-top {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            flex-shrink: 0;
        }

        .game-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-world-name {
            font-size: 13px;
            color: #6abf69;
            font-weight: 600;
        }

        .game-info-right {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .game-exit-btn {
            font-size: 11px;
            color: #888;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 6px;
            padding: 3px 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-exit-btn:hover {
            color: #ef4444;
            border-color: #ef4444;
        }

        .stamina-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 5px;
        }

        .stamina-bar .st-label {
            font-size: 11px;
            color: #aaa;
        }

        .stamina-bar .st-track {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            max-width: 120px;
        }

        .stamina-bar .st-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #4caf50);
            border-radius: 3px;
            transition: width 0.5s;
        }

        .stamina-bar .st-val {
            font-size: 11px;
            color: #ccc;
            min-width: 40px;
            text-align: right;
        }

        .money-top {
            font-size: 12px;
            color: #fcd34d;
            margin-left: 8px;
        }

        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .farm-area {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .farm-title {
            font-size: 13px;
            color: #a5d6a7;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .farm-title .farm-id {
            font-size: 11px;
            color: #666;
            font-family: monospace;
        }

        .plots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .plot {
            background: rgba(139, 90, 43, 0.2);
            border: 1px solid rgba(139, 90, 43, 0.3);
            border-radius: 10px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .plot:hover {
            border-color: #6abf69;
        }

        .plot:active {
            transform: scale(0.96);
        }

        .plot.empty {
            border-style: dashed;
            opacity: 0.6;
        }

        .plot .plot-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 2px;
        }

        .plot .plot-name {
            font-size: 11px;
            color: #ccc;
        }

        .plot .plot-progress {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }

        .plot .plot-progress-bar {
            width: 80%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 3px auto 0;
            overflow: hidden;
        }

        .plot .plot-progress-fill {
            height: 100%;
            background: #4caf50;
            border-radius: 2px;
            transition: width 1s;
        }

        .plot.mature {
            border-color: #fcd34d;
            background: rgba(252, 211, 77, 0.1);
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 4px rgba(252, 211, 77, 0.2);
            }

            to {
                box-shadow: 0 0 12px rgba(252, 211, 77, 0.4);
            }
        }

        .msg-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .msg-item {
            font-size: 13px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-chat {
            color: #ddd;
        }

        .msg-chat .chat-name {
            color: #6abf69;
            font-weight: 600;
            margin-right: 4px;
        }

        .msg-chat .chat-name.me {
            color: #fcd34d;
        }

        .msg-chat .chat-channel {
            font-size: 10px;
            color: #666;
            margin-right: 4px;
        }

        .msg-system {
            color: #888;
            font-size: 12px;
            text-align: center;
            padding: 3px 0;
        }

        .msg-announce {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 12px;
            color: #a5d6a7;
            text-align: center;
        }

        .msg-action {
            color: #aaa;
            font-size: 12px;
            padding-left: 8px;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }

        .msg-action.ok {
            border-left-color: #4ade80;
            color: #a7f3d0;
        }

        .msg-action.fail {
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .msg-private {
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            color: #c4b5fd;
        }

        .msg-trade {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            color: #fcd34d;
        }

        .msg-trade .trade-btns {
            margin-top: 6px;
            display: flex;
            gap: 6px;
        }

        .msg-trade .trade-btns button {
            padding: 4px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }

        .msg-trade .trade-btns .t-accept {
            background: #4caf50;
            color: #fff;
        }

        .msg-trade .trade-btns .t-reject {
            background: #ef4444;
            color: #fff;
        }

        .game-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.2);
        }

        .nav-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            padding: 4px 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .nav-btn {
            text-align: center;
            padding: 4px 2px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .nav-btn:active {
            transform: scale(0.92);
        }

        .nav-btn .nav-icon {
            font-size: 18px;
            display: block;
        }

        .nav-btn .nav-label {
            font-size: 10px;
            color: #888;
            margin-top: 1px;
        }

        .nav-btn.active .nav-label {
            color: #6abf69;
        }

        .chat-input-row {
            display: flex;
            gap: 6px;
            padding: 6px 10px 10px;
        }

        .chat-input-row input {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            padding: 9px 14px;
            font-size: 13px;
            color: #e0e0e0;
            outline: none;
        }

        .chat-input-row input:focus {
            border-color: #6abf69;
        }

        .chat-input-row input::placeholder {
            color: #555;
        }

        .chat-input-row button {
            background: #4caf50;
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 9px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .chat-channel-btn {
            font-size: 11px;
            color: #888;
            padding: 0 14px 2px;
            cursor: pointer;
        }

        .chat-channel-btn:hover {
            color: #6abf69;
        }

        .panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 50;
            justify-content: center;
            align-items: flex-end;
        }

        .panel-overlay.show {
            display: flex;
        }

        .panel-box {
            width: 100%;
            max-width: 500px;
            max-height: 75vh;
            background: #1e2e22;
            border-radius: 16px 16px 0 0;
            padding: 16px;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .panel-title {
            font-size: 15px;
            color: #6abf69;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-close {
            font-size: 20px;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
        }

        .panel-close:hover {
            color: #fff;
        }

        .inv-section {
            margin-bottom: 14px;
        }

        .inv-section-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding-bottom: 4px;
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .inv-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .inv-item:hover {
            border-color: #6abf69;
        }

        .inv-item .ii-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }

        .inv-item .ii-name {
            font-size: 10px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inv-item .ii-count {
            font-size: 10px;
            color: #888;
        }

        .inv-empty {
            text-align: center;
            color: #555;
            padding: 20px;
            font-size: 12px;
            grid-column: 1/-1;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            margin-bottom: 6px;
        }

        .shop-item .si-info {
            flex: 1;
        }

        .shop-item .si-name {
            font-size: 13px;
            color: #a5d6a7;
            font-weight: 600;
        }

        .shop-item .si-desc {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        .shop-item .si-price {
            font-size: 12px;
            color: #fcd34d;
            margin-right: 10px;
            white-space: nowrap;
        }

        .shop-item button {
            padding: 6px 14px;
            background: #4caf50;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
            flex-shrink: 0;
        }

        .shop-item button:active {
            transform: scale(0.95);
        }

        .wild-area-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wild-area-card:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.08);
        }

        .wild-area-card:active {
            transform: scale(0.98);
        }

        .wild-area-card .wa-name {
            font-size: 14px;
            color: #fcd34d;
            font-weight: 600;
        }

        .wild-area-card .wa-desc {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }

        .wild-area-card .wa-seeds {
            font-size: 11px;
            color: #a5d6a7;
            margin-top: 4px;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 13px;
        }

        .friend-item .fi-name {
            color: #a5d6a7;
            font-weight: 600;
        }

        .friend-item .fi-id {
            font-size: 11px;
            color: #666;
            font-family: monospace;
            margin-left: 6px;
        }

        .friend-item .fi-btns {
            display: flex;
            gap: 4px;
        }

        .friend-item .fi-btns button {
            padding: 3px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        .friend-req {
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 6px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trade-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trade-form label {
            font-size: 11px;
            color: #888;
        }

        .trade-form input,
        .trade-form select {
            width: 100%;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            padding: 9px 12px;
            font-size: 13px;
            color: #e0e0e0;
            outline: none;
        }

        .trade-form input:focus,
        .trade-form select:focus {
            border-color: #fcd34d;
        }

        .trade-form select {
            appearance: auto;
        }

        .trade-form button {
            padding: 10px;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: #1a1a2e;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .visit-farm-view {
            text-align: center;
            padding: 10px;
        }

        .visit-plots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .visit-plot {
            background: rgba(139, 90, 43, 0.15);
            border: 1px solid rgba(139, 90, 43, 0.2);
            border-radius: 10px;
            padding: 10px 6px;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .visit-plot .vp-icon {
            font-size: 22px;
        }

        .visit-plot .vp-name {
            font-size: 10px;
            color: #ccc;
            margin-top: 2px;
        }

        .visit-plot .vp-status {
            font-size: 10px;
            color: #888;
        }

        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 13px;
        }

        .group-item .gi-name {
            color: #67e8f9;
            font-weight: 600;
        }

        .group-item .gi-info {
            font-size: 11px;
            color: #888;
        }

        .sell-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .sell-item .sl-info {
            flex: 1;
        }

        .sell-item .sl-name {
            font-size: 13px;
            color: #a5d6a7;
        }

        .sell-item .sl-detail {
            font-size: 11px;
            color: #888;
        }

        .sell-item button {
            padding: 5px 12px;
            background: #f59e0b;
            color: #1a1a2e;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        @media(max-width:360px) {
            .plots-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .inv-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .ranking-medal {
            font-size: 20px;
            display: inline-block;
            margin-right: 6px;
        }

        .ranking-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .ranking-item:hover {
            border-color: #6abf69;
            background: rgba(106, 191, 105, 0.08);
        }

        .ranking-item.me {
            background: rgba(76, 175, 80, 0.08);
            border-color: rgba(76, 175, 80, 0.2);
        }

        .ranking-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 6px 0;
        }

        .ranking-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #fcd34d, #f59e0b);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .cage-area {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .cage-title {
            font-size: 13px;
            color: #fcd34d;
            margin-bottom: 8px;
        }

        .cages-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .cage {
            background: rgba(139, 90, 43, 0.15);
            border: 1px solid rgba(139, 90, 43, 0.25);
            border-radius: 10px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .cage:hover {
            border-color: #fcd34d;
        }

        .cage:active {
            transform: scale(0.96);
        }

        .cage.empty {
            border-style: dashed;
            opacity: 0.6;
        }

        .cage .cage-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 2px;
        }

        .cage .cage-name {
            font-size: 11px;
            color: #ccc;
        }

        .cage .cage-count {
            font-size: 10px;
            color: #fcd34d;
            margin-top: 2px;
        }

        .cage .cage-food {
            font-size: 10px;
            color: #67e8f9;
            margin-top: 2px;
        }

        .cage .cage-status {
            font-size: 9px;
            color: #888;
            margin-top: 2px;
        }

        .cage.starving {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            animation: warning 1.5s infinite;
        }

        @keyframes warning {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .pet-card {
            background: rgba(167, 139, 250, 0.08);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pet-card:hover {
            border-color: #a78bfa;
            background: rgba(167, 139, 250, 0.12);
        }

        .pet-card:active {
            transform: scale(0.98);
        }

        .pet-card .pc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pet-card .pc-icon {
            font-size: 28px;
        }

        .pet-card .pc-name {
            font-size: 14px;
            color: #c4b5fd;
            font-weight: 600;
        }

        .pet-card .pc-species {
            font-size: 11px;
            color: #888;
        }

        .pet-card .pc-stats {
            display: flex;
            gap: 10px;
            margin-top: 6px;
            font-size: 11px;
            color: #aaa;
        }

        .pet-card .pc-adventure {
            font-size: 11px;
            color: #fcd34d;
            margin-top: 4px;
        }

        .mood-bar {
            width: 60px;
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
        }

        .mood-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }

        .rarity-common {
            color: #a5d6a7;
        }

        .rarity-uncommon {
            color: #67e8f9;
        }

        .rarity-rare {
            color: #c4b5fd;
        }

        .rarity-epic {
            color: #fbbf24;
        }

        .rarity-legendary {
            color: #f87171;
        }

        #farmCageWrapper {
            -webkit-overflow-scrolling: touch;
        }

        #farmCageWrapper .farm-area,
        #farmCageWrapper .cage-area {
            max-height: none !important;
            overflow: visible !important;
            flex-shrink: unset !important;
        }

        #farmCageWrapper .cage-area {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <div class="page login-page active" id="loginPage">
        <div class="login-box">
            <h1>üåæ Èò°Èôå‰πãËØó v1.7.3</h1>
            <div class="subtitle">ÁßçÂú∞„ÄÅÈááÈõÜ„ÄÅ‰∫§Âèã„ÄÅ‰∫§Êòì</div>
            <div class="form-group"><label>‰Ω†ÁöÑÊòµÁß∞</label><input type="text" id="loginUser" placeholder="2-16‰∏™Â≠óÁ¨¶"
                    maxlength="16"></div>
            <div class="form-group"><label>ÂØÜÁ†Å</label><input type="password" id="loginPass" placeholder="Ëá≥Â∞ë4‰∏™Â≠óÁ¨¶"></div>
            <div class="remember-row">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">ËÆ∞‰ΩèË¥¶Âè∑Ôºå‰∏ãÊ¨°ÂÖçËæìÂÖ•</label>
            </div>
            <button class="btn btn-green" onclick="doLogin()">Áôª ÂÖ•</button>
            <button class="btn btn-ghost" onclick="doRegister()">Ê≥®ÂÜåÊñ∞Ë¥¶Âè∑</button>
            <div class="login-msg" id="loginMsg"></div>
            <div class="login-status" id="loginStatus">Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...</div>
        </div>
    </div>
    <div class="page worlds-page" id="worldsPage">
        <div class="worlds-header">
            <h2>üåæ ÈÄâÊã©‰∏ñÁïå</h2>
            <div class="user-info">Ê¨¢ËøéÔºå<span id="displayUser"></span>ÔºàÈ¢ÜÂú∞ID: <span id="displayFarmId"
                    style="font-family:monospace;color:#fcd34d;"></span>Ôºâ</div>
        </div>
        <div id="globalNoticeBar" style="display:none;">
            <div style="font-size:11px;color:#66bb6a;font-weight:600;margin-bottom:2px;">üìú ÂÖ¨Âëä</div>
            <div id="globalNoticeText" style="white-space:pre-wrap;"></div>
        </div>
        <div class="worlds-list" id="worldsList"></div>
        <div class="worlds-footer"><button class="btn-logout" onclick="doLogout()">ÈÄÄÂá∫ÁôªÂΩï</button></div>
    </div>
    <div class="page game-page" id="gamePage">
        <div class="game-top">
            <div class="game-top-row">
                <div>
                    <span class="game-world-name" id="gameWorldName">‰∏ñÁïå</span>
                    <div style="font-size:11px;color:#888;margin-top:2px;" id="gamePlayerInfo"></div>
                </div>
                <div class="game-info-right">
                    <span id="gameSeason">üå∏ Êò•</span>
                    <span id="gameWeather">‚òÄÔ∏è Êô¥</span>
                    <span class="money-top" id="moneyTop">üí∞ 0</span>
                    <span class="game-exit-btn" onclick="exitWorld()">üö™ ÈÄÄÂá∫</span>
                </div>
            </div>
            <div class="stamina-bar">
                <span class="st-label">‚ö° ‰ΩìÂäõ</span>
                <div class="st-track">
                    <div class="st-fill" id="staminaFill" style="width:100%"></div>
                </div>
                <span class="st-val" id="staminaVal">100/100</span>
            </div>
        </div>
        <div id="farmCageWrapper"
            style="max-height:35vh;overflow-y:auto;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,0.06);">
            <div class="farm-area" id="farmArea"
                style="max-height:none;overflow:visible;flex-shrink:unset;border-bottom:none;">
                <div class="farm-title"><span>üè° ÂÜúÂú∫Âå∫</span><span class="farm-id" id="farmIdDisplay">ID: ------</span>
                </div>
                <div class="plots-grid" id="plotsGrid"></div>
            </div>
            <div class="cage-area" id="cageArea" style="max-height:none;overflow:visible;flex-shrink:unset;">
                <div class="cage-title">üêæ ÂúàÂÖªÂå∫</div>
                <div class="cages-grid" id="cagesGrid"></div>
            </div>
        </div>
        <div class="msg-area" id="msgArea"></div>
        <div class="game-bottom">
            <div class="nav-bar">
                <div class="nav-btn" onclick="openWild()"><span class="nav-icon">üåø</span><span
                        class="nav-label">ÈáéÂ§ñ</span></div>
                <div class="nav-btn" onclick="openMail()"><span class="nav-icon">üì¨</span><span
                        class="nav-label">ÈÇÆ‰ª∂</span></div>
                <div class="nav-btn" onclick="openPets()"><span class="nav-icon">üê±</span><span
                        class="nav-label">ÂÆ†Áâ©</span></div>
                <div class="nav-btn" onclick="openVisit()"><span class="nav-icon">üè†</span><span
                        class="nav-label">‰∏≤Èó®</span></div>
                <div class="nav-btn" onclick="openInventory()"><span class="nav-icon">üéí</span><span
                        class="nav-label">Áâ©ÂìÅ</span></div>
                <div class="nav-btn" onclick="openShop()"><span class="nav-icon">üè™</span><span
                        class="nav-label">ÂïÜÂ∫ó</span></div>
                <div class="nav-btn" onclick="openTrade()"><span class="nav-icon">ü§ù</span><span
                        class="nav-label">‰∫§Êòì</span></div>
                <div class="nav-btn" onclick="openFriends()"><span class="nav-icon">üë•</span><span
                        class="nav-label">Â•ΩÂèã</span></div>
                <div class="nav-btn" onclick="openRanking()"><span class="nav-icon">üèÜ</span><span
                        class="nav-label">ÊéíË°å</span></div>
                <div class="nav-btn" onclick="openSell()"><span class="nav-icon">üí∞</span><span
                        class="nav-label">ÂçñÂá∫</span></div>
            </div>
            <div class="chat-channel-btn" id="chatChannelBtn" onclick="toggleChannel()">üì¢ ‰∏ñÁïåÈ¢ëÈÅì</div>
            <div class="chat-input-row">
                <input type="text" id="chatInput" placeholder="ËØ¥ÁÇπ‰ªÄ‰πà...">
                <button onclick="sendChat()">ÂèëÈÄÅ</button>
            </div>
        </div>
    </div>
    <div class="panel-overlay" id="panelWild">
        <div class="panel-box">
            <div class="panel-title">üåø ÈáéÂ§ñÈááÈõÜ <span class="panel-close" onclick="closePanel('panelWild')">&times;</span>
            </div>
            <div id="wildContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelMail">
        <div class="panel-box">
            <div class="panel-title">üì¨ ÈÇÆ‰ª∂ <span class="panel-close" onclick="closePanel('panelMail')">&times;</span>
            </div>
            <div id="mailContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelCageAction">
        <div class="panel-box">
            <div class="panel-title">üêæ ÂúàÂÖªÊìç‰Ωú <span class="panel-close"
                    onclick="closePanel('panelCageAction')">&times;</span></div>
            <div id="cageActionContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelVisit">
        <div class="panel-box">
            <div class="panel-title">üè† ‰∏≤Èó® <span class="panel-close" onclick="closePanel('panelVisit')">&times;</span>
            </div>
            <div id="visitContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelInv">
        <div class="panel-box">
            <div class="panel-title">üéí Áâ©ÂìÅ <span class="panel-close" onclick="closePanel('panelInv')">&times;</span>
            </div>
            <div id="invContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelShop">
        <div class="panel-box">
            <div class="panel-title">üè™ ÂïÜÂ∫ó <span class="panel-close" onclick="closePanel('panelShop')">&times;</span>
            </div>
            <div id="shopContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelTrade">
        <div class="panel-box">
            <div class="panel-title">ü§ù ‰∫§Êòì <span class="panel-close" onclick="closePanel('panelTrade')">&times;</span>
            </div>
            <div id="tradeContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelFriends">
        <div class="panel-box">
            <div class="panel-title">üë• Â•ΩÂèã <span class="panel-close" onclick="closePanel('panelFriends')">&times;</span>
            </div>
            <div id="friendsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelSell">
        <div class="panel-box">
            <div class="panel-title">üí∞ ÂçñÂá∫ÊûúÂÆû <span class="panel-close" onclick="closePanel('panelSell')">&times;</span>
            </div>
            <div id="sellContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelPlotAction">
        <div class="panel-box">
            <div class="panel-title">üå± Âú∞ÂùóÊìç‰Ωú <span class="panel-close"
                    onclick="closePanel('panelPlotAction')">&times;</span></div>
            <div id="plotActionContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelGroups">
        <div class="panel-box">
            <div class="panel-title">üí¨ Áæ§ËÅä <span class="panel-close" onclick="closePanel('panelGroups')">&times;</span>
            </div>
            <div id="groupsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelRanking">
        <div class="panel-box">
            <div class="panel-title">üèÜ ÊéíË°åÊ¶ú <span class="panel-close"
                    onclick="closePanel('panelRanking')">&times;</span></div>
            <div style="display:flex;gap:6px;margin-bottom:10px;">
                <button id="rankTabMoney"
                    style="flex:1;padding:8px;border:1px solid rgba(252,211,77,0.3);background:rgba(252,211,77,0.15);color:#fcd34d;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;"
                    onclick="switchRankTab('money')">üí∞ ÈáëÂ∏ÅÊéíË°å</button>
                <button id="rankTabPet"
                    style="flex:1;padding:8px;border:1px solid rgba(167,139,250,0.2);background:transparent;color:#888;border-radius:8px;font-size:12px;cursor:pointer;"
                    onclick="switchRankTab('pet')">üê± ÂÆ†Áâ©‰ª∑ÂÄº</button>
            </div>
            <div id="rankingContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelPets">
        <div class="panel-box">
            <div class="panel-title">üê± ÊàëÁöÑÂÆ†Áâ© <span class="panel-close" onclick="closePanel('panelPets')">&times;</span>
            </div>
            <div id="petsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelPetDetail">
        <div class="panel-box">
            <div class="panel-title">üêæ ÂÆ†Áâ©ËØ¶ÊÉÖ <span class="panel-close"
                    onclick="closePanel('panelPetDetail')">&times;</span></div>
            <div id="petDetailContent"></div>
        </div>
    </div>

    <script>
        var SERVER_URL = 'wss://ws.qmzs.top';
        var ws = null, username = null, farmId = null, currentWorld = null, playerData = null;
        var chatChannel = 'world', reconnTimer = null, hbTimer = null;
        var visitingOwner = null, visitingFarmId = null;
        var cageUpdateTimer = null;
        var serverTimeOffset = 0;
        var cachedFriendList = [];
        var _inWorld = false;

        // ‚òÖ ËÆ∞‰ΩèË¥¶Âè∑
        function loadSavedAccount() {
            try {
                var saved = localStorage.getItem('qmzs_account');
                if (saved) {
                    var data = JSON.parse(saved);
                    if (data.username) document.getElementById('loginUser').value = data.username;
                    if (data.password) document.getElementById('loginPass').value = data.password;
                    document.getElementById('rememberMe').checked = true;
                }
            } catch (e) { }
        }
        function saveAccount(u, p) {
            try {
                if (document.getElementById('rememberMe').checked) {
                    localStorage.setItem('qmzs_account', JSON.stringify({ username: u, password: p }));
                } else {
                    localStorage.removeItem('qmzs_account');
                }
            } catch (e) { }
        }
        function clearSavedAccount() {
            try { localStorage.removeItem('qmzs_account'); } catch (e) { }
        }

        // ‚òÖ ÈÄÄÂá∫‰∏ñÁïåÂõûÂà∞ÈÄâÊã©ÁïåÈù¢
        function exitWorld() {
            if (!_inWorld) return;
            if (!confirm('Á°ÆÂÆöÈÄÄÂá∫ÂΩìÂâç‰∏ñÁïåÔºü')) return;
            _inWorld = false;
            _lastVisitPlotsHash = '';
            clearTimers();
            if (cageUpdateTimer) { clearInterval(cageUpdateTimer); cageUpdateTimer = null; }
            currentWorld = null;
            playerData = null;
            visitingOwner = null;
            visitingFarmId = null;
            document.querySelectorAll('.panel-overlay').forEach(function (el) { el.classList.remove('show'); });
            var vbar = document.getElementById('visitStatusBar');
            if (vbar) vbar.remove();
            document.getElementById('msgArea').innerHTML = '';
            showWorldsPage();
        }

        function openFeedbackForm() {
            var el = document.getElementById('feedbackFormArea');
            if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
        function submitFeedback() {
            var text = (document.getElementById('feedbackText').value || '').trim();
            if (!text || text.length < 2) { alert('ÂèçÈ¶àÂÜÖÂÆπËá≥Â∞ë2‰∏™Â≠ó'); return; }
            if (text.length > 500) { alert('ÂèçÈ¶àÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá500Â≠ó'); return; }
            wsSend({ type: 'submit_feedback', text: text });
            document.getElementById('feedbackText').value = '';
            document.getElementById('feedbackFormArea').style.display = 'none';
            alert('ÊÑüË∞¢‰Ω†ÁöÑÂèçÈ¶àÔºÅ');
        }

        function connectWS() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            updLoginStatus('Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...');
            ws = new WebSocket(SERVER_URL);
            ws.onopen = function () { updLoginStatus('Â∑≤ËøûÊé•', true); if (reconnTimer) { clearTimeout(reconnTimer); reconnTimer = null; } startHB(); };
            ws.onmessage = function (e) { var m; try { m = JSON.parse(e.data); } catch (err) { return; } handleMsg(m); };
            ws.onerror = function () { updLoginStatus('ËøûÊé•Âá∫Èîô', false); };
            ws.onclose = function () { updLoginStatus('ËøûÊé•Êñ≠ÂºÄÔºåÈáçËøû‰∏≠...', false); stopHB(); reconnTimer = setTimeout(connectWS, 3000); };
        }
        function wsSend(o) { if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(o)); }
        function startHB() { stopHB(); hbTimer = setInterval(function () { wsSend({ type: 'heartbeat' }); }, 25000); }
        function stopHB() { if (hbTimer) { clearInterval(hbTimer); hbTimer = null; } }
        function doAction(action, payload) { wsSend({ type: 'action', action: action, payload: payload || {} }); }

        function handleMsg(msg) {
            switch (msg.type) {
                case 'register_result':
                    showLoginMsg(msg.msg, msg.ok);
                    if (msg.ok && msg.farmId) showLoginMsg(msg.msg + 'Ôºå‰Ω†ÁöÑÈ¢ÜÂú∞ID: ' + msg.farmId, true);
                    break;
                case 'login_result':
                    if (msg.ok) {
                        username = msg.username; farmId = msg.farmId;
                        saveAccount(document.getElementById('loginUser').value.trim(), document.getElementById('loginPass').value);
                        showLoginMsg('ÁôªÂΩïÊàêÂäü', true);
                        setTimeout(showWorldsPage, 400);
                    } else showLoginMsg(msg.msg, false);
                    break;
                case 'world_list':
                    renderWorldList(msg.data);
                    if (msg.globalNotice) {
                        document.getElementById('globalNoticeText').textContent = msg.globalNotice;
                        document.getElementById('globalNoticeBar').style.display = 'block';
                    } else {
                        document.getElementById('globalNoticeBar').style.display = 'none';
                    }
                    break;
                case 'enter_world_result':
                    console.log('enter_world_result:', msg);
                    if (msg.ok) enterGame(msg);
                    else alert(msg.msg);
                    break;
                case 'action_result': handleActionResult(msg); break;
                case 'chat':
                    addChatMsg(msg.from, msg.text, msg.channel, false, msg.title);
                    break;
                case 'private_msg': addPrivateMsg(msg.from, msg.text); break;
                case 'group_msg': addGroupMsg(msg.groupName, msg.from, msg.text); break;
                case 'player_online':
                    doAction('friend_list');
                    break;
                case 'player_offline':
                    doAction('friend_list');
                    break;
                case 'announcement': addAnnounce(msg.text); break;
                case 'world_update': if (msg.announcement) addAnnounce(msg.announcement); break;
                case 'season_update': updSeason(msg.season, msg.weather); break;
                case 'visitor_enter': addSysMsg(msg.username + ' Êù•‰Ω†ÂÜúÂú∫‰∏≤Èó®‰∫Ü'); break;
                case 'visitor_leave': addSysMsg(msg.username + ' Á¶ªÂºÄ‰∫Ü‰Ω†ÁöÑÂÜúÂú∫'); break;
                case 'trade_incoming': showTradeIncoming(msg.trade); break;
                case 'trade_completed': addActionOk('‰∫§ÊòìÂÆåÊàêÔºÅ'); if (msg.seeds) playerData.seeds = msg.seeds; if (msg.fruits) playerData.fruits = msg.fruits; if (msg.money !== undefined) { playerData.money = msg.money; updMoney(); } break;
                case 'trade_rejected': addActionFail('ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑ‰∫§Êòì'); break;
                case 'trade_cancelled': addSysMsg('‰∏ÄÁ¨î‰∫§ÊòìË¢´ÂèñÊ∂à‰∫Ü'); break;
                case 'friend_request_received': addSysMsg(msg.from + ' ËØ∑Ê±ÇÂä†‰Ω†‰∏∫Â•ΩÂèã'); break;
                case 'friend_accepted': addActionOk(msg.by + ' Êé•Âèó‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãËØ∑Ê±Ç'); break;
                case 'group_invite': addSysMsg(msg.inviter + ' ÈÇÄËØ∑‰Ω†Âä†ÂÖ•Áæ§ËÅä„Äå' + msg.group.name + '„Äç'); break;
                case 'player_update': playerData = msg.player; refreshFarm(); break;
                case 'kicked': alert(msg.msg || 'Ë¢´Ë∏¢Âá∫'); exitToWorlds(); break;
                case 'blacklisted': alert(msg.msg || '‰Ω†Â∑≤Ë¢´Âä†ÂÖ•ÈªëÂêçÂçï'); exitToWorlds(); break;
                case 'heartbeat_ack':
                    if (msg.timestamp) serverTimeOffset = msg.timestamp - Date.now();
                    break;
                case 'mail_notify':
                    if (msg.count > 0) {
                        addSysMsg('üì¨ ‰Ω†Êúâ ' + msg.count + ' Â∞ÅÈÇÆ‰ª∂' + (msg.unclaimedCount > 0 ? 'Ôºà' + msg.unclaimedCount + ' Â∞ÅÊúâÈôÑ‰ª∂ÂæÖÈ¢ÜÂèñÔºâ' : ''));
                    }
                    break;
                case 'pet_adventure_ready':
                    if (msg.count > 0) {
                        addSysMsg('üêæ ‰Ω†Êúâ ' + msg.count + ' Âè™ÂÆ†Áâ©ÂØªÂÆùÂΩíÊù•Ôºö' + msg.petNames + 'ÔºåÂø´ÂéªÈ¢ÜÂèñÂ•ñÂä±ÂêßÔºÅ');
                    }
                    break;
                case 'new_mail':
                    addSysMsg('üì¨ Êî∂Âà∞Êñ∞ÈÇÆ‰ª∂Ôºö' + (msg.mail.subject || 'Á≥ªÁªüÈÇÆ‰ª∂'));
                    break;
                case 'visitor_water':
                    addSysMsg(msg.from + ' Áªô‰Ω†ÁöÑ ' + msg.plantName + ' Êµá‰∫ÜÊ∞¥ üíß');
                    if (playerData && playerData.plots && playerData.plots[msg.plotId] && playerData.plots[msg.plotId].plant) {
                        playerData.plots[msg.plotId].plant.watered = true;
                        if (!visitingOwner) renderPlots();
                    }
                    break;
                case 'farm_plot_update':
                    if (visitingOwner === msg.owner) {
                        addSysMsg('Êúâ‰∫∫Áªô ' + msg.plantName + ' Êµá‰∫ÜÊ∞¥ üíß');
                        doAction('visit_farm', { farmId: visitingFarmId });
                    }
                    break;
                case 'feedback_result':
                    if (msg.ok) addActionOk(msg.msg || 'ÂèçÈ¶àÂ∑≤Êèê‰∫§');
                    else addActionFail(msg.msg || 'Êèê‰∫§Â§±Ë¥•');
                    break;
                case 'friend_online':
                    addSysMsg('üü¢ ' + esc(msg.username) + ' ‰∏äÁ∫ø‰∫Ü');
                    break;
                case 'friend_offline':
                    addSysMsg('‚ö´ ' + esc(msg.username) + ' ‰∏ãÁ∫ø‰∫Ü');
                    break;
            }
        }


        // ‚òÖ Ë¢´Ë∏¢Âá∫Êó∂ÂõûÂà∞‰∏ñÁïåÂàóË°®ËÄå‰∏çÊòØÂà∑Êñ∞È°µÈù¢
        function exitToWorlds() {
            _inWorld = false;
            _lastVisitPlotsHash = '';
            clearTimers();
            if (cageUpdateTimer) { clearInterval(cageUpdateTimer); cageUpdateTimer = null; }
            currentWorld = null;
            playerData = null;
            visitingOwner = null;
            visitingFarmId = null;
            document.querySelectorAll('.panel-overlay').forEach(function (el) { el.classList.remove('show'); });
            var vbar = document.getElementById('visitStatusBar');
            if (vbar) vbar.remove();
            document.getElementById('msgArea').innerHTML = '';
            if (username) showWorldsPage();
            else showPage('loginPage');
        }

        function handleActionResult(msg) {
            var a = msg.action, ok = msg.ok;
            if (msg.stamina !== undefined && playerData) { playerData.stamina = msg.stamina; updStamina(); }
            if (msg.staminaMax !== undefined && playerData) { playerData.staminaMax = msg.staminaMax; updStamina(); }
            if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); }
            if (msg.plots && playerData && a !== 'visit_farm') {
                if (a === 'water' && visitingOwner) {
                    updateVisitPlots(msg.plots);
                } else {
                    playerData.plots = msg.plots;
                    renderPlots();
                }
            }
            if (msg.seeds && playerData && a !== 'visit_farm') playerData.seeds = msg.seeds;
            if (msg.fruits && playerData && a !== 'visit_farm') playerData.fruits = msg.fruits;
            if (msg.items && playerData) playerData.items = msg.items;
            if (msg.restCooldown !== undefined && playerData) playerData.restCooldown = msg.restCooldown;
            if (msg.hasWaterBoost !== undefined && playerData) playerData.hasWaterBoost = msg.hasWaterBoost;

            switch (a) {
                case 'gather':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.stamina !== undefined && playerData) {
                            playerData.stamina = msg.stamina;
                            updStamina();
                        }
                        if (document.getElementById('panelWild').classList.contains('show')) {
                            doAction('wild_areas');
                        }
                    } else {
                        addActionFail(msg.msg);
                    }
                    break;
                case 'rest': if (ok) { addActionOk(msg.msg); if (document.getElementById('panelWild').classList.contains('show')) { doAction('wild_areas'); } } else addActionFail(msg.msg); break;
                case 'plant': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'water': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'fertilize': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'harvest': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'my_farm':
                    if (ok && playerData) {
                        playerData.plots = msg.plots; playerData.seeds = msg.seeds; playerData.fruits = msg.fruits;
                        playerData.items = msg.items; playerData.money = msg.money; playerData.stamina = msg.stamina;
                        playerData.staminaMax = msg.staminaMax; playerData.restCooldown = msg.restCooldown;
                        playerData.farmId = msg.farmId;
                        playerData.waterBoostLevel = msg.waterBoostLevel || 0;
                        if (!visitingOwner) {
                            refreshFarm();
                        } else {
                            updStamina();
                            updMoney();
                        }
                    }
                    if (msg.cages) playerData.cages = msg.cages;
                    if (msg.animals) playerData.animals = msg.animals;
                    if (msg.pets) playerData.pets = msg.pets;
                    if (!visitingOwner) {
                        renderCages();
                    }
                    break;
                case 'inventory':
                    if (ok) {
                        playerData.seeds = msg.seeds; playerData.fruits = msg.fruits;
                        playerData.items = msg.items; playerData.money = msg.money;
                        renderInventoryPanel(msg.seeds, msg.fruits, msg.items, msg.money);
                        if (window._pendingSellRender) { window._pendingSellRender = false; renderSellPanel(); }
                    }
                    break;
                case 'shop_list':
                    if (ok) renderShopPanel(msg.shop, msg.money);
                    break;
                case 'shop_buy':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.money !== undefined && playerData) playerData.money = msg.money;
                        if (msg.waterBoostLevel !== undefined && playerData) playerData.waterBoostLevel = msg.waterBoostLevel;
                        if (msg.seeds && playerData) playerData.seeds = msg.seeds;
                        if (msg.items && playerData) playerData.items = msg.items;
                        if (msg.plots && playerData) playerData.plots = msg.plots;
                        setTimeout(function () {
                            doAction('shop_list');
                        }, 150);
                    } else addActionFail(msg.msg);
                    break;
                case 'sell_fruit':
                    if (ok) { addActionOk(msg.msg); openSell(); } else addActionFail(msg.msg);
                    break;
                case 'sell_seed':
                    if (ok) { addActionOk(msg.msg); openSell(); } else addActionFail(msg.msg);
                    break;
                case 'sell_stock_animal':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.animals && playerData) playerData.animals = msg.animals;
                        openSell();
                    } else addActionFail(msg.msg);
                    break;
                case 'wild_areas':
                    if (ok) renderWildPanel(msg.areas, msg.stamina, msg.staminaMax);
                    break;
                case 'catch_animal':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.stamina !== undefined && playerData) {
                            playerData.stamina = msg.stamina;
                            updStamina();
                        }
                        if (msg.animals && playerData) {
                            playerData.animals = msg.animals;
                        }
                        if (document.getElementById('panelWild').classList.contains('show')) {
                            doAction('wild_areas');
                        }
                    } else {
                        addActionFail(msg.msg);
                    }
                    break;
                case 'place_animal':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.cages && playerData) playerData.cages = msg.cages;
                        if (msg.animals && playerData) playerData.animals = msg.animals;
                        renderCages();
                        closePanel('panelCageAction');
                    } else {
                        addActionFail(msg.msg);
                    }
                    break;
                case 'feed_animal':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.cages && playerData) playerData.cages = msg.cages;
                        if (msg.seeds && playerData) playerData.seeds = msg.seeds;
                        if (msg.fruits && playerData) playerData.fruits = msg.fruits;
                        renderCages();
                    } else {
                        addActionFail(msg.msg);
                    }
                    break;
                case 'sell_animal':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.cages && playerData) playerData.cages = msg.cages;
                        if (msg.money !== undefined && playerData) {
                            playerData.money = msg.money;
                            updMoney();
                        }
                        renderCages();
                        closePanel('panelCageAction');
                    } else {
                        addActionFail(msg.msg);
                    }
                    break;
                case 'my_cages':
                    if (ok && playerData) {
                        playerData.cages = msg.cages;
                        playerData.animals = msg.animals;
                        renderCages();
                    }
                    break;
                case 'visit_farm':
                    if (ok) {
                        var isRefresh = (visitingOwner === msg.owner);
                        if (isRefresh) {
                            updateVisitPlots(msg.plots);
                        } else {
                            renderVisitFarm(msg.owner, msg.farmId, msg.plots, msg.visitors);
                            closePanel('panelVisit');
                            addActionOk('Êù•Âà∞‰∫Ü ' + msg.owner + ' ÁöÑÂÜúÂú∫');
                        }
                    }
                    else { if (!visitingOwner) addActionFail(msg.msg); }
                    break;
                case 'go_home':
                    if (ok) {
                        visitingOwner = null;
                        visitingFarmId = null;
                        closePanel('panelVisit');
                        var vbar = document.getElementById('visitStatusBar');
                        if (vbar) vbar.remove();
                        var ft = document.querySelector('.farm-title');
                        if (ft && playerData) {
                            ft.innerHTML = '<span>üè° ÊàëÁöÑÂÜúÂú∫</span><span class="farm-id" id="farmIdDisplay">ID: ' + (playerData.farmId || '???') + '</span>';
                        }
                        addActionOk('ÂõûÂà∞‰∫ÜËá™Â∑±ÁöÑÂÜúÂú∫');
                        doAction('my_farm');
                    }
                    break;
                case 'friend_list':
                    if (ok) {
                        cachedFriendList = (msg.friends || []).map(function (f) { return f.username; });
                        renderFriendsPanel(msg.friends, msg.requests);
                    }
                    break;
                case 'friend_request': case 'friend_accept': case 'friend_reject': case 'friend_remove':
                    if (ok) { addActionOk(msg.msg); doAction('friend_list'); } else addActionFail(msg.msg);
                    break;
                case 'trade_create':
                    if (ok) { addActionOk(msg.msg); closePanel('panelTrade'); } else addActionFail(msg.msg);
                    break;
                case 'trade_list':
                    if (ok) renderTradeList(msg.trades);
                    break;
                case 'trade_accept': case 'trade_reject': case 'trade_cancel':
                    if (ok) { addActionOk(msg.msg); doAction('trade_list'); } else addActionFail(msg.msg);
                    break;
                case 'private_msg':
                    if (ok) addActionOk(msg.msg); else addActionFail(msg.msg);
                    break;
                case 'list_groups':
                    if (ok) renderGroupsPanel(msg.groups);
                    break;
                case 'create_group':
                    if (ok) { addActionOk('Áæ§ËÅäÂàõÂª∫ÊàêÂäü'); doAction('list_groups'); } else addActionFail(msg.msg);
                    break;
                case 'invite_group':
                    if (ok) addActionOk(msg.msg); else addActionFail(msg.msg);
                    break;
                case 'leave_group':
                    if (ok) { addActionOk(msg.msg); doAction('list_groups'); } else addActionFail(msg.msg);
                    break;
                case 'group_msg':
                    if (!ok) addActionFail(msg.msg);
                    break;
                case 'my_pets':
                    if (ok && playerData) {
                        playerData.pets = msg.pets || [];
                        renderPetsPanel(playerData.pets);
                    }
                    break;
                case 'catch_pet':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.pets && playerData) playerData.pets = msg.pets;
                        if (msg.stamina !== undefined && playerData) { playerData.stamina = msg.stamina; updStamina(); }
                        if (document.getElementById('panelWild').classList.contains('show')) {
                            doAction('wild_areas');
                        }
                    } else { addActionFail(msg.msg); }
                    break;
                case 'rename_pet':
                    if (ok) { addActionOk(msg.msg); if (msg.pets && playerData) playerData.pets = msg.pets; doAction('my_pets'); }
                    else addActionFail(msg.msg);
                    break;
                case 'pet_adventure':
                    if (ok) { addActionOk(msg.msg); if (msg.pets && playerData) playerData.pets = msg.pets; doAction('my_pets'); }
                    else addActionFail(msg.msg);
                    break;
                case 'pet_collect':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.pets && playerData) playerData.pets = msg.pets;
                        if (msg.seeds && playerData) playerData.seeds = msg.seeds;
                        if (msg.fruits && playerData) playerData.fruits = msg.fruits;
                        if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); }
                        doAction('my_pets');
                    } else addActionFail(msg.msg);
                    break;
                case 'pet_interact':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.pets && playerData) {
                            playerData.pets = msg.pets;
                            // Âà∑Êñ∞ËØ¶ÊÉÖÈù¢ÊùøÔºàÂ¶ÇÊûúÊâìÂºÄÁùÄÔºâ
                            if (document.getElementById('panelPetDetail').classList.contains('show') && msg.petId) {
                                openPetDetail(msg.petId);
                            }
                        }
                        doAction('my_pets');
                    } else addActionFail(msg.msg);
                    break;
                case 'release_pet':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.pets && playerData) playerData.pets = msg.pets;
                        if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); }
                        closePanel('panelPetDetail');
                        doAction('my_pets');
                    } else addActionFail(msg.msg);
                    break;
                case 'world_ranking':
                    if (ok) renderRankingPanel(msg.ranking, msg.myRank);
                    break;
                case 'pet_ranking':
                    if (ok) renderPetRankingPanel(msg.ranking, msg.myRank);
                    break;
                case 'mail_list':
                    if (ok) renderMailPanel(msg.mails);
                    break;
                case 'mail_claim':
                    if (ok) {
                        addActionOk(msg.msg);
                        if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); }
                        if (msg.seeds && playerData) playerData.seeds = msg.seeds;
                        if (msg.fruits && playerData) playerData.fruits = msg.fruits;
                        if (msg.pets && playerData) playerData.pets = msg.pets;
                        doAction('mail_list');
                    } else addActionFail(msg.msg);
                    break;
                case 'mail_delete':
                    if (ok) { addActionOk(msg.msg); doAction('mail_list'); }
                    else addActionFail(msg.msg);
                    break;
                case 'mail_delete_all':
                    if (ok) { addActionOk(msg.msg); doAction('mail_list'); }
                    else addActionFail(msg.msg);
                    break;
                case 'mail_read':
                    if (ok) { doAction('mail_list'); }
                    break;
                case 'mail_read_all':
                    if (ok) { addActionOk(msg.msg); doAction('mail_list'); }
                    break;  
                default:
                    if (msg.msg) { if (ok) addActionOk(msg.msg); else addActionFail(msg.msg); }
            }
        }

        function doLogin() { var u = document.getElementById('loginUser').value.trim(), p = document.getElementById('loginPass').value; if (!u || !p) { showLoginMsg('ËØ∑ËæìÂÖ•ÊòµÁß∞ÂíåÂØÜÁ†Å', false); return; } wsSend({ type: 'login', username: u, password: p }); }
        function doRegister() { var u = document.getElementById('loginUser').value.trim(), p = document.getElementById('loginPass').value; if (!u || !p) { showLoginMsg('ËØ∑ËæìÂÖ•ÊòµÁß∞ÂíåÂØÜÁ†Å', false); return; } wsSend({ type: 'register', username: u, password: p }); }
        function doLogout() { username = null; farmId = null; currentWorld = null; playerData = null; clearTimers(); showPage('loginPage'); }
        function showLoginMsg(t, ok) { var e = document.getElementById('loginMsg'); e.textContent = t; e.className = 'login-msg ' + (ok ? 'ok' : 'err'); }
        function updLoginStatus(t, ok) { var e = document.getElementById('loginStatus'); if (e) { e.textContent = t; e.style.color = ok === true ? '#4ade80' : ok === false ? '#ef4444' : '#555'; } }

        function showWorldsPage() {
            document.getElementById('displayUser').textContent = username;
            document.getElementById('displayFarmId').textContent = farmId || '???';
            showPage('worldsPage');
            wsSend({ type: 'list_worlds' });
        }

        function showPage(id) { document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); }); document.getElementById(id).classList.add('active'); }

        function renderWorldList(list) {
            var c = document.getElementById('worldsList');
            if (!list || list.length === 0) { c.innerHTML = '<div class="no-worlds">ÊöÇÊó†‰∏ñÁïå<br><span style="font-size:12px;color:#555;">Á≠âÂæÖÂ§©ÈÅìÂàõÂª∫...</span></div>'; return; }
            var h = '';
            for (var i = 0; i < list.length; i++) {
                var w = list[i];
                if (w.status !== 'active') continue;
                h += '<div class="world-card" data-wid="' + w.id + '" data-haspw="' + w.hasPassword + '" onclick="clickWorld(this)">';
                h += '<h3>üåæ ' + esc(w.name) + '</h3>';
                h += '<div class="world-info"><span>üë• ' + (w.playerCount || 0) + '‰∫∫</span>';
                if (w.hasPassword) h += '<span>üîí ÈúÄÂØÜÁ†Å</span>';
                h += '</div>';
                h += '<div class="world-pw-input" id="wpw_' + w.id + '" onclick="event.stopPropagation()"><input type="password" placeholder="ËæìÂÖ•ÂØÜÁ†Å" id="wpwi_' + w.id + '"><button onclick="enterWorld(\'' + w.id + '\')">ËøõÂÖ•</button></div>';
                h += '</div>';
            }
            h += '<div style="padding:16px 0 8px;text-align:center;">';
            h += '<button style="padding:10px 24px;background:rgba(167,139,250,0.15);color:#c4b5fd;border:1px solid rgba(167,139,250,0.25);border-radius:10px;font-size:13px;cursor:pointer;" onclick="openFeedbackForm()">üìù ÊÑèËßÅÂèçÈ¶à</button>';
            h += '</div>';
            h += '<div id="feedbackFormArea" style="display:none;padding:0 12px 12px;">';
            h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:14px;">';
            h += '<div style="font-size:13px;color:#c4b5fd;margin-bottom:8px;">üìù ÊÑèËßÅÂèçÈ¶à</div>';
            h += '<textarea id="feedbackText" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÂª∫ËÆÆ„ÄÅbugÂèçÈ¶àÊàñÊÉ≥Ê≥ï..." style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:10px;font-size:13px;color:#e0e0e0;outline:none;min-height:80px;resize:vertical;font-family:inherit;"></textarea>';
            h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">';
            h += '<span style="font-size:11px;color:#666;">ÊúÄÂ§ö500Â≠ó</span>';
            h += '<button style="padding:8px 20px;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;" onclick="submitFeedback()">Êèê‰∫§ÂèçÈ¶à</button>';
            h += '</div></div></div>';
            c.innerHTML = h;
        }
        function clickWorld(el) { var wid = el.getAttribute('data-wid'), hp = el.getAttribute('data-haspw') === 'true'; if (hp) { var d = document.getElementById('wpw_' + wid); d.style.display = d.style.display === 'block' ? 'none' : 'block'; } else enterWorld(wid); }
        function enterWorld(wid) { var pi = document.getElementById('wpwi_' + wid); wsSend({ type: 'enter_world', worldId: wid, password: pi ? pi.value : '' }); }

        function clearTimers() {
            if (window._farmRefreshTimer) { clearInterval(window._farmRefreshTimer); window._farmRefreshTimer = null; }
            if (window._localPlotTimer) { clearInterval(window._localPlotTimer); window._localPlotTimer = null; }
            if (cageUpdateTimer) { clearInterval(cageUpdateTimer); cageUpdateTimer = null; }
        }

        function enterGame(msg) {
            _inWorld = true;
            _lastVisitPlotsHash = '';
            currentWorld = msg.world;
            playerData = msg.player;
            document.getElementById('gameWorldName').textContent = currentWorld.name;
            document.getElementById('farmIdDisplay').textContent = 'ID: ' + (playerData.farmId || '???');
            document.getElementById('gamePlayerInfo').textContent = username + ' ¬∑ ID: ' + (playerData.farmId || '???');
            updSeason(currentWorld.season, currentWorld.weather);
            updStamina();
            updMoney();
            renderPlots();
            renderCages();
            document.getElementById('msgArea').innerHTML = '';
            addSysMsg('Ê¨¢ËøéÊù•Âà∞„Äå' + currentWorld.name + '„Äç');
            if (currentWorld.announcements) {
                for (var i = 0; i < currentWorld.announcements.length; i++) addAnnounce(currentWorld.announcements[i].text);
            }
            showPage('gamePage');
            clearTimers();
            if (cageUpdateTimer) { clearInterval(cageUpdateTimer); cageUpdateTimer = null; }
            cageUpdateTimer = setInterval(function () {
                if (!visitingOwner) {
                    doAction('my_cages');
                }
            }, 15000);
            window._farmRefreshTimer = setInterval(function () {
                if (visitingOwner) {
                    // ‚òÖ ‰∏≤Èó®‰∏≠ÔºöÈáçÊñ∞ÊãâÂèñÂ•ΩÂèãÂÜúÂú∫Êï∞ÊçÆ
                    doAction('visit_farm', { farmId: visitingFarmId });
                } else {
                    doAction('my_farm');
                }
            }, 10000);
            window._localPlotTimer = setInterval(localUpdatePlots, 5000);
            doAction('friend_list');
        }

        function localUpdatePlots() {
            if (visitingOwner) return;
            if (!playerData || !playerData.plots) return;
            var now = Date.now() + serverTimeOffset;
            var anyChange = false;
            playerData.plots.forEach(function (pl) {
                if (pl.plant && !pl.plant.mature) {
                    var elapsed = now - pl.plant.plantedAt;
                    var gt = pl.plant.effectiveGrowTime || pl.plant.growTime || 7200000;
                    var newProg = Math.max(0, Math.min(1, elapsed / gt));
                    if (Math.abs(newProg - (pl.plant.progress || 0)) > 0.005) {
                        pl.plant.progress = newProg;
                        if (newProg >= 1) pl.plant.mature = true;
                        anyChange = true;
                    }
                }
            });
            if (anyChange) renderPlots();
        }

        function updStamina() {
            if (!playerData) return;
            var pct = Math.round((playerData.stamina / (playerData.staminaMax || 100)) * 100);
            document.getElementById('staminaFill').style.width = pct + '%';
            document.getElementById('staminaVal').textContent = playerData.stamina + '/' + (playerData.staminaMax || 100);
        }
        function updMoney() { if (!playerData) return; document.getElementById('moneyTop').textContent = 'üí∞ ' + playerData.money; }
        function updSeason(season, weather) {
            var sMap = { 'Êò•': 'üå∏ Êò•', 'Â§è': '‚òÄÔ∏è Â§è', 'Áßã': 'üçÇ Áßã', 'ÂÜ¨': '‚ùÑÔ∏è ÂÜ¨' };
            var wMap = { 'Êô¥': '‚òÄÔ∏è Êô¥', 'Â§ö‰∫ë': '‚õÖ Â§ö‰∫ë', 'Èò¥': '‚òÅÔ∏è Èò¥', 'Â∞èÈõ®': 'üå¶Ô∏è Â∞èÈõ®', 'Â§ßÈõ®': 'üåßÔ∏è Â§ßÈõ®', 'Èõ™': 'üå®Ô∏è Èõ™', 'Èõæ': 'üå´Ô∏è Èõæ' };
            if (season) document.getElementById('gameSeason').textContent = sMap[season] || season;
            if (weather) document.getElementById('gameWeather').textContent = wMap[weather] || weather;
        }
        function refreshFarm() { updStamina(); updMoney(); renderPlots(); }

        function renderPlots() {
            if (!playerData) return;
            var g = document.getElementById('plotsGrid');
            var h = '';
            for (var i = 0; i < playerData.plots.length; i++) {
                var pl = playerData.plots[i];
                if (pl.plant) {
                    var progress = pl.plant.progress;
                    if (progress === undefined || progress === null || isNaN(progress)) progress = 0;
                    progress = Math.max(0, Math.min(1, progress));
                    var mature = pl.plant.mature || progress >= 1;
                    var pct = Math.floor(progress * 100);
                    h += '<div class="plot' + (mature ? ' mature' : '') + '" onclick="clickPlot(' + i + ')">';
                    h += '<span class="plot-icon">' + (mature ? (pl.plant.fruitIcon || 'üçé') : (pl.plant.icon || 'üå±')) + '</span>';
                    h += '<span class="plot-name">' + esc(pl.plant.name) + '</span>';
                    if (mature) {
                        h += '<span class="plot-progress" style="color:#fcd34d;">ÂèØÊî∂Ëé∑ÔºÅ</span>';
                    } else {
                        h += '<span class="plot-progress">' + pct + '%</span>';
                        h += '<div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + pct + '%"></div></div>';
                    }

                    var tags = [];
                    if (pl.plant.selfWatered || pl.plant.watered) tags.push('üíß');
                    if (pl.plant.fertilizerReduce > 0) tags.push('üß™');
                    var friendWaterCount = (pl.plant.friendWaters || []).length;
                    if (friendWaterCount > 0) tags.push('üë•x' + friendWaterCount);

                    if (tags.length > 0) h += '<span class="plot-progress" style="font-size:12px;">' + tags.join('') + '</span>';
                    h += '</div>';
                } else {
                    h += '<div class="plot empty" onclick="clickPlot(' + i + ')">';
                    h += '<span class="plot-icon">‚ûï</span>';
                    h += '<span class="plot-name">Á©∫Âú∞</span>';
                    h += '</div>';
                }
            }
            g.innerHTML = h;
        }

        function renderCages() {
            if (!playerData || !playerData.cages) return;
            var g = document.getElementById('cagesGrid');
            var h = '';

            for (var i = 0; i < playerData.cages.length; i++) {
                var cage = playerData.cages[i];
                if (cage.animal) {
                    var isStarving = cage.animal.food < 0;
                    var foodStatus = cage.animal.food >= 0 ? 'üçñ' + Math.floor(cage.animal.food) : '‚ö†Ô∏èÈ••È•ø';

                    h += '<div class="cage' + (isStarving ? ' starving' : '') + '" onclick="clickCage(' + i + ')">';
                    h += '<span class="cage-icon">' + (cage.animal.icon || 'üêæ') + '</span>';
                    h += '<span class="cage-name">' + esc(cage.animal.name) + '</span>';
                    h += '<span class="cage-count">Êï∞Èáè: ' + cage.animal.count + '</span>';
                    h += '<span class="cage-food">' + foodStatus + '</span>';
                    h += '<span class="cage-status">Ê∂àËÄó' + cage.animal.foodPerHour + '/Êó∂</span>';
                    h += '</div>';
                } else {
                    h += '<div class="cage empty" onclick="clickCage(' + i + ')">';
                    h += '<span class="cage-icon">‚ûï</span>';
                    h += '<span class="cage-name">Á©∫Âúà</span>';
                    h += '</div>';
                }
            }

            g.innerHTML = h;
        }

        function clickCage(cageId) {
            if (!playerData) return;
            var cage = playerData.cages[cageId];
            var h = '';

            if (!cage.animal) {
                h += '<div style="text-align:center;margin-bottom:10px;font-size:13px;color:#aaa;">Á¨¨' + (cageId + 1) + '‰∏™Âúà ¬∑ Á©∫Âúà</div>';

                if (!playerData.animals || playerData.animals.length === 0) {
                    h += '<div style="text-align:center;color:#666;padding:20px;">Ê≤°ÊúâÂä®Áâ©ÔºåÂéªÈáéÂ§ñÊçïÊçâÂêß</div>';
                } else {
                    h += '<div style="font-size:12px;color:#888;margin-bottom:8px;">ÈÄâÊã©Âä®Áâ©ÊîæÂÖ•Ôºö</div>';
                    for (var i = 0; i < playerData.animals.length; i++) {
                        var a = playerData.animals[i];
                        h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;margin-bottom:6px;">';
                        h += '<span style="font-size:13px;">' + (a.icon || 'üêæ') + ' ' + esc(a.name) + ' <span style="color:#888;font-size:11px;">x' + a.count + '</span></span>';
                        h += '<div style="display:flex;gap:4px;">';
                        h += '<input type="number" id="placeCount_' + i + '" value="1" min="1" max="' + a.count + '" style="width:50px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:4px;font-size:12px;color:#e0e0e0;text-align:center;">';
                        h += '<button style="padding:4px 12px;background:#4caf50;color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doPlaceAnimal(' + cageId + ',\'' + a.id + '\',' + i + ')">ÊîæÂÖ•</button>';
                        h += '</div></div>';
                    }
                }
            } else {
                var a = cage.animal;
                var isStarving = a.food < 0;
                var foodStatus = a.food >= 0 ? Math.floor(a.food) : 0;
                var hoursLeft = a.food > 0 ? Math.floor(a.food / a.foodPerHour) : 0;

                h += '<div style="text-align:center;margin-bottom:12px;">';
                h += '<div style="font-size:36px;margin-bottom:6px;">' + (a.icon || 'üêæ') + '</div>';
                h += '<div style="font-size:16px;color:#fcd34d;">' + esc(a.name) + '</div>';
                h += '<div style="font-size:12px;color:#888;margin-top:4px;">Á¨¨' + (cageId + 1) + '‰∏™Âúà</div>';
                h += '<div style="font-size:14px;color:#67e8f9;margin-top:6px;">Êï∞Èáè: ' + a.count + ' Âè™</div>';

                if (isStarving) {
                    h += '<div style="font-size:13px;color:#ef4444;margin-top:6px;">‚ö†Ô∏è È£üÁâ©‰∏çË∂≥ÔºÅÂä®Áâ©Ê≠£Âú®Ê≠ª‰∫°</div>';
                } else {
                    h += '<div style="font-size:13px;color:#a5d6a7;margin-top:6px;">üçñ È£üÁâ©: ' + foodStatus + ' (Á∫¶' + hoursLeft + 'Â∞èÊó∂)</div>';
                }

                h += '<div style="font-size:11px;color:#888;margin-top:4px;">Ê∂àËÄó: ' + a.foodPerHour + '/Â∞èÊó∂ | ÂîÆ‰ª∑: üí∞' + a.sellPrice + '/Âè™</div>';
                h += '</div>';

                h += '<div style="display:flex;flex-direction:column;gap:6px;">';

                // ÂñÇÈ£üÈÄâÈ°π
                h += '<div style="font-size:12px;color:#888;margin-bottom:4px;">ÂñÇÈ£üÔºàÁßçÂ≠ê+1ÔºåÊûúÂÆû+5ÔºâÔºö</div>';

                var hasFood = false;
                if (playerData.seeds && playerData.seeds.length > 0) {
                    hasFood = true;
                    h += '<select id="feedSeedSelect" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px;font-size:12px;color:#e0e0e0;margin-bottom:4px;">';
                    for (var si = 0; si < playerData.seeds.length; si++) {
                        var s = playerData.seeds[si];
                        h += '<option value="' + s.id + '">üå± ' + esc(s.name) + ' (x' + s.count + ')</option>';
                    }
                    h += '</select>';
                    h += '<div style="display:flex;gap:4px;margin-bottom:8px;">';
                    h += '<input type="number" id="feedSeedCount" value="1" min="1" style="width:60px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px;font-size:12px;color:#e0e0e0;text-align:center;">';
                    h += '<button style="flex:1;padding:8px;background:rgba(76,175,80,0.2);color:#a5d6a7;border:1px solid rgba(76,175,80,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doFeedAnimal(' + cageId + ',\'seed\')">Áî®ÁßçÂ≠êÂñÇÈ£ü</button>';
                    h += '</div>';
                }

                if (playerData.fruits && playerData.fruits.length > 0) {
                    hasFood = true;
                    h += '<select id="feedFruitSelect" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px;font-size:12px;color:#e0e0e0;margin-bottom:4px;">';
                    for (var fi = 0; fi < playerData.fruits.length; fi++) {
                        var f = playerData.fruits[fi];
                        h += '<option value="' + f.id + '">üçé ' + esc(f.name) + ' (x' + f.count + ')</option>';
                    }
                    h += '</select>';
                    h += '<div style="display:flex;gap:4px;margin-bottom:8px;">';
                    h += '<input type="number" id="feedFruitCount" value="1" min="1" style="width:60px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px;font-size:12px;color:#e0e0e0;text-align:center;">';
                    h += '<button style="flex:1;padding:8px;background:rgba(251,191,36,0.2);color:#fcd34d;border:1px solid rgba(251,191,36,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doFeedAnimal(' + cageId + ',\'fruit\')">Áî®ÊûúÂÆûÂñÇÈ£ü</button>';
                    h += '</div>';
                }

                if (!hasFood) {
                    h += '<div style="font-size:11px;color:#666;text-align:center;padding:10px;">Ê≤°ÊúâÈ£üÁâ©ÔºåÂéªÁßçÁî∞ÊàñÈááÈõÜÂêß</div>';
                }

                // Âá∫ÂîÆÈÄâÈ°π
                h += '<div style="border-top:1px solid rgba(255,255,255,0.06);padding-top:8px;margin-top:4px;">';
                h += '<div style="font-size:12px;color:#888;margin-bottom:4px;">Âá∫ÂîÆÂä®Áâ©Ôºö</div>';
                h += '<div style="display:flex;gap:4px;">';
                h += '<input type="number" id="sellAnimalCount" value="1" min="1" max="' + a.count + '" style="width:60px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px;font-size:12px;color:#e0e0e0;text-align:center;">';
                h += '<button style="flex:1;padding:8px;background:rgba(245,158,11,0.2);color:#fcd34d;border:1px solid rgba(245,158,11,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doSellAnimal(' + cageId + ',false)">ÂçñÂá∫</button>';
                h += '<button style="padding:8px 12px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid rgba(239,68,68,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doSellAnimal(' + cageId + ',true)">ÂÖ®Âçñ</button>';
                h += '</div></div>';

                h += '</div>';
            }

            document.getElementById('cageActionContent').innerHTML = h;
            openPanel('panelCageAction');
        }

        function doPlaceAnimal(cageId, animalId, animalIdx) {
            var countInput = document.getElementById('placeCount_' + animalIdx);
            var count = countInput ? parseInt(countInput.value) : 1;
            doAction('place_animal', { cageId: cageId, animalId: animalId, count: count });
        }

        function doFeedAnimal(cageId, feedType) {
            var itemId, count;
            if (feedType === 'seed') {
                var sel = document.getElementById('feedSeedSelect');
                var countInput = document.getElementById('feedSeedCount');
                itemId = sel ? sel.value : '';
                count = countInput ? parseInt(countInput.value) : 1;
            } else {
                var sel = document.getElementById('feedFruitSelect');
                var countInput = document.getElementById('feedFruitCount');
                itemId = sel ? sel.value : '';
                count = countInput ? parseInt(countInput.value) : 1;
            }

            if (!itemId) return;
            doAction('feed_animal', { cageId: cageId, feedType: feedType, itemId: itemId, count: count });
            closePanel('panelCageAction');
        }

        function doSellAnimal(cageId, sellAll) {
            var count = 1;
            if (!sellAll) {
                var countInput = document.getElementById('sellAnimalCount');
                count = countInput ? parseInt(countInput.value) : 1;
            }

            if (!confirm(sellAll ? 'Á°ÆÂÆöÂçñÂá∫ÂÖ®ÈÉ®Âä®Áâ©Ôºü' : 'Á°ÆÂÆöÂçñÂá∫ ' + count + ' Âè™Âä®Áâ©Ôºü')) return;

            doAction('sell_animal', { cageId: cageId, count: count, sellAll: sellAll });
        }

        function doCatch(areaIndex) {
            doAction('catch_animal', { areaIndex: areaIndex });
        }

        function doVisitWater(plotId) { doAction('water', { plotId: plotId }); }

        function clickPlot(plotId) {
            if (!playerData) return;
            var pl = playerData.plots[plotId];
            var h = '';
            if (!pl.plant) {
                h += '<div style="text-align:center;margin-bottom:10px;font-size:13px;color:#aaa;">Á¨¨' + (plotId + 1) + 'ÂùóÂú∞ ¬∑ Á©∫Âú∞</div>';
                if (!playerData.seeds || playerData.seeds.length === 0) {
                    h += '<div style="text-align:center;color:#666;padding:20px;">Ê≤°ÊúâÁßçÂ≠êÔºåÂéªÈáéÂ§ñÈááÈõÜÊàñÂïÜÂ∫óË¥≠‰π∞Âêß</div>';
                } else {
                    h += '<div style="font-size:12px;color:#888;margin-bottom:8px;">ÈÄâÊã©ÁßçÂ≠êÁßçÊ§çÔºö</div>';
                    for (var i = 0; i < playerData.seeds.length; i++) {
                        var s = playerData.seeds[i];
                        var growMin = Math.round(s.growTime / 60000);
                        var growText = growMin >= 60 ? Math.round(growMin / 60 * 10) / 10 + 'Â∞èÊó∂' : growMin + 'ÂàÜÈíü';
                        h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;margin-bottom:6px;cursor:pointer;" onclick="doPlant(' + plotId + ',\'' + s.id + '\')">';
                        h += '<span style="font-size:13px;">' + (s.icon || 'üå±') + ' ' + esc(s.name) + ' <span style="color:#888;font-size:11px;">x' + s.count + '</span></span>';
                        h += '<span style="font-size:11px;color:#888;">ÁîüÈïø: ' + growText + ' ‚Üí ' + (s.fruitIcon || 'üçé') + esc(s.fruitName) + '</span>';
                        h += '</div>';
                    }
                }
            } else {
                var progress = pl.plant.progress;
                if (progress === undefined || progress === null || isNaN(progress)) progress = 0;
                progress = Math.max(0, Math.min(1, progress));
                var mature = pl.plant.mature || progress >= 1;
                var pct = Math.floor(progress * 100);
                var gt = pl.plant.effectiveGrowTime || pl.plant.growTime || 7200000;
                var now = Date.now() + serverTimeOffset;
                var elapsed = now - pl.plant.plantedAt;
                var remainMs = Math.max(0, gt - elapsed);
                var remainMin = Math.ceil(remainMs / 60000);
                var remainText = remainMin >= 60 ? Math.floor(remainMin / 60) + 'Êó∂' + (remainMin % 60) + 'ÂàÜ' : remainMin + 'ÂàÜÈíü';

                h += '<div style="text-align:center;margin-bottom:12px;">';
                h += '<div style="font-size:36px;margin-bottom:6px;">' + (mature ? (pl.plant.fruitIcon || 'üçé') : (pl.plant.icon || 'üå±')) + '</div>';
                h += '<div style="font-size:16px;color:#a5d6a7;">' + esc(pl.plant.name) + '</div>';
                h += '<div style="font-size:12px;color:#888;margin-top:4px;">Á¨¨' + (plotId + 1) + 'ÂùóÂú∞</div>';

                if (mature) {
                    h += '<div style="font-size:14px;color:#fcd34d;margin-top:6px;">üéâ Â∑≤ÊàêÁÜüÔºÅ</div>';
                } else {
                    h += '<div style="font-size:13px;color:#aaa;margin-top:6px;">ÊàêÈïøËøõÂ∫¶: ' + pct + '%</div>';
                    h += '<div style="width:80%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin:6px auto;overflow:hidden;"><div style="height:100%;width:' + pct + '%;background:#4caf50;border-radius:3px;"></div></div>';
                    h += '<div style="font-size:11px;color:#888;">È¢ÑËÆ°ËøòÈúÄ: ' + remainText + '</div>';
                }

                var tags = [];
                if (pl.plant.selfWatered || pl.plant.watered) tags.push('üíß Â∑≤ÊµáÊ∞¥');
                if (pl.plant.fertilizerReduce > 0) tags.push('üß™ Â∑≤ÊñΩËÇ•');
                var friendWaters = pl.plant.friendWaters || [];
                if (friendWaters.length > 0) {
                    var totalReduce = 0;
                    friendWaters.forEach(function (fw) { totalReduce += fw.reduce || 0; });
                    var totalMin = Math.round(totalReduce / 60000);
                    tags.push('üë• ' + friendWaters.length + '‰∫∫ÊµáÊ∞¥Ôºà-' + totalMin + 'ÂàÜÔºâ');
                }

                if (tags.length > 0) h += '<div style="font-size:11px;color:#666;margin-top:4px;">' + tags.join(' ¬∑ ') + '</div>';

                h += '</div>';
                h += '<div style="display:flex;flex-direction:column;gap:6px;">';

                if (mature) {
                    h += '<button style="padding:12px;background:#4caf50;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;" onclick="doHarvest(' + plotId + ')">üåæ Êî∂Ëé∑</button>';
                } else {
                    if (!pl.plant.selfWatered && !pl.plant.watered) {
                        h += '<button style="padding:10px;background:rgba(59,130,246,0.2);color:#93c5fd;border:1px solid rgba(59,130,246,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doWater(' + plotId + ')">üíß ÊµáÊ∞¥ÔºàÂÖçË¥πÔºåÂáèÂ∞ëÁîüÈïøÊó∂Èó¥Ôºâ</button>';
                    }

                    var fertilizers = (playerData.items || []).filter(function (it) { return it.type === 'fertilizer'; });
                    if (fertilizers.length > 0) {
                        for (var fi = 0; fi < fertilizers.length; fi++) {
                            var f = fertilizers[fi];
                            h += '<button style="padding:10px;background:rgba(245,158,11,0.2);color:#fcd34d;border:1px solid rgba(245,158,11,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doFertilize(' + plotId + ',\'' + f.id + '\')">üß™ ' + esc(f.name) + ' (x' + f.count + ')</button>';
                        }
                    } else {
                        h += '<div style="font-size:11px;color:#666;text-align:center;padding:6px;">Ê≤°ÊúâËÇ•ÊñôÔºåÂèØ‰ª•ÂéªÂïÜÂ∫óË¥≠‰π∞</div>';
                    }
                }

                h += '</div>';
            }

            document.getElementById('plotActionContent').innerHTML = h;
            openPanel('panelPlotAction');
        }

        function doPlant(plotId, seedId) { doAction('plant', { plotId: plotId, seedId: seedId }); }
        function doWater(plotId) { doAction('water', { plotId: plotId }); closePanel('panelPlotAction'); }
        function doFertilize(plotId, itemId) { doAction('fertilize', { plotId: plotId, itemId: itemId }); }
        function doHarvest(plotId) { doAction('harvest', { plotId: plotId }); }

        function openWild() { doAction('wild_areas'); openPanel('panelWild'); }
        function renderWildPanel(areas, stamina, staminaMax) {
            var h = '<div style="font-size:12px;color:#888;margin-bottom:10px;">‚ö° ‰ΩìÂäõ: ' + stamina + '/' + staminaMax + '</div>';
            if (!areas || areas.length === 0) {
                h += '<div style="color:#666;text-align:center;padding:20px;">Ëøô‰∏™‰∏ñÁïåÊ≤°ÊúâÈáéÂ§ñÂå∫Âüü</div>';
            } else {
                for (var i = 0; i < areas.length; i++) {
                    var a = areas[i];
                    h += '<div class="wild-area-card">';
                    h += '<div class="wa-name">' + (a.icon || 'üåø') + ' ' + esc(a.name) + '</div>';
                    h += '<div class="wa-desc">' + esc(a.desc || '') + '</div>';
                    if (a.seedNames && a.seedNames.length > 0) {
                        h += '<div class="wa-seeds">ÂèØÈááÈõÜ: ' + a.seedNames.join('„ÄÅ') + '</div>';
                    }
                    h += '<div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">';
                    h += '<button style="flex:1;min-width:80px;padding:8px;background:rgba(76,175,80,0.2);color:#a5d6a7;border:1px solid rgba(76,175,80,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doGather(' + i + ')">üåø ÈááÈõÜ(25‰Ωì)</button>';
                    h += '<button style="flex:1;min-width:80px;padding:8px;background:rgba(251,191,36,0.2);color:#fcd34d;border:1px solid rgba(251,191,36,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doCatch(' + i + ')">üêæ ÊçïÁåé(30‰Ωì)</button>';
                    h += '<button style="flex:1;min-width:80px;padding:8px;background:rgba(167,139,250,0.2);color:#c4b5fd;border:1px solid rgba(167,139,250,0.3);border-radius:8px;font-size:12px;cursor:pointer;" onclick="doCatchPet(' + i + ')">üê± ÊçâÂÆ†(20‰Ωì)</button>';
                    h += '</div>';
                    h += '</div>';
                }
            }
            h += '<div style="margin-top:12px;"><button style="width:100%;padding:10px;background:rgba(6,182,212,0.2);color:#67e8f9;border:1px solid rgba(6,182,212,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doRest()">üí§ ‰ºëÊÅØÔºàÊÅ¢Â§ç35‰ΩìÂäõÔºåCD 10ÂàÜÈíüÔºâ</button></div>';
            document.getElementById('wildContent').innerHTML = h;
        }

        function doGather(areaIndex) { doAction('gather', { areaIndex: areaIndex }); }
        function doRest() { doAction('rest'); }

        function openVisit() {
            var h = '<div style="margin-bottom:12px;">';
            h += '<div style="font-size:12px;color:#888;margin-bottom:6px;">ËæìÂÖ•ÂØπÊñπÁöÑÈ¢ÜÂú∞IDÂéª‰∏≤Èó®Ôºö</div>';
            h += '<div style="display:flex;gap:6px;"><input type="text" id="visitFarmIdInput" placeholder="6‰ΩçÈ¢ÜÂú∞ID" maxlength="6" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:9px 12px;font-size:14px;color:#e0e0e0;outline:none;text-transform:uppercase;font-family:monospace;letter-spacing:2px;">';
            h += '<button style="padding:9px 16px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;" onclick="doVisit()">Âéª‰∏≤Èó®</button></div>';
            h += '</div>';
            if (visitingOwner) {
                h += '<div style="background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.2);border-radius:10px;padding:10px;margin-bottom:10px;font-size:12px;color:#a5d6a7;">ÂΩìÂâçÂú® ' + esc(visitingOwner) + ' ÁöÑÂÜúÂú∫Ôºà' + visitingFarmId + 'Ôºâ</div>';
                h += '<button style="width:100%;padding:10px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid rgba(239,68,68,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doGoHome()">üè° ÂõûËá™Â∑±ÂÜúÂú∫</button>';
            }
            h += '<div id="visitFarmView"></div>';
            document.getElementById('visitContent').innerHTML = h;
            openPanel('panelVisit');
        }
        function doVisit() { var fid = document.getElementById('visitFarmIdInput').value.trim().toUpperCase(); if (!fid) return; doAction('visit_farm', { farmId: fid }); }
        function doGoHome() { doAction('go_home'); }
        function renderVisitFarm(owner, fid, plots, visitors) {
            lastVisitPlotsHash = '';
            visitingOwner = owner; visitingFarmId = fid;
            var h = '<div class="visit-farm-view">';
            h += '<div style="font-size:15px;color:#a5d6a7;margin-bottom:4px;">üè° ' + esc(owner) + ' ÁöÑÂÜúÂú∫</div>';
            h += '<div style="font-size:11px;color:#666;margin-bottom:8px;">È¢ÜÂú∞ID: ' + fid + '</div>';
            if (visitors && visitors.length > 0) h += '<div style="font-size:11px;color:#888;margin-bottom:8px;">‰πüÂú®ËøôÈáå: ' + visitors.map(function (v) { return esc(v); }).join(', ') + '</div>';
            h += '<div class="visit-plots-grid">';
            for (var i = 0; i < plots.length; i++) {
                var pl = plots[i];
                var canWater = pl.plant && !pl.plant.mature && !(pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                h += '<div class="visit-plot' + (canWater ? ' clickable-visit' : '') + '"' + (canWater ? ' onclick="doVisitWater(' + i + ')" style="cursor:pointer;"' : '') + '>';
                if (pl.plant) {
                    var prog = pl.plant.progress;
                    if (prog === undefined || prog === null || isNaN(prog)) prog = 0;
                    prog = Math.max(0, Math.min(1, prog));
                    var isMature = pl.plant.mature || prog >= 1;
                    h += '<span class="vp-icon">' + (isMature ? (pl.plant.fruitIcon || 'üçé') : (pl.plant.icon || 'üå±')) + '</span>';
                    h += '<span class="vp-name">' + esc(pl.plant.name) + '</span>';
                    if (isMature) h += '<span class="vp-status" style="color:#fcd34d;">Â∑≤ÊàêÁÜü</span>';
                    else {
                        h += '<span class="vp-status">' + Math.floor(prog * 100) + '%</span>';
                        var myWatered = (pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                        var waterCount = (pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                        var waterCount = (pl.plant.friendWaters || []).length;
                        if (myWatered) h += '<span class="vp-status" style="color:#67e8f9;">üíßÂ∑≤ÊµáÊ∞¥' + (waterCount > 1 ? '(' + waterCount + '‰∫∫)' : '') + '</span>';
                        else h += '<span class="vp-status" style="color:#93c5fd;">üíßÁÇπÂáªÊµáÊ∞¥</span>';
                    }
                } else {
                    h += '<span class="vp-icon" style="opacity:0.3;">üü´</span>';
                    h += '<span class="vp-name" style="color:#666;">Á©∫Âú∞</span>';
                }
                h += '</div>';
            }
            h += '</div>';
            h += '<button style="width:100%;margin-top:10px;padding:10px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid rgba(239,68,68,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doGoHome()">üè° ÂõûËá™Â∑±ÂÜúÂú∫</button>';
            h += '</div>';
            var vfv = document.getElementById('visitFarmView');
            if (vfv) vfv.innerHTML = h;
            else document.getElementById('visitContent').innerHTML += h;

            // ‚òÖ Âú®‰∏ªÁïåÈù¢ÂÜúÂú∫Âå∫ÂüüÊòæÁ§∫‰∏≤Èó®ËßÜÂõæ
            var farmArea = document.getElementById('farmArea');
            var farmTitle = document.querySelector('.farm-title');
            if (farmTitle) {
                farmTitle.innerHTML = '<span>üè† ' + esc(owner) + ' ÁöÑÂÜúÂú∫</span><span class="farm-id">ID: ' + fid + '</span>';
            }
            var plotsGrid = document.getElementById('plotsGrid');
            var visitHtml = '';
            for (var vi = 0; vi < plots.length; vi++) {
                var vpl = plots[vi];
                var vCanWater = vpl.plant && !vpl.plant.mature && !(vpl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                visitHtml += '<div class="plot' + (vpl.plant && (vpl.plant.mature || (vpl.plant.progress || 0) >= 1) ? ' mature' : '') + (vCanWater ? '' : ' empty') + '"' + (vCanWater ? ' onclick="doVisitWater(' + vi + ')" style="cursor:pointer;"' : '') + '>';
                if (vpl.plant) {
                    var vProg = vpl.plant.progress || 0;
                    vProg = Math.max(0, Math.min(1, vProg));
                    var vMature = vpl.plant.mature || vProg >= 1;
                    visitHtml += '<span class="plot-icon">' + (vMature ? (vpl.plant.fruitIcon || 'üçé') : (vpl.plant.icon || 'üå±')) + '</span>';
                    visitHtml += '<span class="plot-name">' + esc(vpl.plant.name) + '</span>';
                    if (vMature) visitHtml += '<span class="plot-progress" style="color:#fcd34d;">Â∑≤ÊàêÁÜü</span>';
                    else {
                        visitHtml += '<span class="plot-progress">' + Math.floor(vProg * 100) + '%</span>';
                        visitHtml += '<div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + Math.floor(vProg * 100) + '%"></div></div>';
                        var vMyWatered = (vpl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                        var vWaterCount = (vpl.plant.friendWaters || []).length;
                        if (vMyWatered) visitHtml += '<span class="plot-progress">üíßÂ∑≤ÊµáÊ∞¥' + (vWaterCount > 1 ? '(' + vWaterCount + '‰∫∫)' : '') + '</span>';
                        else visitHtml += '<span class="plot-progress" style="color:#93c5fd;">üíßÁÇπÂáªÊµáÊ∞¥</span>';
                    }
                } else {
                    visitHtml += '<span class="plot-icon" style="opacity:0.3;">üü´</span>';
                    visitHtml += '<span class="plot-name" style="color:#666;">Á©∫Âú∞</span>';
                }
                visitHtml += '</div>';
            }
            plotsGrid.innerHTML = visitHtml;

            // ‚òÖ ÊòæÁ§∫‰∏≤Èó®Áä∂ÊÄÅÊù°
            var existingBar = document.getElementById('visitStatusBar');
            if (existingBar) existingBar.remove();
            var bar = document.createElement('div');
            bar.id = 'visitStatusBar';
            bar.style.cssText = 'padding:8px 12px;background:rgba(76,175,80,0.1);border-bottom:1px solid rgba(76,175,80,0.2);font-size:12px;color:#a5d6a7;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;';
            bar.innerHTML = 'üè† Ê≠£Âú®ÂèÇËßÇ <b>' + esc(owner) + '</b> ÁöÑÂÜúÂú∫Ôºà' + fid + 'Ôºâ<button style="padding:4px 12px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid rgba(239,68,68,0.3);border-radius:6px;font-size:11px;cursor:pointer;" onclick="doGoHome()">üè° ÂõûÂÆ∂</button>';
            farmArea.parentNode.insertBefore(bar, farmArea);
        }
        var _lastVisitPlotsHash = '';

        function updateVisitPlots(plots) {
            var newHash = JSON.stringify(plots);
            if (newHash === _lastVisitPlotsHash) return;
            _lastVisitPlotsHash = newHash;

            var plotsGrid = document.getElementById('plotsGrid');
            if (!plotsGrid) return;
            var visitHtml = '';
            for (var vi = 0; vi < plots.length; vi++) {
                var vpl = plots[vi];
                var vCanWater = vpl.plant && !vpl.plant.mature && !(vpl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                visitHtml += '<div class="plot' + (vpl.plant && (vpl.plant.mature || (vpl.plant.progress || 0) >= 1) ? ' mature' : '') + (vCanWater ? '' : ' empty') + '"' + (vCanWater ? ' onclick="doVisitWater(' + vi + ')" style="cursor:pointer;"' : '') + '>';
                if (vpl.plant) {
                    var vProg = vpl.plant.progress || 0;
                    vProg = Math.max(0, Math.min(1, vProg));
                    var vMature = vpl.plant.mature || vProg >= 1;
                    visitHtml += '<span class="plot-icon">' + (vMature ? (vpl.plant.fruitIcon || 'üçé') : (vpl.plant.icon || 'üå±')) + '</span>';
                    visitHtml += '<span class="plot-name">' + esc(vpl.plant.name) + '</span>';
                    if (vMature) visitHtml += '<span class="plot-progress" style="color:#fcd34d;">Â∑≤ÊàêÁÜü</span>';
                    else {
                        visitHtml += '<span class="plot-progress">' + Math.floor(vProg * 100) + '%</span>';
                        visitHtml += '<div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + Math.floor(vProg * 100) + '%"></div></div>';
                        var uvMyWatered = (vpl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                        var uvWaterCount = (vpl.plant.friendWaters || []).length;
                        if (uvMyWatered) visitHtml += '<span class="plot-progress">üíßÂ∑≤ÊµáÊ∞¥' + (uvWaterCount > 1 ? '(' + uvWaterCount + '‰∫∫)' : '') + '</span>';
                        else visitHtml += '<span class="plot-progress" style="color:#93c5fd;">üíßÁÇπÂáªÊµáÊ∞¥</span>';
                    }
                } else {
                    visitHtml += '<span class="plot-icon" style="opacity:0.3;">üü´</span>';
                    visitHtml += '<span class="plot-name" style="color:#666;">Á©∫Âú∞</span>';
                }
                visitHtml += '</div>';
            }
            plotsGrid.innerHTML = visitHtml;

            var vfv = document.getElementById('visitFarmView');
            if (vfv) {
                var vpGrid = vfv.querySelector('.visit-plots-grid');
                if (vpGrid) {
                    var panelHtml = '';
                    for (var i = 0; i < plots.length; i++) {
                        var pl = plots[i];
                        var canWater = pl.plant && !pl.plant.mature && !(pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                        panelHtml += '<div class="visit-plot"' + (canWater ? ' onclick="doVisitWater(' + i + ')" style="cursor:pointer;"' : '') + '>';
                        if (pl.plant) {
                            var prog = pl.plant.progress || 0;
                            prog = Math.max(0, Math.min(1, prog));
                            var isMature = pl.plant.mature || prog >= 1;
                            panelHtml += '<span class="vp-icon">' + (isMature ? (pl.plant.fruitIcon || 'üçé') : (pl.plant.icon || 'üå±')) + '</span>';
                            panelHtml += '<span class="vp-name">' + esc(pl.plant.name) + '</span>';
                            if (isMature) panelHtml += '<span class="vp-status" style="color:#fcd34d;">Â∑≤ÊàêÁÜü</span>';
                            else {
                                panelHtml += '<span class="vp-status">' + Math.floor(prog * 100) + '%</span>';
                                var pMyWatered = (pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                                var pWaterCount = (pl.plant.friendWaters || []).length;
                                if (pMyWatered) panelHtml += '<span class="vp-status" style="color:#67e8f9;">üíßÂ∑≤ÊµáÊ∞¥' + (pWaterCount > 1 ? '(' + pWaterCount + '‰∫∫)' : '') + '</span>';
                                else panelHtml += '<span class="vp-status" style="color:#93c5fd;">üíßÁÇπÂáªÊµáÊ∞¥</span>';
                            }
                        } else {
                            panelHtml += '<span class="vp-icon" style="opacity:0.3;">üü´</span>';
                            panelHtml += '<span class="vp-name" style="color:#666;">Á©∫Âú∞</span>';
                        }
                        panelHtml += '</div>';
                    }
                    vpGrid.innerHTML = panelHtml;
                }
            }
        }

        function openInventory() { doAction('inventory'); openPanel('panelInv'); }
        function renderInventoryPanel(seeds, fruits, items, money) {
            var h = '<div style="font-size:13px;color:#fcd34d;margin-bottom:10px;">üí∞ ÈáëÂ∏Å: ' + money + '</div>';
            h += '<div class="inv-section"><div class="inv-section-title">üå± ÁßçÂ≠ê</div><div class="inv-grid">';
            if (seeds && seeds.length > 0) {
                for (var i = 0; i < seeds.length; i++) {
                    var s = seeds[i];
                    h += '<div class="inv-item" title="' + esc(s.name) + '"><span class="ii-icon">' + (s.icon || 'üå±') + '</span><span class="ii-name">' + esc(s.name) + '</span><span class="ii-count">x' + s.count + '</span></div>';
                }
            } else { h += '<div class="inv-empty">Ê≤°ÊúâÁßçÂ≠ê</div>'; }
            h += '</div></div>';
            h += '<div class="inv-section"><div class="inv-section-title">üçé ÊûúÂÆû</div><div class="inv-grid">';
            if (fruits && fruits.length > 0) {
                for (var j = 0; j < fruits.length; j++) {
                    var f = fruits[j];
                    h += '<div class="inv-item" title="' + esc(f.name) + ' ‰ª∑ÂÄº' + f.value + '"><span class="ii-icon">' + (f.icon || 'üçé') + '</span><span class="ii-name">' + esc(f.name) + '</span><span class="ii-count">x' + f.count + ' (üí∞' + f.value + ')</span></div>';
                }
            } else { h += '<div class="inv-empty">Ê≤°ÊúâÊûúÂÆû</div>'; }
            h += '</div></div>';

            // ‚òÖ Êñ∞Â¢ûÔºöÂä®Áâ©Â∫ìÂ≠ò
            var animals = (playerData && playerData.animals) ? playerData.animals : [];
            h += '<div class="inv-section"><div class="inv-section-title">üêæ Âä®Áâ©ÔºàÊú™ÂÖ•ÂúàÔºâ</div><div class="inv-grid">';
            if (animals.length > 0) {
                for (var ai = 0; ai < animals.length; ai++) {
                    var a = animals[ai];
                    h += '<div class="inv-item" title="' + esc(a.name) + ' ÂîÆ‰ª∑üí∞' + a.sellPrice + ' È£üÈáè' + a.foodPerHour + '/Êó∂">';
                    h += '<span class="ii-icon">' + (a.icon || 'üêæ') + '</span>';
                    h += '<span class="ii-name">' + esc(a.name) + '</span>';
                    h += '<span class="ii-count">x' + a.count + ' (üí∞' + a.sellPrice + ')</span>';
                    h += '</div>';
                }
            } else { h += '<div class="inv-empty">Ê≤°ÊúâÂä®Áâ©</div>'; }
            h += '</div></div>';

            h += '<div class="inv-section"><div class="inv-section-title">üß∞ ÈÅìÂÖ∑</div><div class="inv-grid">';
            if (items && items.length > 0) {
                for (var k = 0; k < items.length; k++) {
                    var it = items[k];
                    h += '<div class="inv-item" title="' + esc(it.desc || '') + '"><span class="ii-icon">üß™</span><span class="ii-name">' + esc(it.name) + '</span><span class="ii-count">x' + it.count + '</span></div>';
                }
            } else { h += '<div class="inv-empty">Ê≤°ÊúâÈÅìÂÖ∑</div>'; }
            h += '</div></div>';
            document.getElementById('invContent').innerHTML = h;
        }

        function openShop() { doAction('shop_list'); openPanel('panelShop'); }
        function renderShopPanel(shop, money) {
            var h = '<div style="font-size:13px;color:#fcd34d;margin-bottom:10px;">üí∞ ‰Ω†ÁöÑÈáëÂ∏Å: ' + money + '</div>';
            if (!shop || !shop.items || shop.items.length === 0) {
                h += '<div style="color:#666;text-align:center;padding:20px;">ÂïÜÂ∫óÁ©∫Á©∫Â¶Ç‰πü</div>';
                document.getElementById('shopContent').innerHTML = h;
                return;
            }

            // ‚òÖ Ëé∑ÂèñÁé©ÂÆ∂ÂΩìÂâçÊ∞¥Â£∂Á≠âÁ∫ß
            var currentWaterLevel = (playerData && playerData.waterBoostLevel) ? playerData.waterBoostLevel : 0;

            var seeds = shop.items.filter(function (it) { return it.type === 'seed'; });
            var fertilizers = shop.items.filter(function (it) { return it.type === 'fertilizer'; });

            // ‚òÖ ÂàÜÁ¶ªÊ∞¥Â£∂ÂíåÂÖ∂‰ªñÂ∑•ÂÖ∑
            var waterTools = shop.items.filter(function (it) {
                if (it.id.startsWith('watering_can_lv')) {
                    var level = parseInt(it.id.replace('watering_can_lv', '')) || 0;
                    return level > currentWaterLevel && level <= 5;
                }
                return false;
            });

            var otherTools = shop.items.filter(function (it) {
                return it.type === 'tool' && !it.id.startsWith('watering_can_lv');
            });

            if (seeds.length > 0) {
                h += '<div style="font-size:12px;color:#a5d6a7;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üå± ÁßçÂ≠ê(‰∏ÄÁßçÂ§öÊî∂)</div>';
                for (var i = 0; i < seeds.length; i++) {
                    var s = seeds[i];
                    var sd = s.seedData || {};
                    var growMin = Math.round((sd.growTime || 0) / 60000);
                    var growText = growMin >= 60 ? Math.round(growMin / 60 * 10) / 10 + 'Â∞èÊó∂' : growMin + 'ÂàÜÈíü';
                    h += '<div class="shop-item">';
                    h += '<div class="si-info"><div class="si-name">' + (s.icon || sd.icon || 'üå±') + ' ' + esc(s.name) + '</div>';
                    h += '<div class="si-desc">' + esc(s.desc) + '</div>';
                    h += '<div style="font-size:10px;color:#888;margin-top:2px;">ÁîüÈïø' + growText + ' ‚Üí ' + (sd.fruitIcon || 'üçé') + esc(sd.fruitName || '') + ' (ÂîÆüí∞' + (sd.fruitValue || '?') + ')</div></div>';
                    h += '<span class="si-price">üí∞' + s.price + '</span>';
                    h += '<div style="display:flex;flex-direction:column;gap:3px;">';
                    h += '<button onclick="doBuy(\'' + s.id + '\',1)">‰π∞1</button>';
                    h += '<button onclick="doBuy(\'' + s.id + '\',5)" style="background:#388e3c;">‰π∞5</button>';
                    h += '</div></div>';
                }
            }
            if (fertilizers.length > 0) {
                h += '<div style="font-size:12px;color:#fcd34d;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üß™ ËÇ•Êñô</div>';
                for (var j = 0; j < fertilizers.length; j++) {
                    var f = fertilizers[j];
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">üß™ ' + esc(f.name) + '</div><div class="si-desc">' + esc(f.desc || '') + '</div></div>';
                    h += '<span class="si-price">üí∞' + f.price + '</span><button onclick="doBuy(\'' + f.id + '\',1)">Ë¥≠‰π∞</button></div>';
                }
            }

            // ‚òÖ ÊòæÁ§∫ÂÖ∂‰ªñÂ∑•ÂÖ∑ÔºàÂºÄÂû¶‰ª§Á≠âÔºâ
            if (otherTools.length > 0) {
                h += '<div style="font-size:12px;color:#67e8f9;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üî® Â∑•ÂÖ∑</div>';
                for (var k = 0; k < otherTools.length; k++) {
                    var t = otherTools[k];
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">üî® ' + esc(t.name) + '</div><div class="si-desc">' + esc(t.desc || '') + '</div></div>';
                    h += '<span class="si-price">üí∞' + t.price + '</span><button onclick="doBuy(\'' + t.id + '\',1)">Ë¥≠‰π∞</button></div>';
                }
            }

            // ‚òÖ ÊòæÁ§∫Ê∞¥Â£∂ÂçáÁ∫ß
            if (waterTools.length > 0) {
                h += '<div style="font-size:12px;color:#67e8f9;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üíß Ê∞¥Â£∂ÂçáÁ∫ß</div>';
                for (var m = 0; m < waterTools.length; m++) {
                    var w = waterTools[m];
                    var level = parseInt(w.id.replace('watering_can_lv', '')) || 0;
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">üíß ' + esc(w.name) + '</div><div class="si-desc">' + esc(w.desc || '') + '</div></div>';
                    h += '<span class="si-price">üí∞' + w.price + '</span><button onclick="doBuy(\'' + w.id + '\',1)">ÂçáÁ∫ß</button></div>';
                }
                if (currentWaterLevel >= 5) {
                    h += '<div style="text-align:center;padding:10px;font-size:12px;color:#fcd34d;background:rgba(252,211,77,0.1);border-radius:8px;margin-top:6px;">üèÜ ‰Ω†Â∑≤Êã•ÊúâÊúÄÈ´òÁ≠âÁ∫ßÁöÑ‰º†ËØ¥Ê∞¥Â£∂ÔºÅ</div>';
                }
            }

            // ‚òÖ ÊòæÁ§∫Âä®Áâ©
            var animalItems = shop.items.filter(function (it) { return it.type === 'animal'; });
            if (animalItems.length > 0) {
                h += '<div style="font-size:12px;color:#fcd34d;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üêæ Âä®Áâ©</div>';
                for (var ai = 0; ai < animalItems.length; ai++) {
                    var a = animalItems[ai];
                    var ad = a.animalData || {};
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">' + (a.icon || ad.icon || 'üêæ') + ' ' + esc(a.name) + '</div>';
                    h += '<div class="si-desc">' + esc(a.desc) + '</div>';
                    h += '<div style="font-size:10px;color:#888;margin-top:2px;">È£üÈáè' + (ad.foodPerHour || '?') + '/Êó∂ | ÂîÆ‰ª∑üí∞' + (ad.sellPrice || '?') + '</div></div>';
                    h += '<span class="si-price">üí∞' + a.price + '</span>';
                    h += '<div style="display:flex;flex-direction:column;gap:3px;">';
                    h += '<button onclick="doBuy(\'' + a.id + '\',1)">‰π∞1</button>';
                    h += '<button onclick="doBuy(\'' + a.id + '\',5)" style="background:#388e3c;">‰π∞5</button>';
                    h += '</div></div>';
                }
            }

            // ‚òÖ ÊòæÁ§∫ÂÆ†Áâ©
            var petItems = shop.items.filter(function (it) { return it.type === 'pet'; });
            if (petItems.length > 0) {
                h += '<div style="font-size:12px;color:#c4b5fd;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üê± ÂÆ†Áâ©</div>';
                for (var pi = 0; pi < petItems.length; pi++) {
                    var pet = petItems[pi];
                    var pd = pet.petData || {};
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">' + (pet.icon || pd.speciesIcon || 'üêæ') + ' ' + esc(pet.name) + '</div>';
                    h += '<div class="si-desc">' + esc(pet.desc) + '</div>';
                    h += '<div style="font-size:10px;color:#888;margin-top:2px;">Á®ÄÊúâÂ∫¶: ' + getRarityText(pd.rarity || 'common') + ' | ‰ª∑ÂÄº' + (pd.baseValue || '?') + '</div></div>';
                    h += '<span class="si-price">üí∞' + pet.price + '</span>';
                    h += '<button onclick="doBuy(\'' + pet.id + '\',1)">Ë¥≠‰π∞</button>';
                    h += '</div>';
                }
            }

            document.getElementById('shopContent').innerHTML = h;
        }

        function doBuy(itemId, count) {
            doAction('shop_buy', { itemId: itemId, count: count || 1 });
        }

        function openSell() {
            window._pendingSellRender = true;
            doAction('inventory');
            openPanel('panelSell');
        }

        var currentRankTab = 'money';
        function openRanking() {
            currentRankTab = 'money';
            doAction('world_ranking');
            openPanel('panelRanking');
            updateRankTabStyle();
        }

        function switchRankTab(tab) {
            currentRankTab = tab;
            updateRankTabStyle();
            if (tab === 'money') {
                doAction('world_ranking');
            } else {
                doAction('pet_ranking');
            }
        }

        function updateRankTabStyle() {
            var moneyBtn = document.getElementById('rankTabMoney');
            var petBtn = document.getElementById('rankTabPet');
            if (currentRankTab === 'money') {
                moneyBtn.style.background = 'rgba(252,211,77,0.15)';
                moneyBtn.style.color = '#fcd34d';
                moneyBtn.style.borderColor = 'rgba(252,211,77,0.3)';
                petBtn.style.background = 'transparent';
                petBtn.style.color = '#888';
                petBtn.style.borderColor = 'rgba(255,255,255,0.1)';
            } else {
                petBtn.style.background = 'rgba(167,139,250,0.15)';
                petBtn.style.color = '#c4b5fd';
                petBtn.style.borderColor = 'rgba(167,139,250,0.3)';
                moneyBtn.style.background = 'transparent';
                moneyBtn.style.color = '#888';
                moneyBtn.style.borderColor = 'rgba(255,255,255,0.1)';
            }
        }

        function renderRankingPanel(ranking, myRank) {
            if (!ranking || ranking.length === 0) {
                document.getElementById('rankingContent').innerHTML = '<div style="color:#666;text-align:center;padding:20px;font-size:12px;">ÊöÇÊó†ÊéíË°åÊ¶úÊï∞ÊçÆ</div>';
                return;
            }

            var h = '';

            // ÊòæÁ§∫ÊàëÁöÑÊéíÂêç
            if (myRank !== undefined && myRank !== null) {
                var myData = ranking[myRank];
                if (myData) {
                    h += '<div style="background:rgba(252,211,77,0.1);border:1px solid rgba(252,211,77,0.2);border-radius:10px;padding:12px;margin-bottom:12px;text-align:center;">';
                    h += '<div style="font-size:12px;color:#888;">‰Ω†ÁöÑÊéíÂêç</div>';
                    h += '<div style="font-size:24px;color:#fcd34d;font-weight:600;margin:4px 0;">ÊéíÂêç ' + (myRank + 1) + '</div>';
                    h += '<div style="font-size:13px;color:#a5d6a7;">üí∞ ' + myData.money + ' ÈáëÂ∏Å</div>';
                    h += '</div>';
                }
            }

            // ÊéíË°åÊ¶úÂàóË°®
            h += '<div style="font-size:12px;color:#888;margin-bottom:8px;">‰∏ñÁïåÊéíË°å</div>';
            for (var i = 0; i < ranking.length; i++) {
                var p = ranking[i];
                var medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                var isMe = p.username === username;
                var barWidth = Math.max(5, Math.round((p.money / ranking[0].money) * 100));

                h += '<div style="background:' + (isMe ? 'rgba(76,175,80,0.08)' : 'rgba(255,255,255,0.03)') + ';border:1px solid ' + (isMe ? 'rgba(76,175,80,0.2)' : 'rgba(255,255,255,0.06)') + ';border-radius:10px;padding:10px;margin-bottom:8px;">';

                h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
                h += '<span style="font-size:13px;display:flex;align-items:center;gap:6px;">';
                if (medal) h += '<span style="font-size:18px;">' + medal + '</span>';
                else h += '<span style="font-size:13px;color:#666;min-width:20px;text-align:center;">#' + (i + 1) + '</span>';
                h += '<span style="color:' + (isMe ? '#4caf50' : '#a5d6a7') + ';font-weight:600;">' + esc(p.username) + (isMe ? ' (‰Ω†)' : '') + '</span>';
                h += '</span>';
                h += '<span style="font-size:13px;color:#fcd34d;font-weight:600;">üí∞ ' + p.money + '</span>';
                h += '</div>';

                h += '<div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin-bottom:6px;">';
                h += '<div style="height:100%;width:' + barWidth + '%;background:linear-gradient(90deg,#fcd34d,#f59e0b);border-radius:2px;transition:width 0.3s;"></div>';
                h += '</div>';

                h += '<div style="display:flex;gap:8px;font-size:10px;color:#888;">';
                h += '<span>üåæ Êî∂Ëé∑:' + p.totalHarvest + '</span>';
                h += '<span>üåø ÈááÈõÜ:' + p.totalGather + '</span>';
                h += '<span>üå± ' + p.plotCount + '/' + p.maxPlots + '</span>';
                h += '</div>';

                h += '</div>';
            }

            document.getElementById('rankingContent').innerHTML = h;
        }

        function renderPetRankingPanel(ranking, myRank) {
            if (!ranking || ranking.length === 0) {
                document.getElementById('rankingContent').innerHTML = '<div style="color:#666;text-align:center;padding:20px;font-size:12px;">ÊöÇÊó†ÂÆ†Áâ©ÊéíË°åÊï∞ÊçÆ<br><span style="color:#555;margin-top:4px;display:inline-block;">ÂéªÊçïÊçâÂÆ†Áâ©Âπ∂Ê¥æÂÆÉ‰ª¨ÂØªÂÆùÊèêÂçá‰ª∑ÂÄºÂêß</span></div>';
                return;
            }

            var h = '';

            // ÊâæÂà∞ÊàëÁöÑÊúÄ‰Ω≥ÂÆ†Áâ©ÊéíÂêç
            if (myRank !== undefined && myRank !== null && ranking[myRank]) {
                var myEntry = ranking[myRank];
                h += '<div style="background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.2);border-radius:10px;padding:12px;margin-bottom:12px;text-align:center;">';
                h += '<div style="font-size:12px;color:#888;">‰Ω†ÁöÑÊúÄ‰Ω≥ÂÆ†Áâ©ÊéíÂêç</div>';
                h += '<div style="font-size:24px;color:#c4b5fd;font-weight:600;margin:4px 0;">Á¨¨ ' + (myRank + 1) + ' Âêç</div>';
                h += '<div style="font-size:13px;color:#a5d6a7;">' + (myEntry.speciesIcon || 'üêæ') + ' ' + esc(myEntry.petName) + ' ¬∑ üí∞' + myEntry.value + '</div>';
                h += '</div>';
            }

            for (var i = 0; i < ranking.length; i++) {
                var p = ranking[i];
                var medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                var isMe = p.owner === username;
                var barWidth = Math.max(5, Math.round((p.value / ranking[0].value) * 100));
                var rarityClass = 'rarity-' + (p.rarity || 'common');

                h += '<div style="background:' + (isMe ? 'rgba(167,139,250,0.08)' : 'rgba(255,255,255,0.03)') + ';border:1px solid ' + (isMe ? 'rgba(167,139,250,0.2)' : 'rgba(255,255,255,0.06)') + ';border-radius:10px;padding:10px;margin-bottom:8px;">';

                h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">';
                h += '<span style="font-size:13px;display:flex;align-items:center;gap:6px;">';
                if (medal) h += '<span style="font-size:18px;">' + medal + '</span>';
                else h += '<span style="font-size:13px;color:#666;min-width:20px;text-align:center;">#' + (i + 1) + '</span>';
                h += '<span style="font-size:18px;">' + (p.speciesIcon || 'üêæ') + '</span>';
                h += '<span style="color:#c4b5fd;font-weight:600;">' + esc(p.petName) + '</span>';
                h += '<span class="' + rarityClass + '" style="font-size:10px;">(' + getRarityText(p.rarity) + ')</span>';
                h += '</span>';
                h += '<span style="font-size:14px;color:#fcd34d;font-weight:600;">üí∞' + p.value + '</span>';
                h += '</div>';

                h += '<div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin-bottom:6px;">';
                h += '<div style="height:100%;width:' + barWidth + '%;background:linear-gradient(90deg,#a78bfa,#c4b5fd);border-radius:2px;transition:width 0.3s;"></div>';
                h += '</div>';

                h += '<div style="display:flex;justify-content:space-between;font-size:10px;color:#888;">';
                h += '<span>' + esc(p.species) + ' ¬∑ Êé¢Èô©' + (p.totalAdventures || 0) + 'Ê¨°</span>';
                h += '<span>‰∏ª‰∫∫: <span style="color:' + (isMe ? '#a78bfa' : '#a5d6a7') + ';">' + esc(p.owner) + (isMe ? ' (‰Ω†)' : '') + '</span></span>';
                h += '</div>';

                h += '</div>';
            }

            document.getElementById('rankingContent').innerHTML = h;
        }

        function renderSellPanel() {
            if (!playerData) return;
            var h = '<div style="font-size:13px;color:#fcd34d;margin-bottom:10px;">üí∞ ÂΩìÂâçÈáëÂ∏Å: ' + playerData.money + '</div>';

            // ÂçñÂá∫ÊûúÂÆû
            h += '<div style="font-size:12px;color:#a5d6a7;margin:12px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üçé ÊûúÂÆûÂçñÂá∫</div>';
            if (!playerData.fruits || playerData.fruits.length === 0) {
                h += '<div style="color:#666;font-size:12px;padding:8px;">Ê≤°ÊúâÂèØÂçñÁöÑÊûúÂÆû</div>';
            } else {
                for (var i = 0; i < playerData.fruits.length; i++) {
                    var f = playerData.fruits[i];
                    h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (f.icon || 'üçé') + ' ' + esc(f.name) + '</div><div class="sl-detail">Êï∞Èáè: ' + f.count + ' ¬∑ Âçï‰ª∑: üí∞' + f.value + '</div></div>';
                    h += '<div style="display:flex;gap:4px;">';
                    h += '<button onclick="doSellFruit(\'' + f.id + '\',1)">Âçñ1‰∏™</button>';
                    if (f.count >= 5) h += '<button onclick="doSellFruit(\'' + f.id + '\',5)">Âçñ5‰∏™</button>';
                    if (f.count >= 10) h += '<button onclick="doSellFruit(\'' + f.id + '\',' + f.count + ')">ÂÖ®Âçñ</button>';
                    h += '</div></div>';
                }
            }

            // ÂçñÂá∫ÁßçÂ≠ê
            h += '<div style="font-size:12px;color:#a5d6a7;margin:12px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üå± ÁßçÂ≠êÂçñÂá∫</div>';
            var sellableSeeds = (playerData.seeds || []).filter(function (s) { return s.source === 'bought' || s.source === 'harvest'; });
            if (sellableSeeds.length === 0) {
                h += '<div style="color:#666;font-size:12px;padding:8px;">Ê≤°ÊúâÂèØÂçñÁöÑÁßçÂ≠êÔºàÂàùÂßãÁßçÂ≠êÊó†Ê≥ïÂçñÂá∫Ôºâ</div>';
            } else {
                for (var j = 0; j < sellableSeeds.length; j++) {
                    var s = sellableSeeds[j];
                    var seedPrice = 0;
                    if (s.source === 'bought') {
                        seedPrice = Math.floor(50 / 2);
                    } else if (s.source === 'harvest') {
                        seedPrice = Math.floor((s.fruitValue || 10) / 3);
                    }
                    var sourceLabel = s.source === 'bought' ? 'üí≥ Ë¥≠‰π∞' : 'üåæ Êî∂Ëé∑';
                    h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (s.icon || 'üå±') + ' ' + esc(s.name) + '</div><div class="sl-detail">Êï∞Èáè: ' + s.count + ' ¬∑ Âçï‰ª∑: üí∞' + seedPrice + ' <span style="color:#888;font-size:10px;">(' + sourceLabel + ')</span></div></div>';
                    h += '<div style="display:flex;gap:4px;">';
                    h += '<button onclick="doSellSeed(\'' + s.id + '\',1)">Âçñ1‰∏™</button>';
                    if (s.count >= 5) h += '<button onclick="doSellSeed(\'' + s.id + '\',5)">Âçñ5‰∏™</button>';
                    if (s.count >= 10) h += '<button onclick="doSellSeed(\'' + s.id + '\',' + s.count + ')">ÂÖ®Âçñ</button>';
                    h += '</div></div>';
                }
            }

            // ‚òÖ Êñ∞Â¢ûÔºöÂçñÂá∫Âä®Áâ©ÔºàÊú™ÂÖ•ÂúàÁöÑÂ∫ìÂ≠òÂä®Áâ©Ôºâ
            h += '<div style="font-size:12px;color:#fcd34d;margin:12px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">üêæ Âä®Áâ©ÂçñÂá∫ÔºàÊú™ÂÖ•ÂúàÔºâ</div>';
            var animals = playerData.animals || [];
            if (animals.length === 0) {
                h += '<div style="color:#666;font-size:12px;padding:8px;">Ê≤°ÊúâÊú™ÂÖ•ÂúàÁöÑÂä®Áâ©</div>';
            } else {
                for (var ai = 0; ai < animals.length; ai++) {
                    var a = animals[ai];
                    h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (a.icon || 'üêæ') + ' ' + esc(a.name) + '</div><div class="sl-detail">Êï∞Èáè: ' + a.count + ' ¬∑ Âçï‰ª∑: üí∞' + a.sellPrice + '</div></div>';
                    h += '<div style="display:flex;gap:4px;">';
                    h += '<button onclick="doSellStockAnimal(\'' + a.id + '\',1)">Âçñ1Âè™</button>';
                    if (a.count >= 5) h += '<button onclick="doSellStockAnimal(\'' + a.id + '\',5)">Âçñ5Âè™</button>';
                    if (a.count >= 10) h += '<button onclick="doSellStockAnimal(\'' + a.id + '\',' + a.count + ')">ÂÖ®Âçñ</button>';
                    h += '</div></div>';
                }
            }

            document.getElementById('sellContent').innerHTML = h;
        }

        function doSellFruit(fruitId, count) { doAction('sell_fruit', { fruitId: fruitId, count: count }); }

        // ‚òÖ ÂçñÂá∫ÁßçÂ≠ê
        function doSellSeed(seedId, count) { doAction('sell_seed', { seedId: seedId, count: count }); }

        function doSellStockAnimal(animalId, count) {
            doAction('sell_stock_animal', { animalId: animalId, count: count });
        }

        function openTrade() {
            var h = '<div style="margin-bottom:14px;">';
            h += '<button style="width:100%;padding:10px;background:rgba(251,191,36,0.2);color:#fcd34d;border:1px solid rgba(251,191,36,0.3);border-radius:10px;font-size:13px;cursor:pointer;margin-bottom:8px;" onclick="showTradeForm()">üìù ÂèëËµ∑Êñ∞‰∫§Êòì</button>';
            h += '<button style="width:100%;padding:10px;background:rgba(255,255,255,0.05);color:#aaa;border:1px solid rgba(255,255,255,0.1);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doAction(\'trade_list\')">üìã Êü•Áúã‰∫§ÊòìÂàóË°®</button>';
            h += '</div><div id="tradeFormArea"></div><div id="tradeListArea"></div>';
            document.getElementById('tradeContent').innerHTML = h;
            openPanel('panelTrade');
            doAction('trade_list');
        }

        function showTradeForm() {
            if (!playerData) return;
            var h = '<div class="trade-form">';
            h += '<label>‰∫§ÊòìÂØπË±°ÔºàÊòµÁß∞Ôºâ</label><input type="text" id="tradeTo" placeholder="ËæìÂÖ•ÂØπÊñπÊòµÁß∞">';
            h += '<label>ÊàëË¶ÅÁªôÂá∫</label><select id="tradeOfferType" onchange="updTradeOfferItems()"><option value="seed">ÁßçÂ≠ê</option><option value="fruit">ÊûúÂÆû</option><option value="pet">ÂÆ†Áâ©</option><option value="money">ÈáëÂ∏Å</option></select>';
            h += '<div id="tradeOfferIdWrap"><select id="tradeOfferId"></select></div>';
            h += '<label id="tradeOfferCountLabel">ÁªôÂá∫Êï∞Èáè</label><input type="number" id="tradeOfferCount" value="1" min="1">';
            h += '<div id="tradeOfferMoneyInfo" style="display:none;font-size:11px;color:#fcd34d;"></div>';
            h += '<label>ÊàëÊÉ≥Ë¶ÅÔºàÁ±ªÂûãÔºâ</label><select id="tradeWantType" onchange="updTradeWantFields()"><option value="seed">ÁßçÂ≠ê</option><option value="fruit">ÊûúÂÆû</option><option value="pet">ÂÆ†Áâ©</option><option value="money">ÈáëÂ∏Å</option><option value="any">‰∏çÈúÄË¶ÅÂõûÊä•ÔºàËµ†ÈÄÅÔºâ</option></select>';
            h += '<div id="tradeWantDetailWrap">';
            h += '<label>ÊÉ≥Ë¶ÅÁöÑÁâ©ÂìÅÂêçÁß∞</label><input type="text" id="tradeWantName" placeholder="ËæìÂÖ•Áâ©ÂìÅÂêçÁß∞">';
            h += '<label>ÊÉ≥Ë¶ÅÊï∞Èáè</label><input type="number" id="tradeWantCount" value="1" min="1">';
            h += '</div>';
            h += '<button onclick="submitTrade()">ü§ù ÂèëËµ∑‰∫§Êòì</button></div>';
            document.getElementById('tradeFormArea').innerHTML = h;
            updTradeOfferItems();
        }

        function updTradeOfferItems() {
            var type = document.getElementById('tradeOfferType').value;
            var selWrap = document.getElementById('tradeOfferIdWrap');
            var moneyInfo = document.getElementById('tradeOfferMoneyInfo');
            var countLabel = document.getElementById('tradeOfferCountLabel');
            if (type === 'money') {
                selWrap.style.display = 'none';
                moneyInfo.style.display = 'block';
                moneyInfo.textContent = 'üí∞ ÂΩìÂâçÈáëÂ∏Å: ' + playerData.money;
                countLabel.textContent = 'ÁªôÂá∫ÈáëÂ∏ÅÊï∞Èáè';
            } else if (type === 'pet') {
                selWrap.style.display = '';
                moneyInfo.style.display = 'none';
                countLabel.textContent = 'ÔºàÂÆ†Áâ©‰∫§ÊòìÊï∞ÈáèÂõ∫ÂÆö‰∏∫1Ôºâ';
                var sel = document.getElementById('tradeOfferId');
                sel.innerHTML = '';
                var petArr = playerData.pets || [];
                for (var i = 0; i < petArr.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = petArr[i].id;
                    opt.textContent = petArr[i].speciesIcon + ' ' + petArr[i].species + '¬∑' + petArr[i].name + ' (üí∞' + petArr[i].value + ')';
                    sel.appendChild(opt);
                }
                if (petArr.length === 0) { var o = document.createElement('option'); o.textContent = 'Ê≤°ÊúâÂÆ†Áâ©'; o.value = ''; sel.appendChild(o); }
            } else {
                selWrap.style.display = '';
                moneyInfo.style.display = 'none';
                countLabel.textContent = 'ÁªôÂá∫Êï∞Èáè';
                var sel = document.getElementById('tradeOfferId');
                sel.innerHTML = '';
                var arr = type === 'seed' ? (playerData.seeds || []) : (playerData.fruits || []);
                for (var i = 0; i < arr.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = arr[i].id;
                    opt.textContent = arr[i].name + ' (x' + arr[i].count + ')';
                    sel.appendChild(opt);
                }
                if (arr.length === 0) { var o = document.createElement('option'); o.textContent = 'Ê≤°ÊúâÁâ©ÂìÅ'; o.value = ''; sel.appendChild(o); }
            }
        }

        function updTradeWantFields() {
            var type = document.getElementById('tradeWantType').value;
            var wrap = document.getElementById('tradeWantDetailWrap');
            if (type === 'any') {
                wrap.style.display = 'none';
            } else if (type === 'money') {
                wrap.innerHTML = '<label>ÊÉ≥Ë¶ÅÈáëÂ∏ÅÊï∞Èáè</label><input type="number" id="tradeWantCount" value="1" min="1">';
                wrap.style.display = '';
            } else {
                wrap.innerHTML = '<label>ÊÉ≥Ë¶ÅÁöÑÁâ©ÂìÅÂêçÁß∞</label><input type="text" id="tradeWantName" placeholder="ËæìÂÖ•Áâ©ÂìÅÂêçÁß∞"><label>ÊÉ≥Ë¶ÅÊï∞Èáè</label><input type="number" id="tradeWantCount" value="1" min="1">';
                wrap.style.display = '';
            }
        }

        function submitTrade() {
            var to = (document.getElementById('tradeTo').value || '').trim();
            if (!to) { addActionFail('ËØ∑ËæìÂÖ•‰∫§ÊòìÂØπË±°'); return; }
            var offerType = document.getElementById('tradeOfferType').value;
            var offerId = offerType === 'money' ? 'money' : (document.getElementById('tradeOfferId').value || '');
            if (offerType !== 'money' && !offerId) { addActionFail('ËØ∑ÈÄâÊã©Ë¶ÅÁªôÂá∫ÁöÑÁâ©ÂìÅ'); return; }
            var offerCount = parseInt(document.getElementById('tradeOfferCount').value) || 1;
            if (offerType === 'pet') offerCount = 1;
            var wantType = document.getElementById('tradeWantType').value;
            var wantNameEl = document.getElementById('tradeWantName');
            var wantCountEl = document.getElementById('tradeWantCount');
            var wantName = wantType === 'money' ? 'ÈáëÂ∏Å' : (wantType === 'any' ? 'Êó†ÔºàËµ†ÈÄÅÔºâ' : (wantNameEl ? wantNameEl.value.trim() : ''));
            var wantCount = wantCountEl ? (parseInt(wantCountEl.value) || 1) : 1;
            if (wantType !== 'any' && wantType !== 'money' && !wantName) { addActionFail('ËØ∑ËæìÂÖ•ÊÉ≥Ë¶ÅÁöÑÁâ©ÂìÅÂêçÁß∞'); return; }
            doAction('trade_create', {
                to: to,
                offerType: offerType,
                offerId: offerId,
                offerCount: offerCount,
                wantType: wantType,
                wantId: wantType === 'money' ? 'money' : (wantName || ''),
                wantName: wantName || '‰ªªÊÑè',
                wantCount: wantCount
            });
        }

        function renderTradeList(trades) {
            var el = document.getElementById('tradeListArea');
            if (!el) return;
            if (!trades || trades.length === 0) { el.innerHTML = '<div style="color:#666;text-align:center;padding:10px;font-size:12px;">Ê≤°ÊúâÂæÖÂ§ÑÁêÜÁöÑ‰∫§Êòì</div>'; return; }
            var h = '<div style="font-size:12px;color:#888;margin-bottom:6px;">ÂæÖÂ§ÑÁêÜ‰∫§ÊòìÔºö</div>';
            for (var i = 0; i < trades.length; i++) {
                var t = trades[i];
                var isFrom = t.from === username;
                var offerText = t.offerType === 'money' ? 'üí∞' + t.offerCount + 'ÈáëÂ∏Å' : esc(t.offerName) + ' x' + t.offerCount;
                var wantText = t.wantType === 'any' ? 'Êó†ÔºàËµ†ÈÄÅÔºâ' : (t.wantType === 'money' ? 'üí∞' + t.wantCount + 'ÈáëÂ∏Å' : esc(t.wantName) + ' x' + t.wantCount);
                h += '<div class="msg-trade" style="margin-bottom:6px;" data-trade-id="' + t.id + '">';
                h += '<div>' + (isFrom ? '‰Ω†' : esc(t.from)) + ' ÊÉ≥Áî® <b>' + offerText + '</b> Êç¢ ' + (isFrom ? esc(t.to) : '‰Ω†') + ' ÁöÑ <b>' + wantText + '</b></div>';
                h += '<div class="trade-btns">';
                if (!isFrom) {
                    h += '<button class="t-accept" onclick="doTradeAction(\'accept\',\'' + t.id + '\')">Êé•Âèó</button>';
                    h += '<button class="t-reject" onclick="doTradeAction(\'reject\',\'' + t.id + '\')">ÊãíÁªù</button>';
                } else {
                    h += '<button class="t-reject" onclick="doTradeAction(\'cancel\',\'' + t.id + '\')">ÂèñÊ∂à</button>';
                }
                h += '</div></div>';
            }
            el.innerHTML = h;
        }

        function showTradeIncoming(trade) {
            var offerText = trade.offerType === 'money' ? 'üí∞' + trade.offerCount + 'ÈáëÂ∏Å' : esc(trade.offerName) + ' x' + trade.offerCount;
            var wantText = trade.wantType === 'any' ? 'Êó†ÔºàËµ†ÈÄÅÔºâ' : (trade.wantType === 'money' ? 'üí∞' + trade.wantCount + 'ÈáëÂ∏Å' : esc(trade.wantName) + ' x' + trade.wantCount);
            var h = '<div class="msg-trade">';
            h += '<div>üì¶ ' + esc(trade.from) + ' ÊÉ≥Áî® <b>' + offerText + '</b> Êç¢‰Ω†ÁöÑ <b>' + wantText + '</b></div>';
            h += '<div class="trade-btns">';
            h += '<button class="t-accept" onclick="doTradeAction(\'accept\',\'' + trade.id + '\')">Êé•Âèó</button>';
            h += '<button class="t-reject" onclick="doTradeAction(\'reject\',\'' + trade.id + '\')">ÊãíÁªù</button>';
            h += '</div></div>';
            var div = document.createElement('div');
            div.className = 'msg-item msg-trade';
            div.setAttribute('data-trade-id', trade.id);
            div.innerHTML = h;
            appendMsg(div);
        }

        function doTradeAction(action, tradeId) {
            if (action === 'accept') {
                doAction('trade_accept', { tradeId: tradeId });
            } else if (action === 'reject') {
                doAction('trade_reject', { tradeId: tradeId });
            } else if (action === 'cancel') {
                doAction('trade_cancel', { tradeId: tradeId });
            }
            removeTradeMessage(tradeId);
        }

        function removeTradeMessage(tradeId) {
            var msgArea = document.getElementById('msgArea');
            var tradeMsg = msgArea.querySelector('[data-trade-id="' + tradeId + '"]');
            if (tradeMsg) {
                tradeMsg.style.opacity = '0';
                tradeMsg.style.transition = 'opacity 0.3s ease';
                setTimeout(function () {
                    if (tradeMsg.parentNode) tradeMsg.parentNode.removeChild(tradeMsg);
                }, 300);
            }
        }

        function openFriends() { doAction('friend_list'); openPanel('panelFriends'); }
        function renderFriendsPanel(friends, requests) {
            cachedFriendList = (friends || []).map(function (f) { return f.username; });
            var h = '';
            h += '<div style="display:flex;gap:6px;margin-bottom:12px;">';
            h += '<input type="text" id="addFriendInput" placeholder="ËæìÂÖ•ÊòµÁß∞" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px 12px;font-size:13px;color:#e0e0e0;outline:none;">';
            h += '<button style="padding:8px 14px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;" onclick="doAddFriend()">Ê∑ªÂä†</button></div>';
            h += '<button style="width:100%;padding:8px;background:rgba(103,232,249,0.1);color:#67e8f9;border:1px solid rgba(103,232,249,0.2);border-radius:8px;font-size:12px;cursor:pointer;margin-bottom:12px;" onclick="openGroups()">üí¨ Áæ§ËÅäÁÆ°ÁêÜ</button>';
            if (requests && requests.length > 0) {
                h += '<div style="font-size:12px;color:#c4b5fd;margin-bottom:6px;">Â•ΩÂèãËØ∑Ê±ÇÔºö</div>';
                for (var r = 0; r < requests.length; r++) {
                    h += '<div class="friend-req"><span>' + esc(requests[r]) + ' ËØ∑Ê±ÇÂä†‰Ω†‰∏∫Â•ΩÂèã</span>';
                    h += '<span style="display:flex;gap:4px;">';
                    h += '<button style="padding:3px 10px;background:#4caf50;color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doAction(\'friend_accept\',{from:\'' + esc(requests[r]) + '\'})">Êé•Âèó</button>';
                    h += '<button style="padding:3px 10px;background:#ef4444;color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doAction(\'friend_reject\',{from:\'' + esc(requests[r]) + '\'})">ÊãíÁªù</button>';
                    h += '</span></div>';
                }
            }
            h += '<div style="font-size:12px;color:#888;margin-bottom:6px;">Â•ΩÂèãÂàóË°®Ôºö</div>';
            if (!friends || friends.length === 0) {
                h += '<div style="color:#666;text-align:center;padding:20px;font-size:12px;">ËøòÊ≤°ÊúâÂ•ΩÂèã</div>';
            } else {
                for (var i = 0; i < friends.length; i++) {
                    var f = friends[i];
                    h += '<div class="friend-item"><span><span class="fi-name">' + (f.online ? 'üü¢' : '‚ö´') + ' ' + esc(f.username) + '</span><span class="fi-id">' + f.farmId + '</span></span>';
                    h += '<div class="fi-btns">';
                    h += '<button style="background:rgba(76,175,80,0.2);color:#a5d6a7;" onclick="doVisitFriend(\'' + f.farmId + '\')">‰∏≤Èó®</button>';
                    h += '<button style="background:rgba(167,139,250,0.2);color:#c4b5fd;" onclick="doPrivateMsg(\'' + esc(f.username) + '\')">ÁßÅËÅä</button>';
                    h += '<button style="background:rgba(239,68,68,0.2);color:#fca5a5;" onclick="doAction(\'friend_remove\',{target:\'' + esc(f.username) + '\'})">Âà†Èô§</button>';
                    h += '</div></div>';
                }
            }
            document.getElementById('friendsContent').innerHTML = h;
        }
        function doAddFriend() { var input = document.getElementById('addFriendInput'); var target = (input.value || '').trim(); if (!target) return; doAction('friend_request', { target: target }); input.value = ''; }
        function doVisitFriend(fid) { closePanel('panelFriends'); doAction('visit_farm', { farmId: fid }); openPanel('panelVisit'); setTimeout(function () { var vi = document.getElementById('visitFarmIdInput'); if (vi) vi.value = fid; }, 100); }
        function doPrivateMsg(target) { var text = prompt('ÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØÁªô ' + target + 'Ôºö'); if (!text || !text.trim()) return; doAction('private_msg', { to: target, text: text.trim() }); }

        function openGroups() { doAction('list_groups'); closePanel('panelFriends'); openPanel('panelGroups'); }
        function renderGroupsPanel(groups) {
            var h = '<div style="display:flex;gap:6px;margin-bottom:12px;">';
            h += '<input type="text" id="newGroupName" placeholder="Áæ§ÂêçÁß∞" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px 12px;font-size:13px;color:#e0e0e0;outline:none;">';
            h += '<button style="padding:8px 14px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;" onclick="doCreateGroup()">ÂàõÂª∫Áæ§</button></div>';
            if (!groups || groups.length === 0) {
                h += '<div style="color:#666;text-align:center;padding:20px;font-size:12px;">ËøòÊ≤°ÊúâÁæ§ËÅä</div>';
            } else {
                for (var i = 0; i < groups.length; i++) {
                    var g = groups[i];
                    h += '<div class="group-item"><span><span class="gi-name">üí¨ ' + esc(g.name) + '</span> <span class="gi-info">(' + g.members.length + '‰∫∫ ¬∑ Áæ§‰∏ª:' + esc(g.owner) + ')</span></span>';
                    h += '<div style="display:flex;gap:4px;">';
                    h += '<button style="padding:3px 10px;background:rgba(103,232,249,0.2);color:#67e8f9;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doGroupChat(\'' + g.id + '\',\'' + esc(g.name) + '\')">ÂèëÊ∂àÊÅØ</button>';
                    h += '<button style="padding:3px 10px;background:rgba(167,139,250,0.2);color:#c4b5fd;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doInviteGroup(\'' + g.id + '\')">ÈÇÄËØ∑</button>';
                    h += '<button style="padding:3px 10px;background:rgba(239,68,68,0.2);color:#fca5a5;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doAction(\'leave_group\',{groupId:\'' + g.id + '\'})">ÈÄÄÂá∫</button>';
                    h += '</div></div>';
                }
            }
            document.getElementById('groupsContent').innerHTML = h;
        }
        function doCreateGroup() { var input = document.getElementById('newGroupName'); var name = (input.value || '').trim(); if (!name) return; doAction('create_group', { name: name }); input.value = ''; }
        function doGroupChat(groupId, groupName) { var text = prompt('ÂèëÈÄÅÊ∂àÊÅØÂà∞Áæ§„Äå' + groupName + '„ÄçÔºö'); if (!text || !text.trim()) return; doAction('group_msg', { groupId: groupId, text: text.trim() }); addGroupMsg(groupName, username, text.trim()); }
        function doInviteGroup(groupId) { var target = prompt('ËæìÂÖ•Ë¶ÅÈÇÄËØ∑ÁöÑÊòµÁß∞Ôºö'); if (!target || !target.trim()) return; doAction('invite_group', { groupId: groupId, target: target.trim() }); }

        function sendChat() {
            var input = document.getElementById('chatInput');
            var text = input.value.trim();
            if (!text) return;
            doAction('chat', { text: text, channel: chatChannel });
            // ‚òÖ Ëé∑ÂèñËá™Â∑±ÁöÑÁß∞Âè∑ÊòæÁ§∫
            var myTitle = null;
            if (playerData && playerData.titles && playerData.titles[currentWorld.id]) {
                myTitle = playerData.titles[currentWorld.id];
            }
            addChatMsg(username, text, chatChannel, true, myTitle);
            input.value = '';
            input.focus();
        }

        function toggleChannel() {
            if (chatChannel === 'world') chatChannel = 'farm';
            else chatChannel = 'world';
            document.getElementById('chatChannelBtn').textContent = 'üì¢ ' + (chatChannel === 'world' ? '‰∏ñÁïåÈ¢ëÈÅì' : 'ÂÜúÂú∫È¢ëÈÅì');
        }

        function addChatMsg(from, text, channel, isMe, titleInfo) {
            var div = document.createElement('div');
            div.className = 'msg-item msg-chat';
            // ‚òÖ Âè™Âú®ÂÜúÂú∫È¢ëÈÅìÊòæÁ§∫Ê†áÁ≠æ
            var chLabel = channel === 'farm' ? '[ÂÜúÂú∫] ' : '';
            var nc = (isMe || from === username) ? 'me' : '';
            // Ê∑ªÂä†Áß∞Âè∑ÊòæÁ§∫
            var titleHtml = '';
            if (titleInfo && titleInfo.titleName) {
                var titleColor = titleInfo.titleColor || '#66bb6a';
                titleHtml = '<span style="color:' + titleColor + ';font-weight:600;margin-left:4px;">¬∑[' + esc(titleInfo.titleName) + ']</span>';
            }
            div.innerHTML = '<span class="chat-channel">' + chLabel + '</span><span class="chat-name ' + nc + '">' + esc(from) + '</span>' + titleHtml + ': ' + esc(text);
            appendMsg(div);
        }

        function addPrivateMsg(from, text) { var div = document.createElement('div'); div.className = 'msg-item msg-private'; div.innerHTML = 'üîí <b>' + esc(from) + '</b> ÊÇÑÊÇÑÂØπ‰Ω†ËØ¥: ' + esc(text); appendMsg(div); }
        function addGroupMsg(groupName, from, text) { var div = document.createElement('div'); div.className = 'msg-item msg-private'; div.innerHTML = 'üí¨ [' + esc(groupName) + '] <b>' + esc(from) + '</b>: ' + esc(text); appendMsg(div); }
        function addSysMsg(text) { var d = document.createElement('div'); d.className = 'msg-item msg-system'; d.textContent = text; appendMsg(d); }
        // ‚òÖ Âè™ÊòæÁ§∫Â•ΩÂèãÁöÑ‰∏ä‰∏ãÁ∫ø
        function checkAndShowFriendStatus(targetUser, isOnline) {
            if (!cachedFriendList || cachedFriendList.length === 0) return;
            if (cachedFriendList.indexOf(targetUser) === -1) return;
            var statusText = isOnline
                ? 'üü¢ ' + esc(targetUser) + ' ‰∏äÁ∫ø‰∫Ü'
                : '‚ö´ ' + esc(targetUser) + ' ‰∏ãÁ∫ø‰∫Ü';
            addSysMsg(statusText);
        }
        function addAnnounce(text) { var d = document.createElement('div'); d.className = 'msg-item msg-announce'; d.innerHTML = 'üìú ' + esc(text); appendMsg(d); }
        function addActionOk(text) { var d = document.createElement('div'); d.className = 'msg-item msg-action ok'; d.textContent = text; appendMsg(d); }
        function addActionFail(text) { var d = document.createElement('div'); d.className = 'msg-item msg-action fail'; d.textContent = text; appendMsg(d); }
        var _scrollPending = false;
        function appendMsg(el) {
            var a = document.getElementById('msgArea');
            a.appendChild(el);
            while (a.children.length > 100) a.removeChild(a.firstChild);
            if (!_scrollPending) {
                _scrollPending = true;
                requestAnimationFrame(function () {
                    a.scrollTop = a.scrollHeight;
                    _scrollPending = false;
                });
            }
        }

        function openPanel(id) { document.getElementById(id).classList.add('show'); }
        function closePanel(id) { document.getElementById(id).classList.remove('show'); }
        document.querySelectorAll('.panel-overlay').forEach(function (el) { el.addEventListener('click', function (e) { if (e.target === el) el.classList.remove('show'); }); });

        function esc(t) { if (t === null || t === undefined) return ''; var d = document.createElement('div'); d.textContent = String(t); return d.innerHTML; }

        document.getElementById('chatInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') sendChat(); });
        document.getElementById('loginPass').addEventListener('keypress', function (e) { if (e.key === 'Enter') doLogin(); });

        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                if (!ws || ws.readyState !== WebSocket.OPEN) connectWS();
                if (playerData) doAction('my_farm');
            }
        });

        // ============================================================
        //  ÂÆ†Áâ©Á≥ªÁªü
        // ============================================================
        function openPets() {
            doAction('my_pets');
            openPanel('panelPets');
        }

        function getRarityLabel(rarity) {
            var map = {
                'common': '<span class="rarity-common">ÊôÆÈÄö</span>',
                'uncommon': '<span class="rarity-uncommon">‰ºòÁßÄ</span>',
                'rare': '<span class="rarity-rare">Á®ÄÊúâ</span>',
                'epic': '<span class="rarity-epic">Âè≤ËØó</span>',
                'legendary': '<span class="rarity-legendary">‰º†ËØ¥</span>'
            };
            return map[rarity] || '<span class="rarity-common">ÊôÆÈÄö</span>';
        }

        function getRarityText(rarity) {
            var map = {
                'common': 'ÊôÆÈÄö',
                'uncommon': '‰ºòÁßÄ',
                'rare': 'Á®ÄÊúâ',
                'epic': 'Âè≤ËØó',
                'legendary': '‰º†ËØ¥'
            };
            return map[rarity] || 'ÊôÆÈÄö';
        }

        function getMoodColor(mood) {
            if (mood >= 70) return '#4caf50';
            if (mood >= 40) return '#fbbf24';
            return '#ef4444';
        }

        function getMoodText(mood) {
            if (mood >= 80) return 'üòä ÂºÄÂøÉ';
            if (mood >= 60) return 'üôÇ ‰∏çÈîô';
            if (mood >= 40) return 'üòê ‰∏ÄËà¨';
            if (mood >= 20) return 'üòü ‰ΩéËêΩ';
            return 'üò¢ ÈöæËøá';
        }

        function renderPetsPanel(pets) {
            var h = '';
            if (!pets || pets.length === 0) {
                h += '<div style="text-align:center;color:#666;padding:30px;">';
                h += '<div style="font-size:36px;margin-bottom:10px;">üêæ</div>';
                h += '<div style="font-size:13px;">ËøòÊ≤°ÊúâÂÆ†Áâ©</div>';
                h += '<div style="font-size:11px;color:#555;margin-top:4px;">ÂéªÈáéÂ§ñÊçïÊçâÊàñÂïÜÂ∫óË¥≠‰π∞Âêß</div>';
                h += '</div>';
            } else {
                h += '<div style="font-size:12px;color:#888;margin-bottom:8px;">ÂÖ± ' + pets.length + '/6 Âè™ÂÆ†Áâ©</div>';
                for (var i = 0; i < pets.length; i++) {
                    var pet = pets[i];
                    var now = Date.now();
                    var isOnAdventure = pet.adventureEndTime && now < pet.adventureEndTime;
                    var adventureReady = pet.adventureEndTime && now >= pet.adventureEndTime;

                    h += '<div class="pet-card" onclick="openPetDetail(\'' + pet.id + '\')">';
                    h += '<div class="pc-header">';
                    h += '<div style="display:flex;align-items:center;gap:8px;">';
                    h += '<span class="pc-icon">' + (pet.speciesIcon || 'üêæ') + '</span>';
                    h += '<div>';
                    h += '<div class="pc-name">' + esc(pet.name) + '</div>';
                    h += '<div class="pc-species">' + esc(pet.species) + ' ¬∑ ' + getRarityLabel(pet.rarity) + '</div>';
                    h += '</div></div>';
                    h += '<div style="text-align:right;">';
                    h += '<div style="font-size:12px;color:#fcd34d;">üí∞' + (pet.value || 0) + '</div>';
                    h += '<div style="font-size:10px;color:#888;">‰ª∑ÂÄº</div>';
                    h += '</div></div>';

                    h += '<div class="pc-stats">';
                    h += '<span>' + getMoodText(pet.mood) + ' <div class="mood-bar"><div class="mood-bar-fill" style="width:' + pet.mood + '%;background:' + getMoodColor(pet.mood) + ';"></div></div></span>';
                    h += '<span>üó∫Ô∏è Êé¢Èô©' + (pet.totalAdventures || 0) + 'Ê¨°</span>';
                    h += '</div>';

                    if (isOnAdventure) {
                        var remainMs = pet.adventureEndTime - now;
                        var remainMin = Math.ceil(remainMs / 60000);
                        h += '<div class="pc-adventure">üó∫Ô∏è ÂØªÂÆù‰∏≠... ËøòÈúÄ' + remainMin + 'ÂàÜÈíü</div>';
                    } else if (adventureReady) {
                        h += '<div class="pc-adventure" style="color:#4ade80;">‚úÖ ÂØªÂÆùÂÆåÊàêÔºÅÁÇπÂáªÈ¢ÜÂèñ</div>';
                    }

                    h += '</div>';
                }
            }
            document.getElementById('petsContent').innerHTML = h;
        }

        function openPetDetail(petId) {
            if (!playerData || !playerData.pets) return;
            var pet = playerData.pets.find(function (pt) { return pt.id === petId; });
            if (!pet) return;

            var now = Date.now();
            var isOnAdventure = pet.adventureEndTime && now < pet.adventureEndTime;
            var adventureReady = pet.adventureEndTime && now >= pet.adventureEndTime;

            var h = '';
            h += '<div style="text-align:center;margin-bottom:14px;">';
            h += '<div style="font-size:48px;margin-bottom:6px;">' + (pet.speciesIcon || 'üêæ') + '</div>';
            h += '<div style="font-size:18px;color:#c4b5fd;font-weight:600;">' + esc(pet.name) + '</div>';
            h += '<div style="font-size:12px;color:#888;margin-top:2px;">' + esc(pet.species) + ' ¬∑ ' + getRarityLabel(pet.rarity) + '</div>';
            h += '</div>';

            // Â±ûÊÄßÈù¢Êùø
            h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">';
            h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px;text-align:center;">';
            h += '<div style="font-size:10px;color:#888;">ÂøÉÊÉÖ</div>';
            h += '<div style="font-size:14px;margin-top:2px;">' + getMoodText(pet.mood) + '</div>';
            h += '<div class="mood-bar" style="width:80%;margin:4px auto 0;"><div class="mood-bar-fill" style="width:' + pet.mood + '%;background:' + getMoodColor(pet.mood) + ';"></div></div>';
            h += '</div>';
            h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px;text-align:center;">';
            h += '<div style="font-size:10px;color:#888;">‰ª∑ÂÄº</div>';
            h += '<div style="font-size:14px;color:#fcd34d;margin-top:2px;">üí∞' + (pet.value || 0) + '</div>';
            h += '</div>';
            h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px;text-align:center;">';
            h += '<div style="font-size:10px;color:#888;">Êé¢Èô©Ê¨°Êï∞</div>';
            h += '<div style="font-size:14px;color:#67e8f9;margin-top:2px;">üó∫Ô∏è ' + (pet.totalAdventures || 0) + '</div>';
            h += '</div>';
            h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px;text-align:center;">';
            h += '<div style="font-size:10px;color:#888;">Ëé∑ÂæóÊó∂Èó¥</div>';
            h += '<div style="font-size:11px;color:#aaa;margin-top:4px;">' + new Date(pet.createdAt).toLocaleDateString() + '</div>';
            h += '</div>';
            h += '</div>';

            // Êìç‰ΩúÊåâÈíÆ
            h += '<div style="display:flex;flex-direction:column;gap:6px;">';

            if (adventureReady) {
                h += '<button style="padding:12px;background:linear-gradient(135deg,#4caf50,#66bb6a);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;" onclick="doPetCollect(\'' + pet.id + '\')">üéÅ È¢ÜÂèñÂØªÂÆùÂ•ñÂä±</button>';
            } else if (isOnAdventure) {
                var remainMs2 = pet.adventureEndTime - now;
                var remainMin2 = Math.ceil(remainMs2 / 60000);
                h += '<div style="padding:12px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);border-radius:10px;text-align:center;font-size:13px;color:#fcd34d;">üó∫Ô∏è ÂØªÂÆù‰∏≠... ËøòÈúÄ' + remainMin2 + 'ÂàÜÈíü</div>';
            } else {
                h += '<button style="padding:10px;background:rgba(251,191,36,0.2);color:#fcd34d;border:1px solid rgba(251,191,36,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doPetAdventure(\'' + pet.id + '\')">üó∫Ô∏è Ê¥æÂá∫ÂØªÂÆùÔºà15ÂàÜÈíüÔºâ</button>';
            }

            h += '<button style="padding:10px;background:rgba(167,139,250,0.2);color:#c4b5fd;border:1px solid rgba(167,139,250,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doPetInteract(\'' + pet.id + '\')">‚ù§Ô∏è ‰∫íÂä®ÔºàÂøÉÊÉÖ+15Ôºâ</button>';

            h += '<button style="padding:10px;background:rgba(103,232,249,0.2);color:#67e8f9;border:1px solid rgba(103,232,249,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doPetRename(\'' + pet.id + '\')">‚úèÔ∏è ÊîπÂêç</button>';

            h += '<button style="padding:10px;background:rgba(239,68,68,0.15);color:#fca5a5;border:1px solid rgba(239,68,68,0.2);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doPetRelease(\'' + pet.id + '\')">üïäÔ∏è ÊîæÁîüÔºàÂõûÊî∂‰∏ÄÂçä‰ª∑ÂÄºÔºâ</button>';

            h += '</div>';

            document.getElementById('petDetailContent').innerHTML = h;
            openPanel('panelPetDetail');
        }

        function doPetAdventure(petId) {
            doAction('pet_adventure', { petId: petId });
            closePanel('panelPetDetail');
        }

        function doPetCollect(petId) {
            doAction('pet_collect', { petId: petId });
            closePanel('panelPetDetail');
        }

        function doPetInteract(petId) {
            doAction('pet_interact', { petId: petId });
        }

        function doPetRename(petId) {
            var newName = prompt('ÁªôÂÆ†Áâ©Ëµ∑‰∏™Êñ∞ÂêçÂ≠óÔºà1-12Â≠óÔºâÔºö');
            if (!newName || !newName.trim()) return;
            doAction('rename_pet', { petId: petId, name: newName.trim() });
            closePanel('panelPetDetail');
        }

        function doPetRelease(petId) {
            if (!confirm('Á°ÆÂÆöÊîæÁîüËøôÂè™ÂÆ†Áâ©ÔºüÂ∞ÜËé∑Âæó‰∏ÄÂçä‰ª∑ÂÄºÁöÑÈáëÂ∏Å„ÄÇ')) return;
            doAction('release_pet', { petId: petId });
            closePanel('panelPetDetail');
        }

        function doCatchPet(areaIndex) {
            doAction('catch_pet', { areaIndex: areaIndex });
        }

        // ============================================================
        //  ÈÇÆ‰ª∂Á≥ªÁªü
        // ============================================================
        function openMail() {
            doAction('mail_list');
            openPanel('panelMail');
        }

        function renderMailPanel(mails) {
            var h = '';
            if (!mails || mails.length === 0) {
                h += '<div style="text-align:center;color:#666;padding:30px;">';
                h += '<div style="font-size:36px;margin-bottom:10px;">üì≠</div>';
                h += '<div style="font-size:13px;">Ê≤°ÊúâÈÇÆ‰ª∂</div>';
                h += '</div>';
            } else {
                h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
                h += '<span style="font-size:12px;color:#888;">ÂÖ± ' + mails.length + ' Â∞ÅÈÇÆ‰ª∂</span>';
                h += '<div style="display:flex;gap:6px;">';
                h += '<button style="padding:5px 12px;background:rgba(103,232,249,0.15);color:#67e8f9;border:1px solid rgba(103,232,249,0.25);border-radius:6px;font-size:11px;cursor:pointer;" onclick="markAllMailRead()">ÂÖ®ÈÉ®Â∑≤ËØª</button>';
                h += '<button style="padding:5px 12px;background:rgba(239,68,68,0.15);color:#fca5a5;border:1px solid rgba(239,68,68,0.25);border-radius:6px;font-size:11px;cursor:pointer;" onclick="deleteAllMail()">ÂÖ®ÈÉ®Âà†Èô§</button>';
                h += '</div></div>';

                for (var i = mails.length - 1; i >= 0; i--) {
                    var m = mails[i];
                    var hasAtt = m.attachments && m.attachments.length > 0;
                    var claimed = m.claimed;
                    var isRead = m.read;
                    var borderColor = !isRead ? 'rgba(103,232,249,0.3)' : hasAtt && !claimed ? 'rgba(251,191,36,0.3)' : 'rgba(255,255,255,0.08)';
                    var bgColor = !isRead ? 'rgba(103,232,249,0.05)' : hasAtt && !claimed ? 'rgba(251,191,36,0.05)' : 'rgba(255,255,255,0.03)';

                    h += '<div style="background:' + bgColor + ';border:1px solid ' + borderColor + ';border-radius:10px;padding:12px;margin-bottom:8px;">';
                    h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
                    h += '<div style="font-size:13px;color:#a5d6a7;font-weight:600;">' + (!isRead ? 'üîµ ' : '') + esc(m.subject || 'Á≥ªÁªüÈÇÆ‰ª∂') + '</div>';
                    h += '<div style="font-size:10px;color:#666;">' + formatMailTime(m.createdAt) + '</div>';
                    h += '</div>';
                    h += '<div style="font-size:11px;color:#888;margin-bottom:4px;">Êù•Ëá™: ' + esc(m.from || 'Á≥ªÁªü') + '</div>';

                    if (m.text) {
                        h += '<div style="font-size:12px;color:#ddd;line-height:1.6;margin-bottom:8px;white-space:pre-wrap;">' + esc(m.text) + '</div>';
                    }

                    if (hasAtt) {
                        h += '<div style="font-size:11px;color:#fcd34d;margin-bottom:6px;">üì¶ ÈôÑ‰ª∂Ôºö</div>';
                        h += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">';
                        for (var j = 0; j < m.attachments.length; j++) {
                            var att = m.attachments[j];
                            var attText = '';
                            if (att.type === 'money') attText = 'üí∞' + att.amount + 'ÈáëÂ∏Å';
                            else if (att.type === 'seed') attText = (att.data.icon || 'üå±') + att.data.name + ' x' + (att.data.count || 1);
                            else if (att.type === 'fruit') attText = (att.data.icon || 'üçé') + att.data.name + ' x' + (att.data.count || 1);
                            else if (att.type === 'pet') attText = (att.data.speciesIcon || 'üêæ') + att.data.species + '¬∑' + (att.data.name || att.data.species);
                            h += '<span style="padding:3px 8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:6px;font-size:11px;color:#ccc;">' + attText + '</span>';
                        }
                        h += '</div>';
                    }

                    h += '<div style="display:flex;gap:6px;">';
                    if (hasAtt && !claimed) {
                        h += '<button style="flex:1;padding:8px;background:linear-gradient(135deg,#4caf50,#66bb6a);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;" onclick="claimMail(\'' + m.id + '\')">üéÅ È¢ÜÂèñÈôÑ‰ª∂</button>';
                    } else if (hasAtt && claimed) {
                        h += '<span style="flex:1;padding:8px;text-align:center;font-size:11px;color:#666;">‚úÖ Â∑≤È¢ÜÂèñ</span>';
                    }
                    if (!isRead) {
                        h += '<button style="padding:8px 14px;background:rgba(103,232,249,0.15);color:#67e8f9;border:1px solid rgba(103,232,249,0.25);border-radius:8px;font-size:11px;cursor:pointer;" onclick="markMailRead(\'' + m.id + '\')">Â∑≤ËØª</button>';
                    }
                    h += '<button style="padding:8px 14px;background:rgba(239,68,68,0.15);color:#fca5a5;border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:11px;cursor:pointer;" onclick="deleteMail(\'' + m.id + '\')">Âà†Èô§</button>';
                    h += '</div>';
                    h += '</div>';
                }
            }
            document.getElementById('mailContent').innerHTML = h;
        }

        function formatMailTime(ts) {
            if (!ts) return '';
            var d = new Date(ts);
            var now = new Date();
            var diff = now - d;
            if (diff < 60000) return 'ÂàöÂàö';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            return d.getMonth() + 1 + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
        }

        function claimMail(mailId) {
            doAction('mail_claim', { mailId: mailId });
        }

        function deleteMail(mailId) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§ËøôÂ∞ÅÈÇÆ‰ª∂Ôºü')) return;
            doAction('mail_delete', { mailId: mailId });
        }

        function markMailRead(mailId) {
            doAction('mail_read', { mailId: mailId });
        }

        function markAllMailRead() {
            doAction('mail_read_all');
        }

        function deleteAllMail() {
            if (!confirm('Á°ÆÂÆöÂà†Èô§ÊâÄÊúâÈÇÆ‰ª∂ÔºüÊú™È¢ÜÂèñÁöÑÈôÑ‰ª∂Â∞Ü‰∏¢Â§±ÔºÅ')) return;
            doAction('mail_delete_all');
        }

        // ‚òÖ È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§ç‰øùÂ≠òÁöÑË¥¶Âè∑
        loadSavedAccount();
        connectWS();
    </script>
</body>

</html>
