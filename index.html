<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é˜¡é™Œä¹‹è¯—</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html{height:100%;width:100%;}
body{height:100%;width:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a2e1a;color:#e0e0e0;overflow:hidden;-webkit-tap-highlight-color:transparent;}
.page{display:none;width:100%;height:100vh;flex-direction:column;}
.page.active{display:flex;}
.login-page{justify-content:center;align-items:center;background:linear-gradient(135deg,#1a2e1a 0%,#2d4a2d 50%,#1a3a1a 100%);}
.login-box{width:90%;max-width:360px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px 24px;backdrop-filter:blur(10px);}
.login-box h1{text-align:center;font-size:28px;margin-bottom:6px;}
.login-box .subtitle{text-align:center;font-size:13px;color:#888;margin-bottom:24px;}
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:12px;color:#aaa;margin-bottom:4px;padding-left:4px;}
.form-group input{width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:11px 14px;font-size:14px;color:#e0e0e0;outline:none;transition:border-color 0.2s;}
.form-group input:focus{border-color:#6abf69;}
.form-group input::placeholder{color:#666;}
.remember-row{display:flex;align-items:center;gap:8px;margin-bottom:14px;padding-left:4px;}
.remember-row input[type=checkbox]{width:16px;height:16px;accent-color:#4caf50;cursor:pointer;}
.remember-row label{font-size:12px;color:#aaa;cursor:pointer;}
.btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.btn:active{transform:scale(0.97);}
.btn-green{background:linear-gradient(135deg,#4caf50,#66bb6a);color:#fff;}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.2);color:#ccc;margin-top:8px;}
.btn-ghost:hover{border-color:#6abf69;color:#6abf69;}
.login-msg{text-align:center;font-size:12px;margin-top:12px;min-height:18px;}
.login-msg.err{color:#ef4444;}
.login-msg.ok{color:#4ade80;}
.login-status{text-align:center;font-size:11px;color:#555;margin-top:16px;}
.worlds-page{background:#1a2e1a;}
.worlds-header{
    padding:16px;
    text-align:center;
    border-bottom:1px solid rgba(255,255,255,0.08);
    flex-shrink:0;
}
.worlds-header h2{
    font-size:18px;
    color:#6abf69;
}
.worlds-header .user-info{
    font-size:12px;
    color:#888;
    margin-top:4px;
}
#globalNoticeBar{
    display:none;
    padding:8px 16px;
    background:rgba(76,175,80,0.08);
    border-bottom:1px solid rgba(76,175,80,0.15);
    font-size:12px;
    color:#a5d6a7;
    line-height:1.6;
    flex-shrink:0;
    max-height:120px;
    overflow-y:auto;
}
#globalNoticeBar.show{
    display:block;
}
.worlds-list{
    flex:1;
    overflow-y:auto;
    padding:12px;
    min-height:0;
}
.world-card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px;margin-bottom:10px;cursor:pointer;transition:all 0.2s;}
.world-card:hover{border-color:#6abf69;background:rgba(106,191,105,0.08);}
.world-card h3{font-size:15px;color:#a5d6a7;margin-bottom:4px;}
.world-card .world-info{font-size:12px;color:#888;display:flex;gap:12px;}
.world-card .world-info span{display:flex;align-items:center;gap:3px;}
.world-pw-input{margin-top:10px;display:none;}
.world-pw-input input{width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:9px 12px;font-size:13px;color:#e0e0e0;outline:none;}
.world-pw-input button{margin-top:6px;width:100%;padding:9px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;}
.no-worlds{text-align:center;color:#666;padding:40px 20px;font-size:14px;}
.worlds-footer{
    padding:12px;
    border-top:1px solid rgba(255,255,255,0.08);
    flex-shrink:0;
    text-align:center;
}
.btn-logout{background:transparent;border:1px solid rgba(255,255,255,0.15);color:#888;padding:8px 24px;border-radius:8px;font-size:12px;cursor:pointer;}
.game-page{background:#12201a;display:flex;flex-direction:column;}
.game-top{padding:8px 12px;background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;}
.game-top-row{display:flex;justify-content:space-between;align-items:center;}
.game-world-name{font-size:13px;color:#6abf69;font-weight:600;}
.game-info-right{font-size:11px;color:#888;display:flex;gap:8px;align-items:center;}
.game-exit-btn{font-size:11px;color:#888;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:3px 10px;cursor:pointer;transition:all 0.2s;}
.game-exit-btn:hover{color:#ef4444;border-color:#ef4444;}
.stamina-bar{display:flex;align-items:center;gap:4px;margin-top:5px;}
.stamina-bar .st-label{font-size:11px;color:#aaa;}
.stamina-bar .st-track{flex:1;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;max-width:120px;}
.stamina-bar .st-fill{height:100%;background:linear-gradient(90deg,#f59e0b,#4caf50);border-radius:3px;transition:width 0.5s;}
.stamina-bar .st-val{font-size:11px;color:#ccc;min-width:40px;text-align:right;}
.money-top{font-size:12px;color:#fcd34d;margin-left:8px;}
.game-main{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;}
.farm-area{padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;max-height:200px;overflow-y:auto;}
.farm-title{font-size:13px;color:#a5d6a7;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.farm-title .farm-id{font-size:11px;color:#666;font-family:monospace;}
.plots-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
.plot{background:rgba(139,90,43,0.2);border:1px solid rgba(139,90,43,0.3);border-radius:10px;padding:10px 6px;text-align:center;cursor:pointer;transition:all 0.2s;min-height:80px;display:flex;flex-direction:column;justify-content:center;align-items:center;}
.plot:hover{border-color:#6abf69;}
.plot:active{transform:scale(0.96);}
.plot.empty{border-style:dashed;opacity:0.6;}
.plot .plot-icon{font-size:24px;display:block;margin-bottom:2px;}
.plot .plot-name{font-size:11px;color:#ccc;}
.plot .plot-progress{font-size:10px;color:#888;margin-top:2px;}
.plot .plot-progress-bar{width:80%;height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin:3px auto 0;overflow:hidden;}
.plot .plot-progress-fill{height:100%;background:#4caf50;border-radius:2px;transition:width 1s;}
.plot.mature{border-color:#fcd34d;background:rgba(252,211,77,0.1);animation:glow 2s infinite alternate;}
@keyframes glow{from{box-shadow:0 0 4px rgba(252,211,77,0.2);}to{box-shadow:0 0 12px rgba(252,211,77,0.4);}}
.msg-area{flex:1;overflow-y:auto;padding:10px 12px;display:flex;flex-direction:column;gap:5px;}
.msg-item{font-size:13px;line-height:1.5;animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}
.msg-chat{color:#ddd;}
.msg-chat .chat-name{color:#6abf69;font-weight:600;margin-right:4px;}
.msg-chat .chat-name.me{color:#fcd34d;}
.msg-chat .chat-channel{font-size:10px;color:#666;margin-right:4px;}
.msg-system{color:#888;font-size:12px;text-align:center;padding:3px 0;}
.msg-announce{background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.2);border-radius:10px;padding:8px 12px;font-size:12px;color:#a5d6a7;text-align:center;}
.msg-action{color:#aaa;font-size:12px;padding-left:8px;border-left:2px solid rgba(255,255,255,0.1);}
.msg-action.ok{border-left-color:#4ade80;color:#a7f3d0;}
.msg-action.fail{border-left-color:#ef4444;color:#fca5a5;}
.msg-private{background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.2);border-radius:8px;padding:6px 10px;font-size:12px;color:#c4b5fd;}
.msg-trade{background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);border-radius:8px;padding:8px 10px;font-size:12px;color:#fcd34d;}
.msg-trade .trade-btns{margin-top:6px;display:flex;gap:6px;}
.msg-trade .trade-btns button{padding:4px 12px;border:none;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600;}
.msg-trade .trade-btns .t-accept{background:#4caf50;color:#fff;}
.msg-trade .trade-btns .t-reject{background:#ef4444;color:#fff;}
.game-bottom{border-top:1px solid rgba(255,255,255,0.06);flex-shrink:0;background:rgba(0,0,0,0.2);}
.nav-bar{display:flex;justify-content:space-around;padding:6px 4px 2px;border-bottom:1px solid rgba(255,255,255,0.04);}
.nav-btn{text-align:center;padding:4px 2px;cursor:pointer;transition:all 0.2s;flex:1;}
.nav-btn:active{transform:scale(0.92);}
.nav-btn .nav-icon{font-size:18px;display:block;}
.nav-btn .nav-label{font-size:10px;color:#888;margin-top:1px;}
.nav-btn.active .nav-label{color:#6abf69;}
.chat-input-row{display:flex;gap:6px;padding:6px 10px 10px;}
.chat-input-row input{flex:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:20px;padding:9px 14px;font-size:13px;color:#e0e0e0;outline:none;}
.chat-input-row input:focus{border-color:#6abf69;}
.chat-input-row input::placeholder{color:#555;}
.chat-input-row button{background:#4caf50;color:#fff;border:none;border-radius:20px;padding:9px 16px;font-size:13px;font-weight:600;cursor:pointer;}
.chat-channel-btn{font-size:11px;color:#888;padding:0 14px 2px;cursor:pointer;}
.chat-channel-btn:hover{color:#6abf69;}
.panel-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:50;justify-content:center;align-items:flex-end;}
.panel-overlay.show{display:flex;}
.panel-box{width:100%;max-width:500px;max-height:75vh;background:#1e2e22;border-radius:16px 16px 0 0;padding:16px;overflow-y:auto;animation:slideUp 0.3s ease;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.panel-title{font-size:15px;color:#6abf69;font-weight:600;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
.panel-close{font-size:20px;color:#888;cursor:pointer;padding:4px 8px;}
.panel-close:hover{color:#fff;}
.inv-section{margin-bottom:14px;}
.inv-section-title{font-size:12px;color:#888;margin-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;}
.inv-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.inv-item{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:8px 4px;text-align:center;cursor:pointer;transition:all 0.2s;}
.inv-item:hover{border-color:#6abf69;}
.inv-item .ii-icon{font-size:20px;display:block;margin-bottom:2px;}
.inv-item .ii-name{font-size:10px;color:#ccc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.inv-item .ii-count{font-size:10px;color:#888;}
.inv-empty{text-align:center;color:#555;padding:20px;font-size:12px;grid-column:1/-1;}
.shop-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:10px;margin-bottom:6px;}
.shop-item .si-info{flex:1;}
.shop-item .si-name{font-size:13px;color:#a5d6a7;font-weight:600;}
.shop-item .si-desc{font-size:11px;color:#888;margin-top:2px;}
.shop-item .si-price{font-size:12px;color:#fcd34d;margin-right:10px;white-space:nowrap;}
.shop-item button{padding:6px 14px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;flex-shrink:0;}
.shop-item button:active{transform:scale(0.95);}
.wild-area-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;}
.wild-area-card:hover{border-color:#f59e0b;background:rgba(245,158,11,0.08);}
.wild-area-card:active{transform:scale(0.98);}
.wild-area-card .wa-name{font-size:14px;color:#fcd34d;font-weight:600;}
.wild-area-card .wa-desc{font-size:12px;color:#888;margin-top:3px;}
.wild-area-card .wa-seeds{font-size:11px;color:#a5d6a7;margin-top:4px;}
.friend-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px;}
.friend-item .fi-name{color:#a5d6a7;font-weight:600;}
.friend-item .fi-id{font-size:11px;color:#666;font-family:monospace;margin-left:6px;}
.friend-item .fi-btns{display:flex;gap:4px;}
.friend-item .fi-btns button{padding:3px 10px;border:none;border-radius:6px;font-size:11px;cursor:pointer;}
.friend-req{background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.2);border-radius:8px;padding:8px;margin-bottom:6px;font-size:12px;display:flex;justify-content:space-between;align-items:center;}
.trade-form{display:flex;flex-direction:column;gap:8px;}
.trade-form label{font-size:11px;color:#888;}
.trade-form input,.trade-form select{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:9px 12px;font-size:13px;color:#e0e0e0;outline:none;}
.trade-form input:focus,.trade-form select:focus{border-color:#fcd34d;}
.trade-form select{appearance:auto;}
.trade-form button{padding:10px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#1a1a2e;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;}
.visit-farm-view{text-align:center;padding:10px;}
.visit-plots-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px;}
.visit-plot{background:rgba(139,90,43,0.15);border:1px solid rgba(139,90,43,0.2);border-radius:10px;padding:10px 6px;text-align:center;min-height:70px;display:flex;flex-direction:column;justify-content:center;align-items:center;}
.visit-plot .vp-icon{font-size:22px;}
.visit-plot .vp-name{font-size:10px;color:#ccc;margin-top:2px;}
.visit-plot .vp-status{font-size:10px;color:#888;}
.group-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px;}
.group-item .gi-name{color:#67e8f9;font-weight:600;}
.group-item .gi-info{font-size:11px;color:#888;}
.sell-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;margin-bottom:6px;}
.sell-item .sl-info{flex:1;}
.sell-item .sl-name{font-size:13px;color:#a5d6a7;}
.sell-item .sl-detail{font-size:11px;color:#888;}
.sell-item button{padding:5px 12px;background:#f59e0b;color:#1a1a2e;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;}
@media(max-width:360px){
    .plots-grid{grid-template-columns:repeat(2,1fr);}
    .inv-grid{grid-template-columns:repeat(3,1fr);}
}
</style>
</head>
<body>
<div class="page login-page active" id="loginPage">
    <div class="login-box">
        <h1>ğŸŒ¾ é˜¡é™Œä¹‹è¯—1.6</h1>
        <div class="subtitle">ç§åœ°ã€é‡‡é›†ã€äº¤å‹ã€äº¤æ˜“</div>
        <div class="form-group"><label>ä½ çš„æ˜µç§°</label><input type="text" id="loginUser" placeholder="2-16ä¸ªå­—ç¬¦" maxlength="16"></div>
        <div class="form-group"><label>å¯†ç </label><input type="password" id="loginPass" placeholder="è‡³å°‘4ä¸ªå­—ç¬¦"></div>
        <div class="remember-row">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe">è®°ä½è´¦å·ï¼Œä¸‹æ¬¡å…è¾“å…¥</label>
        </div>
        <button class="btn btn-green" onclick="doLogin()">ç™» å…¥</button>
        <button class="btn btn-ghost" onclick="doRegister()">æ³¨å†Œæ–°è´¦å·</button>
        <div class="login-msg" id="loginMsg"></div>
        <div class="login-status" id="loginStatus">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
    </div>
</div>
<div class="page worlds-page" id="worldsPage">
    <div class="worlds-header"><h2>ğŸŒ¾ é€‰æ‹©ä¸–ç•Œ</h2><div class="user-info">æ¬¢è¿ï¼Œ<span id="displayUser"></span>ï¼ˆé¢†åœ°ID: <span id="displayFarmId" style="font-family:monospace;color:#fcd34d;"></span>ï¼‰</div></div>
    <div id="globalNoticeBar" style="display:none;">
        <div style="font-size:11px;color:#66bb6a;font-weight:600;margin-bottom:2px;">ğŸ“œ å…¬å‘Š</div>
        <div id="globalNoticeText" style="white-space:pre-wrap;"></div>
    </div>
    <div class="worlds-list" id="worldsList"></div>
    <div class="worlds-footer"><button class="btn-logout" onclick="doLogout()">é€€å‡ºç™»å½•</button></div>
</div>
<div class="page game-page" id="gamePage">
    <div class="game-top">
        <div class="game-top-row">
            <span class="game-world-name" id="gameWorldName">ä¸–ç•Œ</span>
            <div class="game-info-right">
                <span id="gameSeason">ğŸŒ¸ æ˜¥</span>
                <span id="gameWeather">â˜€ï¸ æ™´</span>
                <span class="money-top" id="moneyTop">ğŸ’° 0</span>
                <span class="game-exit-btn" onclick="exitWorld()">ğŸšª é€€å‡º</span>
            </div>
        </div>
        <div class="stamina-bar">
            <span class="st-label">âš¡ ä½“åŠ›</span>
            <div class="st-track"><div class="st-fill" id="staminaFill" style="width:100%"></div></div>
            <span class="st-val" id="staminaVal">100/100</span>
        </div>
    </div>
    <div class="farm-area" id="farmArea" style="max-height:200px;overflow-y:auto;flex-shrink:0;">
        <div class="farm-title"><span>ğŸ¡ æˆ‘çš„å†œåœº</span><span class="farm-id" id="farmIdDisplay">ID: ------</span></div>
        <div class="plots-grid" id="plotsGrid"></div>
    </div>
    <div class="msg-area" id="msgArea"></div>
    <div class="game-bottom">
        <div class="nav-bar">
            <div class="nav-btn" onclick="openWild()"><span class="nav-icon">ğŸŒ¿</span><span class="nav-label">é‡å¤–</span></div>
            <div class="nav-btn" onclick="openVisit()"><span class="nav-icon">ğŸ </span><span class="nav-label">ä¸²é—¨</span></div>
            <div class="nav-btn" onclick="openInventory()"><span class="nav-icon">ğŸ’</span><span class="nav-label">èƒŒåŒ…</span></div>
            <div class="nav-btn" onclick="openShop()"><span class="nav-icon">ğŸª</span><span class="nav-label">å•†åº—</span></div>
            <div class="nav-btn" onclick="openTrade()"><span class="nav-icon">ğŸ¤</span><span class="nav-label">äº¤æ˜“</span></div>
            <div class="nav-btn" onclick="openFriends()"><span class="nav-icon">ğŸ‘¥</span><span class="nav-label">å¥½å‹</span></div>
            <div class="nav-btn" onclick="openSell()"><span class="nav-icon">ğŸ’°</span><span class="nav-label">å–å‡º</span></div>
        </div>
        <div class="chat-channel-btn" id="chatChannelBtn" onclick="toggleChannel()">ğŸ“¢ ä¸–ç•Œé¢‘é“</div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
            <button onclick="sendChat()">å‘é€</button>
        </div>
    </div>
</div>
<div class="panel-overlay" id="panelWild"><div class="panel-box"><div class="panel-title">ğŸŒ¿ é‡å¤–é‡‡é›† <span class="panel-close" onclick="closePanel('panelWild')">&times;</span></div><div id="wildContent"></div></div></div>
<div class="panel-overlay" id="panelVisit"><div class="panel-box"><div class="panel-title">ğŸ  ä¸²é—¨ <span class="panel-close" onclick="closePanel('panelVisit')">&times;</span></div><div id="visitContent"></div></div></div>
<div class="panel-overlay" id="panelInv"><div class="panel-box"><div class="panel-title">ğŸ’ èƒŒåŒ… <span class="panel-close" onclick="closePanel('panelInv')">&times;</span></div><div id="invContent"></div></div></div>
<div class="panel-overlay" id="panelShop"><div class="panel-box"><div class="panel-title">ğŸª å•†åº— <span class="panel-close" onclick="closePanel('panelShop')">&times;</span></div><div id="shopContent"></div></div></div>
<div class="panel-overlay" id="panelTrade"><div class="panel-box"><div class="panel-title">ğŸ¤ äº¤æ˜“ <span class="panel-close" onclick="closePanel('panelTrade')">&times;</span></div><div id="tradeContent"></div></div></div>
<div class="panel-overlay" id="panelFriends"><div class="panel-box"><div class="panel-title">ğŸ‘¥ å¥½å‹ <span class="panel-close" onclick="closePanel('panelFriends')">&times;</span></div><div id="friendsContent"></div></div></div>
<div class="panel-overlay" id="panelSell"><div class="panel-box"><div class="panel-title">ğŸ’° å–å‡ºæœå® <span class="panel-close" onclick="closePanel('panelSell')">&times;</span></div><div id="sellContent"></div></div></div>
<div class="panel-overlay" id="panelPlotAction"><div class="panel-box"><div class="panel-title">ğŸŒ± åœ°å—æ“ä½œ <span class="panel-close" onclick="closePanel('panelPlotAction')">&times;</span></div><div id="plotActionContent"></div></div></div>
<div class="panel-overlay" id="panelGroups"><div class="panel-box"><div class="panel-title">ğŸ’¬ ç¾¤èŠ <span class="panel-close" onclick="closePanel('panelGroups')">&times;</span></div><div id="groupsContent"></div></div></div>

<script>
var SERVER_URL = 'wss://ws.qmzs.top';
var ws = null, username = null, farmId = null, currentWorld = null, playerData = null;
var chatChannel = 'world', reconnTimer = null, hbTimer = null;
var visitingOwner = null, visitingFarmId = null;
var serverTimeOffset = 0;

// â˜… è®°ä½è´¦å·
function loadSavedAccount() {
    try {
        var saved = localStorage.getItem('qmzs_account');
        if (saved) {
            var data = JSON.parse(saved);
            if (data.username) document.getElementById('loginUser').value = data.username;
            if (data.password) document.getElementById('loginPass').value = data.password;
            document.getElementById('rememberMe').checked = true;
        }
    } catch(e) {}
}
function saveAccount(u, p) {
    try {
        if (document.getElementById('rememberMe').checked) {
            localStorage.setItem('qmzs_account', JSON.stringify({ username: u, password: p }));
        } else {
            localStorage.removeItem('qmzs_account');
        }
    } catch(e) {}
}
function clearSavedAccount() {
    try { localStorage.removeItem('qmzs_account'); } catch(e) {}
}

// â˜… é€€å‡ºä¸–ç•Œå›åˆ°é€‰æ‹©ç•Œé¢
function exitWorld() {
    if (!confirm('ç¡®å®šé€€å‡ºå½“å‰ä¸–ç•Œï¼Ÿ')) return;
    clearTimers();
    currentWorld = null;
    playerData = null;
    visitingOwner = null;
    visitingFarmId = null;
    // å…³é—­æ‰€æœ‰é¢æ¿
    document.querySelectorAll('.panel-overlay').forEach(function(el) { el.classList.remove('show'); });
    var vbar = document.getElementById('visitStatusBar');
    if (vbar) vbar.remove();
    document.getElementById('msgArea').innerHTML = '';
    showWorldsPage();
}

function openFeedbackForm() {
    var el = document.getElementById('feedbackFormArea');
    if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
function submitFeedback() {
    var text = (document.getElementById('feedbackText').value || '').trim();
    if (!text || text.length < 2) { alert('åé¦ˆå†…å®¹è‡³å°‘2ä¸ªå­—'); return; }
    if (text.length > 500) { alert('åé¦ˆå†…å®¹ä¸èƒ½è¶…è¿‡500å­—'); return; }
    wsSend({ type: 'submit_feedback', text: text });
    document.getElementById('feedbackText').value = '';
    document.getElementById('feedbackFormArea').style.display = 'none';
    alert('æ„Ÿè°¢ä½ çš„åé¦ˆï¼');
}

function connectWS() {
    if (ws && ws.readyState === WebSocket.OPEN) return;
    updLoginStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
    ws = new WebSocket(SERVER_URL);
    ws.onopen = function() { updLoginStatus('å·²è¿æ¥', true); if (reconnTimer) { clearTimeout(reconnTimer); reconnTimer = null; } startHB(); };
    ws.onmessage = function(e) { var m; try { m = JSON.parse(e.data); } catch(err) { return; } handleMsg(m); };
    ws.onerror = function() { updLoginStatus('è¿æ¥å‡ºé”™', false); };
    ws.onclose = function() { updLoginStatus('è¿æ¥æ–­å¼€ï¼Œé‡è¿ä¸­...', false); stopHB(); reconnTimer = setTimeout(connectWS, 3000); };
}
function wsSend(o) { if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(o)); }
function startHB() { stopHB(); hbTimer = setInterval(function() { wsSend({ type: 'heartbeat' }); }, 25000); }
function stopHB() { if (hbTimer) { clearInterval(hbTimer); hbTimer = null; } }
function doAction(action, payload) { wsSend({ type: 'action', action: action, payload: payload || {} }); }

function handleMsg(msg) {
    switch(msg.type) {
        case 'register_result':
            showLoginMsg(msg.msg, msg.ok);
            if (msg.ok && msg.farmId) showLoginMsg(msg.msg + 'ï¼Œä½ çš„é¢†åœ°ID: ' + msg.farmId, true);
            break;
        case 'login_result':
            if (msg.ok) {
                username = msg.username; farmId = msg.farmId;
                // â˜… ç™»å½•æˆåŠŸæ—¶ä¿å­˜è´¦å·
                saveAccount(document.getElementById('loginUser').value.trim(), document.getElementById('loginPass').value);
                showLoginMsg('ç™»å½•æˆåŠŸ', true);
                setTimeout(showWorldsPage, 400);
            } else showLoginMsg(msg.msg, false);
            break;
        case 'world_list':
            renderWorldList(msg.data);
            if (msg.globalNotice) {
                document.getElementById('globalNoticeText').textContent = msg.globalNotice;
                document.getElementById('globalNoticeBar').style.display = 'block';
            } else {
                document.getElementById('globalNoticeBar').style.display = 'none';
            }
            break;
        case 'enter_world_result':
            console.log('enter_world_result:', msg);
            if (msg.ok) enterGame(msg);
            else alert(msg.msg);
            break;
        case 'action_result': handleActionResult(msg); break;
        case 'chat': addChatMsg(msg.from, msg.text, msg.channel); break;
        case 'private_msg': addPrivateMsg(msg.from, msg.text); break;
        case 'group_msg': addGroupMsg(msg.groupName, msg.from, msg.text); break;
        case 'player_online': addSysMsg(msg.username + ' ä¸Šçº¿äº†'); break;
        case 'player_offline': addSysMsg(msg.username + ' ä¸‹çº¿äº†'); break;
        case 'announcement': addAnnounce(msg.text); break;
        case 'world_update': if (msg.announcement) addAnnounce(msg.announcement); break;
        case 'season_update': updSeason(msg.season, msg.weather); break;
        case 'visitor_enter': addSysMsg(msg.username + ' æ¥ä½ å†œåœºä¸²é—¨äº†'); break;
        case 'visitor_leave': addSysMsg(msg.username + ' ç¦»å¼€äº†ä½ çš„å†œåœº'); break;
        case 'trade_incoming': showTradeIncoming(msg.trade); break;
        case 'trade_completed': addActionOk('äº¤æ˜“å®Œæˆï¼'); if (msg.seeds) playerData.seeds = msg.seeds; if (msg.fruits) playerData.fruits = msg.fruits; if (msg.money !== undefined) { playerData.money = msg.money; updMoney(); } break;
        case 'trade_rejected': addActionFail('å¯¹æ–¹æ‹’ç»äº†ä½ çš„äº¤æ˜“'); break;
        case 'trade_cancelled': addSysMsg('ä¸€ç¬”äº¤æ˜“è¢«å–æ¶ˆäº†'); break;
        case 'friend_request_received': addSysMsg(msg.from + ' è¯·æ±‚åŠ ä½ ä¸ºå¥½å‹'); break;
        case 'friend_accepted': addActionOk(msg.by + ' æ¥å—äº†ä½ çš„å¥½å‹è¯·æ±‚'); break;
        case 'group_invite': addSysMsg(msg.inviter + ' é‚€è¯·ä½ åŠ å…¥ç¾¤èŠã€Œ' + msg.group.name + 'ã€'); break;
        case 'player_update': playerData = msg.player; refreshFarm(); break;
        case 'kicked': alert(msg.msg || 'è¢«è¸¢å‡º'); exitToWorlds(); break;
        case 'blacklisted': alert(msg.msg || 'ä½ å·²è¢«åŠ å…¥é»‘åå•'); exitToWorlds(); break;
        case 'heartbeat_ack':
            if (msg.timestamp) serverTimeOffset = msg.timestamp - Date.now();
            break;
        case 'visitor_water':
            addSysMsg(msg.from + ' ç»™ä½ çš„ ' + msg.plantName + ' æµ‡äº†æ°´ ğŸ’§');
            // â˜… åŒæ­¥æ›´æ–°æœ¬åœ°åœ°å—æµ‡æ°´çŠ¶æ€
            if (playerData && playerData.plots && playerData.plots[msg.plotId] && playerData.plots[msg.plotId].plant) {
                playerData.plots[msg.plotId].plant.watered = true;
                if (!visitingOwner) renderPlots();
            }
            break;
       case 'farm_plot_update':
            // â˜… å…¶ä»–è®¿å®¢æµ‡æ°´åï¼Œæ›´æ–°ä¸²é—¨è§†å›¾
            if (visitingOwner === msg.owner) {
                addSysMsg('æœ‰äººç»™ ' + msg.plantName + ' æµ‡äº†æ°´ ğŸ’§');
                doAction('visit_farm', { farmId: visitingFarmId });
            }
            break;
       case 'feedback_result':
            if (msg.ok) addActionOk(msg.msg || 'åé¦ˆå·²æäº¤');
            else addActionFail(msg.msg || 'æäº¤å¤±è´¥');
            break;
    }
}

// â˜… è¢«è¸¢å‡ºæ—¶å›åˆ°ä¸–ç•Œåˆ—è¡¨è€Œä¸æ˜¯åˆ·æ–°é¡µé¢
function exitToWorlds() {
    clearTimers();
    currentWorld = null;
    playerData = null;
    visitingOwner = null;
    visitingFarmId = null;
    document.querySelectorAll('.panel-overlay').forEach(function(el) { el.classList.remove('show'); });
    var vbar = document.getElementById('visitStatusBar');
    if (vbar) vbar.remove();
    document.getElementById('msgArea').innerHTML = '';
    if (username) showWorldsPage();
    else showPage('loginPage');
}

function handleActionResult(msg) {
    var a = msg.action, ok = msg.ok;
    if (msg.stamina !== undefined && playerData) { playerData.stamina = msg.stamina; updStamina(); }
    if (msg.staminaMax !== undefined && playerData) { playerData.staminaMax = msg.staminaMax; updStamina(); }
    if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); }
    if (msg.plots && playerData && a !== 'visit_farm') {
        if (a === 'water' && visitingOwner) {
            updateVisitPlots(msg.plots);
        } else {
            playerData.plots = msg.plots;
            renderPlots();
        }
    }
    if (msg.seeds && playerData && a !== 'visit_farm') playerData.seeds = msg.seeds;
    if (msg.fruits && playerData && a !== 'visit_farm') playerData.fruits = msg.fruits;
    if (msg.items && playerData) playerData.items = msg.items;
    if (msg.restCooldown !== undefined && playerData) playerData.restCooldown = msg.restCooldown;
    if (msg.hasWaterBoost !== undefined && playerData) playerData.hasWaterBoost = msg.hasWaterBoost;

    switch(a) {
        case 'gather': if (ok) addActionOk(msg.msg); else addActionFail(msg.msg); break;
        case 'rest': if (ok) addActionOk(msg.msg); else addActionFail(msg.msg); break;
        case 'plant': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
        case 'water': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
        case 'fertilize': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
        case 'harvest': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
        case 'my_farm':
    if (ok && playerData) {
        playerData.plots = msg.plots; playerData.seeds = msg.seeds; playerData.fruits = msg.fruits;
        playerData.items = msg.items; playerData.money = msg.money; playerData.stamina = msg.stamina;
        playerData.staminaMax = msg.staminaMax; playerData.restCooldown = msg.restCooldown;
        playerData.farmId = msg.farmId; 
        playerData.waterBoostLevel = msg.waterBoostLevel || 0;  // â˜… æ·»åŠ è¿™è¡Œ
        if (!visitingOwner) {
            refreshFarm();
        } else {
            updStamina();
            updMoney();
        }
    }
    break;
        case 'inventory':
            if (ok) {
                playerData.seeds = msg.seeds; playerData.fruits = msg.fruits;
                playerData.items = msg.items; playerData.money = msg.money;
                renderInventoryPanel(msg.seeds, msg.fruits, msg.items, msg.money);
                if (window._pendingSellRender) { window._pendingSellRender = false; renderSellPanel(); }
            }
            break;
        case 'shop_list':
            if (ok) renderShopPanel(msg.shop, msg.money);
            break;
        case 'shop_buy':
    if (ok) { 
        addActionOk(msg.msg);
        // â˜… ç«‹å³åŒæ­¥æ‰€æœ‰è¿”å›çš„æ•°æ®
        if (msg.money !== undefined && playerData) playerData.money = msg.money;
        if (msg.waterBoostLevel !== undefined && playerData) playerData.waterBoostLevel = msg.waterBoostLevel;
        if (msg.seeds && playerData) playerData.seeds = msg.seeds;
        if (msg.items && playerData) playerData.items = msg.items;
        if (msg.plots && playerData) playerData.plots = msg.plots;
        // é‡æ–°æ‹‰å–å®Œæ•´å•†åº—æ•°æ®
        setTimeout(function() {
            doAction('shop_list');
        }, 150);
    } else addActionFail(msg.msg);
    break;
        case 'sell_fruit':
            if (ok) { addActionOk(msg.msg); openSell(); } else addActionFail(msg.msg);
            break;
        case 'wild_areas':
            if (ok) renderWildPanel(msg.areas, msg.stamina, msg.staminaMax);
            break;
        case 'visit_farm':
            if (ok) {
                var isRefresh = (visitingOwner === msg.owner);
                if (isRefresh) {
                    // â˜… é™é»˜åˆ·æ–°ï¼šåªæ›´æ–°åœ°å—ï¼Œä¸é‡å»ºçŠ¶æ€æ¡å’Œå¼¹æ¶ˆæ¯
                    updateVisitPlots(msg.plots);
                } else {
                    renderVisitFarm(msg.owner, msg.farmId, msg.plots, msg.visitors);
                    closePanel('panelVisit');
                    addActionOk('æ¥åˆ°äº† ' + msg.owner + ' çš„å†œåœº');
                }
            }
            else { if (!visitingOwner) addActionFail(msg.msg); }
            break;
        case 'go_home':
            if (ok) {
                visitingOwner = null;
                visitingFarmId = null;
                closePanel('panelVisit');
                var vbar = document.getElementById('visitStatusBar');
                if (vbar) vbar.remove();
                var ft = document.querySelector('.farm-title');
                if (ft && playerData) {
                    ft.innerHTML = '<span>ğŸ¡ æˆ‘çš„å†œåœº</span><span class="farm-id" id="farmIdDisplay">ID: ' + (playerData.farmId || '???') + '</span>';
                }
                addActionOk('å›åˆ°äº†è‡ªå·±çš„å†œåœº');
                doAction('my_farm');
            }
            break;
        case 'friend_list':
            if (ok) renderFriendsPanel(msg.friends, msg.requests);
            break;
        case 'friend_request': case 'friend_accept': case 'friend_reject': case 'friend_remove':
            if (ok) { addActionOk(msg.msg); doAction('friend_list'); } else addActionFail(msg.msg);
            break;
        case 'trade_create':
            if (ok) { addActionOk(msg.msg); closePanel('panelTrade'); } else addActionFail(msg.msg);
            break;
        case 'trade_list':
            if (ok) renderTradeList(msg.trades);
            break;
        case 'trade_accept': case 'trade_reject': case 'trade_cancel':
            if (ok) { addActionOk(msg.msg); doAction('trade_list'); } else addActionFail(msg.msg);
            break;
        case 'private_msg':
            if (ok) addActionOk(msg.msg); else addActionFail(msg.msg);
            break;
        case 'list_groups':
            if (ok) renderGroupsPanel(msg.groups);
            break;
        case 'create_group':
            if (ok) { addActionOk('ç¾¤èŠåˆ›å»ºæˆåŠŸ'); doAction('list_groups'); } else addActionFail(msg.msg);
            break;
        case 'invite_group':
            if (ok) addActionOk(msg.msg); else addActionFail(msg.msg);
            break;
        case 'leave_group':
            if (ok) { addActionOk(msg.msg); doAction('list_groups'); } else addActionFail(msg.msg);
            break;
        case 'group_msg':
            if (!ok) addActionFail(msg.msg);
            break;
        default:
            if (msg.msg) { if (ok) addActionOk(msg.msg); else addActionFail(msg.msg); }
    }
}

function doLogin() { var u = document.getElementById('loginUser').value.trim(), p = document.getElementById('loginPass').value; if (!u || !p) { showLoginMsg('è¯·è¾“å…¥æ˜µç§°å’Œå¯†ç ', false); return; } wsSend({ type: 'login', username: u, password: p }); }
function doRegister() { var u = document.getElementById('loginUser').value.trim(), p = document.getElementById('loginPass').value; if (!u || !p) { showLoginMsg('è¯·è¾“å…¥æ˜µç§°å’Œå¯†ç ', false); return; } wsSend({ type: 'register', username: u, password: p }); }
function doLogout() { username = null; farmId = null; currentWorld = null; playerData = null; clearTimers(); showPage('loginPage'); }
function showLoginMsg(t, ok) { var e = document.getElementById('loginMsg'); e.textContent = t; e.className = 'login-msg ' + (ok ? 'ok' : 'err'); }
function updLoginStatus(t, ok) { var e = document.getElementById('loginStatus'); if (e) { e.textContent = t; e.style.color = ok === true ? '#4ade80' : ok === false ? '#ef4444' : '#555'; } }

function showWorldsPage() { 
    console.log('showWorldsPage called, username:', username);
    document.getElementById('displayUser').textContent = username; 
    document.getElementById('displayFarmId').textContent = farmId || '???'; 
    console.log('about to call showPage with worldsPage');
    showPage('worldsPage'); 
    console.log('showPage returned, now calling wsSend');
    wsSend({ type: 'list_worlds' }); 
    console.log('wsSend called');
}

function showPage(id) { document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); }); document.getElementById(id).classList.add('active'); }
function showWorldsPage() { document.getElementById('displayUser').textContent = username; document.getElementById('displayFarmId').textContent = farmId || '???'; showPage('worldsPage'); wsSend({ type: 'list_worlds' }); }

function renderWorldList(list) {
    var c = document.getElementById('worldsList');
    if (!list || list.length === 0) { c.innerHTML = '<div class="no-worlds">æš‚æ— ä¸–ç•Œ<br><span style="font-size:12px;color:#555;">ç­‰å¾…å¤©é“åˆ›å»º...</span></div>'; return; }
    var h = '';
    for (var i = 0; i < list.length; i++) {
        var w = list[i];
        if (w.status !== 'active') continue;
        h += '<div class="world-card" data-wid="' + w.id + '" data-haspw="' + w.hasPassword + '" onclick="clickWorld(this)">';
        h += '<h3>ğŸŒ¾ ' + esc(w.name) + '</h3>';
        h += '<div class="world-info"><span>ğŸ‘¥ ' + (w.playerCount || 0) + 'äºº</span>';
        if (w.hasPassword) h += '<span>ğŸ”’ éœ€å¯†ç </span>';
        h += '</div>';
        h += '<div class="world-pw-input" id="wpw_' + w.id + '" onclick="event.stopPropagation()"><input type="password" placeholder="è¾“å…¥å¯†ç " id="wpwi_' + w.id + '"><button onclick="enterWorld(\'' + w.id + '\')">è¿›å…¥</button></div>';
        h += '</div>';
    }
    h += '<div style="padding:16px 0 8px;text-align:center;">';
    h += '<button style="padding:10px 24px;background:rgba(167,139,250,0.15);color:#c4b5fd;border:1px solid rgba(167,139,250,0.25);border-radius:10px;font-size:13px;cursor:pointer;" onclick="openFeedbackForm()">ğŸ“ æ„è§åé¦ˆ</button>';
    h += '</div>';
    h += '<div id="feedbackFormArea" style="display:none;padding:0 12px 12px;">';
    h += '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:14px;">';
    h += '<div style="font-size:13px;color:#c4b5fd;margin-bottom:8px;">ğŸ“ æ„è§åé¦ˆ</div>';
    h += '<textarea id="feedbackText" placeholder="å†™ä¸‹ä½ çš„å»ºè®®ã€bugåé¦ˆæˆ–æƒ³æ³•..." style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:10px;font-size:13px;color:#e0e0e0;outline:none;min-height:80px;resize:vertical;font-family:inherit;"></textarea>';
    h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">';
    h += '<span style="font-size:11px;color:#666;">æœ€å¤š500å­—</span>';
    h += '<button style="padding:8px 20px;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;" onclick="submitFeedback()">æäº¤åé¦ˆ</button>';
    h += '</div></div></div>';
    c.innerHTML = h;
}
function clickWorld(el) { var wid = el.getAttribute('data-wid'), hp = el.getAttribute('data-haspw') === 'true'; if (hp) { var d = document.getElementById('wpw_' + wid); d.style.display = d.style.display === 'block' ? 'none' : 'block'; } else enterWorld(wid); }
function enterWorld(wid) { var pi = document.getElementById('wpwi_' + wid); wsSend({ type: 'enter_world', worldId: wid, password: pi ? pi.value : '' }); }

function clearTimers() {
    if (window._farmRefreshTimer) { clearInterval(window._farmRefreshTimer); window._farmRefreshTimer = null; }
    if (window._localPlotTimer) { clearInterval(window._localPlotTimer); window._localPlotTimer = null; }
}

function enterGame(msg) {
    currentWorld = msg.world;
    playerData = msg.player;
    document.getElementById('gameWorldName').textContent = currentWorld.name;
    document.getElementById('farmIdDisplay').textContent = 'ID: ' + (playerData.farmId || '???');
    updSeason(currentWorld.season, currentWorld.weather);
    updStamina();
    updMoney();
    renderPlots();
    document.getElementById('msgArea').innerHTML = '';
    addSysMsg('æ¬¢è¿æ¥åˆ°ã€Œ' + currentWorld.name + 'ã€');
    if (currentWorld.announcements) {
        for (var i = 0; i < currentWorld.announcements.length; i++) addAnnounce(currentWorld.announcements[i].text);
    }
    showPage('gamePage');
    clearTimers();
    window._farmRefreshTimer = setInterval(function() {
        if (visitingOwner) {
            // â˜… ä¸²é—¨ä¸­ï¼šé‡æ–°æ‹‰å–å¥½å‹å†œåœºæ•°æ®
            doAction('visit_farm', { farmId: visitingFarmId });
        } else {
            doAction('my_farm');
        }
    }, 10000);
    window._localPlotTimer = setInterval(localUpdatePlots, 5000);
}

function localUpdatePlots() {
    if (visitingOwner) return;
    if (!playerData || !playerData.plots) return;
    var now = Date.now() + serverTimeOffset;
    var anyChange = false;
    playerData.plots.forEach(function(pl) {
        if (pl.plant && !pl.plant.mature) {
            var elapsed = now - pl.plant.plantedAt;
            var gt = pl.plant.effectiveGrowTime || pl.plant.growTime || 7200000;
            var newProg = Math.max(0, Math.min(1, elapsed / gt));
            if (Math.abs(newProg - (pl.plant.progress || 0)) > 0.005) {
                pl.plant.progress = newProg;
                if (newProg >= 1) pl.plant.mature = true;
                anyChange = true;
            }
        }
    });
    if (anyChange) renderPlots();
}

function updStamina() {
    if (!playerData) return;
    var pct = Math.round((playerData.stamina / (playerData.staminaMax || 100)) * 100);
    document.getElementById('staminaFill').style.width = pct + '%';
    document.getElementById('staminaVal').textContent = playerData.stamina + '/' + (playerData.staminaMax || 100);
}
function updMoney() { if (!playerData) return; document.getElementById('moneyTop').textContent = 'ğŸ’° ' + playerData.money; }
function updSeason(season, weather) {
    var sMap = { 'æ˜¥': 'ğŸŒ¸ æ˜¥', 'å¤': 'â˜€ï¸ å¤', 'ç§‹': 'ğŸ‚ ç§‹', 'å†¬': 'â„ï¸ å†¬' };
    var wMap = { 'æ™´': 'â˜€ï¸ æ™´', 'å¤šäº‘': 'â›… å¤šäº‘', 'é˜´': 'â˜ï¸ é˜´', 'å°é›¨': 'ğŸŒ¦ï¸ å°é›¨', 'å¤§é›¨': 'ğŸŒ§ï¸ å¤§é›¨', 'é›ª': 'ğŸŒ¨ï¸ é›ª', 'é›¾': 'ğŸŒ«ï¸ é›¾' };
    if (season) document.getElementById('gameSeason').textContent = sMap[season] || season;
    if (weather) document.getElementById('gameWeather').textContent = wMap[weather] || weather;
}
function refreshFarm() { updStamina(); updMoney(); renderPlots(); }

function renderPlots() {
    if (!playerData) return;
    var g = document.getElementById('plotsGrid');
    var h = '';
    for (var i = 0; i < playerData.plots.length; i++) {
        var pl = playerData.plots[i];
        if (pl.plant) {
            var progress = pl.plant.progress;
            if (progress === undefined || progress === null || isNaN(progress)) progress = 0;
            progress = Math.max(0, Math.min(1, progress));
            var mature = pl.plant.mature || progress >= 1;
            var pct = Math.floor(progress * 100);
            h += '<div class="plot' + (mature ? ' mature' : '') + '" onclick="clickPlot(' + i + ')">';
            h += '<span class="plot-icon">' + (mature ? (pl.plant.fruitIcon || 'ğŸ') : (pl.plant.icon || 'ğŸŒ±')) + '</span>';
            h += '<span class="plot-name">' + esc(pl.plant.name) + '</span>';
            if (mature) {
                h += '<span class="plot-progress" style="color:#fcd34d;">å¯æ”¶è·ï¼</span>';
            } else {
                h += '<span class="plot-progress">' + pct + '%</span>';
                h += '<div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + pct + '%"></div></div>';
            }
            var tags = [];
            if (pl.plant.watered) tags.push('ğŸ’§');
            if (pl.plant.fertilizerReduce > 0) tags.push('ğŸ§ª');
            if (tags.length > 0) h += '<span class="plot-progress" style="font-size:12px;">' + tags.join('') + '</span>';
            h += '</div>';
        } else {
            h += '<div class="plot empty" onclick="clickPlot(' + i + ')">';
            h += '<span class="plot-icon">â•</span>';
            h += '<span class="plot-name">ç©ºåœ°</span>';
            h += '</div>';
        }
    }
    g.innerHTML = h;
}

function doVisitWater(plotId) { doAction('water', { plotId: plotId }); }

function clickPlot(plotId) {
    if (!playerData) return;
    var pl = playerData.plots[plotId];
    var h = '';
    if (!pl.plant) {
        h += '<div style="text-align:center;margin-bottom:10px;font-size:13px;color:#aaa;">ç¬¬' + (plotId + 1) + 'å—åœ° Â· ç©ºåœ°</div>';
        if (!playerData.seeds || playerData.seeds.length === 0) {
            h += '<div style="text-align:center;color:#666;padding:20px;">æ²¡æœ‰ç§å­ï¼Œå»é‡å¤–é‡‡é›†æˆ–å•†åº—è´­ä¹°å§</div>';
        } else {
            h += '<div style="font-size:12px;color:#888;margin-bottom:8px;">é€‰æ‹©ç§å­ç§æ¤ï¼š</div>';
            for (var i = 0; i < playerData.seeds.length; i++) {
                var s = playerData.seeds[i];
                var growMin = Math.round(s.growTime / 60000);
                var growText = growMin >= 60 ? Math.round(growMin / 60 * 10) / 10 + 'å°æ—¶' : growMin + 'åˆ†é’Ÿ';
                h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;margin-bottom:6px;cursor:pointer;" onclick="doPlant(' + plotId + ',\'' + s.id + '\')">';
                h += '<span style="font-size:13px;">' + (s.icon || 'ğŸŒ±') + ' ' + esc(s.name) + ' <span style="color:#888;font-size:11px;">x' + s.count + '</span></span>';
                h += '<span style="font-size:11px;color:#888;">ç”Ÿé•¿: ' + growText + ' â†’ ' + (s.fruitIcon || 'ğŸ') + esc(s.fruitName) + '</span>';
                h += '</div>';
            }
        }
    } else {
        var progress = pl.plant.progress;
        if (progress === undefined || progress === null || isNaN(progress)) progress = 0;
        progress = Math.max(0, Math.min(1, progress));
        var mature = pl.plant.mature || progress >= 1;
        var pct = Math.floor(progress * 100);
        var gt = pl.plant.effectiveGrowTime || pl.plant.growTime || 7200000;
        var now = Date.now() + serverTimeOffset;
        var elapsed = now - pl.plant.plantedAt;
        var remainMs = Math.max(0, gt - elapsed);
        var remainMin = Math.ceil(remainMs / 60000);
        var remainText = remainMin >= 60 ? Math.floor(remainMin / 60) + 'æ—¶' + (remainMin % 60) + 'åˆ†' : remainMin + 'åˆ†é’Ÿ';
        h += '<div style="text-align:center;margin-bottom:12px;">';
        h += '<div style="font-size:36px;margin-bottom:6px;">' + (mature ? (pl.plant.fruitIcon || 'ğŸ') : (pl.plant.icon || 'ğŸŒ±')) + '</div>';
        h += '<div style="font-size:16px;color:#a5d6a7;">' + esc(pl.plant.name) + '</div>';
        h += '<div style="font-size:12px;color:#888;margin-top:4px;">ç¬¬' + (plotId + 1) + 'å—åœ°</div>';
        if (mature) {
            h += '<div style="font-size:14px;color:#fcd34d;margin-top:6px;">ğŸ‰ å·²æˆç†Ÿï¼</div>';
        } else {
            h += '<div style="font-size:13px;color:#aaa;margin-top:6px;">æˆé•¿è¿›åº¦: ' + pct + '%</div>';
            h += '<div style="width:80%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin:6px auto;overflow:hidden;"><div style="height:100%;width:' + pct + '%;background:#4caf50;border-radius:3px;"></div></div>';
            h += '<div style="font-size:11px;color:#888;">é¢„è®¡è¿˜éœ€: ' + remainText + '</div>';
        }
        var tags = [];
        if (pl.plant.watered) tags.push('ğŸ’§ å·²æµ‡æ°´');
        if (pl.plant.fertilizerReduce > 0) tags.push('ğŸ§ª å·²æ–½è‚¥');
        if (tags.length > 0) h += '<div style="font-size:11px;color:#666;margin-top:4px;">' + tags.join(' Â· ') + '</div>';
        h += '</div>';
        h += '<div style="display:flex;flex-direction:column;gap:6px;">';
        if (mature) {
            h += '<button style="padding:12px;background:#4caf50;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;" onclick="doHarvest(' + plotId + ')">ğŸŒ¾ æ”¶è·</button>';
        } else {
            if (!pl.plant.watered) {
                h += '<button style="padding:10px;background:rgba(59,130,246,0.2);color:#93c5fd;border:1px solid rgba(59,130,246,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doWater(' + plotId + ')">ğŸ’§ æµ‡æ°´ï¼ˆå…è´¹ï¼Œå‡å°‘ç”Ÿé•¿æ—¶é—´ï¼‰</button>';
            }
            var fertilizers = (playerData.items || []).filter(function(it) { return it.type === 'fertilizer'; });
            if (fertilizers.length > 0) {
                for (var fi = 0; fi < fertilizers.length; fi++) {
                    var f = fertilizers[fi];
                    h += '<button style="padding:10px;background:rgba(245,158,11,0.2);color:#fcd34d;border:1px solid rgba(245,158,11,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doFertilize(' + plotId + ',\'' + f.id + '\')">ğŸ§ª ' + esc(f.name) + ' (x' + f.count + ')</button>';
                }
            } else {
                h += '<div style="font-size:11px;color:#666;text-align:center;padding:6px;">æ²¡æœ‰è‚¥æ–™ï¼Œå¯ä»¥å»å•†åº—è´­ä¹°</div>';
            }
        }
        h += '</div>';
    }
    document.getElementById('plotActionContent').innerHTML = h;
    openPanel('panelPlotAction');
}

function doPlant(plotId, seedId) { doAction('plant', { plotId: plotId, seedId: seedId }); }
function doWater(plotId) { doAction('water', { plotId: plotId }); closePanel('panelPlotAction'); }
function doFertilize(plotId, itemId) { doAction('fertilize', { plotId: plotId, itemId: itemId }); }
function doHarvest(plotId) { doAction('harvest', { plotId: plotId }); }

function openWild() { doAction('wild_areas'); openPanel('panelWild'); }
function renderWildPanel(areas, stamina, staminaMax) {
    var h = '<div style="font-size:12px;color:#888;margin-bottom:10px;">âš¡ ä½“åŠ›: ' + stamina + '/' + staminaMax + 'ï¼ˆæ¯æ¬¡é‡‡é›†æ¶ˆè€—25ä½“åŠ›ï¼‰</div>';
    if (!areas || areas.length === 0) {
        h += '<div style="color:#666;text-align:center;padding:20px;">è¿™ä¸ªä¸–ç•Œæ²¡æœ‰é‡å¤–åŒºåŸŸ</div>';
    } else {
        for (var i = 0; i < areas.length; i++) {
            var a = areas[i];
            h += '<div class="wild-area-card" onclick="doGather(' + i + ')">';
            h += '<div class="wa-name">' + (a.icon || 'ğŸŒ¿') + ' ' + esc(a.name) + '</div>';
            h += '<div class="wa-desc">' + esc(a.desc || '') + '</div>';
            if (a.seedNames && a.seedNames.length > 0) h += '<div class="wa-seeds">å¯èƒ½æ‰¾åˆ°: ' + a.seedNames.join('ã€') + '</div>';
            h += '</div>';
        }
    }
    h += '<div style="margin-top:10px;"><button style="width:100%;padding:10px;background:rgba(6,182,212,0.2);color:#67e8f9;border:1px solid rgba(6,182,212,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doRest()">ğŸ’¤ ä¼‘æ¯ï¼ˆæ¢å¤8ä½“åŠ›ï¼ŒCD 10åˆ†é’Ÿï¼‰</button></div>';
    document.getElementById('wildContent').innerHTML = h;
}
function doGather(areaIndex) { doAction('gather', { areaIndex: areaIndex }); }
function doRest() { doAction('rest'); }

function openVisit() {
    var h = '<div style="margin-bottom:12px;">';
    h += '<div style="font-size:12px;color:#888;margin-bottom:6px;">è¾“å…¥å¯¹æ–¹çš„é¢†åœ°IDå»ä¸²é—¨ï¼š</div>';
    h += '<div style="display:flex;gap:6px;"><input type="text" id="visitFarmIdInput" placeholder="6ä½é¢†åœ°ID" maxlength="6" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:9px 12px;font-size:14px;color:#e0e0e0;outline:none;text-transform:uppercase;font-family:monospace;letter-spacing:2px;">';
    h += '<button style="padding:9px 16px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;" onclick="doVisit()">å»ä¸²é—¨</button></div>';
    h += '</div>';
    if (visitingOwner) {
        h += '<div style="background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.2);border-radius:10px;padding:10px;margin-bottom:10px;font-size:12px;color:#a5d6a7;">å½“å‰åœ¨ ' + esc(visitingOwner) + ' çš„å†œåœºï¼ˆ' + visitingFarmId + 'ï¼‰</div>';
        h += '<button style="width:100%;padding:10px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid rgba(239,68,68,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doGoHome()">ğŸ¡ å›è‡ªå·±å†œåœº</button>';
    }
    h += '<div id="visitFarmView"></div>';
    document.getElementById('visitContent').innerHTML = h;
    openPanel('panelVisit');
}
function doVisit() { var fid = document.getElementById('visitFarmIdInput').value.trim().toUpperCase(); if (!fid) return; doAction('visit_farm', { farmId: fid }); }
function doGoHome() { doAction('go_home'); }
function renderVisitFarm(owner, fid, plots, visitors) {
    visitingOwner = owner; visitingFarmId = fid;
    var h = '<div class="visit-farm-view">';
    h += '<div style="font-size:15px;color:#a5d6a7;margin-bottom:4px;">ğŸ¡ ' + esc(owner) + ' çš„å†œåœº</div>';
    h += '<div style="font-size:11px;color:#666;margin-bottom:8px;">é¢†åœ°ID: ' + fid + '</div>';
    if (visitors && visitors.length > 0) h += '<div style="font-size:11px;color:#888;margin-bottom:8px;">ä¹Ÿåœ¨è¿™é‡Œ: ' + visitors.map(function(v) { return esc(v); }).join(', ') + '</div>';
    h += '<div class="visit-plots-grid">';
    for (var i = 0; i < plots.length; i++) {
        var pl = plots[i];
        var canWater = pl.plant && !pl.plant.mature && !pl.plant.watered;
        h += '<div class="visit-plot' + (canWater ? ' clickable-visit' : '') + '"' + (canWater ? ' onclick="doVisitWater(' + i + ')" style="cursor:pointer;"' : '') + '>';
        if (pl.plant) {
            var prog = pl.plant.progress;
            if (prog === undefined || prog === null || isNaN(prog)) prog = 0;
            prog = Math.max(0, Math.min(1, prog));
            var isMature = pl.plant.mature || prog >= 1;
            h += '<span class="vp-icon">' + (isMature ? (pl.plant.fruitIcon || 'ğŸ') : (pl.plant.icon || 'ğŸŒ±')) + '</span>';
            h += '<span class="vp-name">' + esc(pl.plant.name) + '</span>';
            if (isMature) h += '<span class="vp-status" style="color:#fcd34d;">å·²æˆç†Ÿ</span>';
            else {
                h += '<span class="vp-status">' + Math.floor(prog * 100) + '%</span>';
                if (pl.plant.watered) h += '<span class="vp-status" style="color:#67e8f9;">ğŸ’§å·²æµ‡æ°´</span>';
                else h += '<span class="vp-status" style="color:#93c5fd;">ğŸ’§ç‚¹å‡»æµ‡æ°´</span>';
            }
        } else {
            h += '<span class="vp-icon" style="opacity:0.3;">ğŸŸ«</span>';
            h += '<span class="vp-name" style="color:#666;">ç©ºåœ°</span>';
        }
        h += '</div>';
    }
    h += '</div>';
    h += '<button style="width:100%;margin-top:10px;padding:10px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid rgba(239,68,68,0.3);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doGoHome()">ğŸ¡ å›è‡ªå·±å†œåœº</button>';
    h += '</div>';
    var vfv = document.getElementById('visitFarmView');
    if (vfv) vfv.innerHTML = h;
    else document.getElementById('visitContent').innerHTML += h;

// â˜… åœ¨ä¸»ç•Œé¢å†œåœºåŒºåŸŸæ˜¾ç¤ºä¸²é—¨è§†å›¾
    var farmArea = document.getElementById('farmArea');
    var farmTitle = document.querySelector('.farm-title');
    if (farmTitle) {
        farmTitle.innerHTML = '<span>ğŸ  ' + esc(owner) + ' çš„å†œåœº</span><span class="farm-id">ID: ' + fid + '</span>';
    }
    var plotsGrid = document.getElementById('plotsGrid');
    var visitHtml = '';
    for (var vi = 0; vi < plots.length; vi++) {
        var vpl = plots[vi];
        var vCanWater = vpl.plant && !vpl.plant.mature && !vpl.plant.watered;
        visitHtml += '<div class="plot' + (vpl.plant && (vpl.plant.mature || (vpl.plant.progress || 0) >= 1) ? ' mature' : '') + (vCanWater ? '' : ' empty') + '"' + (vCanWater ? ' onclick="doVisitWater(' + vi + ')" style="cursor:pointer;"' : '') + '>';
        if (vpl.plant) {
            var vProg = vpl.plant.progress || 0;
            vProg = Math.max(0, Math.min(1, vProg));
            var vMature = vpl.plant.mature || vProg >= 1;
            visitHtml += '<span class="plot-icon">' + (vMature ? (vpl.plant.fruitIcon || 'ğŸ') : (vpl.plant.icon || 'ğŸŒ±')) + '</span>';
            visitHtml += '<span class="plot-name">' + esc(vpl.plant.name) + '</span>';
            if (vMature) visitHtml += '<span class="plot-progress" style="color:#fcd34d;">å·²æˆç†Ÿ</span>';
            else {
                visitHtml += '<span class="plot-progress">' + Math.floor(vProg * 100) + '%</span>';
                visitHtml += '<div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + Math.floor(vProg * 100) + '%"></div></div>';
                if (vpl.plant.watered) visitHtml += '<span class="plot-progress">ğŸ’§å·²æµ‡æ°´</span>';
                else visitHtml += '<span class="plot-progress" style="color:#93c5fd;">ğŸ’§ç‚¹å‡»æµ‡æ°´</span>';
            }
        } else {
            visitHtml += '<span class="plot-icon" style="opacity:0.3;">ğŸŸ«</span>';
            visitHtml += '<span class="plot-name" style="color:#666;">ç©ºåœ°</span>';
        }
        visitHtml += '</div>';
    }
    plotsGrid.innerHTML = visitHtml;

    // â˜… æ˜¾ç¤ºä¸²é—¨çŠ¶æ€æ¡
    var existingBar = document.getElementById('visitStatusBar');
    if (existingBar) existingBar.remove();
    var bar = document.createElement('div');
    bar.id = 'visitStatusBar';
    bar.style.cssText = 'padding:8px 12px;background:rgba(76,175,80,0.1);border-bottom:1px solid rgba(76,175,80,0.2);font-size:12px;color:#a5d6a7;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;';
    bar.innerHTML = 'ğŸ  æ­£åœ¨å‚è§‚ <b>' + esc(owner) + '</b> çš„å†œåœºï¼ˆ' + fid + 'ï¼‰<button style="padding:4px 12px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid rgba(239,68,68,0.3);border-radius:6px;font-size:11px;cursor:pointer;" onclick="doGoHome()">ğŸ¡ å›å®¶</button>';
    farmArea.parentNode.insertBefore(bar, farmArea);
}
function updateVisitPlots(plots) {
    // â˜… åªæ›´æ–°ä¸»ç•Œé¢çš„åœ°å—æ ¼å­ï¼Œä¸é‡å»ºçŠ¶æ€æ¡
    var plotsGrid = document.getElementById('plotsGrid');
    if (!plotsGrid) return;
    var visitHtml = '';
    for (var vi = 0; vi < plots.length; vi++) {
        var vpl = plots[vi];
        var vCanWater = vpl.plant && !vpl.plant.mature && !vpl.plant.watered;
        visitHtml += '<div class="plot' + (vpl.plant && (vpl.plant.mature || (vpl.plant.progress || 0) >= 1) ? ' mature' : '') + (vCanWater ? '' : ' empty') + '"' + (vCanWater ? ' onclick="doVisitWater(' + vi + ')" style="cursor:pointer;"' : '') + '>';
        if (vpl.plant) {
            var vProg = vpl.plant.progress || 0;
            vProg = Math.max(0, Math.min(1, vProg));
            var vMature = vpl.plant.mature || vProg >= 1;
            visitHtml += '<span class="plot-icon">' + (vMature ? (vpl.plant.fruitIcon || 'ğŸ') : (vpl.plant.icon || 'ğŸŒ±')) + '</span>';
            visitHtml += '<span class="plot-name">' + esc(vpl.plant.name) + '</span>';
            if (vMature) visitHtml += '<span class="plot-progress" style="color:#fcd34d;">å·²æˆç†Ÿ</span>';
            else {
                visitHtml += '<span class="plot-progress">' + Math.floor(vProg * 100) + '%</span>';
                visitHtml += '<div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + Math.floor(vProg * 100) + '%"></div></div>';
                if (vpl.plant.watered) visitHtml += '<span class="plot-progress">ğŸ’§å·²æµ‡æ°´</span>';
                else visitHtml += '<span class="plot-progress" style="color:#93c5fd;">ğŸ’§ç‚¹å‡»æµ‡æ°´</span>';
            }
        } else {
            visitHtml += '<span class="plot-icon" style="opacity:0.3;">ğŸŸ«</span>';
            visitHtml += '<span class="plot-name" style="color:#666;">ç©ºåœ°</span>';
        }
        visitHtml += '</div>';
    }
    plotsGrid.innerHTML = visitHtml;

    // â˜… åŒæ—¶æ›´æ–°ä¸²é—¨é¢æ¿é‡Œçš„åœ°å—ï¼ˆå¦‚æœé¢æ¿å¼€ç€çš„è¯ï¼‰
    var vfv = document.getElementById('visitFarmView');
    if (vfv) {
        var vpGrid = vfv.querySelector('.visit-plots-grid');
        if (vpGrid) {
            var panelHtml = '';
            for (var i = 0; i < plots.length; i++) {
                var pl = plots[i];
                var canWater = pl.plant && !pl.plant.mature && !pl.plant.watered;
                panelHtml += '<div class="visit-plot"' + (canWater ? ' onclick="doVisitWater(' + i + ')" style="cursor:pointer;"' : '') + '>';
                if (pl.plant) {
                    var prog = pl.plant.progress || 0;
                    prog = Math.max(0, Math.min(1, prog));
                    var isMature = pl.plant.mature || prog >= 1;
                    panelHtml += '<span class="vp-icon">' + (isMature ? (pl.plant.fruitIcon || 'ğŸ') : (pl.plant.icon || 'ğŸŒ±')) + '</span>';
                    panelHtml += '<span class="vp-name">' + esc(pl.plant.name) + '</span>';
                    if (isMature) panelHtml += '<span class="vp-status" style="color:#fcd34d;">å·²æˆç†Ÿ</span>';
                    else {
                        panelHtml += '<span class="vp-status">' + Math.floor(prog * 100) + '%</span>';
                        if (pl.plant.watered) panelHtml += '<span class="vp-status" style="color:#67e8f9;">ğŸ’§å·²æµ‡æ°´</span>';
                        else panelHtml += '<span class="vp-status" style="color:#93c5fd;">ğŸ’§ç‚¹å‡»æµ‡æ°´</span>';
                    }
                } else {
                    panelHtml += '<span class="vp-icon" style="opacity:0.3;">ğŸŸ«</span>';
                    panelHtml += '<span class="vp-name" style="color:#666;">ç©ºåœ°</span>';
                }
                panelHtml += '</div>';
            }
            vpGrid.innerHTML = panelHtml;
        }
    }
}

function openInventory() { doAction('inventory'); openPanel('panelInv'); }
function renderInventoryPanel(seeds, fruits, items, money) {
    var h = '<div style="font-size:13px;color:#fcd34d;margin-bottom:10px;">ğŸ’° é‡‘å¸: ' + money + '</div>';
    h += '<div class="inv-section"><div class="inv-section-title">ğŸŒ± ç§å­</div><div class="inv-grid">';
    if (seeds && seeds.length > 0) {
        for (var i = 0; i < seeds.length; i++) {
            var s = seeds[i];
            h += '<div class="inv-item" title="' + esc(s.name) + '"><span class="ii-icon">' + (s.icon || 'ğŸŒ±') + '</span><span class="ii-name">' + esc(s.name) + '</span><span class="ii-count">x' + s.count + '</span></div>';
        }
    } else { h += '<div class="inv-empty">æ²¡æœ‰ç§å­</div>'; }
    h += '</div></div>';
    h += '<div class="inv-section"><div class="inv-section-title">ğŸ æœå®</div><div class="inv-grid">';
    if (fruits && fruits.length > 0) {
        for (var j = 0; j < fruits.length; j++) {
            var f = fruits[j];
            h += '<div class="inv-item" title="' + esc(f.name) + ' ä»·å€¼' + f.value + '"><span class="ii-icon">' + (f.icon || 'ğŸ') + '</span><span class="ii-name">' + esc(f.name) + '</span><span class="ii-count">x' + f.count + ' (ğŸ’°' + f.value + ')</span></div>';
        }
    } else { h += '<div class="inv-empty">æ²¡æœ‰æœå®</div>'; }
    h += '</div></div>';
    h += '<div class="inv-section"><div class="inv-section-title">ğŸ§° é“å…·</div><div class="inv-grid">';
    if (items && items.length > 0) {
        for (var k = 0; k < items.length; k++) {
            var it = items[k];
            h += '<div class="inv-item" title="' + esc(it.desc || '') + '"><span class="ii-icon">ğŸ§ª</span><span class="ii-name">' + esc(it.name) + '</span><span class="ii-count">x' + it.count + '</span></div>';
        }
    } else { h += '<div class="inv-empty">æ²¡æœ‰é“å…·</div>'; }
    h += '</div></div>';
    document.getElementById('invContent').innerHTML = h;
}

function openShop() { doAction('shop_list'); openPanel('panelShop'); }
function renderShopPanel(shop, money) {
    var h = '<div style="font-size:13px;color:#fcd34d;margin-bottom:10px;">ğŸ’° ä½ çš„é‡‘å¸: ' + money + '</div>';
    if (!shop || !shop.items || shop.items.length === 0) {
        h += '<div style="color:#666;text-align:center;padding:20px;">å•†åº—ç©ºç©ºå¦‚ä¹Ÿ</div>';
        document.getElementById('shopContent').innerHTML = h;
        return;
    }
    
    // â˜… è·å–ç©å®¶å½“å‰æ°´å£¶ç­‰çº§
    var currentWaterLevel = (playerData && playerData.waterBoostLevel) ? playerData.waterBoostLevel : 0;
    
    var seeds = shop.items.filter(function(it) { return it.type === 'seed'; });
    var fertilizers = shop.items.filter(function(it) { return it.type === 'fertilizer'; });
    
    // â˜… åˆ†ç¦»æ°´å£¶å’Œå…¶ä»–å·¥å…·
    var waterTools = shop.items.filter(function(it) { 
        if (it.id.startsWith('watering_can_lv')) {
            var level = parseInt(it.id.replace('watering_can_lv', '')) || 0;
            return level > currentWaterLevel && level <= 5;
        }
        return false;
    });
    
    var otherTools = shop.items.filter(function(it) { 
        return it.type === 'tool' && !it.id.startsWith('watering_can_lv');
    });
    
    if (seeds.length > 0) {
        h += '<div style="font-size:12px;color:#a5d6a7;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">ğŸŒ± ç§å­(ä¸€ç§å¤šæ”¶)</div>';
        for (var i = 0; i < seeds.length; i++) {
            var s = seeds[i];
            var sd = s.seedData || {};
            var growMin = Math.round((sd.growTime || 0) / 60000);
            var growText = growMin >= 60 ? Math.round(growMin / 60 * 10) / 10 + 'å°æ—¶' : growMin + 'åˆ†é’Ÿ';
            h += '<div class="shop-item">';
            h += '<div class="si-info"><div class="si-name">' + (s.icon || sd.icon || 'ğŸŒ±') + ' ' + esc(s.name) + '</div>';
            h += '<div class="si-desc">' + esc(s.desc) + '</div>';
            h += '<div style="font-size:10px;color:#888;margin-top:2px;">ç”Ÿé•¿' + growText + ' â†’ ' + (sd.fruitIcon || 'ğŸ') + esc(sd.fruitName || '') + ' (å”®ğŸ’°' + (sd.fruitValue || '?') + ')</div></div>';
            h += '<span class="si-price">ğŸ’°' + s.price + '</span>';
            h += '<div style="display:flex;flex-direction:column;gap:3px;">';
            h += '<button onclick="doBuy(\'' + s.id + '\',1)">ä¹°1</button>';
            h += '<button onclick="doBuy(\'' + s.id + '\',5)" style="background:#388e3c;">ä¹°5</button>';
            h += '</div></div>';
        }
    }
    if (fertilizers.length > 0) {
        h += '<div style="font-size:12px;color:#fcd34d;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">ğŸ§ª è‚¥æ–™</div>';
        for (var j = 0; j < fertilizers.length; j++) {
            var f = fertilizers[j];
            h += '<div class="shop-item"><div class="si-info"><div class="si-name">ğŸ§ª ' + esc(f.name) + '</div><div class="si-desc">' + esc(f.desc || '') + '</div></div>';
            h += '<span class="si-price">ğŸ’°' + f.price + '</span><button onclick="doBuy(\'' + f.id + '\',1)">è´­ä¹°</button></div>';
        }
    }
    
    // â˜… æ˜¾ç¤ºå…¶ä»–å·¥å…·ï¼ˆå¼€å¦ä»¤ç­‰ï¼‰
    if (otherTools.length > 0) {
        h += '<div style="font-size:12px;color:#67e8f9;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">ğŸ”¨ å·¥å…·</div>';
        for (var k = 0; k < otherTools.length; k++) {
            var t = otherTools[k];
            h += '<div class="shop-item"><div class="si-info"><div class="si-name">ğŸ”¨ ' + esc(t.name) + '</div><div class="si-desc">' + esc(t.desc || '') + '</div></div>';
            h += '<span class="si-price">ğŸ’°' + t.price + '</span><button onclick="doBuy(\'' + t.id + '\',1)">è´­ä¹°</button></div>';
        }
    }
    
    // â˜… æ˜¾ç¤ºæ°´å£¶å‡çº§
    if (waterTools.length > 0) {
        h += '<div style="font-size:12px;color:#67e8f9;margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:4px;">ğŸ’§ æ°´å£¶å‡çº§</div>';
        for (var m = 0; m < waterTools.length; m++) {
            var w = waterTools[m];
            var level = parseInt(w.id.replace('watering_can_lv', '')) || 0;
            h += '<div class="shop-item"><div class="si-info"><div class="si-name">ğŸ’§ ' + esc(w.name) + '</div><div class="si-desc">' + esc(w.desc || '') + '</div></div>';
            h += '<span class="si-price">ğŸ’°' + w.price + '</span><button onclick="doBuy(\'' + w.id + '\',1)">å‡çº§</button></div>';
        }
        if (currentWaterLevel >= 5) {
            h += '<div style="text-align:center;padding:10px;font-size:12px;color:#fcd34d;background:rgba(252,211,77,0.1);border-radius:8px;margin-top:6px;">ğŸ† ä½ å·²æ‹¥æœ‰æœ€é«˜ç­‰çº§çš„ä¼ è¯´æ°´å£¶ï¼</div>';
        }
    }
    
    document.getElementById('shopContent').innerHTML = h;
}

function doBuy(itemId, count) { 
    doAction('shop_buy', { itemId: itemId, count: count || 1 }); 
}

function openSell() {
    window._pendingSellRender = true;
    doAction('inventory');
    openPanel('panelSell');
}
function renderSellPanel() {
    if (!playerData) return;
    var h = '<div style="font-size:13px;color:#fcd34d;margin-bottom:10px;">ğŸ’° å½“å‰é‡‘å¸: ' + playerData.money + '</div>';
    if (!playerData.fruits || playerData.fruits.length === 0) {
        h += '<div style="color:#666;text-align:center;padding:20px;">æ²¡æœ‰å¯å–çš„æœå®</div>';
    } else {
        for (var i = 0; i < playerData.fruits.length; i++) {
            var f = playerData.fruits[i];
            h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (f.icon || 'ğŸ') + ' ' + esc(f.name) + '</div><div class="sl-detail">æ•°é‡: ' + f.count + ' Â· å•ä»·: ğŸ’°' + f.value + '</div></div>';
            h += '<div style="display:flex;gap:4px;">';
            h += '<button onclick="doSell(\'' + f.id + '\',1)">å–1ä¸ª</button>';
            if (f.count >= 5) h += '<button onclick="doSell(\'' + f.id + '\',5)">å–5ä¸ª</button>';
            if (f.count >= 10) h += '<button onclick="doSell(\'' + f.id + '\',' + f.count + ')">å…¨å–</button>';
            h += '</div></div>';
        }
    }
    document.getElementById('sellContent').innerHTML = h;
}
function doSell(fruitId, count) { doAction('sell_fruit', { fruitId: fruitId, count: count }); }

function openTrade() {
    var h = '<div style="margin-bottom:14px;">';
    h += '<button style="width:100%;padding:10px;background:rgba(251,191,36,0.2);color:#fcd34d;border:1px solid rgba(251,191,36,0.3);border-radius:10px;font-size:13px;cursor:pointer;margin-bottom:8px;" onclick="showTradeForm()">ğŸ“ å‘èµ·æ–°äº¤æ˜“</button>';
    h += '<button style="width:100%;padding:10px;background:rgba(255,255,255,0.05);color:#aaa;border:1px solid rgba(255,255,255,0.1);border-radius:10px;font-size:13px;cursor:pointer;" onclick="doAction(\'trade_list\')">ğŸ“‹ æŸ¥çœ‹äº¤æ˜“åˆ—è¡¨</button>';
    h += '</div><div id="tradeFormArea"></div><div id="tradeListArea"></div>';
    document.getElementById('tradeContent').innerHTML = h;
    openPanel('panelTrade');
    doAction('trade_list');
}

function showTradeForm() {
    if (!playerData) return;
    var h = '<div class="trade-form">';
    h += '<label>äº¤æ˜“å¯¹è±¡ï¼ˆæ˜µç§°ï¼‰</label><input type="text" id="tradeTo" placeholder="è¾“å…¥å¯¹æ–¹æ˜µç§°">';
    h += '<label>æˆ‘è¦ç»™å‡º</label><select id="tradeOfferType" onchange="updTradeOfferItems()"><option value="seed">ç§å­</option><option value="fruit">æœå®</option><option value="money">é‡‘å¸</option></select>';
    h += '<div id="tradeOfferIdWrap"><select id="tradeOfferId"></select></div>';
    h += '<label id="tradeOfferCountLabel">ç»™å‡ºæ•°é‡</label><input type="number" id="tradeOfferCount" value="1" min="1">';
    h += '<div id="tradeOfferMoneyInfo" style="display:none;font-size:11px;color:#fcd34d;"></div>';
    h += '<label>æˆ‘æƒ³è¦ï¼ˆç±»å‹ï¼‰</label><select id="tradeWantType" onchange="updTradeWantFields()"><option value="seed">ç§å­</option><option value="fruit">æœå®</option><option value="money">é‡‘å¸</option><option value="any">ä¸éœ€è¦å›æŠ¥ï¼ˆèµ é€ï¼‰</option></select>';
    h += '<div id="tradeWantDetailWrap">';
    h += '<label>æƒ³è¦çš„ç‰©å“åç§°</label><input type="text" id="tradeWantName" placeholder="è¾“å…¥ç‰©å“åç§°">';
    h += '<label>æƒ³è¦æ•°é‡</label><input type="number" id="tradeWantCount" value="1" min="1">';
    h += '</div>';
    h += '<button onclick="submitTrade()">ğŸ¤ å‘èµ·äº¤æ˜“</button></div>';
    document.getElementById('tradeFormArea').innerHTML = h;
    updTradeOfferItems();
}

function updTradeOfferItems() {
    var type = document.getElementById('tradeOfferType').value;
    var selWrap = document.getElementById('tradeOfferIdWrap');
    var moneyInfo = document.getElementById('tradeOfferMoneyInfo');
    var countLabel = document.getElementById('tradeOfferCountLabel');
    if (type === 'money') {
        selWrap.style.display = 'none';
        moneyInfo.style.display = 'block';
        moneyInfo.textContent = 'ğŸ’° å½“å‰é‡‘å¸: ' + playerData.money;
        countLabel.textContent = 'ç»™å‡ºé‡‘å¸æ•°é‡';
    } else {
        selWrap.style.display = '';
        moneyInfo.style.display = 'none';
        countLabel.textContent = 'ç»™å‡ºæ•°é‡';
        var sel = document.getElementById('tradeOfferId');
        sel.innerHTML = '';
        var arr = type === 'seed' ? (playerData.seeds || []) : (playerData.fruits || []);
        for (var i = 0; i < arr.length; i++) {
            var opt = document.createElement('option');
            opt.value = arr[i].id;
            opt.textContent = arr[i].name + ' (x' + arr[i].count + ')';
            sel.appendChild(opt);
        }
        if (arr.length === 0) { var o = document.createElement('option'); o.textContent = 'æ²¡æœ‰ç‰©å“'; o.value = ''; sel.appendChild(o); }
    }
}

function updTradeWantFields() {
    var type = document.getElementById('tradeWantType').value;
    var wrap = document.getElementById('tradeWantDetailWrap');
    if (type === 'any') {
        wrap.style.display = 'none';
    } else if (type === 'money') {
        wrap.innerHTML = '<label>æƒ³è¦é‡‘å¸æ•°é‡</label><input type="number" id="tradeWantCount" value="1" min="1">';
        wrap.style.display = '';
    } else {
        wrap.innerHTML = '<label>æƒ³è¦çš„ç‰©å“åç§°</label><input type="text" id="tradeWantName" placeholder="è¾“å…¥ç‰©å“åç§°"><label>æƒ³è¦æ•°é‡</label><input type="number" id="tradeWantCount" value="1" min="1">';
        wrap.style.display = '';
    }
}

function submitTrade() {
    var to = (document.getElementById('tradeTo').value || '').trim();
    if (!to) { addActionFail('è¯·è¾“å…¥äº¤æ˜“å¯¹è±¡'); return; }
    var offerType = document.getElementById('tradeOfferType').value;
    var offerId = offerType === 'money' ? 'money' : (document.getElementById('tradeOfferId').value || '');
    if (offerType !== 'money' && !offerId) { addActionFail('è¯·é€‰æ‹©è¦ç»™å‡ºçš„ç‰©å“'); return; }
    var offerCount = parseInt(document.getElementById('tradeOfferCount').value) || 1;
    var wantType = document.getElementById('tradeWantType').value;
    var wantNameEl = document.getElementById('tradeWantName');
    var wantCountEl = document.getElementById('tradeWantCount');
    var wantName = wantType === 'money' ? 'é‡‘å¸' : (wantType === 'any' ? 'æ— ï¼ˆèµ é€ï¼‰' : (wantNameEl ? wantNameEl.value.trim() : ''));
    var wantCount = wantCountEl ? (parseInt(wantCountEl.value) || 1) : 1;
    if (wantType !== 'any' && wantType !== 'money' && !wantName) { addActionFail('è¯·è¾“å…¥æƒ³è¦çš„ç‰©å“åç§°'); return; }
    doAction('trade_create', {
        to: to,
        offerType: offerType,
        offerId: offerId,
        offerCount: offerCount,
        wantType: wantType,
        wantId: wantType === 'money' ? 'money' : (wantName || ''),
        wantName: wantName || 'ä»»æ„',
        wantCount: wantCount
    });
}

function renderTradeList(trades) {
    var el = document.getElementById('tradeListArea');
    if (!el) return;
    if (!trades || trades.length === 0) { el.innerHTML = '<div style="color:#666;text-align:center;padding:10px;font-size:12px;">æ²¡æœ‰å¾…å¤„ç†çš„äº¤æ˜“</div>'; return; }
    var h = '<div style="font-size:12px;color:#888;margin-bottom:6px;">å¾…å¤„ç†äº¤æ˜“ï¼š</div>';
    for (var i = 0; i < trades.length; i++) {
        var t = trades[i];
        var isFrom = t.from === username;
        var offerText = t.offerType === 'money' ? 'ğŸ’°' + t.offerCount + 'é‡‘å¸' : esc(t.offerName) + ' x' + t.offerCount;
        var wantText = t.wantType === 'any' ? 'æ— ï¼ˆèµ é€ï¼‰' : (t.wantType === 'money' ? 'ğŸ’°' + t.wantCount + 'é‡‘å¸' : esc(t.wantName) + ' x' + t.wantCount);
        h += '<div class="msg-trade" style="margin-bottom:6px;">';
        h += '<div>' + (isFrom ? 'ä½ ' : esc(t.from)) + ' æƒ³ç”¨ <b>' + offerText + '</b> æ¢ ' + (isFrom ? esc(t.to) : 'ä½ ') + ' çš„ <b>' + wantText + '</b></div>';
        h += '<div class="trade-btns">';
        if (!isFrom) {
            h += '<button class="t-accept" onclick="doAction(\'trade_accept\',{tradeId:\'' + t.id + '\'})">æ¥å—</button>';
            h += '<button class="t-reject" onclick="doAction(\'trade_reject\',{tradeId:\'' + t.id + '\'})">æ‹’ç»</button>';
        } else {
            h += '<button class="t-reject" onclick="doAction(\'trade_cancel\',{tradeId:\'' + t.id + '\'})">å–æ¶ˆ</button>';
        }
        h += '</div></div>';
    }
    el.innerHTML = h;
}

function showTradeIncoming(trade) {
    var offerText = trade.offerType === 'money' ? 'ğŸ’°' + trade.offerCount + 'é‡‘å¸' : esc(trade.offerName) + ' x' + trade.offerCount;
    var wantText = trade.wantType === 'any' ? 'æ— ï¼ˆèµ é€ï¼‰' : (trade.wantType === 'money' ? 'ğŸ’°' + trade.wantCount + 'é‡‘å¸' : esc(trade.wantName) + ' x' + trade.wantCount);
    var h = '<div class="msg-trade">';
    h += '<div>ğŸ“¦ ' + esc(trade.from) + ' æƒ³ç”¨ <b>' + offerText + '</b> æ¢ä½ çš„ <b>' + wantText + '</b></div>';
    h += '<div class="trade-btns">';
    h += '<button class="t-accept" onclick="doAction(\'trade_accept\',{tradeId:\'' + trade.id + '\'})">æ¥å—</button>';
    h += '<button class="t-reject" onclick="doAction(\'trade_reject\',{tradeId:\'' + trade.id + '\'})">æ‹’ç»</button>';
    h += '</div></div>';
    var div = document.createElement('div');
    div.className = 'msg-item';
    div.innerHTML = h;
    appendMsg(div);
}

function openFriends() { doAction('friend_list'); openPanel('panelFriends'); }
function renderFriendsPanel(friends, requests) {
    var h = '';
    h += '<div style="display:flex;gap:6px;margin-bottom:12px;">';
    h += '<input type="text" id="addFriendInput" placeholder="è¾“å…¥æ˜µç§°" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px 12px;font-size:13px;color:#e0e0e0;outline:none;">';
    h += '<button style="padding:8px 14px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;" onclick="doAddFriend()">æ·»åŠ </button></div>';
    h += '<button style="width:100%;padding:8px;background:rgba(103,232,249,0.1);color:#67e8f9;border:1px solid rgba(103,232,249,0.2);border-radius:8px;font-size:12px;cursor:pointer;margin-bottom:12px;" onclick="openGroups()">ğŸ’¬ ç¾¤èŠç®¡ç†</button>';
    if (requests && requests.length > 0) {
        h += '<div style="font-size:12px;color:#c4b5fd;margin-bottom:6px;">å¥½å‹è¯·æ±‚ï¼š</div>';
        for (var r = 0; r < requests.length; r++) {
            h += '<div class="friend-req"><span>' + esc(requests[r]) + ' è¯·æ±‚åŠ ä½ ä¸ºå¥½å‹</span>';
            h += '<span style="display:flex;gap:4px;">';
            h += '<button style="padding:3px 10px;background:#4caf50;color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doAction(\'friend_accept\',{from:\'' + esc(requests[r]) + '\'})">æ¥å—</button>';
            h += '<button style="padding:3px 10px;background:#ef4444;color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doAction(\'friend_reject\',{from:\'' + esc(requests[r]) + '\'})">æ‹’ç»</button>';
            h += '</span></div>';
        }
    }
    h += '<div style="font-size:12px;color:#888;margin-bottom:6px;">å¥½å‹åˆ—è¡¨ï¼š</div>';
    if (!friends || friends.length === 0) {
        h += '<div style="color:#666;text-align:center;padding:20px;font-size:12px;">è¿˜æ²¡æœ‰å¥½å‹</div>';
    } else {
        for (var i = 0; i < friends.length; i++) {
            var f = friends[i];
            h += '<div class="friend-item"><span><span class="fi-name">' + (f.online ? 'ğŸŸ¢' : 'âš«') + ' ' + esc(f.username) + '</span><span class="fi-id">' + f.farmId + '</span></span>';
            h += '<div class="fi-btns">';
            h += '<button style="background:rgba(76,175,80,0.2);color:#a5d6a7;" onclick="doVisitFriend(\'' + f.farmId + '\')">ä¸²é—¨</button>';
            h += '<button style="background:rgba(167,139,250,0.2);color:#c4b5fd;" onclick="doPrivateMsg(\'' + esc(f.username) + '\')">ç§èŠ</button>';
            h += '<button style="background:rgba(239,68,68,0.2);color:#fca5a5;" onclick="doAction(\'friend_remove\',{target:\'' + esc(f.username) + '\'})">åˆ é™¤</button>';
            h += '</div></div>';
        }
    }
    document.getElementById('friendsContent').innerHTML = h;
}
function doAddFriend() { var input = document.getElementById('addFriendInput'); var target = (input.value || '').trim(); if (!target) return; doAction('friend_request', { target: target }); input.value = ''; }
function doVisitFriend(fid) { closePanel('panelFriends'); doAction('visit_farm', { farmId: fid }); openPanel('panelVisit'); setTimeout(function() { var vi = document.getElementById('visitFarmIdInput'); if (vi) vi.value = fid; }, 100); }
function doPrivateMsg(target) { var text = prompt('å‘é€ç§èŠæ¶ˆæ¯ç»™ ' + target + 'ï¼š'); if (!text || !text.trim()) return; doAction('private_msg', { to: target, text: text.trim() }); }

function openGroups() { doAction('list_groups'); closePanel('panelFriends'); openPanel('panelGroups'); }
function renderGroupsPanel(groups) {
    var h = '<div style="display:flex;gap:6px;margin-bottom:12px;">';
    h += '<input type="text" id="newGroupName" placeholder="ç¾¤åç§°" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px 12px;font-size:13px;color:#e0e0e0;outline:none;">';
    h += '<button style="padding:8px 14px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600;" onclick="doCreateGroup()">åˆ›å»ºç¾¤</button></div>';
    if (!groups || groups.length === 0) {
        h += '<div style="color:#666;text-align:center;padding:20px;font-size:12px;">è¿˜æ²¡æœ‰ç¾¤èŠ</div>';
    } else {
        for (var i = 0; i < groups.length; i++) {
            var g = groups[i];
            h += '<div class="group-item"><span><span class="gi-name">ğŸ’¬ ' + esc(g.name) + '</span> <span class="gi-info">(' + g.members.length + 'äºº Â· ç¾¤ä¸»:' + esc(g.owner) + ')</span></span>';
            h += '<div style="display:flex;gap:4px;">';
            h += '<button style="padding:3px 10px;background:rgba(103,232,249,0.2);color:#67e8f9;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doGroupChat(\'' + g.id + '\',\'' + esc(g.name) + '\')">å‘æ¶ˆæ¯</button>';
            h += '<button style="padding:3px 10px;background:rgba(167,139,250,0.2);color:#c4b5fd;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doInviteGroup(\'' + g.id + '\')">é‚€è¯·</button>';
            h += '<button style="padding:3px 10px;background:rgba(239,68,68,0.2);color:#fca5a5;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="doAction(\'leave_group\',{groupId:\'' + g.id + '\'})">é€€å‡º</button>';
            h += '</div></div>';
        }
    }
    document.getElementById('groupsContent').innerHTML = h;
}
function doCreateGroup() { var input = document.getElementById('newGroupName'); var name = (input.value || '').trim(); if (!name) return; doAction('create_group', { name: name }); input.value = ''; }
function doGroupChat(groupId, groupName) { var text = prompt('å‘é€æ¶ˆæ¯åˆ°ç¾¤ã€Œ' + groupName + 'ã€ï¼š'); if (!text || !text.trim()) return; doAction('group_msg', { groupId: groupId, text: text.trim() }); addGroupMsg(groupName, username, text.trim()); }
function doInviteGroup(groupId) { var target = prompt('è¾“å…¥è¦é‚€è¯·çš„æ˜µç§°ï¼š'); if (!target || !target.trim()) return; doAction('invite_group', { groupId: groupId, target: target.trim() }); }

function sendChat() {
    var input = document.getElementById('chatInput');
    var text = input.value.trim();
    if (!text) return;
    doAction('chat', { text: text, channel: chatChannel });
    addChatMsg(username, text, chatChannel, true);
    input.value = '';
    input.focus();
}
function toggleChannel() {
    if (chatChannel === 'world') chatChannel = 'farm';
    else chatChannel = 'world';
    document.getElementById('chatChannelBtn').textContent = 'ğŸ“¢ ' + (chatChannel === 'world' ? 'ä¸–ç•Œé¢‘é“' : 'å†œåœºé¢‘é“');
}

function addChatMsg(from, text, channel, isMe) {
    var div = document.createElement('div');
    div.className = 'msg-item msg-chat';
    var chLabel = channel === 'world' ? '[ä¸–ç•Œ] ' : '[å†œåœº] ';
    var nc = (isMe || from === username) ? 'me' : '';
    div.innerHTML = '<span class="chat-channel">' + chLabel + '</span><span class="chat-name ' + nc + '">' + esc(from) + '</span>' + esc(text);
    appendMsg(div);
}
function addPrivateMsg(from, text) { var div = document.createElement('div'); div.className = 'msg-item msg-private'; div.innerHTML = 'ğŸ”’ <b>' + esc(from) + '</b> æ‚„æ‚„å¯¹ä½ è¯´: ' + esc(text); appendMsg(div); }
function addGroupMsg(groupName, from, text) { var div = document.createElement('div'); div.className = 'msg-item msg-private'; div.innerHTML = 'ğŸ’¬ [' + esc(groupName) + '] <b>' + esc(from) + '</b>: ' + esc(text); appendMsg(div); }
function addSysMsg(text) { var d = document.createElement('div'); d.className = 'msg-item msg-system'; d.textContent = text; appendMsg(d); }
function addAnnounce(text) { var d = document.createElement('div'); d.className = 'msg-item msg-announce'; d.innerHTML = 'ğŸ“œ ' + esc(text); appendMsg(d); }
function addActionOk(text) { var d = document.createElement('div'); d.className = 'msg-item msg-action ok'; d.textContent = text; appendMsg(d); }
function addActionFail(text) { var d = document.createElement('div'); d.className = 'msg-item msg-action fail'; d.textContent = text; appendMsg(d); }
function appendMsg(el) { var a = document.getElementById('msgArea'); a.appendChild(el); while (a.children.length > 200) a.removeChild(a.firstChild); a.scrollTop = a.scrollHeight; }

function openPanel(id) { document.getElementById(id).classList.add('show'); }
function closePanel(id) { document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.panel-overlay').forEach(function(el) { el.addEventListener('click', function(e) { if (e.target === el) el.classList.remove('show'); }); });

function esc(t) { if (t === null || t === undefined) return ''; var d = document.createElement('div'); d.textContent = String(t); return d.innerHTML; }

document.getElementById('chatInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') sendChat(); });
document.getElementById('loginPass').addEventListener('keypress', function(e) { if (e.key === 'Enter') doLogin(); });

document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        if (!ws || ws.readyState !== WebSocket.OPEN) connectWS();
        if (playerData) doAction('my_farm');
    }
});

// â˜… é¡µé¢åŠ è½½æ—¶æ¢å¤ä¿å­˜çš„è´¦å·
loadSavedAccount();
connectWS();
</script>
</body>
</html>

