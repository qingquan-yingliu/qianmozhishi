<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>阡陌之诗</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a2e1e;
            color: #e0e0e0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== 全局动画 ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 6px rgba(252, 211, 77, 0.15);
            }

            to {
                box-shadow: 0 0 16px rgba(252, 211, 77, 0.4);
            }
        }

        @keyframes warning {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.55;
            }
        }

        @keyframes eventGlow {
            from {
                box-shadow: 0 0 4px rgba(251, 191, 36, 0.12);
            }

            to {
                box-shadow: 0 0 16px rgba(251, 191, 36, 0.3);
            }
        }

        @keyframes bgShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        @keyframes pulseRing {
            0% {
                box-shadow: 0 0 0 0 rgba(106, 191, 105, 0.35);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(106, 191, 105, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(106, 191, 105, 0);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes subtlePulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ===== 通用按钮 ===== */
        .btn-td {
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(76, 175, 80, 0.15);
            color: #a5d6a7;
            border: 1px solid rgba(76, 175, 80, 0.25);
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
            position: relative;
            overflow: hidden;
        }

        .btn-td.btn-green {
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: #fff;
            border: none;
            box-shadow: 0 2px 12px rgba(76, 175, 80, 0.25);
        }

        .btn-td.btn-green:hover {
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
            transform: translateY(-1px);
        }

        .btn-td:active {
            transform: scale(0.96);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-green {
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: #fff;
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .btn-green:hover {
            box-shadow: 0 6px 24px rgba(76, 175, 80, 0.45);
            transform: translateY(-1px);
        }

        .btn-green::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            animation: shimmer 3s infinite;
        }

        .btn-ghost {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #aaa;
            margin-top: 8px;
            backdrop-filter: blur(4px);
        }

        .btn-ghost:hover {
            border-color: #6abf69;
            color: #6abf69;
            background: rgba(106, 191, 105, 0.06);
        }

        /* ===== 页面容器 ===== */
        .page {
            display: none;
            width: 100%;
            height: 100vh;
            flex-direction: column;
        }

        .page.active {
            display: flex;
        }

        /* ===== 登录页 ===== */
        .login-page {
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a2e1e 0%, #2a4a2a 40%, #1e3a28 70%, #243e2a 100%);
            background-size: 300% 300%;
            animation: bgShift 12s ease infinite;
        }

        .login-page::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 40%, rgba(76, 175, 80, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(106, 191, 105, 0.04) 0%, transparent 50%);
            animation: float 8s ease-in-out infinite;
            pointer-events: none;
        }

        .login-box {
            width: 90%;
            max-width: 360px;
            background: rgba(20, 35, 22, 0.85);
            border: 1px solid rgba(106, 191, 105, 0.12);
            border-radius: 20px;
            padding: 36px 24px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.04);
            animation: fadeIn 0.6s ease;
            position: relative;
            z-index: 1;
        }

        .login-box h1 {
            text-align: center;
            font-size: 26px;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .login-box .subtitle {
            text-align: center;
            font-size: 12px;
            color: #6abf69;
            margin-bottom: 28px;
            letter-spacing: 3px;
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            color: #7a9a7a;
            margin-bottom: 5px;
            padding-left: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 14px;
            color: #e0e0e0;
            outline: none;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: #6abf69;
            box-shadow: 0 0 0 3px rgba(106, 191, 105, 0.1);
            background: rgba(255, 255, 255, 0.07);
        }

        .form-group input::placeholder {
            color: #4a5a4a;
        }

        .remember-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-left: 4px;
        }

        .remember-row input[type=checkbox] {
            width: 16px;
            height: 16px;
            accent-color: #4caf50;
            cursor: pointer;
        }

        .remember-row label {
            font-size: 12px;
            color: #7a9a7a;
            cursor: pointer;
        }

        .login-msg {
            text-align: center;
            font-size: 12px;
            margin-top: 12px;
            min-height: 18px;
            transition: color 0.3s;
        }

        .login-msg.err {
            color: #ef4444;
        }

        .login-msg.ok {
            color: #4ade80;
        }

        .login-status {
            text-align: center;
            font-size: 11px;
            color: #3a5a3a;
            margin-top: 16px;
        }

        /* ===== 世界选择页 ===== */
        .worlds-page {
            background: #1a2e1e;
        }

        .worlds-header {
            padding: 18px 16px;
            text-align: center;
            border-bottom: 1px solid rgba(106, 191, 105, 0.08);
            flex-shrink: 0;
            background: linear-gradient(180deg, rgba(106, 191, 105, 0.04) 0%, transparent 100%);
        }

        .worlds-header h2 {
            font-size: 18px;
            color: #6abf69;
        }

        .worlds-header .user-info {
            font-size: 12px;
            color: #5a7a5a;
            margin-top: 4px;
        }

        #globalNoticeBar {
            display: none;
            padding: 10px 16px;
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.06), rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.06));
            border-bottom: 1px solid rgba(76, 175, 80, 0.12);
            font-size: 12px;
            color: #a5d6a7;
            line-height: 1.6;
            flex-shrink: 0;
            max-height: 120px;
            overflow-y: auto;
        }

        #globalNoticeBar.show {
            display: block;
        }

        .worlds-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
        }

        .world-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(106, 191, 105, 0.08);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .world-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(106, 191, 105, 0.04), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .world-card:hover {
            border-color: rgba(106, 191, 105, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .world-card:hover::before {
            opacity: 1;
        }

        .world-card h3 {
            font-size: 15px;
            color: #a5d6a7;
            margin-bottom: 4px;
            position: relative;
        }

        .world-card .world-info {
            font-size: 12px;
            color: #5a7a5a;
            display: flex;
            gap: 12px;
            position: relative;
        }

        .world-card .world-info span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .world-pw-input {
            margin-top: 10px;
            display: none;
        }

        .world-pw-input input {
            width: 100%;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 9px 12px;
            font-size: 13px;
            color: #e0e0e0;
            outline: none;
        }

        .world-pw-input button {
            margin-top: 6px;
            width: 100%;
            padding: 9px;
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .no-worlds {
            text-align: center;
            color: #4a5a4a;
            padding: 40px 20px;
            font-size: 14px;
        }

        .worlds-footer {
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            text-align: center;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #5a7a5a;
            padding: 8px 24px;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .btn-logout:hover {
            border-color: #ef4444;
            color: #fca5a5;
        }

        /* ===== 游戏页 ===== */
        .game-page {
            background: #162a1a;
            display: flex;
            flex-direction: column;
        }

        .game-top {
            padding: 8px 12px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.15));
            border-bottom: 1px solid rgba(106, 191, 105, 0.06);
            flex-shrink: 0;
        }

        .game-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-world-name {
            font-size: 13px;
            color: #6abf69;
            font-weight: 600;
        }

        .game-info-right {
            font-size: 11px;
            color: #5a7a5a;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .game-exit-btn {
            font-size: 11px;
            color: #6a8a6a;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .game-exit-btn:hover {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.06);
        }

        .stamina-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 5px;
        }

        .stamina-bar .st-label {
            font-size: 11px;
            color: #7a9a7a;
        }

        .stamina-bar .st-track {
            flex: 1;
            height: 5px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 3px;
            overflow: hidden;
            max-width: 120px;
        }

        .stamina-bar .st-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #4caf50);
            border-radius: 3px;
            transition: width 0.5s;
        }

        .stamina-bar .st-val {
            font-size: 11px;
            color: #8aaa8a;
            min-width: 40px;
            text-align: right;
        }

        .money-top {
            font-size: 12px;
            color: #fcd34d;
            margin-left: 8px;
        }

        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* ===== 农场区 ===== */
        .farm-area {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .farm-title {
            font-size: 13px;
            color: #a5d6a7;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .farm-title .farm-id {
            font-size: 11px;
            color: #3a5a3a;
            font-family: monospace;
        }

        .farm-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .farm-actions button {
            flex: 1;
            padding: 7px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s;
        }

        .btn-water-all {
            background: rgba(59, 130, 246, 0.12) !important;
            border: 1px solid rgba(59, 130, 246, 0.2) !important;
            color: #93c5fd !important;
        }

        .btn-water-all:hover {
            background: rgba(59, 130, 246, 0.2) !important;
        }

        .btn-harvest-all {
            background: rgba(245, 158, 11, 0.12) !important;
            border: 1px solid rgba(245, 158, 11, 0.2) !important;
            color: #fcd34d !important;
        }

        .btn-harvest-all:hover {
            background: rgba(245, 158, 11, 0.2) !important;
        }

        .farm-actions button:active {
            transform: scale(0.96);
        }

        /* ===== 地块 ===== */
        .plots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .plot {
            background: rgba(80, 55, 30, 0.12);
            border: 1px solid rgba(120, 80, 40, 0.18);
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .plot::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 80%, rgba(106, 191, 105, 0.06), transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .plot:hover {
            border-color: rgba(106, 191, 105, 0.35);
            transform: translateY(-2px);
        }

        .plot:hover::before {
            opacity: 1;
        }

        .plot:active {
            transform: scale(0.96);
        }

        .plot.empty {
            border-style: dashed;
            opacity: 0.5;
        }

        .plot .plot-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 2px;
            position: relative;
        }

        .plot .plot-name {
            font-size: 11px;
            color: #aaa;
            position: relative;
        }

        .plot .plot-progress {
            font-size: 10px;
            color: #6a8a6a;
            margin-top: 2px;
            position: relative;
        }

        .plot .plot-progress-bar {
            width: 80%;
            height: 3px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 2px;
            margin: 3px auto 0;
            overflow: hidden;
            position: relative;
        }

        .plot .plot-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2e7d32, #4caf50);
            border-radius: 2px;
            transition: width 1s;
        }

        .plot.mature {
            border-color: rgba(252, 211, 77, 0.35);
            background: rgba(252, 211, 77, 0.06);
            animation: glow 2s infinite alternate;
        }

        .plot.mature .plot-icon {
            animation: float 2.5s ease-in-out infinite;
        }

        /* ===== 消息区 ===== */
        .msg-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.1), transparent 20%);
        }

        .msg-item {
            font-size: 13px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        .msg-chat {
            color: #d0d0d0;
        }

        .msg-chat .chat-name {
            color: #6abf69;
            font-weight: 600;
            margin-right: 4px;
        }

        .msg-chat .chat-name.me {
            color: #fcd34d;
        }

        .msg-chat .chat-channel {
            font-size: 10px;
            color: #3a5a3a;
            margin-right: 4px;
        }

        .msg-system {
            color: #5a7a5a;
            font-size: 12px;
            text-align: center;
            padding: 3px 0;
        }

        .msg-announce {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.08), rgba(76, 175, 80, 0.04));
            border: 1px solid rgba(76, 175, 80, 0.15);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 12px;
            color: #a5d6a7;
            text-align: center;
        }

        .msg-action {
            color: #7a9a7a;
            font-size: 12px;
            padding-left: 8px;
            border-left: 2px solid rgba(255, 255, 255, 0.06);
        }

        .msg-action.ok {
            border-left-color: #4ade80;
            color: #a7f3d0;
        }

        .msg-action.fail {
            border-left-color: #ef4444;
            color: #fca5a5;
        }

        .msg-private {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.1);
            border-radius: 10px;
            padding: 6px 10px;
            font-size: 13px;
            color: #ffdce0;
        }

        .msg-private .private-tag {
            color: #ef4444;
            font-weight: 800;
            margin-right: 4px;
        }

        .msg-private .private-user {
            color: #fca5a5;
            font-weight: 600;
            cursor: pointer;
        }

        .msg-trade {
            background: rgba(251, 191, 36, 0.06);
            border: 1px solid rgba(251, 191, 36, 0.15);
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 12px;
            color: #fcd34d;
        }

        .msg-trade .trade-btns {
            margin-top: 6px;
            display: flex;
            gap: 6px;
        }

        .msg-trade .trade-btns button {
            padding: 4px 12px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .msg-trade .trade-btns .t-accept {
            background: #43a047;
            color: #fff;
        }

        .msg-trade .trade-btns .t-accept:hover {
            background: #4caf50;
        }

        .msg-trade .trade-btns .t-reject {
            background: #d32f2f;
            color: #fff;
        }

        /* ===== 底部导航 ===== */
        .game-bottom {
            border-top: 1px solid rgba(106, 191, 105, 0.06);
            flex-shrink: 0;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.15));
        }

        .nav-bar {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            padding: 4px 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .nav-btn {
            text-align: center;
            padding: 5px 2px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .nav-btn:hover {
            background: rgba(106, 191, 105, 0.06);
        }

        .nav-btn:active {
            transform: scale(0.9);
        }

        .nav-btn .nav-icon {
            font-size: 18px;
            display: block;
            transition: transform 0.2s;
        }

        .nav-btn:hover .nav-icon {
            transform: scale(1.15);
        }

        .nav-btn .nav-label {
            font-size: 10px;
            color: #4a6a4a;
            margin-top: 1px;
        }

        .nav-btn.active .nav-label {
            color: #6abf69;
        }

        .chat-input-row {
            display: flex;
            gap: 6px;
            padding: 6px 10px 10px;
        }

        .chat-input-row input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 9px 14px;
            font-size: 13px;
            color: #e0e0e0;
            outline: none;
            transition: all 0.3s;
        }

        .chat-input-row input:focus {
            border-color: rgba(106, 191, 105, 0.4);
            box-shadow: 0 0 0 3px rgba(106, 191, 105, 0.08);
        }

        .chat-input-row input::placeholder {
            color: #3a4a3a;
        }

        .chat-input-row button {
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 9px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }

        .chat-input-row button:hover {
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.35);
        }

        .chat-channel-btn {
            font-size: 11px;
            color: #4a6a4a;
            padding: 0 14px 2px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .chat-channel-btn:hover {
            color: #6abf69;
        }

        /* ===== 面板覆盖层 ===== */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            overflow: hidden;
            pointer-events: none;
            visibility: hidden;
            transition: background 0.2s ease, visibility 0s 0.2s;
        }

        .panel-overlay.show {
            background: rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            visibility: visible;
            transition: background 0.2s ease, visibility 0s 0s;
        }

        .panel-overlay.show .panel-box {
            transform: translateY(0);
        }

        .panel-box {
            width: 100%;
            max-width: 500px;
            max-height: 75vh;
            background: #1a2e1e;
            background: linear-gradient(180deg, #1a2e1e 0%, #152218 100%);
            border-radius: 20px 20px 0 0;
            padding: 16px;
            overflow-y: auto;
            overflow-x: hidden;
            border-top: 1px solid rgba(106, 191, 105, 0.2);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.2s ease;
        }

        .panel-title {
            font-size: 15px;
            color: #6abf69;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-close {
            font-size: 20px;
            color: #5a7a5a;
            cursor: pointer;
            padding: 4px 8px;
            transition: color 0.2s;
        }

        .panel-close:hover {
            color: #fff;
        }

        /* ===== 物品栏 ===== */
        .inv-section {
            margin-bottom: 14px;
        }

        .inv-section-title {
            font-size: 12px;
            color: #5a7a5a;
            margin-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            padding-bottom: 4px;
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .inv-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
        }

        .inv-item:hover {
            border-color: rgba(106, 191, 105, 0.3);
            transform: translateY(-2px);
            background: rgba(106, 191, 105, 0.04);
        }

        .inv-item .ii-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }

        .inv-item .ii-name {
            font-size: 10px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inv-item .ii-count {
            font-size: 10px;
            color: #5a7a5a;
        }

        .inv-empty {
            text-align: center;
            color: #3a4a3a;
            padding: 20px;
            font-size: 12px;
            grid-column: 1/-1;
        }

        /* ===== 商店 ===== */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 6px;
            transition: all 0.2s;
        }

        .shop-item.shop-item:hover {
            border-color: rgba(106, 191, 105, 0.2);
            background: rgba(106, 191, 105, 0.03);
        }

        .shop-item .si-info {
            flex: 1;
        }

        .shop-item .si-name {
            font-size: 13px;
            color: #a5d6a7;
            font-weight: 600;
        }

        .shop-item .si-desc {
            font-size: 11px;
            color: #5a7a5a;
            margin-top: 2px;
        }

        .shop-item .si-price {
            font-size: 12px;
            color: #fcd34d;
            margin-right: 10px;
            white-space: nowrap;
        }

        .shop-item button {
            padding: 6px 14px;
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
            flex-shrink: 0;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.15);
        }

        .shop-item button:hover {
            box-shadow: 0 3px 12px rgba(76, 175, 80, 0.3);
        }

        .shop-item button:active {
            transform: scale(0.95);
        }

        /* ===== 野外区域 ===== */
        .wild-area-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }

        .wild-area-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.04), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .wild-area-card:hover {
            border-color: rgba(245, 158, 11, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .wild-area-card:hover::before {
            opacity: 1;
        }

        .wild-area-card:active {
            transform: scale(0.98);
        }

        .wild-area-card .wa-name {
            font-size: 14px;
            color: #fcd34d;
            font-weight: 600;
            position: relative;
        }

        .wild-area-card .wa-desc {
            font-size: 12px;
            color: #5a7a5a;
            margin-top: 3px;
            position: relative;
        }

        .wild-area-card .wa-seeds {
            font-size: 11px;
            color: #a5d6a7;
            margin-top: 4px;
            position: relative;
        }

        /* ===== 好友 ===== */
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 13px;
        }

        .friend-item .fi-name {
            color: #a5d6a7;
            font-weight: 600;
        }

        .friend-item .fi-id {
            font-size: 11px;
            color: #3a5a3a;
            font-family: monospace;
            margin-left: 6px;
        }

        .friend-item .fi-btns {
            display: flex;
            gap: 4px;
        }

        .friend-item .fi-btns button {
            padding: 3px 10px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .friend-item .fi-btns button:hover {
            transform: translateY(-1px);
        }

        .friend-req {
            background: rgba(167, 139, 250, 0.06);
            border: 1px solid rgba(167, 139, 250, 0.15);
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 6px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ===== 交易表单 ===== */
        .trade-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trade-form label {
            font-size: 11px;
            color: #5a7a5a;
        }

        .trade-form input,
        .trade-form select {
            width: 100%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 9px 12px;
            font-size: 13px;
            color: #e0e0e0;
            outline: none;
            transition: all 0.3s;
        }

        .trade-form input:focus,
        .trade-form select:focus {
            border-color: rgba(252, 211, 77, 0.4);
            box-shadow: 0 0 0 3px rgba(252, 211, 77, 0.06);
        }

        .trade-form select {
            appearance: auto;
        }

        .trade-form button {
            padding: 10px;
            background: linear-gradient(135deg, #e6a00a, #fbbf24);
            color: #1a1a2e;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(251, 191, 36, 0.2);
            transition: all 0.25s;
        }

        .trade-form button:hover {
            box-shadow: 0 5px 20px rgba(251, 191, 36, 0.35);
            transform: translateY(-1px);
        }

        /* ===== 串门 ===== */
        .visit-farm-view {
            text-align: center;
            padding: 10px;
        }

        .visit-plots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .visit-plot {
            background: rgba(80, 55, 30, 0.1);
            border: 1px solid rgba(120, 80, 40, 0.15);
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        .visit-plot:hover {
            border-color: rgba(106, 191, 105, 0.25);
        }

        .visit-plot .vp-icon {
            font-size: 22px;
        }

        .visit-plot .vp-name {
            font-size: 10px;
            color: #aaa;
            margin-top: 2px;
        }

        .visit-plot .vp-status {
            font-size: 10px;
            color: #5a7a5a;
        }

        /* ===== 群聊 ===== */
        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 13px;
        }

        .group-item .gi-name {
            color: #67e8f9;
            font-weight: 600;
        }

        .group-item .gi-info {
            font-size: 11px;
            color: #5a7a5a;
        }

        /* ===== 卖出 ===== */
        .sell-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 6px;
            transition: all 0.2s;
        }

        .sell-item:hover {
            border-color: rgba(245, 158, 11, 0.2);
        }

        .sell-item .sl-info {
            flex: 1;
        }

        .sell-item .sl-name {
            font-size: 13px;
            color: #a5d6a7;
        }

        .sell-item .sl-detail {
            font-size: 11px;
            color: #5a7a5a;
        }

        .sell-item button {
            padding: 5px 12px;
            background: linear-gradient(135deg, #e6a00a, #fbbf24);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .sell-item button:hover {
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.25);
        }

        /* ===== 排行榜 ===== */
        .ranking-medal {
            font-size: 20px;
            display: inline-block;
            margin-right: 6px;
        }

        .ranking-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 8px;
            transition: all 0.25s;
        }

        .ranking-item:hover {
            border-color: rgba(106, 191, 105, 0.2);
            background: rgba(106, 191, 105, 0.04);
            transform: translateY(-1px);
        }

        .ranking-item.me {
            background: rgba(76, 175, 80, 0.06);
            border-color: rgba(76, 175, 80, 0.15);
        }

        .ranking-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 2px;
            overflow: hidden;
            margin: 6px 0;
        }

        .ranking-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #fcd34d, #f59e0b);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* ===== 圈养区 ===== */
        .cage-area {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .cage-title {
            font-size: 13px;
            color: #fcd34d;
            margin-bottom: 8px;
        }

        .cages-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .cage {
            background: rgba(80, 55, 30, 0.1);
            border: 1px solid rgba(120, 80, 40, 0.18);
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .cage:hover {
            border-color: rgba(252, 211, 77, 0.3);
            transform: translateY(-2px);
        }

        .cage:active {
            transform: scale(0.96);
        }

        .cage.empty {
            border-style: dashed;
            opacity: 0.5;
        }

        .cage .cage-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 2px;
        }

        .cage .cage-name {
            font-size: 11px;
            color: #aaa;
        }

        .cage .cage-count {
            font-size: 10px;
            color: #fcd34d;
            margin-top: 2px;
        }

        .cage .cage-food {
            font-size: 10px;
            color: #67e8f9;
            margin-top: 2px;
        }

        .cage .cage-status {
            font-size: 9px;
            color: #5a7a5a;
            margin-top: 2px;
        }

        .cage.starving {
            border-color: rgba(239, 68, 68, 0.4);
            background: rgba(239, 68, 68, 0.06);
            animation: warning 1.5s infinite;
        }

        /* ===== 宠物 ===== */
        .pet-card {
            background: rgba(167, 139, 250, 0.04);
            border: 1px solid rgba(167, 139, 250, 0.12);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .pet-card:hover {
            border-color: rgba(167, 139, 250, 0.3);
            background: rgba(167, 139, 250, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .pet-card:active {
            transform: scale(0.98);
        }

        .pet-card .pc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pet-card .pc-icon {
            font-size: 28px;
        }

        .pet-card .pc-name {
            font-size: 14px;
            color: #c4b5fd;
            font-weight: 600;
        }

        .pet-card .pc-species {
            font-size: 11px;
            color: #5a6a7a;
        }

        .pet-card .pc-stats {
            display: flex;
            gap: 10px;
            margin-top: 6px;
            font-size: 11px;
            color: #7a8a7a;
        }

        .pet-card .pc-adventure {
            font-size: 11px;
            color: #fcd34d;
            margin-top: 4px;
        }

        .mood-bar {
            width: 60px;
            height: 5px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
        }

        .mood-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }

        .rarity-common {
            color: #a5d6a7;
        }

        .rarity-uncommon {
            color: #67e8f9;
        }

        .rarity-rare {
            color: #c4b5fd;
        }

        .rarity-epic {
            color: #fbbf24;
        }

        .rarity-legendary {
            color: #f87171;
        }

        /* ===== 活动 ===== */
        .event-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 10px;
            transition: all 0.25s;
        }

        .event-card.active-event {
            border-color: rgba(251, 191, 36, 0.3);
            background: rgba(251, 191, 36, 0.04);
            animation: eventGlow 2.5s infinite alternate;
        }

        .event-card.upcoming-event {
            border-color: rgba(103, 232, 249, 0.2);
            background: rgba(103, 232, 249, 0.02);
        }

        .event-card.ended-event {
            opacity: 0.4;
        }

        .event-card .ec-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .event-card .ec-name {
            font-size: 14px;
            font-weight: 600;
            color: #fcd34d;
        }

        .event-card .ec-status {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .event-card .ec-status.st-active {
            background: rgba(76, 175, 80, 0.15);
            color: #4ade80;
        }

        .event-card .ec-status.st-upcoming {
            background: rgba(103, 232, 249, 0.1);
            color: #67e8f9;
        }

        .event-card .ec-status.st-ended {
            background: rgba(255, 255, 255, 0.05);
            color: #5a5a5a;
        }

        .event-card .ec-desc {
            font-size: 12px;
            color: #7a8a7a;
            line-height: 1.5;
            margin-bottom: 6px;
        }

        .event-card .ec-time {
            font-size: 11px;
            color: #5a6a5a;
        }

        .event-card .ec-countdown {
            font-size: 12px;
            color: #fbbf24;
            margin-top: 4px;
        }

        /* ===== 设置 ===== */
        .settings-section {
            margin-bottom: 16px;
        }

        .settings-section-title {
            font-size: 12px;
            color: #5a7a5a;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .settings-player-card {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.06), rgba(76, 175, 80, 0.02));
            border: 1px solid rgba(76, 175, 80, 0.12);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 14px;
        }

        .settings-player-card .sp-name {
            font-size: 18px;
            color: #a5d6a7;
            font-weight: 600;
        }

        .settings-player-card .sp-title {
            font-size: 13px;
            margin-top: 4px;
        }

        .settings-player-card .sp-id {
            font-size: 12px;
            color: #5a7a5a;
            font-family: monospace;
            margin-top: 4px;
        }

        .settings-placeholder {
            text-align: center;
            color: #3a4a3a;
            padding: 30px 20px;
            font-size: 13px;
        }

        /* ===== 装饰 ===== */
        .decoration-item {
            background: rgba(167, 139, 250, 0.06);
            border: 1px solid rgba(167, 139, 250, 0.12);
            border-radius: 10px;
            padding: 6px 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
            position: relative;
            transition: all 0.2s;
        }

        .decoration-item:hover {
            border-color: rgba(167, 139, 250, 0.3);
            transform: translateY(-1px);
        }

        .decoration-item .d-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .decoration-item .d-name {
            font-size: 11px;
            color: #d0d0d0;
        }

        .decoration-remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: #d32f2f;
            color: #fff;
            border-radius: 50%;
            font-size: 12px;
            line-height: 18px;
            text-align: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s;
        }

        .decoration-remove-btn:hover {
            background: #ef4444;
            transform: scale(1.1);
        }

        #farmCageWrapper {
            -webkit-overflow-scrolling: touch;
        }

        #farmCageWrapper .farm-area,
        #farmCageWrapper .cage-area {
            max-height: none !important;
            overflow: visible !important;
            flex-shrink: unset !important;
        }

        #farmCageWrapper .cage-area {
            border-bottom: none;
        }

        /* ===== 通用辅助类 ===== */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
        }

        .glass:hover {
            border-color: rgba(106, 191, 105, 0.2);
        }

        .text-muted {
            color: #5a7a5a;
            font-size: 11px;
        }

        .text-gold {
            color: #fcd34d;
        }

        .text-green {
            color: #a5d6a7;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .flex-gap-4 {
            display: flex;
            gap: 4px;
        }

        .flex-gap-6 {
            display: flex;
            gap: 6px;
        }

        .flex-col-6 {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .mb-6 {
            margin-bottom: 6px;
        }

        .mb-8 {
            margin-bottom: 8px;
        }

        .mb-12 {
            margin-bottom: 12px;
        }

        .p-8 {
            padding: 8px;
        }

        .p-10 {
            padding: 10px;
        }

        .p-12 {
            padding: 12px;
        }

        .rounded-8 {
            border-radius: 8px;
        }

        .rounded-10 {
            border-radius: 10px;
        }

        .rounded-12 {
            border-radius: 12px;
        }

        .w-full {
            width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .text-12 {
            font-size: 12px;
        }

        .text-11 {
            font-size: 11px;
        }

        .text-13 {
            font-size: 13px;
        }

        .fw-600 {
            font-weight: 600;
        }

        /* 通用内联按钮样式 */
        .action-btn {
            padding: 8px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
            font-weight: 500;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        .action-btn-blue {
            background: rgba(59, 130, 246, 0.12);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .action-btn-gold {
            background: rgba(245, 158, 11, 0.12);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .action-btn-purple {
            background: rgba(167, 139, 250, 0.12);
            color: #c4b5fd;
            border: 1px solid rgba(167, 139, 250, 0.2);
        }

        .action-btn-cyan {
            background: rgba(6, 182, 212, 0.12);
            color: #67e8f9;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .action-btn-red {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.18);
        }

        .action-btn-green {
            background: rgba(76, 175, 80, 0.12);
            color: #a5d6a7;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .action-btn-pink {
            background: linear-gradient(135deg, #ec4899, #f472b6);
            color: #fff;
            border: none;
        }

        .action-btn-solid-green {
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: #fff;
            border: none;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }

        /* 通用输入框 */
        .input-dark {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 9px 12px;
            font-size: 13px;
            color: #e0e0e0;
            outline: none;
            transition: all 0.3s;
        }

        .input-dark:focus {
            border-color: rgba(106, 191, 105, 0.4);
            box-shadow: 0 0 0 3px rgba(106, 191, 105, 0.06);
        }

        .input-dark::placeholder {
            color: #3a4a3a;
        }

        .input-sm {
            width: 50px;
            padding: 4px;
            font-size: 12px;
            text-align: center;
        }

        .input-num {
            width: 60px;
            padding: 6px;
            font-size: 12px;
            text-align: center;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(106, 191, 105, 0.15);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(106, 191, 105, 0.25);
        }

        @media(max-width:360px) {
            .plots-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .inv-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>

<body>
    <div id="toastBar"
        style="display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);z-index:9999;padding:10px 28px;border-radius:20px;font-size:14px;font-weight:600;pointer-events:none;transition:opacity 0.5s;white-space:nowrap;max-width:90vw;text-align:center;">
    </div>

    <div class="page login-page active" id="loginPage">
        <div class="login-box">
            <h1>🌾 阡陌之诗 v1.9.14</h1>
            <div class="subtitle">种地 · 采集 · 交友 · 交易</div>
            <div class="form-group"><label>你的昵称</label><input type="text" id="loginUser" placeholder="2-16个字符"
                    maxlength="16"></div>
            <div class="form-group"><label>密码</label><input type="password" id="loginPass" placeholder="至少4个字符"></div>
            <div class="remember-row">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">记住账号，下次免输入</label>
            </div>
            <button class="btn btn-green" onclick="doLogin()">登 入</button>
            <button class="btn btn-ghost" onclick="doRegister()">注册新账号</button>
            <div class="login-msg" id="loginMsg"></div>
            <div class="login-status" id="loginStatus">正在连接服务器...</div>
        </div>
    </div>

    <div class="page worlds-page" id="worldsPage">
        <div class="worlds-header">
            <h2>🌾 选择世界</h2>
            <div class="user-info">欢迎，<span id="displayUser"></span>（领地ID: <span id="displayFarmId"
                    style="font-family:monospace;color:#fcd34d;"></span>）</div>
        </div>
        <div id="globalNoticeBar" style="display:none;">
            <div style="font-size:11px;color:#66bb6a;font-weight:600;margin-bottom:2px;">📜 公告</div>
            <div id="globalNoticeText" style="white-space:pre-wrap;"></div>
        </div>
        <div class="worlds-list" id="worldsList"></div>
        <div class="worlds-footer"><button class="btn-logout" onclick="doLogout()">退出登录</button></div>
    </div>

    <div class="page game-page" id="gamePage">
        <div class="game-top">
            <div class="game-top-row">
                <div>
                    <span class="game-world-name" id="gameWorldName">世界</span>
                    <div style="font-size:11px;color:#5a7a5a;margin-top:2px;" id="gamePlayerInfo"></div>
                </div>
                <div class="game-info-right">
                    <span id="gameSeason">🌸 春</span>
                    <span id="gameWeather">☀️ 晴</span>
                    <span class="money-top" id="moneyTop">💰 0</span>
                    <span class="game-exit-btn" onclick="openSettings()">⚙️</span>
                </div>
            </div>
            <div class="stamina-bar">
                <span class="st-label">⚡ 体力</span>
                <div class="st-track">
                    <div class="st-fill" id="staminaFill" style="width:100%"></div>
                </div>
                <span class="st-val" id="staminaVal">100/100</span>
            </div>
        </div>
        <div id="farmCageWrapper"
            style="max-height:35vh;overflow-y:auto;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,0.04);">
            <div class="farm-area" id="farmArea"
                style="max-height:none;overflow:visible;flex-shrink:unset;border-bottom:none;">
                <div class="farm-title">
                    <span>🏡 农场区</span><span class="farm-id" id="farmIdDisplay">ID: ------</span>
                </div>
                <div class="farm-actions" id="myFarmActions" style="margin-bottom:10px;">
                    <button class="btn-water-all" onclick="doWaterAll()">💧 一键浇水</button>
                    <button class="btn-harvest-all" onclick="doHarvestAll()">🌾 一键收获</button>
                </div>
                <div class="plots-grid" id="plotsGrid"></div>
            </div>
            <div class="cage-area" id="cageArea" style="max-height:none;overflow:visible;flex-shrink:unset;">
                <div class="cage-title">🐾 圈养区</div>
                <div class="cages-grid" id="cagesGrid"></div>
            </div>
            <div class="decoration-area" id="decorationArea"
                style="padding:10px;border-top:1px solid rgba(255,255,255,0.04);">
                <div class="decoration-title" style="font-size:13px;color:#a78bfa;margin-bottom:8px;">🎨 装饰区 (0/6)</div>
                <div class="decorations-grid" id="decorationsGrid" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
            </div>
        </div>
        <div class="msg-area" id="msgArea"></div>
        <div class="game-bottom">
            <div class="nav-bar" id="navPage1">
                <div class="nav-btn" onclick="openWild()"><span class="nav-icon">🌿</span><span
                        class="nav-label">野外</span></div>
                <div class="nav-btn" onclick="openMail()"><span class="nav-icon">📬</span><span
                        class="nav-label">邮件</span></div>
                <div class="nav-btn" onclick="openPets()"><span class="nav-icon">🐱</span><span
                        class="nav-label">宠物</span></div>
                <div class="nav-btn" onclick="openVisit()"><span class="nav-icon">🏠</span><span
                        class="nav-label">串门</span></div>
                <div class="nav-btn" onclick="openEvents()"><span class="nav-icon">🎉</span><span
                        class="nav-label">活动</span></div>
                <div class="nav-btn" onclick="openInventory()"><span class="nav-icon">🎒</span><span
                        class="nav-label">物品</span></div>
                <div class="nav-btn" onclick="openShop()"><span class="nav-icon">🏪</span><span
                        class="nav-label">商店</span></div>
                <div class="nav-btn" onclick="openTrade()"><span class="nav-icon">🤝</span><span
                        class="nav-label">交易</span></div>
                <div class="nav-btn" onclick="openFriends()"><span class="nav-icon">👥</span><span
                        class="nav-label">好友</span></div>
                <div class="nav-btn" onclick="openRanking()"><span class="nav-icon">🏆</span><span
                        class="nav-label">排行</span></div>
                <div class="nav-btn" onclick="openSell()"><span class="nav-icon">💰</span><span
                        class="nav-label">卖出</span></div>
                <div class="nav-btn" onclick="switchNavPage()"><span class="nav-icon">▶️</span><span
                        class="nav-label">更多</span></div>
            </div>
            <div class="nav-bar" id="navPage2" style="display:none;">
                <div class="nav-btn" onclick="openDailyTasks()"><span class="nav-icon">📋</span><span
                        class="nav-label">每日</span></div>
                <div class="nav-btn" onclick="openWeeklyChallenge()"><span class="nav-icon">📅</span><span
                        class="nav-label">周挑战</span></div>
                <div class="nav-btn" onclick="openDecorations()"><span class="nav-icon">🎨</span><span
                        class="nav-label">装饰</span></div>
                <div class="nav-btn" onclick="switchNavPage()"><span class="nav-icon">◀️</span><span
                        class="nav-label">返回</span></div>
            </div>
            <div class="chat-channel-btn" id="chatChannelBtn" onclick="toggleChannel()">📢 世界频道</div>
            <div class="chat-input-row">
                <input type="text" id="chatInput" placeholder="说点什么...">
                <button onclick="sendChat()">发送</button>
            </div>
        </div>
    </div>

    <!-- 所有面板 -->
    <div class="panel-overlay" id="panelWild">
        <div class="panel-box">
            <div class="panel-title">🌿 野外采集 <span class="panel-close" onclick="closePanel('panelWild')">&times;</span>
            </div>
            <div id="wildContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelMail">
        <div class="panel-box">
            <div class="panel-title">📬 邮件 <span class="panel-close" onclick="closePanel('panelMail')">&times;</span>
            </div>
            <div id="mailContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelCageAction">
        <div class="panel-box">
            <div class="panel-title">🐾 圈养操作 <span class="panel-close"
                    onclick="closePanel('panelCageAction')">&times;</span></div>
            <div id="cageActionContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelVisit">
        <div class="panel-box">
            <div class="panel-title">🏠 串门 <span class="panel-close" onclick="closePanel('panelVisit')">&times;</span>
            </div>
            <div id="visitContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelInv">
        <div class="panel-box">
            <div class="panel-title">🎒 物品 <span class="panel-close" onclick="closePanel('panelInv')">&times;</span>
            </div>
            <div id="invContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelShop">
        <div class="panel-box">
            <div class="panel-title">🏪 商店 <span class="panel-close" onclick="closePanel('panelShop')">&times;</span>
            </div>
            <div id="shopContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelTrade">
        <div class="panel-box">
            <div class="panel-title">🤝 交易 <span class="panel-close" onclick="closePanel('panelTrade')">&times;</span>
            </div>
            <div id="tradeContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelDecorations">
        <div class="panel-box">
            <div class="panel-title">🎨 农场装饰 <span class="panel-close"
                    onclick="closePanel('panelDecorations')">&times;</span></div>
            <div id="decorationsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelFriends">
        <div class="panel-box">
            <div class="panel-title">👥 好友 <span class="panel-close" onclick="closePanel('panelFriends')">&times;</span>
            </div>
            <div id="friendsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelSell">
        <div class="panel-box">
            <div class="panel-title">💰 卖出果实 <span class="panel-close" onclick="closePanel('panelSell')">&times;</span>
            </div>
            <div id="sellContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelPlotAction">
        <div class="panel-box">
            <div class="panel-title">🌱 地块操作 <span class="panel-close"
                    onclick="closePanel('panelPlotAction')">&times;</span></div>
            <div id="plotActionContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelGroups">
        <div class="panel-box">
            <div class="panel-title">💬 群聊 <span class="panel-close" onclick="closePanel('panelGroups')">&times;</span>
            </div>
            <div id="groupsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelRanking">
        <div class="panel-box">
            <div class="panel-title">🏆 排行榜 <span class="panel-close"
                    onclick="closePanel('panelRanking')">&times;</span></div>
            <div style="display:flex;gap:6px;margin-bottom:10px;">
                <button id="rankTabMoney" class="action-btn action-btn-gold w-full fw-600"
                    onclick="switchRankTab('money')">💰 金币排行</button>
                <button id="rankTabPet" class="action-btn action-btn-purple w-full" onclick="switchRankTab('pet')">🐱
                    宠物价值</button>
                <button id="rankTabWeekly" class="action-btn action-btn-cyan w-full"
                    onclick="switchRankTab('weekly')">📅 周挑战</button>
            </div>
            <div id="rankingContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelPets">
        <div class="panel-box">
            <div class="panel-title">🐱 我的宠物 <span class="panel-close" onclick="closePanel('panelPets')">&times;</span>
            </div>
            <div id="petsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelPetDetail">
        <div class="panel-box">
            <div class="panel-title">🐾 宠物详情 <span class="panel-close"
                    onclick="closePanel('panelPetDetail')">&times;</span></div>
            <div id="petDetailContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelEvents">
        <div class="panel-box">
            <div class="panel-title">🎉 活动 <span class="panel-close" onclick="closePanel('panelEvents')">&times;</span>
            </div>
            <div id="eventsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelSettings">
        <div class="panel-box">
            <div class="panel-title">⚙️ 设置 <span class="panel-close"
                    onclick="closePanel('panelSettings')">&times;</span></div>
            <div id="settingsContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelDailyTasks">
        <div class="panel-box">
            <div class="panel-title">📋 每日任务 <span class="panel-close"
                    onclick="closePanel('panelDailyTasks')">&times;</span></div>
            <div id="dailyTasksContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelWeeklyChallenge">
        <div class="panel-box">
            <div class="panel-title">📅 周挑战 <span class="panel-close"
                    onclick="closePanel('panelWeeklyChallenge')">&times;</span></div>
            <div id="weeklyChallengeContent"></div>
        </div>
    </div>
    <div class="panel-overlay" id="panelTitleSelect">
        <div class="panel-box">
            <div class="panel-title">👑 选择称号 <span class="panel-close"
                    onclick="closePanel('panelTitleSelect')">&times;</span></div>
            <div id="titleSelectContent"></div>
        </div>
    </div>

    <script>
        var SERVER_URL = 'wss://ws.qmzs.top';
        var PET_MAX = 10;// 宠物上限
        var ws = null, username = null, farmId = null, currentWorld = null, playerData = null;
        var chatChannel = 'world', reconnTimer = null, hbTimer = null;
        var visitingOwner = null, visitingFarmId = null;
        var cageUpdateTimer = null, serverTimeOffset = 0;
        var cachedFriendList = [];
        var _inWorld = false, _lastVisitPlotsHash = '', _pendingWildTip = null, _scrollPending = false;
        var currentRankTab = 'money';

        // 辅助：生成内联样式字符串
        function S(obj) { var s = ''; for (var k in obj) s += k + ':' + obj[k] + ';'; return s; }

        function calcRealTimeLeft(cage) {
            if (!cage.animal || cage.animal.count <= 0 || cage.food <= 0) return 0;

            var food = cage.food;
            var count = cage.animal.count;
            var foodRate = cage.animal.foodPerHour;
            var breedTime = cage.animal.breedTime;
            var lastBreed = cage.animal.lastBreed || Date.now();
            var breedCount = cage.animal.breedCount || 0; // 当前生育次数
            var now = Date.now();

            // 必须和后端的配置保持完全一致
            var MAX_BREED_TIMES = 10;
            var CAGE_CAPACITY = 1024;
            var BABIES_PER_CYCLE = 2;

            var hours = 0;
            // 限制最大推演次数，防止极端数据卡死循环 (5000小时 ≈ 208天)
            while (food > 0 && hours < 5000) {
                var currentConsumption = count * foodRate;

                // 如果剩下的食物不够吃完整整1小时，计算小数(满算)并返回
                if (food < currentConsumption) {
                    return hours + (food / currentConsumption);
                }

                food -= currentConsumption;
                hours++;

                // 模拟推演时间线，看看这个小时里有没有触发繁殖
                var simTime = now + (hours * 3600000);
                if (count >= 2 && breedCount < MAX_BREED_TIMES && count < CAGE_CAPACITY) {
                    if ((simTime - lastBreed) >= breedTime) {
                        count = Math.min(CAGE_CAPACITY, count + BABIES_PER_CYCLE);
                        lastBreed = simTime;
                        breedCount++; // 模拟一次生育
                    }
                }
            }
            return hours;
        }

        function formatHours(h) {
            if (h <= 0) return '0小时'; if (h < 1) return Math.floor(h * 60) + '分钟';
            var hh = Math.floor(h); if (hh > 24) { var d = Math.floor(hh / 24); return d + '天' + (hh % 24) + '小时'; } return hh + '小时';
        }

        function buildCageHtml(cages) {
            var h = '';
            for (var i = 0; i < cages.length; i++) {
                var c = cages[i];
                var starving = c.animal && c.food < 0;
                h += '<div class="cage' + (starving ? ' starving' : (!c.animal ? ' empty' : '')) + '" onclick="clickCage(' + i + ')">';

                if (c.animal) {
                    h += '<span class="cage-icon">' + (c.animal.icon || '🐾') + '</span>';
                    h += '<span class="cage-name">' + esc(c.animal.name) + '</span>';
                    h += '<span class="cage-count">数量: ' + c.animal.count + '</span>';
                    h += '<span class="cage-food">' + (c.food >= 0 ? '🍖' + Math.floor(c.food) : '⚠️饥饿') + '</span>';
                    h += '<span class="cage-status">消耗' + c.animal.foodPerHour + '/时</span>';
                } else {
                    h += '<span class="cage-icon" style="opacity:0.3;">🟫</span>';
                    h += '<span class="cage-name" style="color:#4a5a4a;">空圈</span>';
                    h += '<span class="cage-food" style="margin-top:6px;color:#a5d6a7;">🍖存粮: ' + Math.floor(c.food || 0) + '</span>';
                }
                h += '</div>';
            }
            return h;
        }

        function loadingPlaceholder() {
            return '<div style="text-align:center;padding:30px 0;color:#5a7a5a;">'
                + '<div style="font-size:24px;animation:subtlePulse 1.5s infinite;">⏳</div>'
                + '<div style="font-size:12px;margin-top:8px;">加载中...</div></div>';
        }

        // 记住账号
        function loadSavedAccount() { try { var s = localStorage.getItem('qmzs_account'); if (s) { var d = JSON.parse(s); if (d.username) document.getElementById('loginUser').value = d.username; if (d.password) document.getElementById('loginPass').value = d.password; document.getElementById('rememberMe').checked = true; } } catch (e) { } }
        function saveAccount(u, p) { try { if (document.getElementById('rememberMe').checked) localStorage.setItem('qmzs_account', JSON.stringify({ username: u, password: p })); else localStorage.removeItem('qmzs_account'); } catch (e) { } }
        function clearSavedAccount() { try { localStorage.removeItem('qmzs_account'); } catch (e) { } }

        function exitWorld() {
            if (!_inWorld) return; if (!confirm('确定退出当前世界？')) return;
            wsSend({ type: 'leave_world' }); _inWorld = false; _lastVisitPlotsHash = '';
            clearTimers(); currentWorld = null; playerData = null; visitingOwner = null; visitingFarmId = null;
            document.querySelectorAll('.panel-overlay').forEach(function (el) { el.classList.remove('show'); });
            var vbar = document.getElementById('visitStatusBar'); if (vbar) vbar.remove();
            document.getElementById('msgArea').innerHTML = ''; showWorldsPage();
        }
        function exitToWorlds() {
            _inWorld = false; _lastVisitPlotsHash = ''; clearTimers();
            currentWorld = null; playerData = null; visitingOwner = null; visitingFarmId = null;
            document.querySelectorAll('.panel-overlay').forEach(function (el) { el.classList.remove('show'); });
            var vbar = document.getElementById('visitStatusBar'); if (vbar) vbar.remove();
            document.getElementById('msgArea').innerHTML = '';
            if (username) showWorldsPage(); else showPage('loginPage');
        }

        function openFeedbackForm() { var el = document.getElementById('feedbackFormArea'); if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none'; }
        function submitFeedback() { var t = (document.getElementById('feedbackText').value || '').trim(); if (!t || t.length < 2) { alert('反馈内容至少2个字'); return; } if (t.length > 500) { alert('反馈内容不能超过500字'); return; } wsSend({ type: 'submit_feedback', text: t }); document.getElementById('feedbackText').value = ''; document.getElementById('feedbackFormArea').style.display = 'none'; alert('感谢你的反馈！'); }

        // WebSocket
        function connectWS() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            updLoginStatus('正在连接服务器...');
            ws = new WebSocket(SERVER_URL);
            ws.onopen = function () { updLoginStatus('已连接', true); if (reconnTimer) { clearTimeout(reconnTimer); reconnTimer = null; } startHB(); };
            ws.onmessage = function (e) { try { handleMsg(JSON.parse(e.data)); } catch (err) { } };
            ws.onerror = function () { updLoginStatus('连接出错', false); };
            ws.onclose = function () { updLoginStatus('连接断开，重连中...', false); stopHB(); reconnTimer = setTimeout(connectWS, 3000); };
        }
        function wsSend(o) { if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(o)); }
        function startHB() { stopHB(); hbTimer = setInterval(function () { wsSend({ type: 'heartbeat' }); }, 25000); }
        function stopHB() { if (hbTimer) { clearInterval(hbTimer); hbTimer = null; } }
        function doAction(action, payload) { wsSend({ type: 'action', action: action, payload: payload || {} }); }

        function handleMsg(msg) {
            switch (msg.type) {
                case 'register_result': showLoginMsg(msg.msg, msg.ok); if (msg.ok && msg.farmId) showLoginMsg(msg.msg + '，你的领地ID: ' + msg.farmId, true); break;
                case 'login_result':
                    if (msg.ok) { username = msg.username; farmId = msg.farmId; saveAccount(document.getElementById('loginUser').value.trim(), document.getElementById('loginPass').value); showLoginMsg('登录成功', true); setTimeout(showWorldsPage, 400); }
                    else showLoginMsg(msg.msg, false); break;
                case 'world_list':
                    renderWorldList(msg.data);
                    if (msg.globalNotice) { document.getElementById('globalNoticeText').textContent = msg.globalNotice; document.getElementById('globalNoticeBar').style.display = 'block'; }
                    else document.getElementById('globalNoticeBar').style.display = 'none'; break;
                case 'enter_world_result': if (msg.ok) enterGame(msg); else alert(msg.msg); break;
                case 'action_result': handleActionResult(msg); break;
                case 'chat': addChatMsg(msg.from, msg.text, msg.channel, false, msg.title); break;
                case 'private_msg': addPrivateChatLog(msg.from, username, msg.text, false); break;
                case 'group_msg': addGroupMsg(msg.groupName, msg.from, msg.text); break;
                case 'player_online': case 'player_offline': doAction('friend_list'); break;
                case 'announcement': addAnnounce(msg.text); break;
                case 'world_update': if (msg.announcement) addAnnounce(msg.announcement); break;
                case 'season_update': updSeason(msg.season, msg.weather); break;
                case 'visitor_enter': addSysMsg(msg.username + ' 来你农场串门了'); break;
                case 'visitor_leave': addSysMsg(msg.username + ' 离开了你的农场'); break;
                case 'trade_incoming': showTradeIncoming(msg.trade); break;
                case 'trade_completed': addActionOk('交易完成！'); if (msg.seeds) playerData.seeds = msg.seeds; if (msg.fruits) playerData.fruits = msg.fruits; if (msg.money !== undefined) { playerData.money = msg.money; updMoney(); } break;
                case 'trade_rejected': addActionFail('对方拒绝了你的交易'); break;
                case 'trade_cancelled': addSysMsg('一笔交易被取消了'); break;
                case 'friend_request_received': addSysMsg(msg.from + ' 请求加你为好友'); break;
                case 'friend_accepted': addActionOk(msg.by + ' 接受了你的好友请求'); break;
                case 'group_invite': addSysMsg(msg.inviter + ' 邀请你加入群聊「' + msg.group.name + '」'); break;
                case 'player_update':
                    playerData = msg.player; if (!playerData.holidayTasks) playerData.holidayTasks = {};
                    refreshFarm();
                    if (document.getElementById('panelSettings').classList.contains('show')) renderSettingsPanel();
                    if (document.getElementById('panelTitleSelect').classList.contains('show')) renderTitleSelectPanel(); break;
                case 'kicked': alert(msg.msg || '被踢出'); exitToWorlds(); break;
                case 'blacklisted': alert(msg.msg || '你已被加入黑名单'); exitToWorlds(); break;
                case 'heartbeat_ack': if (msg.timestamp) serverTimeOffset = msg.timestamp - Date.now(); break;
                case 'event_update': if (document.getElementById('panelEvents').classList.contains('show')) doAction('event_list'); break;
                case 'mail_notify': if (msg.count > 0) addSysMsg('📬 你有 ' + msg.count + ' 封邮件' + (msg.unclaimedCount > 0 ? '（' + msg.unclaimedCount + ' 封有附件待领取）' : '')); break;
                case 'pet_adventure_ready': if (msg.count > 0) addSysMsg('🐾 你有 ' + msg.count + ' 只宠物寻宝归来：' + msg.petNames + '，快去领取奖励吧！'); break;
                case 'new_mail': addSysMsg('📬 收到新邮件：' + (msg.mail.subject || '系统邮件')); break;
                case 'visitor_water':
                    addSysMsg(msg.from + ' 给你的 ' + msg.plantName + ' 浇了水 💧');
                    if (playerData && playerData.plots && playerData.plots[msg.plotId] && playerData.plots[msg.plotId].plant) { playerData.plots[msg.plotId].plant.watered = true; if (!visitingOwner) renderPlots(); } break;
                case 'farm_plot_update': if (visitingOwner === msg.owner) { addSysMsg('有人给 ' + msg.plantName + ' 浇了水 💧'); doAction('visit_farm', { farmId: visitingFarmId }); } break;
                case 'feedback_result': if (msg.ok) addActionOk(msg.msg || '反馈已提交'); else addActionFail(msg.msg || '提交失败'); break;
                case 'friend_online': addSysMsg('🟢 ' + esc(msg.username) + ' 上线了'); break;
                case 'friend_offline': addSysMsg('⚫ ' + esc(msg.username) + ' 下线了'); break;
                case 'adventure_result': showAdventureToast(msg.adventure.text, msg.adventure.rewards); break;
                case 'holiday_task_complete': showHolidayTaskComplete(msg.eventName, msg.taskDesc, msg.titleName, msg.titleColor); if (document.getElementById('panelEvents').classList.contains('show')) doAction('event_list'); break;
            }
        }

        function handleActionResult(msg) {
            var a = msg.action, ok = msg.ok;
            if (msg.stamina !== undefined && playerData) { playerData.stamina = msg.stamina; updStamina(); }
            if (msg.staminaMax !== undefined && playerData) { playerData.staminaMax = msg.staminaMax; updStamina(); }
            if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); }
            if (msg.plots && playerData && a !== 'visit_farm') {
                if (a === 'water' && visitingOwner) updateVisitPlots(msg.plots, msg.cages, msg.decorations);
                else { playerData.plots = msg.plots; renderPlots(); }
            }
            if (msg.seeds && playerData && a !== 'visit_farm') playerData.seeds = msg.seeds;
            if (msg.fruits && playerData && a !== 'visit_farm') playerData.fruits = msg.fruits;
            if (msg.items && playerData) playerData.items = msg.items;
            if (msg.restCooldown !== undefined && playerData) playerData.restCooldown = msg.restCooldown;
            if (msg.hasWaterBoost !== undefined && playerData) playerData.hasWaterBoost = msg.hasWaterBoost;

            switch (a) {
                case 'gather':
                    if (ok) { addActionOk(msg.msg); if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: true }; doAction('wild_areas'); } }
                    else { addActionFail(msg.msg); if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: false }; doAction('wild_areas'); } } break;
                case 'rest':
                    if (ok) { addActionOk(msg.msg); if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: true }; doAction('wild_areas'); } }
                    else { addActionFail(msg.msg); if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: false }; doAction('wild_areas'); } } break;
                case 'plant': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'water': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'fertilize': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'harvest': if (ok) { addActionOk(msg.msg); closePanel('panelPlotAction'); } else addActionFail(msg.msg); break;
                case 'my_farm':
                    if (msg.msg) addActionOk(msg.msg);
                    if (ok && playerData) {
                        if (msg.plots) playerData.plots = msg.plots; if (msg.seeds) playerData.seeds = msg.seeds;
                        if (msg.fruits) playerData.fruits = msg.fruits; if (msg.items) playerData.items = msg.items;
                        if (msg.money !== undefined) playerData.money = msg.money; if (msg.stamina !== undefined) playerData.stamina = msg.stamina;
                        if (msg.staminaMax !== undefined) playerData.staminaMax = msg.staminaMax; if (msg.restCooldown !== undefined) playerData.restCooldown = msg.restCooldown;
                        if (msg.farmId) playerData.farmId = msg.farmId; if (msg.waterBoostLevel !== undefined) playerData.waterBoostLevel = msg.waterBoostLevel;
                        if (msg.decorations) playerData.decorations = msg.decorations;
                        if (!visitingOwner) { refreshFarm(); renderCages(); } else { updStamina(); updMoney(); }
                    }
                    if (msg.cages) playerData.cages = msg.cages; if (msg.decorations) playerData.decorations = msg.decorations;
                    if (!visitingOwner) { renderCages(); renderDecorationsArea(playerData.decorations, false); }
                    if (msg.animals) playerData.animals = msg.animals; if (msg.pets) playerData.pets = msg.pets;
                    if (!visitingOwner) renderCages(); break;
                case 'inventory':
                    if (ok) {
                        playerData.seeds = msg.seeds;
                        playerData.fruits = msg.fruits;
                        playerData.items = msg.items;
                        playerData.money = msg.money;
                        renderInventoryPanel(msg.seeds, msg.fruits, msg.items, msg.money);
                        if (document.getElementById('panelSell').classList.contains('show')) {
                            renderSellPanel();
                        }
                        // 重置标记
                        window._noLoadingRender = false;
                    }
                    break;
                case 'shop_list':
                    if (ok) {
                        renderShopPanel(msg.shop, msg.money);
                        if (window._shopScrollRestore !== undefined) {
                            var box = document.querySelector('#panelShop .panel-box');
                            if (box) box.scrollTop = window._shopScrollRestore;
                            window._shopScrollRestore = undefined;
                        }
                    }
                    break;
                case 'shop_buy':
                    if (ok) {
                        addActionOk(msg.msg);
                        showToast(msg.msg, true);
                        if (msg.money !== undefined && playerData)
                            playerData.money = msg.money;
                        if (msg.waterBoostLevel !== undefined && playerData)
                            playerData.waterBoostLevel = msg.waterBoostLevel;
                        if (msg.seeds && playerData) playerData.seeds = msg.seeds;
                        if (msg.items && playerData) playerData.items = msg.items; if (msg.plots && playerData) { playerData.plots = msg.plots; renderPlots(); } if (msg.cages && playerData) { playerData.cages = msg.cages; renderCages(); } if (msg.animals && playerData) playerData.animals = msg.animals; setTimeout(function () { var box = document.querySelector('#panelShop .panel-box'); var st = box ? box.scrollTop : 0; doAction('shop_list'); window._shopScrollRestore = st; }, 150);
                        var shopBox = document.querySelector('#panelShop .panel-box');
                        var currentScroll = shopBox ? shopBox.scrollTop : 0;
                        window._shopScrollRestore = currentScroll;
                        doAction('shop_list');
                    }
                    else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'sell_fruit': if (ok) { showToast(msg.msg, true); openSell(); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'sell_seed': if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); openSell(); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'sell_stock_animal': if (ok) { showToast(msg.msg, true); if (msg.animals && playerData) playerData.animals = msg.animals; openSell(); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'wild_areas': if (ok) renderWildPanel(msg.areas, msg.stamina, msg.staminaMax); if (_pendingWildTip) { showWildTip(_pendingWildTip.msg, _pendingWildTip.ok); _pendingWildTip = null; } break;
                case 'catch_animal':
                    if (ok) { addActionOk(msg.msg); if (msg.stamina !== undefined && playerData) { playerData.stamina = msg.stamina; updStamina(); } if (msg.animals && playerData) playerData.animals = msg.animals; if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: true }; doAction('wild_areas'); } }
                    else { addActionFail(msg.msg); if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: false }; doAction('wild_areas'); } } break;
                case 'place_animal': if (ok) { addActionOk(msg.msg); if (msg.cages && playerData) playerData.cages = msg.cages; if (msg.animals && playerData) playerData.animals = msg.animals; renderCages(); closePanel('panelCageAction'); } else addActionFail(msg.msg); break;
                case 'feed_animal': if (ok) { addActionOk(msg.msg); if (msg.cages && playerData) playerData.cages = msg.cages; if (msg.seeds && playerData) playerData.seeds = msg.seeds; if (msg.fruits && playerData) playerData.fruits = msg.fruits; renderCages(); } else addActionFail(msg.msg); break;
                case 'sell_animal': if (ok) { addActionOk(msg.msg); if (msg.cages && playerData) playerData.cages = msg.cages; if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); } renderCages(); closePanel('panelCageAction'); } else addActionFail(msg.msg); break;
                case 'sell_item':
                    if (ok) {
                        showToast(msg.msg, true);
                        if (msg.money !== undefined && playerData) {
                            playerData.money = msg.money;
                            updMoney();
                        }
                        if (msg.items && playerData) playerData.items = msg.items;
                        if (document.getElementById('panelSell').classList.contains('show')) {
                            window._noLoadingRender = true;
                            doAction('inventory');
                        }
                    } else {
                        addActionFail(msg.msg);
                        showToast(msg.msg, false);
                    }
                    break;
                case 'transfer_cage_food':
                    if (ok) {
                        addActionOk(msg.msg); showToast(msg.msg, true);
                        if (msg.cages && playerData) playerData.cages = msg.cages;
                        if (msg.items && playerData) playerData.items = msg.items;
                        renderCages();
                    } else {
                        addActionFail(msg.msg); showToast(msg.msg, false);
                    }
                    break;
                case 'my_cages': if (ok && playerData) { playerData.cages = msg.cages; playerData.animals = msg.animals; renderCages(); } break;
                case 'visit_farm':
                    if (ok) {
                        var isRefresh = (visitingOwner === msg.owner);
                        if (isRefresh) {
                            updateVisitPlots(msg.plots, msg.cages, msg.decorations);
                        } else {
                            renderVisitFarm(msg.owner, msg.farmId, msg.plots, msg.visitors, msg.cages, msg.decorations);
                            closePanel('panelVisit');
                            addActionOk('来到了 ' + msg.owner + ' 的农场');
                        }
                    } else {
                        renderVisitFarm(msg.owner, msg.farmId, msg.plots, msg.visitors, msg.cages, msg.decorations);
                        if (!visitingOwner) addActionFail(msg.msg);
                    }
                    break;
                case 'go_home':
                    if (ok) { visitingOwner = null; visitingFarmId = null; closePanel('panelVisit'); var vbar = document.getElementById('visitStatusBar'); if (vbar) vbar.remove(); var ft = document.querySelector('.farm-title'); if (ft && playerData) ft.innerHTML = '<span>🏡 我的农场</span><span class="farm-id" id="farmIdDisplay">ID: ' + (playerData.farmId || '???') + '</span>'; addActionOk('回到了自己的农场'); var ct = document.querySelector('.cage-title'); if (ct) ct.textContent = '🐾 圈养区'; doAction('my_farm'); } break;
                case 'friend_list': if (ok) { cachedFriendList = (msg.friends || []).map(function (f) { return f.username; }); renderFriendsPanel(msg.friends, msg.requests); } break;
                case 'friend_request': case 'friend_accept': case 'friend_reject': case 'friend_remove': if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); doAction('friend_list'); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'trade_create': if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); closePanel('panelTrade'); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'trade_list': if (ok) renderTradeList(msg.trades); break;
                case 'trade_accept': case 'trade_reject': case 'trade_cancel': if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); doAction('trade_list'); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'private_msg': if (ok) addActionOk(msg.msg); else addActionFail(msg.msg); break;
                case 'list_groups': if (ok) renderGroupsPanel(msg.groups); break;
                case 'create_group': if (ok) { addActionOk('群聊创建成功'); doAction('list_groups'); } else addActionFail(msg.msg); break;
                case 'invite_group': if (ok) addActionOk(msg.msg); else addActionFail(msg.msg); break;
                case 'leave_group': if (ok) { addActionOk(msg.msg); doAction('list_groups'); } else addActionFail(msg.msg); break;
                case 'group_msg': if (!ok) addActionFail(msg.msg); break;
                case 'my_pets': if (ok && playerData) { playerData.pets = msg.pets || []; renderPetsPanel(playerData.pets); } break;
                case 'catch_pet':
                    if (ok) { addActionOk(msg.msg); if (msg.pets && playerData) playerData.pets = msg.pets; if (msg.stamina !== undefined && playerData) { playerData.stamina = msg.stamina; updStamina(); } if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: true }; doAction('wild_areas'); } }
                    else { addActionFail(msg.msg); if (document.getElementById('panelWild').classList.contains('show')) { _pendingWildTip = { msg: msg.msg, ok: false }; doAction('wild_areas'); } } break;
                case 'rename_pet': if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); if (msg.pets && playerData) playerData.pets = msg.pets; doAction('my_pets'); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'pet_adventure':
                    if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); if (msg.pets && playerData) playerData.pets = msg.pets; if (document.getElementById('panelPetDetail').classList.contains('show') && msg.petId) openPetDetail(msg.petId); doAction('my_pets'); }
                    else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'pet_collect':
                    if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); if (msg.pets && playerData) playerData.pets = msg.pets; if (msg.seeds && playerData) playerData.seeds = msg.seeds; if (msg.fruits && playerData) playerData.fruits = msg.fruits; if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); } if (document.getElementById('panelPetDetail').classList.contains('show') && msg.petId) openPetDetail(msg.petId); doAction('my_pets'); }
                    else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'pet_interact':
                    if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); if (msg.pets && playerData) { playerData.pets = msg.pets; if (document.getElementById('panelPetDetail').classList.contains('show') && msg.petId) openPetDetail(msg.petId); } doAction('my_pets'); }
                    else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'release_pet': if (ok) { addActionOk(msg.msg); showToast(msg.msg, true); if (msg.pets && playerData) playerData.pets = msg.pets; if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); } closePanel('panelPetDetail'); doAction('my_pets'); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'world_ranking': if (ok) renderRankingPanel(msg.ranking, msg.myRank); break;
                case 'pet_ranking': if (ok) renderPetRankingPanel(msg.ranking, msg.myRank); break;
                case 'mail_list': if (ok) renderMailPanel(msg.mails); break;
                case 'mail_claim': if (ok) { if (msg.money !== undefined && playerData) { playerData.money = msg.money; updMoney(); } if (msg.seeds && playerData) playerData.seeds = msg.seeds; if (msg.fruits && playerData) playerData.fruits = msg.fruits; if (msg.pets && playerData) playerData.pets = msg.pets; doAction('mail_list'); } else addActionFail(msg.msg); break;
                case 'mail_delete': case 'mail_delete_all': if (ok) doAction('mail_list'); else addActionFail(msg.msg); break;
                case 'mail_read': if (ok) doAction('mail_list'); break;
                case 'mail_read_all': if (ok) { showToast(msg.msg, true); doAction('mail_list'); } break;
                case 'event_list': if (msg.ok) renderEventsPanel(msg.events, msg.playerProgress); break;
                case 'daily_tasks': if (msg.ok) renderDailyTasksPanel(msg.dailyTasks, msg.perfectBonus); else addActionFail(msg.msg); break;
                case 'claim_daily_task': if (msg.ok) { showToast(msg.msg, true); addActionOk(msg.msg); if (document.getElementById('panelDailyTasks').classList.contains('show')) doAction('daily_tasks'); } else { addActionFail(msg.msg); showToast(msg.msg, false); } break;
                case 'weekly_challenge_info': if (msg.ok) renderWeeklyChallengePanel(msg.challenge, msg.progress); else renderWeeklyChallengePanel(null, null); break;
                case 'claim_weekly_reward': if (msg.ok) { showToast(msg.msg, true); addActionOk(msg.msg); doAction('weekly_challenge_info'); } else { showToast(msg.msg, false); addActionFail(msg.msg); } break;
                case 'place_decoration': if (msg.ok) { addActionOk(msg.msg); if (msg.decorations) playerData.decorations = msg.decorations; renderDecorationsArea(playerData.decorations, false); if (document.getElementById('panelDecorations').classList.contains('show')) renderDecorationsPanel(); } else addActionFail(msg.msg); break;
                case 'remove_decoration': if (msg.ok) { addActionOk(msg.msg); if (msg.decorations) playerData.decorations = msg.decorations; renderDecorationsArea(playerData.decorations, false); if (document.getElementById('panelDecorations').classList.contains('show')) renderDecorationsPanel(); } else addActionFail(msg.msg); break;
                case 'cage_detail': if (msg.ok && msg.html) { document.getElementById('cageActionContent').innerHTML = msg.html; openPanel('panelCageAction'); window._currentFriendFarmId = msg.farmId; window._currentFriendCageId = msg.cageId; } else addActionFail(msg.msg || '无法获取圈养区详情'); break;
                case 'weekly_ranking': if (ok) renderWeeklyRankingPanel(msg.ranking, msg.myRank); break;
                default: if (msg.msg) { if (ok) addActionOk(msg.msg); else addActionFail(msg.msg); }
            }
        }

        // 登录/注册
        function doLogin() { var u = document.getElementById('loginUser').value.trim(), p = document.getElementById('loginPass').value; if (!u || !p) { showLoginMsg('请输入昵称和密码', false); return; } wsSend({ type: 'login', username: u, password: p }); }
        function doRegister() { var u = document.getElementById('loginUser').value.trim(), p = document.getElementById('loginPass').value; if (!u || !p) { showLoginMsg('请输入昵称和密码', false); return; } wsSend({ type: 'register', username: u, password: p }); }
        function doLogout() { username = null; farmId = null; currentWorld = null; playerData = null; clearTimers(); showPage('loginPage'); }
        function showLoginMsg(t, ok) { var e = document.getElementById('loginMsg'); e.textContent = t; e.className = 'login-msg ' + (ok ? 'ok' : 'err'); }
        function updLoginStatus(t, ok) { var e = document.getElementById('loginStatus'); if (e) { e.textContent = t; e.style.color = ok === true ? '#4ade80' : ok === false ? '#ef4444' : '#3a5a3a'; } }
        function showWorldsPage() { document.getElementById('displayUser').textContent = username; document.getElementById('displayFarmId').textContent = farmId || '???'; showPage('worldsPage'); wsSend({ type: 'list_worlds' }); }
        function showPage(id) { document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); }); document.getElementById(id).classList.add('active'); }

        function renderWorldList(list) {
            var c = document.getElementById('worldsList');
            if (!list || list.length === 0) { c.innerHTML = '<div class="no-worlds">暂无世界<br><span style="font-size:12px;color:#3a4a3a;">等待天道创建...</span></div>'; return; }
            var h = '';
            for (var i = 0; i < list.length; i++) {
                var w = list[i]; if (w.status !== 'active') continue;
                h += '<div class="world-card" data-wid="' + w.id + '" data-haspw="' + w.hasPassword + '" onclick="clickWorld(this)">';
                h += '<h3>🌾 ' + esc(w.name) + '</h3>';
                h += '<div class="world-info"><span>👥 ' + (w.playerCount || 0) + '人</span>';
                if (w.hasPassword) h += '<span>🔒 需密码</span>';
                h += '</div>';
                h += '<div class="world-pw-input" id="wpw_' + w.id + '" onclick="event.stopPropagation()"><input type="password" placeholder="输入密码" id="wpwi_' + w.id + '"><button onclick="enterWorld(\'' + w.id + '\')">进入</button></div></div>';
            }
            h += '<div style="padding:16px 0 8px;text-align:center;"><button class="action-btn action-btn-purple" style="padding:10px 24px;font-size:13px;" onclick="openFeedbackForm()">📝 意见反馈</button></div>';
            h += '<div id="feedbackFormArea" style="display:none;padding:0 12px 12px;"><div class="glass" style="padding:14px;border-radius:14px;">';
            h += '<div style="font-size:13px;color:#c4b5fd;margin-bottom:8px;">📝 意见反馈</div>';
            h += '<textarea id="feedbackText" placeholder="写下你的建议、bug反馈或想法..." class="input-dark" style="width:100%;min-height:80px;resize:vertical;font-family:inherit;border-radius:10px;"></textarea>';
            h += '<div class="flex-between" style="margin-top:8px;"><span class="text-muted">最多500字</span>';
            h += '<button class="action-btn action-btn-solid-green" style="padding:8px 20px;" onclick="submitFeedback()">提交反馈</button></div></div></div>';
            c.innerHTML = h;
        }
        function clickWorld(el) { var wid = el.getAttribute('data-wid'), hp = el.getAttribute('data-haspw') === 'true'; if (hp) { var d = document.getElementById('wpw_' + wid); d.style.display = d.style.display === 'block' ? 'none' : 'block'; } else enterWorld(wid); }
        function enterWorld(wid) { var pi = document.getElementById('wpwi_' + wid); wsSend({ type: 'enter_world', worldId: wid, password: pi ? pi.value : '' }); }

        function clearTimers() {
            if (window._farmRefreshTimer) { clearInterval(window._farmRefreshTimer); window._farmRefreshTimer = null; }
            if (window._localPlotTimer) { clearInterval(window._localPlotTimer); window._localPlotTimer = null; }
            if (cageUpdateTimer) { clearInterval(cageUpdateTimer); cageUpdateTimer = null; }
        }

        function enterGame(msg) {
            _inWorld = true; _lastVisitPlotsHash = ''; currentWorld = msg.world; playerData = msg.player; playerData._worldId = currentWorld.id;
            document.getElementById('gameWorldName').textContent = currentWorld.name;
            document.getElementById('farmIdDisplay').textContent = 'ID: ' + (playerData.farmId || '???');
            document.getElementById('gamePlayerInfo').textContent = username + ' · ID: ' + (playerData.farmId || '???');
            updSeason(currentWorld.season, currentWorld.weather); updStamina(); updMoney();
            renderPlots(); renderCages(); renderDecorationsArea(playerData.decorations, false);
            document.getElementById('msgArea').innerHTML = ''; addSysMsg('欢迎来到「' + currentWorld.name + '」');
            if (currentWorld.announcements) for (var i = 0; i < currentWorld.announcements.length; i++)addAnnounce(currentWorld.announcements[i].text);
            showPage('gamePage'); clearTimers();
            cageUpdateTimer = setInterval(function () { if (!visitingOwner) doAction('my_cages'); }, 15000);
            window._farmRefreshTimer = setInterval(function () { if (visitingOwner) doAction('visit_farm', { farmId: visitingFarmId }); else doAction('my_farm'); }, 10000);
            window._localPlotTimer = setInterval(localUpdatePlots, 5000);
            doAction('friend_list');
            if (msg.player && msg.player.dailyTasks && msg.player.dailyTasks.tasks) { var uc = msg.player.dailyTasks.tasks.filter(function (t) { return t.completed && !t.claimed; }); if (uc.length > 0) addSysMsg('📋 你有 ' + uc.length + ' 个每日任务奖励待领取'); }
        }

        function localUpdatePlots() {
            if (visitingOwner || !playerData || !playerData.plots) return;
            var now = Date.now() + serverTimeOffset, any = false;
            playerData.plots.forEach(function (pl) {
                if (pl.plant && !pl.plant.mature) {
                    var gt = pl.plant.effectiveGrowTime || pl.plant.growTime || 7200000;
                    var np = Math.max(0, Math.min(1, (now - pl.plant.plantedAt) / gt));
                    if (Math.abs(np - (pl.plant.progress || 0)) > 0.005) { pl.plant.progress = np; if (np >= 1) pl.plant.mature = true; any = true; }
                }
            });
            if (any) renderPlots();
        }

        function updStamina() { if (!playerData) return; var p = Math.round((playerData.stamina / (playerData.staminaMax || 100)) * 100); document.getElementById('staminaFill').style.width = p + '%'; document.getElementById('staminaVal').textContent = playerData.stamina + '/' + (playerData.staminaMax || 100); }
        function updMoney() { if (!playerData) return; document.getElementById('moneyTop').textContent = '💰 ' + playerData.money; }
        function updSeason(s, w) { var sm = { '春': '🌸 春', '夏': '☀️ 夏', '秋': '🍂 秋', '冬': '❄️ 冬' }, wm = { '晴': '☀️ 晴', '多云': '⛅ 多云', '阴': '☁️ 阴', '小雨': '🌦️ 小雨', '大雨': '🌧️ 大雨', '雪': '🌨️ 雪', '雾': '🌫️ 雾' }; if (s) document.getElementById('gameSeason').textContent = sm[s] || s; if (w) document.getElementById('gameWeather').textContent = wm[w] || w; }
        function refreshFarm() { updStamina(); updMoney(); renderPlots(); }

        function renderPlots() {
            if (!playerData) return;
            var g = document.getElementById('plotsGrid'), h = '';
            for (var i = 0; i < playerData.plots.length; i++) {
                var pl = playerData.plots[i];
                if (pl.plant) {
                    var progress = Math.max(0, Math.min(1, pl.plant.progress || 0));
                    var mature = pl.plant.mature || progress >= 1, pct = Math.floor(progress * 100);
                    h += '<div class="plot' + (mature ? ' mature' : '') + '" onclick="clickPlot(' + i + ')">';
                    h += '<span class="plot-icon">' + (mature ? (pl.plant.fruitIcon || '🍎') : (pl.plant.icon || '🌱')) + '</span>';
                    h += '<span class="plot-name">' + esc(pl.plant.name) + '</span>';
                    if (mature) h += '<span class="plot-progress" style="color:#fcd34d;">可收获！</span>';
                    else { h += '<span class="plot-progress">' + pct + '%</span><div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + pct + '%"></div></div>'; }
                    var tags = [];
                    if (pl.plant.selfWatered || pl.plant.watered) tags.push('💧');
                    if (pl.plant.fertilizerReduce > 0) tags.push('🧪');
                    var fwc = (pl.plant.friendWaters || []).length; if (fwc > 0) tags.push('👥x' + fwc);
                    if (tags.length > 0) h += '<span class="plot-progress" style="font-size:12px;">' + tags.join('') + '</span>';
                    h += '</div>';
                } else {
                    h += '<div class="plot empty" onclick="clickPlot(' + i + ')"><span class="plot-icon">➕</span><span class="plot-name">空地</span></div>';
                }
            }
            g.innerHTML = h;
        }

        function renderCages() {
            if (!playerData || !playerData.cages) return;
            document.getElementById('cagesGrid').innerHTML = buildCageHtml(playerData.cages);
        }

        function renderDecorationsArea(decorations, isVisiting) {
            var area = document.getElementById('decorationArea'), grid = document.getElementById('decorationsGrid'), title = area.querySelector('.decoration-title');
            decorations = decorations || [];
            title.textContent = '🎨 装饰区 (' + decorations.length + '/6)';
            if (decorations.length === 0) { grid.innerHTML = '<div class="text-muted w-full text-center p-10">暂无装饰</div>'; return; }
            var h = '';
            for (var i = 0; i < decorations.length; i++) {
                var d = decorations[i];
                h += '<div class="decoration-item"><div class="d-icon">' + (d.icon || '🎨') + '</div><div class="d-name">' + esc(d.name || '未知装饰') + '</div>';
                if (!isVisiting) h += '<div class="decoration-remove-btn" onclick="removeDecoration(\'' + d.id + '\')">×</div>';
                h += '</div>';
            }
            grid.innerHTML = h;
        }

        function clickCage(cageId) {
            if (!playerData) return;
            if (visitingOwner) {
                addSysMsg('正在操作 ' + visitingOwner + ' 的圈养区');
                doAction('cage_detail', { farmId: visitingFarmId, cageId: cageId });
                return;
            }

            var cage = playerData.cages[cageId], h = '';

            if (!cage.animal) {
                // === 空圈状态 ===
                h += '<div class="text-center mb-12 text-13" style="color:#7a9a7a;">第' + (cageId + 1) + '个圈 · 空圈</div>';

                if (!playerData.animals || playerData.animals.length === 0) {
                    h += '<div class="text-center p-12" style="color:#4a5a4a;">没有动物，去野外捕捉吧</div>';
                } else {
                    h += '<div class="text-12 mb-8" style="color:#5a7a5a;">选择动物放入：</div><div class="flex-col-6">';
                    for (var i = 0; i < playerData.animals.length; i++) {
                        var a = playerData.animals[i];
                        h += '<div class="glass flex-between p-8"><span class="text-13">' + (a.icon || '🐾') + ' ' + esc(a.name) + ' <span class="text-muted">x' + a.count + '</span></span>';
                        h += '<div class="flex-gap-4"><input type="number" id="placeCount_' + i + '" value="1" min="1" max="' + a.count + '" class="input-dark input-sm"><button class="action-btn action-btn-solid-green" onclick="doPlaceAnimal(' + cageId + ',\'' + a.id + '\',' + i + ')">放入</button></div></div>';
                    }
                    h += '</div>';
                }
            } else {
                // === 已有动物状态 ===
                var a = cage.animal, starving = cage.food < 0, foodStatus = cage.food >= 0 ? Math.floor(cage.food) : 0;
                var realH = calcRealTimeLeft(cage), timeStr = formatHours(realH);

                // 计算并显示繁衍状态
                var breedCount = a.breedCount || 0;
                var breedStatusStr = '';
                if (a.count < 2) {
                    breedStatusStr = '<span style="color:#888;">(数量不足无法繁殖)</span>';
                } else if (breedCount >= 10) {
                    breedStatusStr = '<span style="color:#ef4444;font-weight:bold;">(已绝育)</span>';
                } else {
                    breedStatusStr = '<span style="color:#a5d6a7;">(已生育 ' + breedCount + '/10 次)</span>';
                }

                h += '<div class="text-center mb-12"><div style="font-size:36px;margin-bottom:6px;">' + (a.icon || '🐾') + '</div>';
                h += '<div style="font-size:16px;color:#fcd34d;">' + esc(a.name) + '</div>';
                h += '<div class="text-muted" style="margin-top:4px;">第' + (cageId + 1) + '个圈</div>';
                h += '<div style="font-size:14px;color:#67e8f9;margin-top:6px;">数量: ' + a.count + ' 只 ' + breedStatusStr + '</div>';
                if (starving) {
                    h += '<div style="font-size:13px;color:#ef4444;margin-top:6px;">⚠️ 食物不足！动物正在死亡</div>';
                } else {
                    h += '<div style="font-size:13px;color:#a5d6a7;margin-top:6px;">🍖 食物: ' + foodStatus + ' (预计还能撑 ' + timeStr + ')</div>';
                }
                h += '<div class="text-muted" style="margin-top:4px;">消耗: ' + a.foodPerHour + '/小时 | 售价: 💰' + a.sellPrice + '/只</div></div><div class="flex-col-6">';

                var sa = (playerData.animals || []).filter(function (an) { return an.id === a.id; });
                if (sa.length > 0) {
                    var s0 = sa[0], si = playerData.animals.indexOf(s0);
                    h += '<div class="glass p-8" style="margin-bottom:4px;"><div class="text-12" style="color:#67e8f9;margin-bottom:4px;">➕ 追加同种（库存 ' + s0.count + '）：</div><div class="flex-gap-4"><input type="number" id="addMoreCount" value="1" min="1" max="' + s0.count + '" class="input-dark input-num"><button class="action-btn action-btn-cyan" style="flex:1;" onclick="doPlaceAnimal(' + cageId + ',\'' + a.id + '\',' + si + ',true)">追加</button><button class="action-btn action-btn-cyan" onclick="doPlaceAnimalAll(' + cageId + ',\'' + a.id + '\',' + s0.count + ')">全部</button></div></div>';
                }

                h += '<div class="glass p-8"><div class="text-12 mb-6" style="color:#5a7a5a;">喂食：</div>';
                var hasFood = false;
                var feeds = (playerData.items || []).filter(function (it) { return it.type === 'feed' && !it.unsalable; });
                if (feeds.length > 0) {
                    hasFood = true;
                    h += '<div class="mb-6"><select id="feedFeedSelect" class="input-dark w-full mb-6">';
                    for (var fi = 0; fi < feeds.length; fi++) {
                        var f = feeds[fi];
                        h += '<option value="' + f.id + '">' + (f.icon || '🥡') + ' ' + esc(f.name) + ' (+' + ((f.effect && f.effect.foodValue) ? f.effect.foodValue : 20) + ') x' + f.count + '</option>';
                    }
                    h += '</select><div class="flex-gap-4"><input type="number" id="feedFeedCount" value="1" min="1" class="input-dark input-num"><button class="action-btn action-btn-pink" style="flex:1;" onclick="doFeedAnimal(' + cageId + ',\'feed\')">✨ 喂饲料</button></div></div>';
                }

                if (playerData.seeds && playerData.seeds.length > 0) {
                    hasFood = true;
                    h += '<div class="mb-6"><select id="feedSeedSelect" class="input-dark w-full mb-6">';
                    for (var si2 = 0; si2 < playerData.seeds.length; si2++) { var s = playerData.seeds[si2]; h += '<option value="' + s.id + '">🌱 ' + esc(s.name) + ' (x' + s.count + ')</option>'; }
                    h += '</select><div class="flex-gap-4"><input type="number" id="feedSeedCount" value="1" min="1" class="input-dark input-num"><button class="action-btn action-btn-green" style="flex:1;" onclick="doFeedAnimal(' + cageId + ',\'seed\')">喂种子(+1)</button></div></div>';
                }

                if (playerData.fruits && playerData.fruits.length > 0) {
                    hasFood = true;
                    h += '<div class="mb-6"><select id="feedFruitSelect" class="input-dark w-full mb-6">';
                    for (var fi2 = 0; fi2 < playerData.fruits.length; fi2++) { var f2 = playerData.fruits[fi2]; h += '<option value="' + f2.id + '">🍎 ' + esc(f2.name) + ' (x' + f2.count + ')</option>'; }
                    h += '</select><div class="flex-gap-4"><input type="number" id="feedFruitCount" value="1" min="1" class="input-dark input-num"><button class="action-btn action-btn-gold" style="flex:1;" onclick="doFeedAnimal(' + cageId + ',\'fruit\')">喂果实(+5)</button></div></div>';
                }
                if (!hasFood) h += '<div class="text-11 text-center p-10" style="color:#3a4a3a;">没有食物</div>';
                h += '</div>';

                h += '<div class="glass p-8" style="border-color:rgba(239,68,68,0.2);"><div class="text-12 mb-6" style="color:#5a7a5a;">出售动物：</div><div class="flex-gap-4"><input type="number" id="sellAnimalCount" value="1" min="1" max="' + a.count + '" class="input-dark input-num"><button class="action-btn action-btn-gold" style="flex:1;" onclick="doSellAnimal(' + cageId + ',false)">卖出</button><button class="action-btn action-btn-red" onclick="doSellAnimal(' + cageId + ',true)">全卖</button></div></div></div>';
            }

            // == 饲料槽存取UI (动态读取所有饲料) ==
            var allFeeds = (playerData.items || []).filter(function (it) { return it.type === 'feed' && !it.unsalable; });
            // 补充查找已搅拌饲料(它是unsalable的)
            var ufItem = (playerData.items || []).find(function (it) { return it.id === 'universal_feed'; });
            if (ufItem) allFeeds.unshift(ufItem); // 放到列表第一位

            h += '<div class="glass p-8" style="margin-top:8px; border-color:rgba(106,191,105,0.3);">';
            h += '<div class="text-12 mb-6" style="color:#a5d6a7;">🌿 饲料槽</div>';
            h += '<div class="text-11 text-muted mb-6">槽内当前存粮: ' + Math.floor(cage.food || 0) + ' 点</div>';

            // 存入区域
            if (allFeeds.length > 0) {
                h += '<div class="mb-6"><select id="troughDepositSelect" class="input-dark w-full mb-6">';
                for (var fi = 0; fi < allFeeds.length; fi++) {
                    var f = allFeeds[fi];
                    var fv = (f.effect && f.effect.foodValue) ? f.effect.foodValue : 20;
                    h += '<option value="' + f.id + '">' + (f.icon || '🥡') + ' ' + esc(f.name) + ' (+' + fv + '点/个) 拥有:x' + f.count + '</option>';
                }
                h += '</select>';
                h += '<div class="flex-gap-4">';
                h += '<input type="number" id="troughDepositCount" value="1" min="1" class="input-dark input-num">';
                h += '<button class="action-btn action-btn-solid-green" style="flex:1;" onclick="doTransferCageFood(' + cageId + ',\'deposit\')">存入所选饲料</button>';
                h += '</div></div>';
            } else {
                h += '<div class="text-11 text-muted mb-6">背包中没有饲料可存入。</div>';
            }

            // 取出区域 (固定取出为已搅拌饲料，1点=1个)
            h += '<div style="border-top:1px solid rgba(106,191,105,0.15); margin-top:8px; padding-top:8px;">';
            h += '<div class="text-11 text-muted mb-6" style="color:#7a9a7a;">将存粮打包为「已搅拌饲料」(1点=1个)取出：</div>';
            h += '<div class="flex-gap-4">';
            h += '<input type="number" id="troughWithdrawCount" value="1" min="1" class="input-dark input-num">';
            h += '<button class="action-btn action-btn-dark" style="flex:1;" onclick="doTransferCageFood(' + cageId + ',\'withdraw\')">取出存粮</button>';
            h += '</div></div>';
            h += '</div>';

            document.getElementById('cageActionContent').innerHTML = h;
            openPanel('panelCageAction');
        }

        // 补充辅助调用函数 (放在 clickCage 同级即可)
        function doTransferCageFood(cageId, transferType) {
            var amount = 1;
            var itemId = null;

            if (transferType === 'deposit') {
                var countInput = document.getElementById('troughDepositCount');
                var sel = document.getElementById('troughDepositSelect');
                if (!sel || !sel.value) return; // 没有饲料
                itemId = sel.value;
                amount = parseInt(countInput.value) || 1;
            } else if (transferType === 'withdraw') {
                var countInput = document.getElementById('troughWithdrawCount');
                amount = parseInt(countInput.value) || 1;
            }

            doAction('transfer_cage_food', {
                cageId: cageId,
                transferType: transferType,
                amount: amount,
                itemId: itemId
            });
            closePanel('panelCageAction');
        }

        function doFeedFriendAnimal(farmId, cageId, feedType) {
            var itemId, count;
            if (feedType === 'seed') { var sel = document.getElementById('feedSeedSelect'), ci = document.getElementById('feedSeedCount'); itemId = sel ? sel.value : ''; count = ci ? parseInt(ci.value) : 1; }
            else if (feedType === 'fruit') { var sel = document.getElementById('feedFruitSelect'), ci = document.getElementById('feedFruitCount'); itemId = sel ? sel.value : ''; count = ci ? parseInt(ci.value) : 1; }
            else if (feedType === 'feed') { var sel = document.getElementById('feedFeedSelect'), ci = document.getElementById('feedFeedCount'); itemId = sel ? sel.value : ''; count = ci ? parseInt(ci.value) : 1; }
            if (!itemId) return;
            doAction('visit_farm', { farmId: farmId });
            setTimeout(function () { doAction('feed_animal', { cageId: cageId, feedType: feedType, itemId: itemId, count: count }); closePanel('panelCageAction'); }, 300);
        }
        function doPlaceAnimal(cageId, animalId, idx, isAdd) { var ci = isAdd ? document.getElementById('addMoreCount') : document.getElementById('placeCount_' + idx); doAction('place_animal', { cageId: cageId, animalId: animalId, count: ci ? parseInt(ci.value) : 1 }); }
        function doPlaceAnimalAll(cageId, animalId, total) { doAction('place_animal', { cageId: cageId, animalId: animalId, count: total }); }
        function doFeedAnimal(cageId, feedType) {
            var itemId, count;
            if (feedType === 'seed') { var s = document.getElementById('feedSeedSelect'), c = document.getElementById('feedSeedCount'); itemId = s ? s.value : ''; count = c ? parseInt(c.value) : 1; }
            else if (feedType === 'fruit') { var s = document.getElementById('feedFruitSelect'), c = document.getElementById('feedFruitCount'); itemId = s ? s.value : ''; count = c ? parseInt(c.value) : 1; }
            else if (feedType === 'feed') { var s = document.getElementById('feedFeedSelect'), c = document.getElementById('feedFeedCount'); itemId = s ? s.value : ''; count = c ? parseInt(c.value) : 1; }
            if (!itemId) return; doAction('feed_animal', { cageId: cageId, feedType: feedType, itemId: itemId, count: count }); closePanel('panelCageAction');
        }
        function doSellAnimal(cageId, sellAll) {
            var count = 1; if (!sellAll) { var ci = document.getElementById('sellAnimalCount'); count = ci ? parseInt(ci.value) : 1; }
            if (!confirm(sellAll ? '确定卖出全部动物？' : '确定卖出 ' + count + ' 只动物？')) return;
            doAction('sell_animal', { cageId: cageId, count: count, sellAll: sellAll });
        }
        function doCatch(i) { doAction('catch_animal', { areaIndex: i }); }
        function doVisitWater(plotId) { doAction('water', { plotId: plotId }); }

        function clickPlot(plotId) {
            if (!playerData) return;
            var pl = playerData.plots[plotId], h = '';

            if (!pl.plant) {
                // === 空地状态：显示选种列表 ===
                h += '<div class="text-center mb-12 text-13" style="color:#7a9a7a;">第' + (plotId + 1) + '块地 · 空地</div>';

                if (!playerData.seeds || playerData.seeds.length === 0) {
                    h += '<div class="text-center p-12" style="color:#4a5a4a;">没有种子，去野外采集或商店购买吧</div>';
                } else {
                    h += '<div class="text-12 mb-8" style="color:#5a7a5a;">选择种子种植：</div>';
                    h += '<div class="flex-col-6">'; // 包裹一层容器

                    for (var i = 0; i < playerData.seeds.length; i++) {
                        var s = playerData.seeds[i];
                        if (!s) continue; // 容错

                        var gm = Math.round(s.growTime / 60000);
                        var gt = gm >= 60 ? (Math.round(gm / 60 * 10) / 10 + '小时') : (gm + '分钟');

                        // 确保ID被转义，防止单引号破坏HTML
                        var safeSeedId = s.id.replace(/'/g, "\\'");

                        h += '<div class="glass flex-between p-8" style="cursor:pointer;margin-bottom:6px;" onclick="doPlant(' + plotId + ',\'' + safeSeedId + '\')">';
                        h += '  <div>';
                        h += '    <div class="text-13">' + (s.icon || '🌱') + ' ' + esc(s.name) + ' <span class="text-muted">x' + s.count + '</span></div>';
                        h += '    <div class="text-11" style="color:#5a7a5a;margin-top:2px;">生长: ' + gt + ' → ' + (s.fruitIcon || '🍎') + esc(s.fruitName) + '</div>';
                        h += '  </div>';
                        h += '  <div class="btn-td btn-green" style="padding:4px 12px;">种植</div>';
                        h += '</div>';
                    }
                    h += '</div>'; // 关闭 flex-col-6
                }
            } else {
                // === 已种植状态 ===
                var progress = Math.max(0, Math.min(1, pl.plant.progress || 0));
                var mature = pl.plant.mature || progress >= 1;
                var pct = Math.floor(progress * 100);

                var gt2 = pl.plant.effectiveGrowTime || pl.plant.growTime || 7200000;
                var now = Date.now() + serverTimeOffset;
                var remainMs = Math.max(0, gt2 - (now - pl.plant.plantedAt));
                var remainMin = Math.ceil(remainMs / 60000);
                var remainText = remainMin >= 60 ? (Math.floor(remainMin / 60) + '时' + (remainMin % 60) + '分') : (remainMin + '分钟');

                h += '<div class="text-center mb-12">';
                h += '<div style="font-size:36px;margin-bottom:6px;">' + (mature ? (pl.plant.fruitIcon || '🍎') : (pl.plant.icon || '🌱')) + '</div>';
                h += '<div style="font-size:16px;color:#a5d6a7;">' + esc(pl.plant.name) + '</div>';
                h += '<div class="text-muted" style="margin-top:4px;">第' + (plotId + 1) + '块地</div>';

                if (mature) {
                    h += '<div style="font-size:14px;color:#fcd34d;margin-top:6px;">🎉 已成熟！</div>';
                } else {
                    h += '<div style="font-size:13px;color:#7a9a7a;margin-top:6px;">成长进度: ' + pct + '%</div>';
                    h += '<div style="width:80%;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;margin:6px auto;overflow:hidden;">';
                    h += '  <div style="height:100%;width:' + pct + '%;background:linear-gradient(90deg,#2e7d32,#4caf50);border-radius:3px;"></div>';
                    h += '</div>';
                    h += '<div class="text-11" style="color:#5a7a5a;">预计还需: ' + remainText + '</div>';
                }

                // 标签展示
                var tags = [];
                if (pl.plant.selfWatered || pl.plant.watered) tags.push('💧 已浇水');
                if (pl.plant.fertilizerReduce > 0) tags.push('🧪 已施肥');
                var fw = pl.plant.friendWaters || [];
                if (fw.length > 0) {
                    var tr = 0;
                    fw.forEach(function (f) { tr += f.reduce || 0; });
                    tags.push('👥 ' + fw.length + '人浇水（-' + Math.round(tr / 60000) + '分）');
                }
                if (tags.length > 0) {
                    h += '<div class="text-11" style="color:#4a5a4a;margin-top:4px;">' + tags.join(' · ') + '</div>';
                }

                h += '</div><div class="flex-col-6">';

                if (mature) {
                    h += '<button class="action-btn action-btn-solid-green w-full" style="padding:12px;font-size:14px;" onclick="doHarvest(' + plotId + ')">🌾 收获</button>';
                } else {
                    if (!pl.plant.selfWatered) {
                        h += '<button class="action-btn action-btn-blue w-full" style="padding:10px;" onclick="doWater(' + plotId + ')">💧 浇水（免费，减少生长时间）</button>';
                    }
                    var ferts = (playerData.items || []).filter(function (it) { return it.type === 'fertilizer'; });
                    if (ferts.length > 0) {
                        for (var fi = 0; fi < ferts.length; fi++) {
                            var f = ferts[fi];
                            h += '<button class="action-btn action-btn-gold w-full" style="padding:10px;" onclick="doFertilize(' + plotId + ',\'' + f.id + '\')">🧪 ' + esc(f.name) + ' (x' + f.count + ')</button>';
                        }
                    } else {
                        h += '<div class="text-11 text-center" style="color:#3a4a3a;padding:6px;">没有肥料，可以去商店购买</div>';
                    }
                }

                h += '<div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px;">';
                h += '<button class="action-btn action-btn-red w-full" onclick="doRemovePlant(' + plotId + ')">🗑️ 铲除作物 (无法找回)</button></div></div>';
            }

            document.getElementById('plotActionContent').innerHTML = h;
            openPanel('panelPlotAction');
        }

        function doPlant(p, s) { doAction('plant', { plotId: p, seedId: s }); }
        function doWater(p) { doAction('water', { plotId: p }); closePanel('panelPlotAction'); }
        function doFertilize(p, id) { doAction('fertilize', { plotId: p, itemId: id }); }
        function doHarvest(p) { doAction('harvest', { plotId: p }); }
        function doRemovePlant(p) { if (!confirm('⚠️ 确定铲除？种子和果实都将消失！')) return; doAction('remove_plant', { plotId: p }); closePanel('panelPlotAction'); }
        function doWaterAll() { if (visitingOwner) { alert('不能一键给别人浇水'); return; } doAction('water_all'); }
        function doHarvestAll() { if (visitingOwner) return; doAction('harvest_all'); }

        // 装饰
        function openDecorations() { renderDecorationsPanel(); openPanel('panelDecorations'); }
        function renderDecorationsPanel() {
            if (!playerData) return; var h = '';
            h += '<div class="mb-12"><div class="text-12 text-green mb-6">🏡 已放置的装饰</div>';
            if (playerData.decorations && playerData.decorations.length > 0) {
                h += '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
                for (var i = 0; i < playerData.decorations.length; i++) { var d = playerData.decorations[i]; h += '<div class="glass text-center p-8"><div style="font-size:24px;">' + (d.icon || '🎨') + '</div><div class="text-11" style="color:#aaa;">' + esc(d.name) + '</div><button class="action-btn action-btn-red" style="margin-top:4px;padding:2px 8px;font-size:10px;" onclick="removeDecoration(\'' + d.id + '\')">收起</button></div>'; }
                h += '</div>';
            } else h += '<div class="text-muted p-8">还没有放置装饰物</div>';
            h += '</div><div class="mb-12"><div class="text-12 text-gold mb-6">📦 可用装饰</div>';
            var decs = (playerData.items || []).filter(function (it) { return it.type === 'decoration'; });
            if (decs.length > 0) {
                h += '<div class="flex-col-6">';
                for (var i = 0; i < decs.length; i++) {
                    var it = decs[i], pc = (playerData.decorations || []).filter(function (d) { return d.id === it.id; }).length, rem = it.count - pc;
                    if (rem > 0) { h += '<div class="glass flex-between p-8"><div class="flex-gap-6" style="align-items:center;"><span style="font-size:20px;">' + (it.icon || '🎨') + '</span><div><div class="text-13 text-green">' + esc(it.name) + '</div><div class="text-muted">剩余 ' + rem + ' 个</div></div></div><button class="btn-td btn-green" onclick="placeDecoration(\'' + it.id + '\')">放置</button></div>'; }
                }
                h += '</div>';
            } else { h += '<div class="text-muted p-8">没有装饰物道具，可以去商店购买</div><button class="action-btn action-btn-gold w-full" style="margin-top:4px;" onclick="openShop()">🏪 去商店</button>'; }
            h += '</div>';
            document.getElementById('decorationsContent').innerHTML = h;
        }
        function placeDecoration(id) { doAction('place_decoration', { itemId: id, position: { x: 0, y: playerData.decorations ? playerData.decorations.length : 0 } }); setTimeout(function () { renderDecorationsPanel(); refreshFarm(); }, 300); }
        function removeDecoration(id) { if (!confirm('确定收起这个装饰物？')) return; doAction('remove_decoration', { decorationId: id }); setTimeout(function () { renderDecorationsPanel(); refreshFarm(); }, 300); }

        // 周挑战
        function openWeeklyChallenge() {
            document.getElementById('weeklyChallengeContent').innerHTML = loadingPlaceholder();
            openPanel('panelWeeklyChallenge');
            doAction('weekly_challenge_info');
        }
        function renderWeeklyChallengePanel(ch, prog) {
            var h = '';
            if (!ch) {
                h += '<div class="text-center p-12" style="color:#4a5a4a;"><div style="font-size:36px;margin-bottom:10px;">📅</div><div class="text-13">暂无周挑战</div><div class="text-muted" style="margin-top:4px;">等待天道开启新挑战</div></div>';
                document.getElementById('weeklyChallengeContent').innerHTML = h;
                return;
            }

            var now = Date.now(), st = new Date(ch.startTime), et = new Date(ch.endTime), tr = et - now, dr = Math.floor(tr / 86400000), hr = Math.floor((tr % 86400000) / 3600000);

            h += '<div class="text-center mb-12"><div style="font-size:16px;color:#fcd34d;font-weight:600;">' + esc(ch.name) + '</div>';
            if (ch.desc) h += '<div class="text-12" style="color:#5a7a5a;margin-top:4px;">' + esc(ch.desc) + '</div>';
            h += '<div class="text-11" style="color:#4a5a4a;margin-top:6px;">' + st.toLocaleDateString() + ' ~ ' + et.toLocaleDateString() + '</div>';
            h += '<div class="text-12" style="color:#67e8f9;margin-top:4px;">⏳ 剩余 ' + dr + '天' + hr + '小时</div></div>';

            // 任务列表
            h += '<div style="margin:12px 0;"><div class="text-13 text-green mb-6">📋 挑战任务</div>';
            var tasks = ch.tasks || [], allDone = true;

            for (var i = 0; i < tasks.length; i++) {
                var t = tasks[i], tp = prog && prog.tasks ? (prog.tasks[i] || 0) : 0, done = tp >= t.targetCount, pct = Math.min(100, Math.floor((tp / t.targetCount) * 100));
                if (!done) allDone = false;

                h += '<div class="glass p-10 mb-6" style="border-color:' + (done ? 'rgba(76,175,80,0.25)' : 'rgba(255,255,255,0.06)') + ';background:' + (done ? 'rgba(76,175,80,0.06)' : 'transparent') + ';">';
                h += '  <div class="flex-between mb-6">';
                h += '    <span style="color:' + (done ? '#a5d6a7' : '#aaa') + ';">' + getTaskTypeName(t.type) + ' x' + t.targetCount + '</span>';
                h += '    <span style="color:' + (done ? '#4ade80' : '#5a7a5a') + ';">' + tp + '/' + t.targetCount + '</span>';
                h += '  </div>';
                h += '  <div style="width:100%;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;">';
                h += '    <div style="height:100%;width:' + pct + '%;background:' + (done ? '#4caf50' : '#fbbf24') + ';border-radius:2px;"></div>';
                h += '  </div>';
                h += '</div>';
            }
            h += '</div>';

            // 奖励列表
            if (ch.rewards && ch.rewards.length > 0) {
                h += '<div class="glass p-10 mb-12" style="border-color:rgba(251,191,36,0.12);">';
                h += '<div class="text-12 text-gold mb-6">🎁 挑战奖励</div><div style="display:flex;flex-wrap:wrap;gap:6px;">';
                for (var i = 0; i < ch.rewards.length; i++) {
                    var r = ch.rewards[i];
                    if (r.type === 'money') h += '<span class="glass p-8 text-11 text-gold" style="padding:4px 8px;">💰 ' + r.amount + '金币</span>';
                    else if (r.type === 'seed' && r.data) h += '<span class="glass p-8 text-11 text-green" style="padding:4px 8px;">' + (r.data.icon || '🌱') + ' ' + r.data.name + ' x' + (r.data.count || 1) + '</span>';
                    else if (r.type === 'fruit' && r.data) h += '<span class="glass p-8 text-11 text-green" style="padding:4px 8px;">' + (r.data.icon || '🍎') + ' ' + r.data.name + ' x' + (r.data.count || 1) + '</span>';
                    else if (r.type === 'pet' && r.data) h += '<span class="glass p-8 text-11" style="padding:4px 8px;color:#c4b5fd;">' + (r.data.speciesIcon || '🐱') + ' ' + r.data.species + '·' + (r.data.name || r.data.species) + '</span>';
                }
                h += '</div></div>';
            }

            // 底部按钮状态
            if (prog && prog.completed) {
                if (prog.claimed) {
                    h += '<div class="glass text-center p-12 text-13" style="color:#5a7a5a;">✅ 奖励已领取</div>';
                } else {
                    h += '<button class="btn btn-green" onclick="claimWeeklyReward()">🎁 领取奖励</button>';
                }
            } else if (allDone) {
                h += '<div class="text-center text-12" style="color:#4ade80;padding:8px;">✨ 任务已完成！等待结算...</div>';
                h += '<button class="btn btn-green" style="margin-top:4px;" onclick="refreshWeeklyChallenge()">🔄 刷新状态</button>';
            } else {
                h += '<div class="text-center text-12" style="color:#5a7a5a;padding:8px;">完成所有任务领取丰厚奖励</div>';
            }

            document.getElementById('weeklyChallengeContent').innerHTML = h;
        }
        function claimWeeklyReward() { doAction('claim_weekly_reward'); }
        function refreshWeeklyChallenge() { doAction('weekly_challenge_info'); }
        function getTaskTypeName(t) { var m = { 'harvest': '🌾 收获果实', 'gather': '🌿 野外采集', 'plant': '🌱 种植作物', 'catch_animal': '🐾 捕获动物', 'catch_pet': '🐱 捕获宠物', 'sell': '💰 卖出物品', 'shop_buy': '🏪 商店购买', 'water_friend': '💧 好友浇水', 'feed_friend': '🍖 好友喂食', 'pet_adventure': '🗺️ 宠物寻宝', 'visit': '🏠 串门' }; return m[t] || t; }

        // Toast
        function showToast(msg, ok) {
            var dm = msg && msg.length > 100 ? msg.substring(0, 100) + '...' : msg;
            var t = document.createElement('div');
            t.style.cssText = 'position:fixed;top:20%;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:14px;font-size:14px;font-weight:600;color:#fff;z-index:9999;pointer-events:none;opacity:0;transition:opacity 0.3s,top 0.3s;white-space:normal;max-width:90vw;text-align:center;word-break:break-word;backdrop-filter:blur(8px);' + (ok ? 'background:rgba(67,160,71,0.92);box-shadow:0 4px 20px rgba(76,175,80,0.3);' : 'background:rgba(211,47,47,0.92);box-shadow:0 4px 20px rgba(239,68,68,0.3);');
            t.textContent = dm; document.body.appendChild(t);
            requestAnimationFrame(function () { t.style.opacity = '1'; t.style.top = '16%'; });
            setTimeout(function () { t.style.opacity = '0'; t.style.top = '12%'; setTimeout(function () { if (t.parentNode) t.parentNode.removeChild(t); }, 300); }, 3000);
        }
        function showAdventureToast(text, rewards) {
            var t = document.createElement('div');
            t.style.cssText = 'position:fixed;top:30%;left:50%;transform:translateX(-50%);padding:16px 24px;border-radius:18px;font-size:14px;color:#fff;z-index:9999;pointer-events:none;opacity:0;transition:opacity 0.3s,top 0.3s;white-space:normal;max-width:90vw;text-align:center;word-break:break-word;background:linear-gradient(135deg,#7c3aed,#a78bfa);box-shadow:0 4px 24px rgba(167,139,250,0.35);backdrop-filter:blur(8px);';
            var rh = ''; if (rewards && rewards.length > 0) rh = '<div style="font-size:12px;margin-top:8px;color:#fcd34d;">🎁 获得: ' + rewards.join(' ') + '</div>';
            t.innerHTML = '<div style="font-size:16px;margin-bottom:4px;">✨ 奇遇 ✨</div><div>' + text + '</div>' + rh;
            document.body.appendChild(t);
            requestAnimationFrame(function () { t.style.opacity = '1'; t.style.top = '25%'; });
            setTimeout(function () { t.style.opacity = '0'; t.style.top = '20%'; setTimeout(function () { if (t.parentNode) t.parentNode.removeChild(t); }, 300); }, 5000);
        }
        function showWildTip(msg, ok) { showToast(msg, ok); }
        function showHolidayTaskComplete(en, td, tn, tc) {
            var t = document.createElement('div');
            t.style.cssText = 'position:fixed;top:20%;left:50%;transform:translateX(-50%);padding:16px 24px;border-radius:18px;font-size:14px;color:#fff;z-index:9999;pointer-events:none;opacity:0;transition:opacity 0.3s,top 0.3s;white-space:normal;max-width:90vw;text-align:center;word-break:break-word;background:linear-gradient(135deg,#fcd34d,#fbbf24);box-shadow:0 4px 24px rgba(251,191,36,0.35);';
            t.innerHTML = '<div style="font-size:16px;margin-bottom:4px;">🎉 节日任务完成 🎉</div><div style="font-size:13px;color:#1e2e1e;">' + esc(td) + '</div><div style="font-size:14px;margin-top:6px;">获得称号：<span style="color:' + tc + ';font-weight:600;">[' + esc(tn) + ']</span></div>';
            document.body.appendChild(t);
            requestAnimationFrame(function () { t.style.opacity = '1'; t.style.top = '25%'; });
            setTimeout(function () { t.style.opacity = '0'; t.style.top = '20%'; setTimeout(function () { if (t.parentNode) t.parentNode.removeChild(t); }, 300); }, 5000);
        }

        // 野外
        function openWild() { document.getElementById('wildContent').innerHTML = loadingPlaceholder(); openPanel('panelWild'); doAction('wild_areas'); }
        function renderWildPanel(areas, stamina, staminaMax) {
            var h = '<div class="text-12 mb-12" style="color:#5a7a5a;">⚡ 体力: ' + stamina + '/' + staminaMax + '</div>';
            if (!areas || areas.length === 0) { h += '<div class="text-center p-12" style="color:#4a5a4a;">这个世界没有野外区域</div>'; }
            else {
                for (var i = 0; i < areas.length; i++) {
                    var a = areas[i];
                    h += '<div class="wild-area-card"><div class="wa-name">' + (a.icon || '🌿') + ' ' + esc(a.name) + '</div><div class="wa-desc">' + esc(a.desc || '') + '</div>';
                    if (a.seedNames && a.seedNames.length > 0) h += '<div class="wa-seeds">🌱 种子: ' + a.seedNames.join('、') + '</div>';
                    if (a.animalNames && a.animalNames.length > 0) h += '<div class="text-11" style="color:#fcd34d;margin-top:3px;">🐾 动物: ' + a.animalNames.join('、') + '</div>';
                    if (a.petNames && a.petNames.length > 0) h += '<div class="text-11" style="color:#c4b5fd;margin-top:3px;">🐱 宠物: ' + a.petNames.join('、') + '</div>';
                    h += '<div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">';
                    h += '<button class="action-btn action-btn-green" style="flex:1;min-width:80px;" onclick="doGather(' + i + ')">🌿 采集(25体)</button>';
                    h += '<button class="action-btn action-btn-gold" style="flex:1;min-width:80px;" onclick="doCatch(' + i + ')">🐾 捕猎(30体)</button>';
                    h += '<button class="action-btn action-btn-purple" style="flex:1;min-width:80px;" onclick="doCatchPet(' + i + ')">🐱 捉宠(20体)</button>';
                    h += '</div></div>';
                }
            }
            h += '<div style="margin-top:12px;"><button class="action-btn action-btn-cyan w-full" style="padding:10px;font-size:13px;" onclick="doRest()">💤 休息（恢复35体力，CD 10分钟）</button></div>';
            document.getElementById('wildContent').innerHTML = h;
        }
        function doGather(i) { doAction('gather', { areaIndex: i }); }
        function doRest() { doAction('rest'); }
        function doCatchPet(i) { doAction('catch_pet', { areaIndex: i }); }

        // 串门
        function openVisit() {
            var h = '<div class="mb-12"><div class="text-12 mb-6" style="color:#5a7a5a;">输入对方的领地ID去串门：</div>';
            h += '<div class="flex-gap-6"><input type="text" id="visitFarmIdInput" placeholder="6位领地ID" maxlength="6" class="input-dark" style="flex:1;text-transform:uppercase;font-family:monospace;letter-spacing:2px;">';
            h += '<button class="action-btn action-btn-solid-green fw-600" onclick="doVisit()">去串门</button></div></div>';
            if (visitingOwner) {
                h += '<div class="glass p-10 mb-12 text-12 text-green">当前在 ' + esc(visitingOwner) + ' 的农场（' + visitingFarmId + '）</div>';
                h += '<button class="action-btn action-btn-red w-full" style="padding:10px;font-size:13px;" onclick="doGoHome()">🏡 回自己农场</button>';
            }
            h += '<div id="visitFarmView"></div>';
            document.getElementById('visitContent').innerHTML = h; openPanel('panelVisit');
        }
        function doVisit() { var fid = document.getElementById('visitFarmIdInput').value.trim().toUpperCase(); if (!fid) return; doAction('visit_farm', { farmId: fid }); }
        function doGoHome() {
            var ab = document.getElementById('myFarmActions');
            if (ab) ab.style.display = 'flex';
            if (playerData) renderDecorationsArea(playerData.decorations, false);

            // 立即在前端清除串门状态
            visitingOwner = null;
            visitingFarmId = null;

            var vbar = document.getElementById('visitStatusBar');
            if (vbar) vbar.remove();
            var ft = document.querySelector('.farm-title');
            if (ft && playerData) ft.innerHTML = '<span>🏡 我的农场</span><span class="farm-id" id="farmIdDisplay">ID: ' + (playerData.farmId || '???') + '</span>';
            var ct = document.querySelector('.cage-title');
            if (ct) ct.textContent = '🐾 圈养区';

            doAction('go_home');
        }

        function renderVisitFarm(owner, fid, plots, visitors, cages, decorations) {
            var ab = document.getElementById('myFarmActions'); if (ab) ab.style.display = 'none';
            _lastVisitPlotsHash = ''; visitingOwner = owner; visitingFarmId = fid;
            // 面板内视图
            var h = '<div class="visit-farm-view"><div style="font-size:15px;color:#a5d6a7;margin-bottom:4px;">🏡 ' + esc(owner) + ' 的农场</div>';
            h += '<div class="text-muted mb-8">领地ID: ' + fid + '</div>';
            if (visitors && visitors.length > 0) h += '<div class="text-11 mb-8" style="color:#5a7a5a;">也在这里: ' + visitors.map(function (v) { return esc(v); }).join(', ') + '</div>';
            h += '<div class="visit-plots-grid">';
            for (var i = 0; i < plots.length; i++) {
                var pl = plots[i]; var cw = pl.plant && !pl.plant.mature && !(pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                h += '<div class="visit-plot"' + (cw ? ' onclick="doVisitWater(' + i + ')" style="cursor:pointer;"' : '') + '>';
                if (pl.plant) {
                    var pg = Math.max(0, Math.min(1, pl.plant.progress || 0)), im = pl.plant.mature || pg >= 1;
                    h += '<span class="vp-icon">' + (im ? (pl.plant.fruitIcon || '🍎') : (pl.plant.icon || '🌱')) + '</span><span class="vp-name">' + esc(pl.plant.name) + '</span>';
                    if (im) h += '<span class="vp-status" style="color:#fcd34d;">已成熟</span>';
                    else {
                        h += '<span class="vp-status">' + Math.floor(pg * 100) + '%</span>'; var mw = (pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; }), wc = (pl.plant.friendWaters || []).length;
                        if (mw) h += '<span class="vp-status" style="color:#67e8f9;">💧已浇水' + (wc > 1 ? '(' + wc + '人)' : '') + '</span>';
                        else h += '<span class="vp-status" style="color:#93c5fd;">💧点击浇水</span>';
                    }
                } else { h += '<span class="vp-icon" style="opacity:0.3;">🟫</span><span class="vp-name" style="color:#4a5a4a;">空地</span>'; }
                h += '</div>';
            }
            h += '</div><button class="action-btn action-btn-red w-full" style="margin-top:10px;padding:10px;font-size:13px;" onclick="doGoHome()">🏡 回自己农场</button></div>';
            var vfv = document.getElementById('visitFarmView'); if (vfv) vfv.innerHTML = h; else document.getElementById('visitContent').innerHTML += h;
            renderDecorationsArea(decorations, true);
            // 主界面农场区
            var ft = document.querySelector('.farm-title'); if (ft) ft.innerHTML = '<span>🏠 ' + esc(owner) + ' 的农场</span><span class="farm-id">ID: ' + fid + '</span>';
            var pg2 = document.getElementById('plotsGrid'), vh = '';
            for (var vi = 0; vi < plots.length; vi++) {
                var vpl = plots[vi]; var vcw = vpl.plant && !vpl.plant.mature && !(vpl.plant.friendWaters || []).some(function (fw) { return fw.username === username; });
                var vMature = vpl.plant && (vpl.plant.mature || (vpl.plant.progress || 0) >= 1);
                vh += '<div class="plot' + (vMature ? ' mature' : '') + (vcw ? '' : ' empty') + '"' + (vcw ? ' onclick="doVisitWater(' + vi + ')" style="cursor:pointer;"' : '') + '>';
                if (vpl.plant) {
                    var vp = Math.max(0, Math.min(1, vpl.plant.progress || 0));
                    vh += '<span class="plot-icon">' + (vMature ? (vpl.plant.fruitIcon || '🍎') : (vpl.plant.icon || '🌱')) + '</span><span class="plot-name">' + esc(vpl.plant.name) + '</span>';
                    if (vMature) vh += '<span class="plot-progress" style="color:#fcd34d;">已成熟</span>';
                    else {
                        vh += '<span class="plot-progress">' + Math.floor(vp * 100) + '%</span><div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + Math.floor(vp * 100) + '%"></div></div>';
                        var vmw = (vpl.plant.friendWaters || []).some(function (fw) { return fw.username === username; }), vwc = (vpl.plant.friendWaters || []).length;
                        if (vmw) vh += '<span class="plot-progress">💧已浇水' + (vwc > 1 ? '(' + vwc + '人)' : '') + '</span>';
                        else vh += '<span class="plot-progress" style="color:#93c5fd;">💧点击浇水</span>';
                    }
                } else { vh += '<span class="plot-icon" style="opacity:0.3;">🟫</span><span class="plot-name" style="color:#4a5a4a;">空地</span>'; }
                vh += '</div>';
            }
            pg2.innerHTML = vh;
            // 串门状态条
            var eb = document.getElementById('visitStatusBar'); if (eb) eb.remove();
            var bar = document.createElement('div'); bar.id = 'visitStatusBar';
            bar.style.cssText = 'padding:8px 12px;background:linear-gradient(90deg,rgba(76,175,80,0.06),rgba(76,175,80,0.1));border-bottom:1px solid rgba(76,175,80,0.12);font-size:12px;color:#a5d6a7;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;';
            bar.innerHTML = '🏠 正在参观 <b>' + esc(owner) + '</b> 的农场（' + fid + '）<button class="action-btn action-btn-red" style="padding:4px 12px;font-size:11px;" onclick="doGoHome()">🏡 回家</button>';
            var fa = document.getElementById('farmArea'); fa.parentNode.insertBefore(bar, fa);
            // 圈养区
            var cg = document.getElementById('cagesGrid'), ct = document.querySelector('.cage-title');
            if (ct) ct.textContent = '🐾 ' + esc(owner) + ' 的圈养区';
            cg.innerHTML = (cages && cages.length > 0) ? buildCageHtml(cages) : '<div class="text-center text-12 p-10" style="color:#4a5a4a;grid-column:1/-1;">没有圈养数据</div>';
        }

        function updateVisitPlots(plots, cages, decorations) {
            var nh = JSON.stringify(plots);
            if (nh !== _lastVisitPlotsHash) {
                _lastVisitPlotsHash = nh;
                function bph(pl, idx, cls, icls, ncls, scls) {
                    var h = '', cw = pl.plant && !pl.plant.mature && !(pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; }), im = pl.plant && (pl.plant.mature || (pl.plant.progress || 0) >= 1);
                    h += '<div class="' + cls + (im ? ' mature' : '') + (cw ? '' : ' empty') + '"' + (cw ? ' onclick="doVisitWater(' + idx + ')" style="cursor:pointer;"' : '') + '>';
                    if (pl.plant) {
                        var pg = Math.max(0, Math.min(1, pl.plant.progress || 0));
                        h += '<span class="' + icls + '">' + (im ? (pl.plant.fruitIcon || '🍎') : (pl.plant.icon || '🌱')) + '</span><span class="' + ncls + '">' + esc(pl.plant.name) + '</span>';
                        if (im) h += '<span class="' + scls + '" style="color:#fcd34d;">已成熟</span>';
                        else {
                            h += '<span class="' + scls + '">' + Math.floor(pg * 100) + '%</span>'; if (cls === 'plot') h += '<div class="plot-progress-bar"><div class="plot-progress-fill" style="width:' + Math.floor(pg * 100) + '%"></div></div>';
                            var mw = (pl.plant.friendWaters || []).some(function (fw) { return fw.username === username; }), wc = (pl.plant.friendWaters || []).length;
                            if (mw) h += '<span class="' + scls + '" style="color:#67e8f9;">💧已浇水' + (wc > 1 ? '(' + wc + '人)' : '') + '</span>';
                            else h += '<span class="' + scls + '" style="color:#93c5fd;">💧点击浇水</span>';
                        }
                    } else { h += '<span class="' + icls + '" style="opacity:0.3;">🟫</span><span class="' + ncls + '" style="color:#4a5a4a;">空地</span>'; }
                    h += '</div>'; return h;
                }
                var pg = document.getElementById('plotsGrid'); if (pg) { var mh = ''; for (var i = 0; i < plots.length; i++)mh += bph(plots[i], i, 'plot', 'plot-icon', 'plot-name', 'plot-progress'); pg.innerHTML = mh; }
                var vfv = document.getElementById('visitFarmView'); if (vfv) { var vpg = vfv.querySelector('.visit-plots-grid'); if (vpg) { var ph = ''; for (var j = 0; j < plots.length; j++)ph += bph(plots[j], j, 'visit-plot', 'vp-icon', 'vp-name', 'vp-status'); vpg.innerHTML = ph; } }
            }
            if (cages) { var cg = document.getElementById('cagesGrid'); if (cg) cg.innerHTML = buildCageHtml(cages); }
            // 实时同步更新好友的装饰品
            if (decorations) { renderDecorationsArea(decorations, true); }
        }

        // 物品栏
        function openInventory() {
            var contentEl = document.getElementById('invContent');
            if (contentEl) {
                contentEl.innerHTML = loadingPlaceholder();
            }
            openPanel('panelInv');
            doAction('inventory');
        }
        function renderInventoryPanel(seeds, fruits, items, money) {
            var h = '<div class="text-13 text-gold mb-12">💰 金币: ' + money + '</div>';
            h += '<div class="inv-section"><div class="inv-section-title">🌱 种子</div><div class="inv-grid">';
            if (seeds && seeds.length > 0) { for (var i = 0; i < seeds.length; i++) { var s = seeds[i]; h += '<div class="inv-item" title="' + esc(s.name) + '"><span class="ii-icon">' + (s.icon || '🌱') + '</span><span class="ii-name">' + esc(s.name) + '</span><span class="ii-count">x' + s.count + '</span></div>'; } }
            else h += '<div class="inv-empty">没有种子</div>';
            h += '</div></div><div class="inv-section"><div class="inv-section-title">🍎 果实</div><div class="inv-grid">';
            if (fruits && fruits.length > 0) { for (var j = 0; j < fruits.length; j++) { var f = fruits[j]; h += '<div class="inv-item" title="' + esc(f.name) + ' 价值' + f.value + '"><span class="ii-icon">' + (f.icon || '🍎') + '</span><span class="ii-name">' + esc(f.name) + '</span><span class="ii-count">x' + f.count + ' (💰' + f.value + ')</span></div>'; } }
            else h += '<div class="inv-empty">没有果实</div>';
            h += '</div></div>';
            var animals = (playerData && playerData.animals) ? playerData.animals : [];
            h += '<div class="inv-section"><div class="inv-section-title">🐾 动物（未入圈）</div><div class="inv-grid">';
            if (animals.length > 0) { for (var ai = 0; ai < animals.length; ai++) { var a = animals[ai]; h += '<div class="inv-item" title="' + esc(a.name) + ' 售价💰' + a.sellPrice + '"><span class="ii-icon">' + (a.icon || '🐾') + '</span><span class="ii-name">' + esc(a.name) + '</span><span class="ii-count">x' + a.count + ' (💰' + a.sellPrice + ')</span></div>'; } }
            else h += '<div class="inv-empty">没有动物</div>';
            h += '</div></div><div class="inv-section"><div class="inv-section-title">🧰 道具</div><div class="inv-grid">';
            if (items && items.length > 0) { for (var k = 0; k < items.length; k++) { var it = items[k]; h += '<div class="inv-item" title="' + esc(it.desc || '') + '"><span class="ii-icon">' + (it.icon || (it.type === 'feed' ? '🥡' : '🧪')) + '</span><span class="ii-name">' + esc(it.name) + '</span><span class="ii-count">x' + it.count + '</span></div>'; } }
            else h += '<div class="inv-empty">没有道具</div>';
            h += '</div></div>'; document.getElementById('invContent').innerHTML = h;
        }

        // 商店
        function openShop() {
            if (!document.getElementById('panelShop').classList.contains('show')) {
                document.getElementById('shopContent').innerHTML = loadingPlaceholder();
            }
            openPanel('panelShop');
            doAction('shop_list');
        }
        function renderShopPanel(shop, money) {
            var h = '<div class="text-13 text-gold mb-12">💰 你的金币: ' + money + '</div>';
            if (!shop || !shop.items || shop.items.length === 0) { h += '<div class="text-center p-12" style="color:#4a5a4a;">商店空空如也</div>'; document.getElementById('shopContent').innerHTML = h; return; }
            var cwl = (playerData && playerData.waterBoostLevel) ? playerData.waterBoostLevel : 0;
            var seeds = shop.items.filter(function (i) { return i.type === 'seed'; }), ferts = shop.items.filter(function (i) { return i.type === 'fertilizer'; }), feeds = shop.items.filter(function (i) { return i.type === 'feed'; }), decs = shop.items.filter(function (i) { return i.type === 'decoration'; });
            var wtools = shop.items.filter(function (i) { if (i.id.startsWith('watering_can_lv')) { var lv = parseInt(i.id.replace('watering_can_lv', '')) || 0; return lv > cwl && lv <= 5; } return false; });
            var otools = shop.items.filter(function (i) { return i.type === 'tool' && !i.id.startsWith('watering_can_lv'); });
            function secTitle(icon, label, color) { return '<div class="text-12 fw-600" style="color:' + color + ';margin:10px 0 6px;border-bottom:1px solid rgba(255,255,255,0.04);padding-bottom:4px;">' + icon + ' ' + label + '</div>'; }
            if (seeds.length > 0) {
                h += secTitle('🌱', '种子(一种多收)', '#a5d6a7'); for (var i = 0; i < seeds.length; i++) {
                    var s = seeds[i], sd = s.seedData || {}, gm = Math.round((sd.growTime || 0) / 60000), gt = gm >= 60 ? Math.round(gm / 60 * 10) / 10 + '小时' : gm + '分钟';
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">' + (s.icon || sd.icon || '🌱') + ' ' + esc(s.name) + '</div><div class="si-desc">' + esc(s.desc) + '</div>';
                    h += '<div style="font-size:10px;color:#5a7a5a;margin-top:2px;">生长' + gt + ' → ' + (sd.fruitIcon || '🍎') + esc(sd.fruitName || '') + ' (售💰' + (sd.fruitValue || '?') + ')</div></div>';
                    h += '<span class="si-price">💰' + s.price + '</span><div class="flex-col-6" style="gap:3px;"><button onclick="doBuy(\'' + s.id + '\',1)">买1</button><button onclick="doBuy(\'' + s.id + '\',5)" style="background:#2e7d32;">买5</button></div></div>';
                }
            }
            if (ferts.length > 0) { h += secTitle('🧪', '肥料', '#fcd34d'); for (var j = 0; j < ferts.length; j++) { var f = ferts[j]; h += '<div class="shop-item"><div class="si-info"><div class="si-name">🧪 ' + esc(f.name) + '</div><div class="si-desc">' + esc(f.desc || '') + '</div></div><span class="si-price">💰' + f.price + '</span><button onclick="doBuy(\'' + f.id + '\',1)">购买</button></div>'; } }
            if (feeds.length > 0) {
                h += secTitle('🥡', '饲料', '#f472b6'); for (var fi = 0; fi < feeds.length; fi++) {
                    var it = feeds[fi], fv = (it.effect && it.effect.foodValue) ? it.effect.foodValue : 20;
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">' + (it.icon || '🥡') + ' ' + esc(it.name) + '</div><div class="si-desc">' + esc(it.desc || '') + ' <span style="color:#f472b6;font-size:10px;">(食物+' + fv + ')</span></div></div>';
                    h += '<span class="si-price">💰' + it.price + '</span><div class="flex-col-6" style="gap:3px;"><button onclick="doBuy(\'' + it.id + '\',1)">买1</button><button onclick="doBuy(\'' + it.id + '\',5)" style="background:#2e7d32;">买5</button></div></div>';
                }
            }
            if (decs.length > 0) { h += secTitle('🎨', '农场装饰', '#a78bfa'); for (var di = 0; di < decs.length; di++) { var it = decs[di]; h += '<div class="shop-item"><div class="si-info"><div class="si-name">' + (it.icon || '🎨') + ' ' + esc(it.name) + '</div><div class="si-desc">' + esc(it.desc || '') + '</div></div><span class="si-price">💰' + it.price + '</span><button onclick="doBuy(\'' + it.id + '\',1)">购买</button></div>'; } }
            if (otools.length > 0) { h += secTitle('🔨', '工具', '#67e8f9'); for (var k = 0; k < otools.length; k++) { var t = otools[k]; h += '<div class="shop-item"><div class="si-info"><div class="si-name">🔨 ' + esc(t.name) + '</div><div class="si-desc">' + esc(t.desc || '') + '</div></div><span class="si-price">💰' + t.price + '</span><button onclick="doBuy(\'' + t.id + '\',1)">购买</button></div>'; } }
            if (wtools.length > 0) {
                h += secTitle('💧', '水壶升级', '#67e8f9'); for (var m = 0; m < wtools.length; m++) { var w = wtools[m]; h += '<div class="shop-item"><div class="si-info"><div class="si-name">💧 ' + esc(w.name) + '</div><div class="si-desc">' + esc(w.desc || '') + '</div></div><span class="si-price">💰' + w.price + '</span><button onclick="doBuy(\'' + w.id + '\',1)">升级</button></div>'; }
                if (cwl >= 5) h += '<div class="glass text-center p-10 text-12 text-gold" style="margin-top:6px;">🏆 你已拥有最高等级的传说水壶！</div>';
            }
            var aItems = shop.items.filter(function (i) { return i.type === 'animal'; });
            if (aItems.length > 0) {
                h += secTitle('🐾', '动物', '#fcd34d'); for (var ai = 0; ai < aItems.length; ai++) {
                    var a = aItems[ai], ad = a.animalData || {};
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">' + (a.icon || ad.icon || '🐾') + ' ' + esc(a.name) + '</div><div class="si-desc">' + esc(a.desc) + '</div>';
                    h += '<div style="font-size:10px;color:#5a7a5a;margin-top:2px;">食量' + (ad.foodPerHour || '?') + '/时 | 售价💰' + (ad.sellPrice || '?') + '</div></div>';
                    h += '<span class="si-price">💰' + a.price + '</span><div class="flex-col-6" style="gap:3px;"><button onclick="doBuy(\'' + a.id + '\',1)">买1</button><button onclick="doBuy(\'' + a.id + '\',5)" style="background:#2e7d32;">买5</button></div></div>';
                }
            }
            var pItems = shop.items.filter(function (i) { return i.type === 'pet'; });
            if (pItems.length > 0) {
                h += secTitle('🐱', '宠物', '#c4b5fd'); for (var pi = 0; pi < pItems.length; pi++) {
                    var pet = pItems[pi], pd = pet.petData || {};
                    h += '<div class="shop-item"><div class="si-info"><div class="si-name">' + (pet.icon || pd.speciesIcon || '🐾') + ' ' + esc(pet.name) + '</div><div class="si-desc">' + esc(pet.desc) + '</div>';
                    h += '<div style="font-size:10px;color:#5a7a5a;margin-top:2px;">稀有度: ' + getRarityText(pd.rarity || 'common') + ' | 价值' + (pd.baseValue || '?') + '</div></div>';
                    h += '<span class="si-price">💰' + pet.price + '</span><button onclick="doBuy(\'' + pet.id + '\',1)">购买</button></div>';
                }
            }
            document.getElementById('shopContent').innerHTML = h;
        }
        function doBuy(id, c) { doAction('shop_buy', { itemId: id, count: c || 1 }); }

        // 卖出
        function openSell() {
            if (!document.getElementById('panelSell').classList.contains('show')) {
                document.getElementById('sellContent').innerHTML = loadingPlaceholder();
            }
            openPanel('panelSell');
            doAction('inventory');
        }
        function renderSellPanel() {
            if (!playerData) return; var h = '<div class="text-13 text-gold mb-12">💰 当前金币: ' + playerData.money + '</div>';
            function secT(icon, label) { return '<div class="text-12 text-green" style="margin:12px 0 6px;border-bottom:1px solid rgba(255,255,255,0.04);padding-bottom:4px;">' + icon + ' ' + label + '</div>'; }
            function sellBtns(action, id, count) { var h = '<div class="flex-gap-4">'; h += '<button onclick="' + action + '(\'' + id + '\',1)">卖1个</button>'; if (count >= 5) h += '<button onclick="' + action + '(\'' + id + '\',5)">卖5个</button>'; if (count) h += '<button onclick="' + action + '(\'' + id + '\',' + count + ')">全卖</button>'; h += '</div>'; return h; }
            // 果实
            h += secT('🍎', '果实卖出');
            if (!playerData.fruits || playerData.fruits.length === 0) h += '<div class="text-muted p-8">没有可卖的果实</div>';
            else { for (var i = 0; i < playerData.fruits.length; i++) { var f = playerData.fruits[i]; h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (f.icon || '🍎') + ' ' + esc(f.name) + '</div><div class="sl-detail">数量: ' + f.count + ' · 单价: 💰' + f.value + '</div></div>' + sellBtns('doSellFruit', f.id, f.count) + '</div>'; } }
            // 种子
            h += secT('🌱', '种子卖出');
            var ss = (playerData.seeds || []).filter(function (s) { return s.source && s.source !== 'starter'; });
            if (ss.length === 0) h += '<div class="text-muted p-8">没有可卖的种子（初始种子无法卖出）</div>';
            else {
                for (var j = 0; j < ss.length; j++) {
                    var s = ss[j], sp = s.source === 'bought' ? Math.floor(50 / 2) : (s.fruitValue ? Math.floor(s.fruitValue / 3) : 3), sl = s.source === 'bought' ? '💳 购买' : '🌾 收获';
                    h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (s.icon || '🌱') + ' ' + esc(s.name) + '</div><div class="sl-detail">数量: ' + s.count + ' · 单价: 💰' + sp + ' <span class="text-muted">(' + sl + ')</span></div></div>' + sellBtns('doSellSeed', s.id, s.count) + '</div>';
                }
            }
            // 动物
            h += '<div class="text-12 text-gold" style="margin:12px 0 6px;border-bottom:1px solid rgba(255,255,255,0.04);padding-bottom:4px;">🐾 动物卖出（未入圈）</div>';
            var an = playerData.animals || [];
            if (an.length === 0) h += '<div class="text-muted p-8">没有未入圈的动物</div>';
            else { for (var ai = 0; ai < an.length; ai++) { var a = an[ai]; h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (a.icon || '🐾') + ' ' + esc(a.name) + '</div><div class="sl-detail">数量: ' + a.count + ' · 单价: 💰' + a.sellPrice + '</div></div>' + sellBtns('doSellStockAnimal', a.id, a.count) + '</div>'; } }
            // 道具
            h += '<div class="text-12" style="color:#67e8f9;margin:12px 0 6px;border-bottom:1px solid rgba(255,255,255,0.04);padding-bottom:4px;">🎁 装饰与道具</div>';
            var si = (playerData.items || []).filter(function (it) {
                return !it.unsalable && (it.type === 'decoration' || it.type === 'feed' || it.type === 'fertilizer' || it.type === 'tool');
            });
            if (si.length === 0) h += '<div class="text-muted p-8">没有可卖出的物品</div>';
            else {
                for (var k = 0; k < si.length; k++) {
                    var it = si[k], pr = it.sellPrice || (it.price ? Math.floor(it.price / 2) : 5);
                    h += '<div class="sell-item"><div class="sl-info"><div class="sl-name">' + (it.icon || '📦') + ' ' + esc(it.name) + '</div><div class="sl-detail">数量: ' + it.count + ' · 单价: 💰' + pr + '</div></div>' + sellBtns('doSellItem', it.id, it.count) + '</div>';
                }
            }
            document.getElementById('sellContent').innerHTML = h;
        }
        function doSellItem(id, c) { doAction('sell_item', { itemId: id, count: c }); }
        function doSellFruit(id, c) { doAction('sell_fruit', { fruitId: id, count: c }); }
        function doSellSeed(id, c) { doAction('sell_seed', { seedId: id, count: c }); }
        function doSellStockAnimal(id, c) { doAction('sell_stock_animal', { animalId: id, count: c }); }

        // 排行榜
        function openRanking() {
            currentRankTab = 'money';
            document.getElementById('rankingContent').innerHTML = loadingPlaceholder();
            doAction('world_ranking');
            openPanel('panelRanking');
            updateRankTabStyle();
        }
        function switchRankTab(tab) { currentRankTab = tab; updateRankTabStyle(); if (tab === 'money') doAction('world_ranking'); else if (tab === 'pet') doAction('pet_ranking'); else if (tab === 'weekly') doAction('weekly_ranking'); }
        function updateRankTabStyle() {
            var tabs = { money: document.getElementById('rankTabMoney'), pet: document.getElementById('rankTabPet'), weekly: document.getElementById('rankTabWeekly') };
            var colors = { money: ['rgba(252,211,77,0.3)', 'rgba(252,211,77,0.15)', '#fcd34d'], pet: ['rgba(167,139,250,0.3)', 'rgba(167,139,250,0.15)', '#c4b5fd'], weekly: ['rgba(103,232,249,0.3)', 'rgba(103,232,249,0.15)', '#67e8f9'] };
            for (var k in tabs) {
                var el = tabs[k]; if (k === currentRankTab) { var c = colors[k]; el.style.cssText = 'flex:1;padding:8px;border:1px solid ' + c[0] + ';background:' + c[1] + ';color:' + c[2] + ';border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;'; }
                else el.style.cssText = 'flex:1;padding:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#5a7a5a;border-radius:8px;font-size:12px;cursor:pointer;';
            }
        }
        function renderRankingPanel(ranking, myRank) {
            if (!ranking || ranking.length === 0) { document.getElementById('rankingContent').innerHTML = '<div class="text-center text-12 p-12" style="color:#4a5a4a;">暂无排行榜数据</div>'; return; }
            var h = '';
            if (myRank !== undefined && myRank !== null && ranking[myRank]) {
                var md = ranking[myRank];
                h += '<div class="glass text-center p-12 mb-12" style="border-color:rgba(252,211,77,0.15);"><div class="text-12" style="color:#5a7a5a;">你的排名</div><div style="font-size:24px;color:#fcd34d;font-weight:600;margin:4px 0;">排名 ' + (myRank + 1) + '</div><div class="text-13 text-green">💰 ' + md.money + ' 金币</div></div>';
            }
            h += '<div class="text-12 mb-8" style="color:#5a7a5a;">世界排行 (前50)</div>';
            var maxShow = Math.min(ranking.length, 50);
            for (var i = 0; i < maxShow; i++) {
                var p = ranking[i], medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '', isMe = p.username === username, bw = Math.max(5, Math.round((p.money / ranking[0].money) * 100));
                h += '<div class="glass p-10 mb-8" style="border-color:' + (isMe ? 'rgba(76,175,80,0.15)' : 'rgba(255,255,255,0.04)') + ';background:' + (isMe ? 'rgba(76,175,80,0.04)' : 'transparent') + ';">';
                h += '<div class="flex-between mb-6"><span class="text-13" style="display:flex;align-items:center;gap:6px;">';
                if (medal) h += '<span style="font-size:18px;">' + medal + '</span>'; else h += '<span class="text-13" style="color:#4a5a4a;min-width:20px;text-align:center;">#' + (i + 1) + '</span>';
                h += '<span style="color:' + (isMe ? '#4caf50' : '#a5d6a7') + ';font-weight:600;">' + esc(p.username) + (isMe ? ' (你)' : '') + '</span></span>';
                h += '<span class="text-13 text-gold fw-600">💰 ' + p.money + '</span></div>';
                h += '<div class="ranking-bar"><div class="ranking-bar-fill" style="width:' + bw + '%;"></div></div>';
                h += '<div class="flex-gap-6 text-muted"><span>🌾 收获:' + p.totalHarvest + '</span><span>🌿 采集:' + p.totalGather + '</span><span>🌱 ' + p.plotCount + '/' + p.maxPlots + '</span></div></div>';
            }
            document.getElementById('rankingContent').innerHTML = h;
        }
        function renderPetRankingPanel(ranking, myRank) {
            if (!ranking || ranking.length === 0) { document.getElementById('rankingContent').innerHTML = '<div class="text-center text-12 p-12" style="color:#4a5a4a;">暂无宠物排行数据</div>'; return; }
            var h = '';
            if (myRank !== undefined && myRank !== null && ranking[myRank]) {
                var me = ranking[myRank];
                h += '<div class="glass text-center p-12 mb-12" style="border-color:rgba(167,139,250,0.15);"><div class="text-12" style="color:#5a7a5a;">你的最佳宠物排名</div><div style="font-size:24px;color:#c4b5fd;font-weight:600;margin:4px 0;">第 ' + (myRank + 1) + ' 名</div><div class="text-13 text-green">' + (me.speciesIcon || '🐾') + ' ' + esc(me.petName) + ' · 💰' + me.value + '</div></div>';
            }
            var maxShow = Math.min(ranking.length, 50);
            for (var i = 0; i < maxShow; i++) {
                var p = ranking[i], medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '', isMe = p.owner === username, bw = Math.max(5, Math.round((p.value / ranking[0].value) * 100));
                h += '<div class="glass p-10 mb-8" style="border-color:' + (isMe ? 'rgba(167,139,250,0.15)' : 'rgba(255,255,255,0.04)') + ';"><div class="flex-between" style="margin-bottom:4px;"><span class="text-13" style="display:flex;align-items:center;gap:6px;">';
                if (medal) h += '<span style="font-size:18px;">' + medal + '</span>'; else h += '<span style="color:#4a5a4a;min-width:20px;text-align:center;">#' + (i + 1) + '</span>';
                h += '<span style="font-size:18px;">' + (p.speciesIcon || '🐾') + '</span><span style="color:#c4b5fd;font-weight:600;">' + esc(p.petName) + '</span><span class="rarity-' + (p.rarity || 'common') + '" style="font-size:10px;">(' + getRarityText(p.rarity) + ')</span></span>';
                h += '<span style="font-size:14px;color:#fcd34d;font-weight:600;">💰' + p.value + '</span></div>';
                h += '<div class="ranking-bar"><div class="ranking-bar-fill" style="width:' + bw + '%;background:linear-gradient(90deg,#a78bfa,#c4b5fd);"></div></div>';
                h += '<div class="flex-between text-muted"><span>' + esc(p.species) + ' · 探险' + (p.totalAdventures || 0) + '次</span><span>主人: <span style="color:' + (isMe ? '#a78bfa' : '#a5d6a7') + ';">' + esc(p.owner) + (isMe ? ' (你)' : '') + '</span></span></div></div>';
            }
            document.getElementById('rankingContent').innerHTML = h;
        }
        function renderWeeklyRankingPanel(ranking, myRank) {
            var h = '<div style="text-align:right;margin-bottom:8px;"><button class="action-btn action-btn-cyan" style="padding:4px 12px;" onclick="doAction(\'weekly_ranking\')">🔄 刷新</button></div>';
            if (!ranking || ranking.length === 0) { document.getElementById('rankingContent').innerHTML = h + '<div class="text-center text-12 p-12" style="color:#4a5a4a;">暂无本周挑战完成记录</div>'; return; }
            ranking.sort(function (a, b) { return a.completedAt - b.completedAt; });
            if (myRank !== undefined && myRank !== null && ranking[myRank]) {
                var me = ranking[myRank], d = new Date(me.completedAt), ds = (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
                h += '<div class="glass text-center p-12 mb-12" style="border-color:rgba(103,232,249,0.15);"><div class="text-12" style="color:#5a7a5a;">你的挑战成绩</div><div style="font-size:24px;color:#67e8f9;font-weight:600;margin:4px 0;">第 ' + (myRank + 1) + ' 名</div><div class="text-13 text-green">完成时间: ' + ds + '</div></div>';
            }
            h += '<div class="text-12 mb-8" style="color:#5a7a5a;">最快完成记录</div>';
            for (var i = 0; i < ranking.length; i++) {
                var p = ranking[i], medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '', isMe = p.username === username, d = new Date(p.completedAt), ds = (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
                h += '<div class="glass p-10 mb-8" style="border-color:' + (isMe ? 'rgba(103,232,249,0.15)' : 'rgba(255,255,255,0.04)') + ';"><div class="flex-between"><span class="text-13" style="display:flex;align-items:center;gap:6px;">';
                if (medal) h += '<span style="font-size:18px;">' + medal + '</span>'; else h += '<span style="color:#4a5a4a;min-width:20px;text-align:center;">#' + (i + 1) + '</span>';
                h += '<span style="color:' + (isMe ? '#67e8f9' : '#a5d6a7') + ';font-weight:600;">' + esc(p.username) + (isMe ? ' (你)' : '') + '</span></span>';
                h += '<span class="text-12" style="color:#5a7a5a;">⏱️ ' + ds + '</span></div></div>';
            }
            document.getElementById('rankingContent').innerHTML = h;
        }

        // 交易
        function openTrade() {
            var h = '<div class="mb-12"><button class="action-btn action-btn-gold w-full mb-8" style="padding:10px;font-size:13px;" onclick="showTradeForm()">📝 发起新交易</button>';
            h += '<button class="action-btn w-full" style="padding:10px;font-size:13px;background:rgba(255,255,255,0.03);color:#7a9a7a;border:1px solid rgba(255,255,255,0.06);" onclick="doAction(\'trade_list\')">📋 查看交易列表</button>';
            h += '</div><div id="tradeFormArea"></div><div id="tradeListArea"></div>';
            document.getElementById('tradeContent').innerHTML = h; openPanel('panelTrade'); doAction('trade_list');
        }
        function showTradeForm() {
            if (!playerData) return;
            var h = '<div class="trade-form"><label>交易对象（昵称）</label><input type="text" id="tradeTo" placeholder="输入对方昵称">';
            h += '<label>我要给出</label><select id="tradeOfferType" onchange="updTradeOfferItems()"><option value="seed">种子</option><option value="fruit">果实</option><option value="item">装饰/道具</option><option value="animal">库存动物</option><option value="pet">宠物(单只)</option><option value="money">金币</option></select>';
            h += '<div id="tradeOfferMoneyInfo" style="display:none;font-size:12px;color:#fcd34d;"></div>';
            h += '<div id="tradeOfferIdWrap"><select id="tradeOfferId" class="input-dark w-full"></select></div>';
            h += '<label id="tradeOfferCountLabel">给出数量</label><input type="number" id="tradeOfferCount" value="1" min="1">';
            h += '<label>我想要（类型）</label><select id="tradeWantType" onchange="updTradeWantFields()"><option value="seed">种子</option><option value="fruit">果实</option><option value="item">装饰/道具</option><option value="animal">库存动物</option><option value="pet">宠物</option><option value="money">金币</option><option value="any">不需要回报（赠送）</option></select>';
            h += '<div id="tradeWantDetailWrap"><label>想要的物品名称</label><input type="text" id="tradeWantName" placeholder="输入物品名称"><label>想要数量</label><input type="number" id="tradeWantCount" value="1" min="1"></div>';
            h += '<label>留言信息 (可选)</label><input type="text" id="tradeMessage" placeholder="给对方留个话..." maxlength="30">';
            h += '<button onclick="submitTrade()">🤝 发起交易</button></div>';
            document.getElementById('tradeFormArea').innerHTML = h; updTradeOfferItems();
        }
        function updTradeOfferItems() {
            var type = document.getElementById('tradeOfferType').value, wrap = document.getElementById('tradeOfferIdWrap'), mi = document.getElementById('tradeOfferMoneyInfo'), cl = document.getElementById('tradeOfferCountLabel');
            if (type === 'money') { wrap.style.display = 'none'; mi.style.display = 'block'; mi.textContent = '💰 当前金币: ' + playerData.money; cl.textContent = '给出金币数量'; return; }
            wrap.style.display = ''; mi.style.display = 'none'; cl.textContent = type === 'pet' ? '（宠物交易数量固定为1）' : '给出数量';
            var sel = document.getElementById('tradeOfferId'); sel.innerHTML = '';
            var arr = [];
            if (type === 'seed') arr = playerData.seeds || [];
            else if (type === 'fruit') arr = playerData.fruits || [];
            else if (type === 'item') arr = playerData.items || [];
            else if (type === 'animal') arr = playerData.animals || [];
            else if (type === 'pet') { arr = playerData.pets || []; for (var i = 0; i < arr.length; i++) { var o = document.createElement('option'); o.value = arr[i].id; o.textContent = arr[i].speciesIcon + ' ' + arr[i].species + '·' + arr[i].name + ' (💰' + arr[i].value + ')'; sel.appendChild(o); } if (arr.length === 0) { var o = document.createElement('option'); o.textContent = '没有宠物'; o.value = ''; sel.appendChild(o); } return; }
            for (var i = 0; i < arr.length; i++) { var o = document.createElement('option'); o.value = arr[i].id; var icon = arr[i].icon || (type === 'animal' ? '🐾' : '📦'); o.textContent = icon + ' ' + arr[i].name + ' (x' + arr[i].count + ')'; sel.appendChild(o); }
            if (arr.length === 0) { var o = document.createElement('option'); o.textContent = '没有物品'; o.value = ''; sel.appendChild(o); }
        }
        function updTradeWantFields() {
            var type = document.getElementById('tradeWantType').value, wrap = document.getElementById('tradeWantDetailWrap');
            if (type === 'any') wrap.style.display = 'none';
            else if (type === 'money') { wrap.innerHTML = '<label>想要金币数量</label><input type="number" id="tradeWantCount" value="1" min="1">'; wrap.style.display = ''; }
            else { wrap.innerHTML = '<label>想要的物品名称</label><input type="text" id="tradeWantName" placeholder="输入物品名称"><label>想要数量</label><input type="number" id="tradeWantCount" value="1" min="1">'; wrap.style.display = ''; }
        }
        function submitTrade() {
            var to = (document.getElementById('tradeTo').value || '').trim(); if (!to) { addActionFail('请输入交易对象'); return; }
            var ot = document.getElementById('tradeOfferType').value, oi = ot === 'money' ? 'money' : (document.getElementById('tradeOfferId').value || '');
            if (ot !== 'money' && !oi) { addActionFail('请选择要给出的物品'); return; }
            var oc = parseInt(document.getElementById('tradeOfferCount').value) || 1; if (ot === 'pet') oc = 1;
            var wt = document.getElementById('tradeWantType').value, wne = document.getElementById('tradeWantName'), wce = document.getElementById('tradeWantCount');
            var wn = wt === 'money' ? '金币' : (wt === 'any' ? '无（赠送）' : (wne ? wne.value.trim() : '')), wc = wce ? (parseInt(wce.value) || 1) : 1;
            if (wt !== 'any' && wt !== 'money' && !wn) { addActionFail('请输入想要的物品名称'); return; }
            var msg = (document.getElementById('tradeMessage').value || '').trim();
            doAction('trade_create', { to: to, offerType: ot, offerId: oi, offerCount: oc, wantType: wt, wantId: wt === 'money' ? 'money' : (wn || ''), wantName: wn || '任意', wantCount: wc, message: msg });
        }
        function renderTradeList(trades) {
            var el = document.getElementById('tradeListArea'); if (!el) return;
            if (!trades || trades.length === 0) { el.innerHTML = '<div class="text-center text-12 p-10" style="color:#4a5a4a;">没有待处理的交易</div>'; return; }
            var h = '<div class="text-12 mb-6" style="color:#5a7a5a;">待处理交易：</div>';
            for (var i = 0; i < trades.length; i++) {
                var t = trades[i], isFrom = t.from === username;
                var ofT = t.offerType === 'money' ? '💰' + t.offerCount + '金币' : esc(t.offerName) + ' x' + t.offerCount;
                var waT = t.wantType === 'any' ? '无（赠送）' : (t.wantType === 'money' ? '💰' + t.wantCount + '金币' : esc(t.wantName) + ' x' + t.wantCount);
                h += '<div class="msg-trade mb-6" data-trade-id="' + t.id + '"><div>' + (isFrom ? '你' : esc(t.from)) + ' 想用 <b>' + ofT + '</b> 换 ' + (isFrom ? esc(t.to) : '你') + ' 的 <b>' + waT + '</b></div>';
                if (t.message) h += '<div style="margin-top:2px;font-size:11px;color:#eee;">💬 ' + esc(t.message) + '</div>';
                h += '<div class="trade-btns">';
                if (!isFrom) h += '<button class="t-accept" onclick="doTradeAction(\'accept\',\'' + t.id + '\')">接受</button><button class="t-reject" onclick="doTradeAction(\'reject\',\'' + t.id + '\')">拒绝</button>';
                else h += '<button class="t-reject" onclick="doTradeAction(\'cancel\',\'' + t.id + '\')">取消</button>';
                h += '</div></div>';
            }
            el.innerHTML = h;
        }
        function showTradeIncoming(trade) {
            var ofT = trade.offerType === 'money' ? '💰' + trade.offerCount + '金币' : esc(trade.offerName) + ' x' + trade.offerCount;
            var waT = trade.wantType === 'any' ? '无（赠送）' : (trade.wantType === 'money' ? '💰' + trade.wantCount + '金币' : esc(trade.wantName) + ' x' + trade.wantCount);
            var h = '<div class="msg-trade"><div>📦 ' + esc(trade.from) + ' 想用 <b>' + ofT + '</b> 换你的 <b>' + waT + '</b></div>';
            if (trade.message) h += '<div style="margin-top:4px;font-size:11px;color:#fff;background:rgba(0,0,0,0.2);padding:4px;border-radius:4px;">💬 留言: ' + esc(trade.message) + '</div>';
            h += '<div class="trade-btns"><button class="t-accept" onclick="doTradeAction(\'accept\',\'' + trade.id + '\')">接受</button><button class="t-reject" onclick="doTradeAction(\'reject\',\'' + trade.id + '\')">拒绝</button></div></div>';
            var div = document.createElement('div'); div.className = 'msg-item msg-trade'; div.setAttribute('data-trade-id', trade.id); div.innerHTML = h; appendMsg(div);
        }
        function doTradeAction(action, id) { doAction('trade_' + action, { tradeId: id }); removeTradeMessage(id); }
        function removeTradeMessage(id) { var ma = document.getElementById('msgArea'), el = ma.querySelector('[data-trade-id="' + id + '"]'); if (el) { el.style.opacity = '0'; el.style.transition = 'opacity 0.3s'; setTimeout(function () { if (el.parentNode) el.parentNode.removeChild(el); }, 300); } }

        // 好友
        function openFriends() {
            document.getElementById('friendsContent').innerHTML = loadingPlaceholder();
            openPanel('panelFriends');
            doAction('friend_list');
        }
        function renderFriendsPanel(friends, requests) {
            cachedFriendList = (friends || []).map(function (f) { return f.username; });
            var h = '<div class="flex-gap-6 mb-12"><input type="text" id="addFriendInput" placeholder="输入昵称" class="input-dark" style="flex:1;">';
            h += '<button class="action-btn action-btn-solid-green fw-600" onclick="doAddFriend()">添加</button></div>';
            h += '<button class="action-btn action-btn-cyan w-full mb-12" onclick="openGroups()">💬 群聊管理</button>';
            if (requests && requests.length > 0) {
                h += '<div class="text-12 mb-6" style="color:#c4b5fd;">好友请求：</div>';
                for (var r = 0; r < requests.length; r++) {
                    h += '<div class="friend-req"><span>' + esc(requests[r]) + ' 请求加你为好友</span><span class="flex-gap-4">';
                    h += '<button class="action-btn action-btn-solid-green" style="padding:3px 10px;font-size:11px;" onclick="doAction(\'friend_accept\',{from:\'' + esc(requests[r]) + '\'})">接受</button>';
                    h += '<button class="action-btn action-btn-red" style="padding:3px 10px;font-size:11px;" onclick="doAction(\'friend_reject\',{from:\'' + esc(requests[r]) + '\'})">拒绝</button></span></div>';
                }
            }
            h += '<div class="text-12 mb-6" style="color:#5a7a5a;">好友列表：</div>';
            if (!friends || friends.length === 0) h += '<div class="text-center text-12 p-12" style="color:#4a5a4a;">还没有好友</div>';
            else {
                for (var i = 0; i < friends.length; i++) {
                    var f = friends[i], cur = f.friendship || 0, min = f.levelMin || 0, max = f.levelMax, pct = 0, pt = '';
                    if (max === null || max === undefined || max === Infinity) { pct = 100; pt = cur + ' (已满级)'; } else { var rng = max - min; if (rng <= 0) rng = 100; pct = Math.max(0, Math.min(100, ((cur - min) / rng) * 100)); pt = cur + ' / ' + max; }
                    h += '<div class="friend-item"><div style="flex:1;"><div><span class="fi-name">' + (f.online ? '🟢' : '⚫') + ' ' + esc(f.username) + '</span><span class="fi-id">' + f.farmId + '</span></div>';
                    h += '<div class="text-muted" style="margin-top:2px;">❤️ ' + esc(f.levelName) + ' <span style="color:#3a4a3a;">(' + pt + ')</span></div>';
                    h += '<div style="width:100px;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;margin-top:3px;overflow:hidden;"><div style="height:100%;width:' + pct + '%;background:linear-gradient(90deg,#ff69b4,#ff8da1);border-radius:2px;transition:width 0.3s;"></div></div></div>';
                    h += '<div class="fi-btns"><button style="background:rgba(76,175,80,0.12);color:#a5d6a7;" onclick="doVisitFriend(\'' + f.farmId + '\')">串门</button>';
                    h += '<button style="background:rgba(167,139,250,0.12);color:#c4b5fd;" onclick="doPrivateMsg(\'' + esc(f.username) + '\')">私聊</button>';
                    h += '<button style="background:rgba(239,68,68,0.1);color:#fca5a5;" onclick="doAction(\'friend_remove\',{target:\'' + esc(f.username) + '\'})">删除</button></div></div>';
                }
            }
            document.getElementById('friendsContent').innerHTML = h;
        }
        function doAddFriend() { var i = document.getElementById('addFriendInput'), t = (i.value || '').trim(); if (!t) return; doAction('friend_request', { target: t }); i.value = ''; }
        function doVisitFriend(fid) { closePanel('panelFriends'); doAction('visit_farm', { farmId: fid }); openPanel('panelVisit'); setTimeout(function () { var vi = document.getElementById('visitFarmIdInput'); if (vi) vi.value = fid; }, 100); }
        function doPrivateMsg(target) { var t = prompt('发送私聊消息给 ' + target + '：'); if (!t || !t.trim()) return; var ct = t.trim(); doAction('private_msg', { to: target, text: ct }); addPrivateChatLog(username, target, ct, true); }
        function addPrivateChatLog(from, to, text, isMe) {
            var div = document.createElement('div'); div.className = 'msg-item msg-private';
            var h = '<span class="private-tag">[私聊]</span>';
            if (isMe) h += '<span class="private-user">我</span> 对 <span class="private-user" onclick="doPrivateMsg(\'' + esc(to) + '\')">' + esc(to) + '</span> 说: ';
            else h += '<span class="private-user" onclick="doPrivateMsg(\'' + esc(from) + '\')">' + esc(from) + '</span> 对 <span class="private-user">你</span> 说: ';
            h += '<span style="color:#e0e0e0;">' + esc(text) + '</span>'; div.innerHTML = h; appendMsg(div);
        }

        // 群聊
        function openGroups() { doAction('list_groups'); closePanel('panelFriends'); openPanel('panelGroups'); }
        function renderGroupsPanel(groups) {
            var h = '<div class="flex-gap-6 mb-12"><input type="text" id="newGroupName" placeholder="群名称" class="input-dark" style="flex:1;">';
            h += '<button class="action-btn action-btn-solid-green fw-600" onclick="doCreateGroup()">创建群</button></div>';
            if (!groups || groups.length === 0) h += '<div class="text-center text-12 p-12" style="color:#4a5a4a;">还没有群聊</div>';
            else {
                for (var i = 0; i < groups.length; i++) {
                    var g = groups[i];
                    h += '<div class="group-item"><span><span class="gi-name">💬 ' + esc(g.name) + '</span> <span class="gi-info">(' + g.members.length + '人 · 群主:' + esc(g.owner) + ')</span></span>';
                    h += '<div class="flex-gap-4"><button class="action-btn action-btn-cyan" style="padding:3px 10px;font-size:11px;" onclick="doGroupChat(\'' + g.id + '\',\'' + esc(g.name) + '\')">发消息</button>';
                    h += '<button class="action-btn action-btn-purple" style="padding:3px 10px;font-size:11px;" onclick="doInviteGroup(\'' + g.id + '\')">邀请</button>';
                    h += '<button class="action-btn action-btn-red" style="padding:3px 10px;font-size:11px;" onclick="doAction(\'leave_group\',{groupId:\'' + g.id + '\'})">退出</button></div></div>';
                }
            }
            document.getElementById('groupsContent').innerHTML = h;
        }
        function doCreateGroup() { var i = document.getElementById('newGroupName'), n = (i.value || '').trim(); if (!n) return; doAction('create_group', { name: n }); i.value = ''; }
        function doGroupChat(gid, gn) { var t = prompt('发送消息到群「' + gn + '」：'); if (!t || !t.trim()) return; doAction('group_msg', { groupId: gid, text: t.trim() }); addGroupMsg(gn, username, t.trim()); }
        function doInviteGroup(gid) { var t = prompt('输入要邀请的昵称：'); if (!t || !t.trim()) return; doAction('invite_group', { groupId: gid, target: t.trim() }); }

        // 聊天
        function sendChat() { var i = document.getElementById('chatInput'), t = i.value.trim(); if (!t) return; doAction('chat', { text: t, channel: chatChannel }); var mt = playerData ? playerData.activeTitle : null; addChatMsg(username, t, chatChannel, true, mt); i.value = ''; i.focus(); }
        function toggleChannel() { chatChannel = chatChannel === 'world' ? 'farm' : 'world'; document.getElementById('chatChannelBtn').textContent = '📢 ' + (chatChannel === 'world' ? '世界频道' : '农场频道'); }
        function addChatMsg(from, text, ch, isMe, ti) { var d = document.createElement('div'); d.className = 'msg-item msg-chat'; var cl = ch === 'farm' ? '[农场] ' : '', nc = (isMe || from === username) ? 'me' : '', th = ''; if (ti && ti.name) th = '<span style="color:' + (ti.color || '#66bb6a') + ';font-weight:600;margin-left:4px;">·[' + esc(ti.name) + ']</span>'; d.innerHTML = '<span class="chat-channel">' + cl + '</span><span class="chat-name ' + nc + '">' + esc(from) + '</span>' + th + ': ' + esc(text); appendMsg(d); }
        function addGroupMsg(gn, from, text) { var d = document.createElement('div'); d.className = 'msg-item msg-private'; d.innerHTML = '💬 [' + esc(gn) + '] <b>' + esc(from) + '</b>: ' + esc(text); appendMsg(d); }
        function addSysMsg(t) { var d = document.createElement('div'); d.className = 'msg-item msg-system'; d.textContent = t; appendMsg(d); }
        function addAnnounce(t) { var d = document.createElement('div'); d.className = 'msg-item msg-announce'; d.innerHTML = '📜 ' + esc(t); appendMsg(d); }
        function addActionOk(t) { var d = document.createElement('div'); d.className = 'msg-item msg-action ok'; d.textContent = t; appendMsg(d); }
        function addActionFail(t) { var d = document.createElement('div'); d.className = 'msg-item msg-action fail'; d.textContent = t; appendMsg(d); }
        function appendMsg(el) { var a = document.getElementById('msgArea'); a.appendChild(el); while (a.children.length > 100) a.removeChild(a.firstChild); if (!_scrollPending) { _scrollPending = true; requestAnimationFrame(function () { a.scrollTop = a.scrollHeight; _scrollPending = false; }); } }

        // 宠物
        function openPets() { document.getElementById('petsContent').innerHTML = loadingPlaceholder(); openPanel('panelPets'); doAction('my_pets'); }
        function getRarityLabel(r) { var m = { 'common': '<span class="rarity-common">普通</span>', 'uncommon': '<span class="rarity-uncommon">优秀</span>', 'rare': '<span class="rarity-rare">稀有</span>', 'epic': '<span class="rarity-epic">史诗</span>', 'legendary': '<span class="rarity-legendary">传说</span>' }; return m[r] || m.common; }
        function getRarityText(r) { var m = { 'common': '普通', 'uncommon': '优秀', 'rare': '稀有', 'epic': '史诗', 'legendary': '传说' }; return m[r] || '普通'; }
        function getMoodColor(m) { return m >= 70 ? '#4caf50' : m >= 40 ? '#fbbf24' : '#ef4444'; }
        function getMoodText(m) { return m >= 80 ? '😊 开心' : m >= 60 ? '🙂 不错' : m >= 40 ? '😐 一般' : m >= 20 ? '😟 低落' : '😢 难过'; }
        function renderPetsPanel(pets) {
            var h = '';
            if (!pets || pets.length === 0) { h += '<div class="text-center p-12" style="color:#4a5a4a;"><div style="font-size:36px;margin-bottom:10px;">🐾</div><div class="text-13">还没有宠物</div><div class="text-muted" style="margin-top:4px;">去野外捕捉或商店购买吧</div></div>'; }
            else {
                h += '<div class="text-12 mb-8" style="color:#5a7a5a;">共 ' + pets.length + '/' + PET_MAX + ' 只宠物</div>';
                for (var i = 0; i < pets.length; i++) {
                    var p = pets[i], now = Date.now(), onAdv = p.adventureEndTime && now < p.adventureEndTime, advReady = p.adventureEndTime && now >= p.adventureEndTime;
                    h += '<div class="pet-card" onclick="openPetDetail(\'' + p.id + '\')">';
                    h += '<div class="pc-header"><div style="display:flex;align-items:center;gap:8px;"><span class="pc-icon">' + (p.speciesIcon || '🐾') + '</span><div><div class="pc-name">' + esc(p.name) + '</div><div class="pc-species">' + esc(p.species) + ' · ' + getRarityLabel(p.rarity) + '</div></div></div>';
                    h += '<div style="text-align:right;"><div class="text-12 text-gold">💰' + (p.value || 0) + '</div><div class="text-muted">价值</div></div></div>';
                    h += '<div class="pc-stats"><span>' + getMoodText(p.mood) + ' <div class="mood-bar"><div class="mood-bar-fill" style="width:' + p.mood + '%;background:' + getMoodColor(p.mood) + ';"></div></div></span><span>🗺️ 探险' + (p.totalAdventures || 0) + '次</span></div>';
                    if (onAdv) { var rm = Math.ceil((p.adventureEndTime - now) / 60000); h += '<div class="pc-adventure">🗺️ 寻宝中... 还需' + rm + '分钟</div>'; }
                    else if (advReady) h += '<div class="pc-adventure" style="color:#4ade80;">✅ 寻宝完成！点击领取</div>';
                    h += '</div>';
                }
            }
            document.getElementById('petsContent').innerHTML = h;
        }
        function openPetDetail(pid) {
            if (!playerData || !playerData.pets) return; var pet = playerData.pets.find(function (p) { return p.id === pid; }); if (!pet) return;
            var now = Date.now(), onAdv = pet.adventureEndTime && now < pet.adventureEndTime, advReady = pet.adventureEndTime && now >= pet.adventureEndTime;
            var h = '<div class="text-center mb-12"><div style="font-size:48px;margin-bottom:6px;">' + (pet.speciesIcon || '🐾') + '</div>';
            h += '<div style="font-size:18px;color:#c4b5fd;font-weight:600;">' + esc(pet.name) + '</div>';
            h += '<div class="text-12" style="color:#5a7a5a;margin-top:2px;">' + esc(pet.species) + ' · ' + getRarityLabel(pet.rarity) + '</div></div>';
            h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">';
            h += '<div class="glass text-center p-10"><div class="text-muted">心情</div><div style="font-size:14px;margin-top:2px;">' + getMoodText(pet.mood) + '</div><div class="mood-bar" style="width:80%;margin:4px auto 0;"><div class="mood-bar-fill" style="width:' + pet.mood + '%;background:' + getMoodColor(pet.mood) + ';"></div></div></div>';
            h += '<div class="glass text-center p-10"><div class="text-muted">价值</div><div style="font-size:14px;color:#fcd34d;margin-top:2px;">💰' + (pet.value || 0) + '</div></div>';
            h += '<div class="glass text-center p-10"><div class="text-muted">探险次数</div><div style="font-size:14px;color:#67e8f9;margin-top:2px;">🗺️ ' + (pet.totalAdventures || 0) + '</div></div>';
            h += '<div class="glass text-center p-10"><div class="text-muted">获得时间</div><div class="text-11" style="color:#7a9a7a;margin-top:4px;">' + new Date(pet.createdAt).toLocaleDateString() + '</div></div></div>';
            h += '<div class="flex-col-6">';
            if (advReady) h += '<button class="action-btn action-btn-solid-green w-full" style="padding:12px;font-size:14px;" onclick="doPetCollect(\'' + pet.id + '\')">🎁 领取寻宝奖励</button>';
            else if (onAdv) { var rm2 = Math.ceil((pet.adventureEndTime - now) / 60000); h += '<div class="glass text-center p-12 text-13 text-gold">🗺️ 寻宝中... 还需' + rm2 + '分钟</div>'; }
            else h += '<button class="action-btn action-btn-gold w-full" style="padding:10px;" onclick="doPetAdventure(\'' + pet.id + '\')">🗺️ 派出寻宝（15分钟）</button>';
            h += '<button class="action-btn action-btn-purple w-full" style="padding:10px;" onclick="doPetInteract(\'' + pet.id + '\')">❤️ 互动（心情+15）</button>';
            h += '<button class="action-btn action-btn-cyan w-full" style="padding:10px;" onclick="doPetRename(\'' + pet.id + '\')">✏️ 改名</button>';
            h += '<button class="action-btn action-btn-red w-full" style="padding:10px;" onclick="doPetRelease(\'' + pet.id + '\')">🕊️ 放生（回收一半价值）</button></div>';
            document.getElementById('petDetailContent').innerHTML = h; openPanel('panelPetDetail');
        }
        function doPetAdventure(id) { doAction('pet_adventure', { petId: id }); }
        function doPetCollect(id) { doAction('pet_collect', { petId: id }); }
        function doPetInteract(id) { doAction('pet_interact', { petId: id }); }
        function doPetRename(id) { var n = prompt('给宠物起个新名字（1-12字）：'); if (!n || !n.trim()) return; doAction('rename_pet', { petId: id, name: n.trim() }); closePanel('panelPetDetail'); }
        function doPetRelease(id) { if (!confirm('确定放生这只宠物？将获得一半价值的金币。')) return; doAction('release_pet', { petId: id }); closePanel('panelPetDetail'); }

        // 邮件
        function openMail() { document.getElementById('mailContent').innerHTML = loadingPlaceholder(); openPanel('panelMail'); doAction('mail_list'); openPanel('panelMail'); }
        function renderMailPanel(mails) {
            var h = '';
            if (!mails || mails.length === 0) { h += '<div class="text-center p-12" style="color:#4a5a4a;"><div style="font-size:36px;margin-bottom:10px;">📭</div><div class="text-13">没有邮件</div></div>'; }
            else {
                h += '<div class="flex-between mb-8"><span class="text-12" style="color:#5a7a5a;">共 ' + mails.length + ' 封邮件</span><div class="flex-gap-6">';
                h += '<button class="action-btn action-btn-cyan" style="padding:5px 12px;font-size:11px;" onclick="markAllMailRead()">全部已读</button>';
                h += '<button class="action-btn action-btn-red" style="padding:5px 12px;font-size:11px;" onclick="deleteAllMail()">全部删除</button></div></div>';
                for (var i = mails.length - 1; i >= 0; i--) {
                    var m = mails[i], ha = m.attachments && m.attachments.length > 0, cl = m.claimed, rd = m.read;
                    var bc = !rd ? 'rgba(103,232,249,0.2)' : ha && !cl ? 'rgba(251,191,36,0.2)' : 'rgba(255,255,255,0.04)';
                    var bg = !rd ? 'rgba(103,232,249,0.03)' : ha && !cl ? 'rgba(251,191,36,0.03)' : 'rgba(255,255,255,0.02)';
                    h += '<div class="glass p-12 mb-8" style="border-color:' + bc + ';background:' + bg + ';">';
                    h += '<div class="flex-between mb-6"><div class="text-13 text-green fw-600">' + (!rd ? '🔵 ' : '') + esc(m.subject || '系统邮件') + '</div><div class="text-muted">' + formatMailTime(m.createdAt) + '</div></div>';
                    h += '<div class="text-11 mb-6" style="color:#5a7a5a;">来自: ' + esc(m.from || '系统') + '</div>';
                    if (m.text) h += '<div class="text-12" style="color:#ccc;line-height:1.6;margin-bottom:8px;white-space:pre-wrap;">' + esc(m.text) + '</div>';
                    if (ha) {
                        h += '<div class="text-11 text-gold mb-6">📦 附件：</div><div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">';
                        for (var j = 0; j < m.attachments.length; j++) {
                            var at = m.attachments[j], atT = '';
                            if (at.type === 'money') atT = '💰' + at.amount + '金币'; else if (at.type === 'seed') atT = (at.data.icon || '🌱') + at.data.name + ' x' + (at.data.count || 1);
                            else if (at.type === 'fruit') atT = (at.data.icon || '🍎') + at.data.name + ' x' + (at.data.count || 1); else if (at.type === 'pet') atT = (at.data.speciesIcon || '🐾') + at.data.species + '·' + (at.data.name || at.data.species);
                            else if (at.type === 'item') atT = (at.data.icon || '📦') + at.data.name + ' x' + (at.data.count || 1);
                            else if (at.type === 'animal') atT = (at.data.icon || '🐾') + at.data.name + ' x' + (at.data.count || 1);
                            h += '<span class="glass text-11" style="padding:3px 8px;color:#aaa;">' + atT + '</span>';
                        }
                        h += '</div>';
                    }
                    h += '<div class="flex-gap-6">';
                    if (ha && !cl) h += '<button class="action-btn action-btn-solid-green" style="flex:1;padding:8px;font-size:12px;" onclick="claimMail(\'' + m.id + '\')">🎁 领取附件</button>';
                    else if (ha && cl) h += '<span style="flex:1;padding:8px;text-align:center;font-size:11px;color:#4a5a4a;">✅ 已领取</span>';
                    if (!rd) h += '<button class="action-btn action-btn-cyan" style="padding:8px 14px;font-size:11px;" onclick="markMailRead(\'' + m.id + '\')">已读</button>';
                    h += '<button class="action-btn action-btn-red" style="padding:8px 14px;font-size:11px;" onclick="deleteMail(\'' + m.id + '\')">删除</button></div></div>';
                }
            }
            document.getElementById('mailContent').innerHTML = h;
        }
        function formatMailTime(ts) { if (!ts) return ''; var d = new Date(ts), now = new Date(), df = now - d; if (df < 60000) return '刚刚'; if (df < 3600000) return Math.floor(df / 60000) + '分钟前'; if (df < 86400000) return Math.floor(df / 3600000) + '小时前'; return (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0'); }
        function claimMail(id) { doAction('mail_claim', { mailId: id }); }
        function deleteMail(id) { if (!confirm('确定删除这封邮件？')) return; doAction('mail_delete', { mailId: id }); }
        function markMailRead(id) { doAction('mail_read', { mailId: id }); }
        function markAllMailRead() { doAction('mail_read_all'); }
        function deleteAllMail() { if (!confirm('确定删除所有邮件？未领取的附件将丢失！')) return; doAction('mail_delete_all'); }

        // 活动
        function openEvents() {
            document.getElementById('eventsContent').innerHTML = loadingPlaceholder();
            openPanel('panelEvents');
            if (playerData && playerData._worldId) doAction('event_list');
            else renderEventsPanel([]);
        }
        function renderEventsPanel(events, playerProgress) {
            var h = '', now = Date.now() + serverTimeOffset;
            playerProgress = playerProgress || {};

            if (!events || events.length === 0) {
                h += '<div class="text-center p-12" style="color:#3a4a3a;"><div style="font-size:36px;margin-bottom:10px;">🎉</div><div style="font-size:14px;color:#5a7a5a;">暂无活动</div><div class="text-12" style="color:#3a4a3a;margin-top:6px;">敬请期待天道开启新活动</div></div>';
                document.getElementById('eventsContent').innerHTML = h;
                return;
            }

            function renderEI(ev) {
                var st = getEventStatus(ev, now);
                var sc = st === 'active' ? 'active-event' : st === 'upcoming' ? 'upcoming-event' : 'ended-event';
                var sl = st === 'active' ? '<span class="ec-status st-active">进行中</span>' : st === 'upcoming' ? '<span class="ec-status st-upcoming">即将开始</span>' : '<span class="ec-status st-ended">已结束</span>';

                var html = '<div class="event-card ' + sc + '">';
                html += '<div class="ec-header"><span class="ec-name">' + (ev.icon || '🎉') + ' ' + esc(ev.name) + '</span>' + sl + '</div>';

                if (ev.desc) html += '<div class="ec-desc">' + esc(ev.desc) + '</div>';

                // Buff效果
                var eff = [];
                if (ev.doubleHarvest) eff.push('🌾 双倍收获');
                if (ev.doubleGather) eff.push('🌿 双倍采集');
                if (ev.doubleMoney) eff.push('💰 双倍金币');
                if (eff.length > 0) html += '<div class="text-11 text-green" style="margin:4px 0;">✨ ' + eff.join(' · ') + '</div>';

                // 特殊掉落
                if (ev.specialDrops && ev.specialDrops.length > 0) {
                    html += '<div class="text-muted" style="margin:4px 0;">🎁 特殊掉落：';
                    for (var j = 0; j < ev.specialDrops.length; j++) {
                        var d = ev.specialDrops[j];
                        html += (d.icon || '🎁') + (d.data ? d.data.name : d.name) + '(' + d.chance + '%) ';
                    }
                    html += '</div>';
                }

                // 限定称号
                if (ev.limitedTitles && ev.limitedTitles.length > 0) {
                    html += '<div class="text-muted" style="margin:2px 0;">👑 限定称号：';
                    for (var j = 0; j < ev.limitedTitles.length; j++) {
                        var t = ev.limitedTitles[j];
                        html += '<span style="color:' + (t.color || '#fcd34d') + ';">[' + t.name + ']</span> ';
                    }
                    html += '</div>';
                }

                // 任务列表
                if (ev.tasks && ev.tasks.length > 0) {
                    var ep = playerProgress[ev.id] || {}, pt = ep.tasks || [];
                    html += '<div style="margin-top:8px;">';
                    for (var j = 0; j < ev.tasks.length; j++) {
                        var tk = ev.tasks[j], pg = (pt[j] !== undefined && pt[j] !== null) ? pt[j] : 0, pct = Math.min(100, Math.floor((pg / tk.targetCount) * 100)), done = pg >= tk.targetCount;

                        html += '<div class="glass" style="padding:6px;margin-bottom:4px;border-color:' + (done ? 'rgba(76,175,80,0.25)' : 'rgba(255,255,255,0.04)') + ';background:' + (done ? 'rgba(76,175,80,0.04)' : 'transparent') + ';">';
                        html += '  <div class="flex-between text-11" style="margin-bottom:2px;">';
                        html += '    <span style="color:' + (done ? '#a5d6a7' : '#aaa') + ';">' + esc(tk.desc) + '</span>';
                        html += '    <span style="color:' + (done ? '#4ade80' : '#5a7a5a') + ';">' + pg + '/' + tk.targetCount + '</span>';
                        html += '  </div>';
                        html += '  <div style="width:100%;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;">';
                        html += '    <div style="height:100%;width:' + pct + '%;background:' + (done ? '#4caf50' : '#fbbf24') + ';border-radius:2px;"></div>';
                        html += '  </div>';
                        if (tk.rewardTitle && done) {
                            html += '<div style="font-size:10px;color:' + tk.rewardTitle.color + ';margin-top:2px;">🎁 可领取称号：[' + esc(tk.rewardTitle.name) + ']</div>';
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                }

                // 时间显示
                var ss = ev.startTime ? new Date(ev.startTime).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
                var es = ev.endTime ? new Date(ev.endTime).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

                if (ss || es) html += '<div class="ec-time">🕐 ' + ss + (es ? ' ~ ' + es : '') + '</div>';

                if (st === 'active' && ev.endTime) {
                    html += '<div class="ec-countdown">⏳ 剩余 ' + formatCountdown(ev.endTime - now) + '</div>';
                } else if (st === 'upcoming' && ev.startTime) {
                    html += '<div class="ec-countdown" style="color:#67e8f9;">⏳ ' + formatCountdown(ev.startTime - now) + ' 后开始</div>';
                }

                html += '</div>'; // close event-card
                return html;
            }

            var hol = events.filter(function (e) { return e.type === 'holiday' || e.holiday; });
            var nor = events.filter(function (e) { return e.type !== 'holiday' && !e.holiday; });

            if (hol.length > 0) {
                h += '<div class="mb-12"><div class="text-12 text-gold mb-6">🎊 节日活动</div>';
                for (var i = 0; i < hol.length; i++) h += renderEI(hol[i]);
                h += '</div>';
            }
            if (nor.length > 0) {
                h += '<div style="margin-top:' + (hol.length > 0 ? '16px' : '0') + ';"><div class="text-12 text-green mb-6">📢 普通活动</div>';
                var sorted = nor.slice().sort(function (a, b) { return getEventSortOrder(a, now) - getEventSortOrder(b, now); });
                for (var i = 0; i < sorted.length; i++) h += renderEI(sorted[i]);
                h += '</div>';
            }

            document.getElementById('eventsContent').innerHTML = h;
        }
        function getEventStatus(ev, now) { if (ev.startTime && now < ev.startTime) return 'upcoming'; if (ev.endTime && now > ev.endTime) return 'ended'; return 'active'; }
        function getEventSortOrder(ev, now) { var s = getEventStatus(ev, now); return s === 'active' ? 0 : s === 'upcoming' ? 1 : 2; }
        function formatCountdown(ms) { if (ms <= 0) return '已结束'; var ts = Math.floor(ms / 1000), d = Math.floor(ts / 86400), h = Math.floor((ts % 86400) / 3600), m = Math.floor((ts % 3600) / 60); if (d > 0) return d + '天' + h + '小时'; if (h > 0) return h + '小时' + m + '分'; return m + '分钟'; }

        // 设置
        function openSettings() { renderSettingsPanel(); openPanel('panelSettings'); }
        function renderSettingsPanel() {
            var h = '<div class="settings-player-card"><div class="sp-name">' + esc(username || '???') + '</div>';
            if (playerData && playerData.activeTitle) h += '<div class="sp-title" style="color:' + playerData.activeTitle.color + ';">·[' + esc(playerData.activeTitle.name) + ']</div>';
            h += '<div class="sp-id">领地ID: ' + esc(farmId || '???') + '</div>';
            if (currentWorld) h += '<div class="text-11" style="color:#4a5a4a;margin-top:6px;">当前世界: ' + esc(currentWorld.name) + '</div>';
            h += '</div><div class="settings-section"><div class="settings-section-title">👑 我的称号</div>';
            h += '<button class="btn-td btn-green w-full" style="padding:10px;border-radius:20px;" onclick="openTitleSelect()">📜 选择称号</button></div>';
            h += '<div class="settings-section"><div class="settings-section-title">⚙️ 游戏设置</div><div class="settings-placeholder"><div style="font-size:24px;margin-bottom:8px;">🔧</div><div>更多设置即将推出</div><div class="text-11" style="color:#2a3a2a;margin-top:4px;">音效、通知、界面主题...</div></div></div>';
            h += '<div style="margin-top:20px;"><button class="action-btn action-btn-red w-full" style="padding:12px;font-size:14px;font-weight:600;" onclick="exitWorld()">🚪 退出当前世界</button></div>';
            document.getElementById('settingsContent').innerHTML = h;
        }
        function openTitleSelect() { renderTitleSelectPanel(); openPanel('panelTitleSelect'); }
        function renderTitleSelectPanel() {
            var h = '';
            if (!playerData || !playerData.titles || playerData.titles.length === 0) h += '<div class="text-center p-12" style="color:#5a7a5a;">你还没有获得任何称号</div>';
            else {
                for (var i = 0; i < playerData.titles.length; i++) {
                    var t = playerData.titles[i], isA = playerData.activeTitle && playerData.activeTitle.titleId === t.titleId;
                    h += '<div class="glass flex-between p-8 mb-6" style="border-color:' + (isA ? 'rgba(76,175,80,0.25)' : 'rgba(255,255,255,0.04)') + ';background:' + (isA ? 'rgba(76,175,80,0.06)' : 'transparent') + ';">';
                    h += '<span style="color:' + t.color + ';">[' + esc(t.name) + ']</span>';
                    if (isA) h += '<button class="action-btn action-btn-red" style="padding:4px 10px;font-size:11px;" onclick="setActiveTitle(null)">取消使用</button>';
                    else h += '<button class="btn-td btn-green" style="padding:4px 10px;font-size:11px;" onclick="setActiveTitle(\'' + t.titleId + '\')">使用</button>';
                    h += '</div>';
                }
            }
            document.getElementById('titleSelectContent').innerHTML = h;
        }
        function setActiveTitle(id) { doAction('set_active_title', { titleId: id }); }

        // 每日任务
        function openDailyTasks() {
            document.getElementById('dailyTasksContent').innerHTML = loadingPlaceholder();
            openPanel('panelDailyTasks');
            doAction('daily_tasks');
        }
        function renderDailyTasksPanel(dt, pb) {
            if (!dt || !dt.tasks) {
                document.getElementById('dailyTasksContent').innerHTML = '<div class="text-center p-12" style="color:#4a5a4a;">暂无任务</div>';
                return;
            }

            var tasks = dt.tasks;
            var cc = tasks.filter(function (t) { return t.completed; }).length;
            var tc = tasks.length;
            var allC = cc === tc && tc > 0;
            var allCl = tasks.every(function (t) { return t.claimed; }) && allC;

            // 计算倒计时
            var now = new Date();
            var tmr = new Date(now);
            tmr.setDate(tmr.getDate() + 1);
            tmr.setHours(0, 0, 0, 0);
            var df = tmr - now;
            var dh = Math.floor(df / 3600000);
            var dm = Math.floor((df % 3600000) / 60000);
            var ds = Math.floor((df % 60000) / 1000);
            var cd = dh + ':' + String(dm).padStart(2, '0') + ':' + String(ds).padStart(2, '0');

            // 头部统计
            var h = '<div class="text-center mb-12"><div class="text-12" style="color:#5a7a5a;">刷新倒计时 <span class="text-gold fw-600">' + cd + '</span></div>';
            h += '<div class="text-13 text-green" style="margin-top:4px;">完成 ' + cc + '/' + tc + ' 个任务</div></div>';

            // 任务列表循环
            for (var i = 0; i < tasks.length; i++) {
                var t = tasks[i];
                var pp = Math.min(100, Math.floor((t.progress / t.targetCount) * 100));

                var bg = t.claimed ? 'rgba(255,255,255,0.01)' : (t.completed ? 'rgba(76,175,80,0.06)' : 'rgba(255,255,255,0.02)');
                var bc = t.claimed ? 'rgba(255,255,255,0.04)' : (t.completed ? 'rgba(76,175,80,0.2)' : 'rgba(255,255,255,0.06)');

                // --- 任务卡片容器 ---
                h += '<div class="glass p-12 mb-8" style="background:' + bg + ';border-color:' + bc + ';border-radius:14px;">';

                // 任务标题行
                h += '<div class="flex-between mb-6">';
                h += '  <span class="text-13" style="color:' + (t.completed ? '#a5d6a7' : '#aaa') + ';">' + esc(t.targetDesc) + '</span>';

                // 状态按钮/文字
                if (t.claimed) {
                    h += '<span class="text-11 glass" style="padding:2px 8px;color:#5a7a5a;">✅ 已领取</span>';
                } else if (t.completed) {
                    h += '<button class="btn-td btn-green" style="padding:4px 12px;font-size:11px;" onclick="claimDailyTask(' + i + ')">领取奖励</button>';
                } else {
                    h += '<span class="text-11" style="color:#5a7a5a;">' + t.progress + '/' + t.targetCount + '</span>';
                }
                h += '</div>'; // 关闭 flex-between

                // 进度条
                h += '<div style="width:100%;height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;">';
                h += '  <div style="height:100%;width:' + pp + '%;background:' + (t.completed ? '#4caf50' : '#fbbf24') + ';border-radius:3px;"></div>';
                h += '</div>';

                // 任务奖励文本
                if (t.rewards && t.rewards.length > 0) {
                    h += '<div class="text-muted" style="margin-top:6px;">🎁 奖励: ';
                    for (var j = 0; j < t.rewards.length; j++) {
                        var r = t.rewards[j];
                        if (r.type === 'money') h += '💰' + r.amount + ' ';
                        else if (r.type === 'seed' && r.data) h += (r.data.icon || '🌱') + r.data.name + ' x' + (r.data.count || 1) + ' ';
                        else if (r.type === 'fruit' && r.data) h += (r.data.icon || '🍎') + r.data.name + ' x' + (r.data.count || 1) + ' ';
                    }
                    h += '</div>';
                }
                h += '</div>'; // 关闭 glass div
            }

            // 全勤奖励区域
            if (pb && pb.rewards) {
                h += '<div class="glass p-12" style="margin-top:12px;border-color:rgba(252,211,77,0.12);background:rgba(252,211,77,0.04);">';
                h += '<div class="flex-between"><span class="text-12 text-gold fw-600">🏆 全勤奖励</span>';

                if (allC && allCl) {
                    h += '<span class="text-11" style="color:#4ade80;">✅ 已领取</span>';
                } else if (allC) {
                    h += '<span class="text-11 text-gold">✨ 已完成！</span>';
                } else {
                    h += '<span class="text-11" style="color:#5a7a5a;">完成全部任务领取</span>';
                }
                h += '</div>';

                h += '<div class="text-11" style="color:#5a7a5a;margin-top:4px;">';
                for (var k = 0; k < pb.rewards.length; k++) {
                    var r = pb.rewards[k];
                    if (r.type === 'money') h += '💰' + r.amount + ' ';
                    else if (r.type === 'seed' && r.data) h += (r.data.icon || '🌱') + r.data.name + ' x' + (r.data.count || 1) + ' ';
                }
                h += '</div></div>';
            }

            document.getElementById('dailyTasksContent').innerHTML = h;
        }


        function claimDailyTask(idx) { doAction('claim_daily_task', { taskIndex: idx }); }

        // 导航切换
        function switchNavPage() { var p1 = document.getElementById('navPage1'), p2 = document.getElementById('navPage2'); if (p1.style.display === 'none') { p1.style.display = ''; p2.style.display = 'none'; } else { p1.style.display = 'none'; p2.style.display = ''; } }

        // 面板通用
        function openPanel(id) { document.getElementById(id).classList.add('show'); }
        function closePanel(id) { document.getElementById(id).classList.remove('show'); }
        document.querySelectorAll('.panel-overlay').forEach(function (el) { el.addEventListener('click', function (e) { if (e.target === el) el.classList.remove('show'); }); });

        // 工具
        function esc(t) { if (t === null || t === undefined) return ''; var d = document.createElement('div'); d.textContent = String(t); return d.innerHTML; }

        // 事件绑定
        document.getElementById('chatInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') sendChat(); });
        document.getElementById('loginPass').addEventListener('keypress', function (e) { if (e.key === 'Enter') doLogin(); });
        document.addEventListener('visibilitychange', function () { if (document.visibilityState === 'visible') { if (!ws || ws.readyState !== WebSocket.OPEN) connectWS(); if (playerData) doAction('my_farm'); } });

        // 亲密度（保留接口）
        function renderFriendshipLevels() { var el = document.getElementById('friendshipLevels'); if (!el) return; }
        function checkAndShowFriendStatus(tu, io) { if (!cachedFriendList || cachedFriendList.length === 0) return; if (cachedFriendList.indexOf(tu) === -1) return; addSysMsg((io ? '🟢 ' : '⚫ ') + esc(tu) + (io ? ' 上线了' : ' 下线了')); }

        // 启动
        loadSavedAccount();
        connectWS();
    </script>
</body>

</html>
